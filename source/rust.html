<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-03-12 Tue 14:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>rust learn</title>
<meta name="author" content="wildimagine" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">rust learn</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org726553a">1. Rust</a>
<ul>
<li><a href="#orgfd6ad98">1.1. Rust基础 知识：</a>
<ul>
<li><a href="#org3224d36">1.1.1. std::fmt:</a></li>
<li><a href="#orga44aa37">1.1.2. array &amp; Slice</a></li>
<li><a href="#org4853a33">1.1.3. structures： 有三种类型： 1） Tuple struct, 2) classic struct 3) Unit structs</a></li>
<li><a href="#org77b79d0">1.1.4. Enums： 包含多个 变体 的 组合项， 任何一个变体 都是一个 正确的 enum 类型</a></li>
<li><a href="#orge2d81f3">1.1.5. Type Alias：type 关键字能够 使用 type Name = ExistingType； 语法来 使用 Name 代替 ExistingType 使用。 Self 是一种Type Alias</a></li>
<li><a href="#orgd90f443">1.1.6. const， static</a></li>
<li><a href="#org3e1a89d">1.1.7. Variable Bindings： 1）变量默认 是不可修改的， 使用mut 改变 2） 可以在内部的scope中 其同样的名字来shadow 外部的变量 3）可以使用 先声明 后设定数值的形式 使用变量，但是rust 会检查 使用 未定义变量的错误， 来预防因此产生的问题</a></li>
<li><a href="#org5a15a6c">1.1.8. Types: 1）转换 as关键字  2） type alias： type NanoSecond = u64; 3） 数值的类型，可以添加到  后面最为后缀使用， 例如： 42i32</a></li>
<li><a href="#orgc506251">1.1.9. Conversion： rust 的struct 以及 enum 等自定义类型的 type转换</a></li>
<li><a href="#orgbff0c1d">1.1.10. Expression： 程序是由一系列表达式组成的， 1） 赋值表达式 用; 结尾， 2） {} 也是表达式， 如果最后一个表达式 以; 结尾，则返回  (), 否则为最后一个表达式的 结果</a></li>
<li><a href="#org4f54f3a">1.1.11. Flow of control：</a></li>
<li><a href="#orgf6ad3d5">1.1.12. Functions:</a></li>
<li><a href="#org9f2032c">1.1.13. Modules:</a></li>
<li><a href="#org4508843">1.1.14. Attributes: 可以用来作什么？ 1） 条件编译， 2）设定crate 属性， 3）关闭 warning 4)启用编译器特性(maros etc) 5） link to a foreign library 6) 设定unit test</a></li>
<li><a href="#org0c2ed42">1.1.15. Smart Pointer:</a></li>
<li><a href="#org4c240ee">1.1.16. OIBITs:</a></li>
<li><a href="#org185fcd5">1.1.17. stand for “opt-in builtin trait”: 比如 Send， Sync， 该种 Trait 默认 为所有的 struct enum 提供默认实现，  即： 如果 struct A 中的field 都impl Trait 则 struct A 也同样 impl Trait。</a></li>
<li><a href="#org17e19e2">1.1.18. 参考链接, 参考链接1</a></li>
<li><a href="#orgcd1971c">1.1.19. impl Trait: 目前 可以在 fn xxx() -&gt; impl Trait</a></li>
<li><a href="#org8c2ebe9">1.1.20. Box&lt;Trait&gt; vs Box&lt;T&gt; where T: Trait vs &amp;Trait 的区别：</a></li>
<li><a href="#orge6ec2e0">1.1.21. dyn trait:</a></li>
<li><a href="#org19651b9">1.1.22. rust stackoverflow 问题： 使用 lldb target/debug/deps/smoke-910c8a3208aec5c7 ，跟gdb 调试一样，定义定位到 callstack的相关信息</a></li>
</ul>
</li>
<li><a href="#org6efc2cd">1.2. rust mut var &amp; mut ref 的含义</a></li>
<li><a href="#orgb71b8b9">1.3. const &amp; static : 参考</a></li>
<li><a href="#org088697d">1.4. Rust 周边工具</a>
<ul>
<li><a href="#orgdd42e6a">1.4.1. rustup: rust complier 的管理工具， 可以方便的切换 stable, beta, and nightly</a></li>
<li><a href="#orga1095cc">1.4.2. cargo: 是rust的包管理工具， 用来 下载 rust的依赖， 编译， 以及 分发 到 crates.io</a></li>
<li><a href="#org38c45d1">1.4.3. rustup： 从官方下载rustc， 使能够随意的在 stable, beta, nightly 中切换。 让 cross-compiling 编译变的简单</a></li>
</ul>
</li>
<li><a href="#org52a560a">1.5. 工具 Trait:</a>
<ul>
<li><a href="#org934ae4b">1.5.1. Drop</a></li>
<li><a href="#org832217e">1.5.2. Sized: marker trait , rust 用来标记 在 compile时期， size 能够确定的 type</a></li>
<li><a href="#org663a623">1.5.3. Clone:</a></li>
<li><a href="#org99ca1c3">1.5.4. Copy: 基本类型  i32， i64 etc</a></li>
<li><a href="#orga6edccc">1.5.5. Deref &amp; DerefMut : rust 自动尝试 插入 deref() 代码，当类型不匹配时， 可以经过多次插入</a></li>
<li><a href="#orgf3c457b">1.5.6. Default</a></li>
<li><a href="#org33bac2b">1.5.7. AsRef &amp; AsMut:</a></li>
<li><a href="#org4b8a518">1.5.8. Borrow &amp; BorrowMut</a></li>
<li><a href="#org3e70b6f">1.5.9. From &amp; Into:</a></li>
<li><a href="#orgfb777ff">1.5.10. ToOwned:</a></li>
<li><a href="#orgc21693c">1.5.11. Send, Sync</a></li>
<li><a href="#org590d6ae">1.5.12. Ref Pointer:</a></li>
</ul>
</li>
<li><a href="#orgd9634aa">1.6. rust std 阅读</a>
<ul>
<li><a href="#orge5b84bb">1.6.1. doc 中经常出现 primitive type 与 std:: 的问题， 是因为 primitive type是 compiler 实现的。 而 std 也实现了同样名字的一部分。所以是此现象</a></li>
<li><a href="#orgc816dec">1.6.2. rust prelude:</a></li>
<li><a href="#org540515b">1.6.3. iter module: 是一个 关于 iter 的模块，包含了 一系列的 trait， struct  用于支持 Iterator</a></li>
<li><a href="#orga5d5a83">1.6.4. Vev Iter, Iterator, Enumerate 函数中 find, map block中的参数类型，是否 为 &amp;T, &amp;mut T</a></li>
<li><a href="#orgc482bfb">1.6.5. Box: Box::new(T) 方法</a></li>
<li><a href="#org132aacc">1.6.6. Borrow Trait 的错误使用： 下面为代码的 正确使用示例： 为什么会如此设计？</a></li>
<li><a href="#org693ce0b">1.6.7. FromIterator: 定义如下:</a></li>
<li><a href="#orgbadb20f">1.6.8. Vec: 的使用</a></li>
<li><a href="#orgdefbcef">1.6.9. rust thread unwrap 的问题</a></li>
</ul>
</li>
<li><a href="#org408ac94">1.7. Atomic: rust 使用c++ 20 的 atomic 内存模型（并非c++ 非常好，而是 atomic 非常复杂，使用现有的有利于 学习使用）， 为了 弥补 complier 与 hardwre 之间优化的差异。</a>
<ul>
<li><a href="#org5a8576c">1.7.1. Compiler Reordering: 编译器 将分析 程序，并重新排列 指令 以优化 程序性能， example：</a></li>
<li><a href="#orgd490a30">1.7.2. Hardware Reordering: 因为cpu的内存层次结构设计， 比如 每个Cpu都存在L1，共用 L2， 同样将导致问题。example：</a></li>
<li><a href="#org488d160">1.7.3. 不同的 cpu 存在不同的 保证： strongly-ordered(Inter) and weakly-ordered(Arm)</a></li>
<li><a href="#org5dfba25">1.7.4. C++ 内存模型通过 因果一致  （causality result） 来弥补 cpu/ compiler 之间的差异。</a></li>
<li><a href="#orgc8830bc">1.7.5. data access：</a></li>
<li><a href="#org9bee49f">1.7.6. rust 的 Ordering: 类型</a></li>
<li><a href="#orgebceaec">1.7.7. Sequentially Consistent: 最为安全的模式，将限制Compiler 对于指令的重排，Hardware则将更改完全同步到 其他 thread。代价： 即便是 strongly-ordered cpu 依然 可能需要使用 momory fences(内存栅栏) 来实现</a></li>
<li><a href="#org4bff3de">1.7.8. Acquire-Release: 非常适合 lock 的 acquire/release, 确保关键部分内容 不会重叠（overlap）</a></li>
<li><a href="#org4d634d4">1.7.9. Relaxed： 最弱的atomic order， 但依然是 atomic， read-modify-write 依然是原子操作， 不能够提供 Acquire/Release 提供的保证。对于  weakly-order cpu 非常好用</a></li>
<li><a href="#orge1dc00e">1.7.10. fense: 栅栏，rust还提供了  fense 操作， 在Arc 的Drop 操作中，使用 来保证 代码顺序的发生</a></li>
</ul>
</li>
<li><a href="#orgcd419d6">1.8. STD::Thread 标准库中的thread</a>
<ul>
<li><a href="#org9000e87">1.8.1. 1. Builder  用来 自定义Thread name, stack_size 参数配置</a></li>
<li><a href="#orgcbb0787">1.8.2. 2. ::spawn(f) 经过层层调用, 最终为: spawn_unchecked_ 其 内部 组装 main函数, __rust_begin_short_backtrace(f), 并调用  imp::Thread::new(stack_size, Box::new(main)) //可能为 系统native调用</a></li>
<li><a href="#org80d81a1">1.8.3. 3. thread::park()  的实现, Parker 结构如下:</a></li>
</ul>
</li>
<li><a href="#org5db8131">1.9. STD: mpsc;:channel :  是如何 实现的</a>
<ul>
<li><a href="#org146d36a">1.9.1. 代码整体</a></li>
<li><a href="#org7db995a">1.9.2. mpsc::channel 将创建 一个 onshot::Packet(), 所以为何怒在 Flavor的多种enum?</a></li>
<li><a href="#orgb911ad9">1.9.3. Flavor::OneShot() 为 只send(T) 一次 的优化版本, 当第二次 进行send调用时候, 将进行 upgrade 到 Flavor&lt;Stream&gt;</a></li>
<li><a href="#org08e7546">1.9.4. 整体逻辑为: 将 替换  Receiver, Sender 中的 inner  Receiver { inner: UnsafeCell&lt;Flavor::Oneshot(Arc&lt;oneshot::Packet&lt;T&gt;&gt;)&gt; } -&gt;  Receiver { inner: UnsafeCell&lt;Flavor::Stream(Arc&lt;stream::Packet&lt;T&gt;&gt;)&gt; } , sender 类似</a></li>
<li><a href="#org21b9663">1.9.5. stream  即为 queue: 需要详细分析一下:</a></li>
<li><a href="#orgd09e683">1.9.6. 代码如下:</a></li>
<li><a href="#orgf2a3192">1.9.7. Sender &amp; Receiver 共享 inner 中的 Arc&lt;stream::Packet&gt;, 主要为queue</a></li>
<li><a href="#org779c698">1.9.8. Queue: 中  consumer &amp; producer 使用链表, 共享 同样的内存空间</a></li>
<li><a href="#orgd4146a8">1.9.9. ConsumerAddition, ProducerAddition: ProducerAddition 中比较重要,</a></li>
<li><a href="#org500cd46">1.9.10. </a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd64c1d9">2. Error handle, rust 是如何处理error的?</a>
<ul>
<li><a href="#org82aae61">2.1. ? : operator expression &amp; From 机制:</a></li>
<li><a href="#org39bbbc8">2.2. std: 标准库 中是如何使用 实现的?</a>
<ul>
<li><a href="#org5789ea0">2.2.1. Result core 中自定义了 Result  为一个 enum, 而并没有定义E 的类型</a></li>
<li><a href="#orgc31ac37">2.2.2. std 库 定义了 多种 Error 类型, 包括 std::io::Error, std::fmt::Error,  std::num::ParseIntError &#x2026; etc,每种 自定义Error 不尽相同:</a></li>
<li><a href="#orgb5db33c">2.2.3. std::error: 提供 构建、 handle、 report、 propagating Rust 错误,  构建(表示 ) 即为: Result, error trait , custome  types  &amp; failure 处理模式:</a></li>
<li><a href="#org19895eb">2.2.4. trait: Error : Debug + Display {} 表达错误的基本结构, description(), cause(), type_id() etc&#x2026;</a></li>
<li><a href="#org3853bc0">2.2.5. Box&lt;dyn Error + 'a&gt;  {fn from(err: E) -&gt; Box&lt;dyn Error + 'a&gt; {Box::new(err)};</a></li>
<li><a href="#org670e36f">2.2.6. Report:  提供 error 的格式化工作, (通过配置 来控制 )</a></li>
</ul>
</li>
<li><a href="#orgc8378fd">2.3. Result::unwrap/expect 的区别: expect 接受参数, 来自定义 panic时候的 错误输出</a></li>
<li><a href="#org56c4e0f">2.4. error-chain: impl details:</a></li>
<li><a href="#orgffb7c4a">2.5. error_chain! macro 主要有3步骤:</a>
<ul>
<li><a href="#org437db8d">2.5.1. 1. 定义: struct Error, enum ErrorKind, Error(ErrorKind, State)</a></li>
<li><a href="#org59cc8a1">2.5.2. 2. impl From&lt;xxx&gt; for Error {}, 实现 ?</a></li>
<li><a href="#orge739c20">2.5.3. 3. 重新定义 Result:  pub type Result&lt;T&gt;  =  ::std::result::Result&lt;T,Error&gt;;</a></li>
</ul>
</li>
<li><a href="#org8d6dc96">2.6. error_chain! {} 中各个组成部分:  通过 expand-macro 来进行分析</a>
<ul>
<li><a href="#orgfd95c83">2.6.1. types: 从macro的展开结果看：  为 自定义 Error， ErrorKind, Result 名称, 不应该自定义 Result名字，而应该使用 Result</a></li>
<li><a href="#orgfb0aba8">2.6.2. errors: 为 ErrorKind 增加 ErrorKind 类型, 如下: 主要为 chain_err(error: F) F: FnOnce() -&gt; EK: Into&lt;ErrorKind&gt; 使用</a></li>
<li><a href="#orgecc8623">2.6.3. foreign_links: 实现 foreign error(外部的error定义) 到 ErrorKind的转换:</a></li>
<li><a href="#orgaf525ac">2.6.4. ErrorKind::Msg 为 方便 使用 &amp;str, String 定义error 而定义的ErrorKind Variant,</a></li>
<li><a href="#orga7e8fc7">2.6.5. links: 将其他的  error_chain 中定义的 Error 转换到 当前的Error中</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd9ea381">3. Rust diesel  还有 InsertAble 未掌握</a>
<ul>
<li><a href="#orgffc3305">3.1. 其中table! macro 的作用 在于 其提供的dsl模块， 其中可以 方便的构建 query_dsl::QueryDsl,即是sql 构建工厂，</a></li>
<li><a href="#orgb13087c">3.2. diesel::query_dsl::RunQueryDsl 则 实现了 load, execute, get_result 函数，来获取sql查询结果。</a></li>
<li><a href="#org631de34">3.3. QueryDsl 已经实现了  RunQueryDsl</a></li>
<li><a href="#org14edefd">3.4. 示例代码为：</a></li>
<li><a href="#orge1a910a">3.5. Insertable, macro: diesel::impl_Insertable</a></li>
</ul>
</li>
<li><a href="#org5a776bd">4. Rust redis;</a>
<ul>
<li><a href="#org1015e59">4.1. 理解 其 hget command, 其中的impl_commands macro 是如何展开的,能够自动的 添加返回值</a></li>
<li><a href="#org9459493">4.2. redis 主要有</a>
<ul>
<li><a href="#orgd5de01b">4.2.1. types(redis 数据类型 到rust 类型的映射), client, connection, cmd, pipeline</a></li>
<li><a href="#org6f3eb38">4.2.2. connection: 实现了 连接、操作redis的能力</a></li>
<li><a href="#org12fd028">4.2.3. types: 如何在redis typeless 到 rust type 之间进行转换</a></li>
<li><a href="#org973a4c4">4.2.4. macro 的使用方法</a></li>
</ul>
</li>
<li><a href="#org365fb7f">4.3. Cmd: struct:</a>
<ul>
<li><a href="#org4e0fe3b">4.3.1. 构建Cmd 可以使用 default/cmd("get")</a></li>
<li><a href="#org4251292">4.3.2. Cmd 直接 get,hget etc&#x2026; 命令在</a></li>
<li><a href="#orge574322">4.3.3. 为Cmd 增加方法的 主要有  impl Cmd; impl RedisWrite; impl Default, 以及重要的 implement_commands! macro  展开形式如下:</a></li>
</ul>
</li>
<li><a href="#org79b411f">4.4. 如何 执行 redis 命令?</a></li>
<li><a href="#org63ba981">4.5. types: 类型转换</a>
<ul>
<li><a href="#orgea90f68">4.5.1. ToRedisValue: 不需要看太多内容</a></li>
<li><a href="#orgff81b29">4.5.2. FromRedisValue: 大多 都已 macro 完成: 以 i8 为例:</a></li>
<li><a href="#orgf3bfe1a">4.5.3. 需要注意 nil 的转换, 在对 i8 的转换代码中, 并没有对 Value::Nil 的匹配</a></li>
<li><a href="#orge455a3b">4.5.4. 即简单命令 let res: RedisResult&lt;i64&gt; = cli.get("xx"); 如果xx 没有设定数值的话, 会导致 一直返回错误, 正确的方法是是 let res: RedisResult&lt;Option&lt;i64&gt;&gt; = cli.get("xx");</a></li>
<li><a href="#org3eee04a">4.5.5. 但是: HashMap&lt;String, String&gt;, 以及 Vec, Set 等集合类, 这是一个例外, 即便是 没有 key, 依然返回一个 empty 的集合</a></li>
</ul>
</li>
<li><a href="#org9a93ce6">4.6. cmd 到 redis命令格式的转换: 主要集中在 write_command 中, 代码如下:</a></li>
</ul>
</li>
<li><a href="#org1fc78e2">5. Pin &amp; UnPin, Future</a>
<ul>
<li><a href="#org9844fcd">5.1. 需要重新读一下： https://doc.rust-lang.org/std/pin/index.html 因为 Box::pin(t) 可以将 T: Pin, 变为  unpin, 因为 Pointer 为 unpin.</a></li>
<li><a href="#org048bcf3">5.2. Pin 的定义: Pin wrap pointers type， guarantee the value behind the pointer, won't be moved 即： Pin&lt;P&lt;T&gt;&gt; , 中的 T 不给交换(mem::swap) 移动</a></li>
<li><a href="#orgafeedd9">5.3. Pin 的意义: 即解决 self-ref的 结构体的 内存移动。</a></li>
<li><a href="#org7622eb2">5.4. Pin &amp; UnPin 类型涉及到 Struct 中存在 自引用(self ref) 指针 的结构。</a>
<ul>
<li><a href="#org292bb4a">5.4.1. 因为 该种结构 可能需要move，即： 使用 mem::swap（one, two）， 该函数接受任何类型的 &amp;mut ref， 使用 memcpy 对内存进行交换。</a></li>
<li><a href="#org6de389d">5.4.2. memcpy 并不适合 对于 包含 self-ref 的结构进行 交换， 将导致 指针错乱，详见： https://rust-lang.github.io/async-book/04_pinning/01_chapter.html#pinning</a></li>
<li><a href="#orga4038e2">5.4.3. Pin 的doc为https://doc.rust-lang.org/std/pin/index.html</a></li>
</ul>
</li>
<li><a href="#org3935172">5.5. 重读：https://rust-lang.github.io/async-book/04_pinning/01_chapter.html#pinning</a>
<ul>
<li><a href="#org74e2b41">5.5.1. 其中有对 为什么 会Future要求Pin 的要求，进行了基本的解释， 比如 async {} 转换为 类似对应的 Future（其中包含了 self-ref ） example：</a></li>
<li><a href="#org4d87b53">5.5.2. Pin wrap pointers type， guarantee the value behind the pointer, won't be moved, T: !Unpin  then  Pin&lt;&amp;mut T&gt;, Pin&lt;&amp;T&gt;, Pin&lt;Box&lt;T&gt;&gt; 保证T不被移动，</a></li>
<li><a href="#org22e7057">5.5.3. Future/Stream 从 Pin 到Unpin 的转换： Box::pin(Fut) =&gt; Pin&lt;Box&lt;Fut&gt;&gt;, pin_utils::pin_mut!(fut) =&gt; Pin&lt;&amp;mut Fut&gt; 即 =&gt; 后的实现 都是impl Unpin</a></li>
<li><a href="#org269bce3">5.5.4. summary:</a></li>
</ul>
</li>
<li><a href="#org476ac0d">5.6. Pin 并没有对 mem::swap 做特殊处理，因为swap 要求 &amp;mut T, 所以， Pin来prevent &amp;mut T 的导出即可。</a>
<ul>
<li><a href="#org5d829e7">5.6.1. 1. 测试一下，直接  mem::swap(&amp;mut Pin&lt;T&gt;, &amp;mut Pin&lt;T&gt;) ;</a></li>
<li><a href="#org8b17dfb">5.6.2. 2. 基本上所有的type 都会自动实现 Unpin, Future 是一个意外（需要查找 async function rust auto generator的示例 才能更深入的理解）</a></li>
<li><a href="#org8fb8db5">5.6.3. 3. T: is Unpin, then  Pin&lt;Box&lt;T&gt;&gt;, Box&lt;T&gt;, Pin&lt;&amp;mut T&gt;, &amp;mut T 都是 Unpin 的</a></li>
<li><a href="#org3391750">5.6.4. 4. Pin&lt;Box&lt;T&gt;&gt;</a></li>
<li><a href="#org5573895">5.6.5. </a></li>
</ul>
</li>
<li><a href="#org13f497a">5.7. https://cfsamson.github.io/books-futures-explained/introduction.html</a></li>
<li><a href="#org0a45fbf">5.8. ? 所以Pin 的要求是什么？呢？,如果 要求 Pin&lt;Future&lt;Output = T&gt;&gt;  ?</a></li>
<li><a href="#org8baf614">5.9. Test:</a>
<ul>
<li><a href="#org0a787cd">5.9.1. mem::swap(&amp;mut Pin&lt;Box&lt;T&gt;&gt;, &amp;mut Pin); T: !Unpin 可以的</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga8f991c">6. ?? 如何构建一个 delegate_to macro库：</a>
<ul>
<li><a href="#org306974f">6.1. 1. 肯定是需要借助 macro构建</a></li>
<li><a href="#org1a5c7e2">6.2. 2. 如何动态的进行一个  信息收集功能呢？ （这里面必然涉及到 一个动态分发的功能的实现） 举例说明：</a></li>
<li><a href="#org8099739">6.3. 3. 为什么没有使用 Deref trait？ 因为Deref 中的target 只能有一个， 不能在一个 包含多个field的 struct中，同时 实现 Deref&lt;One&gt; , Deref&lt;Two&gt;, 即如下：</a></li>
</ul>
</li>
<li><a href="#org7396a84">7. Async</a>
<ul>
<li><a href="#org38633ca">7.1. 需要查看的相关 文章/github：</a></li>
<li><a href="#org75f0704">7.2. Runtime:</a></li>
<li><a href="#orgd055b48">7.3. Concurreny &amp; async</a></li>
<li><a href="#org23fa89a">7.4. Waker:</a></li>
<li><a href="#orge2f42b7">7.5. Generators &amp; async/await</a></li>
<li><a href="#org03eba78">7.6. Pin:</a></li>
<li><a href="#org1f450b5">7.7. Park thread:</a></li>
<li><a href="#orgaaf70ca">7.8. book:</a></li>
</ul>
</li>
<li><a href="#orgf3ff5ef">8. Async impl:</a>
<ul>
<li><a href="#org461a5f5">8.1. 200 line  rust async: 讲解： 代码在： rust_test/async_test/src/main.rs:193</a></li>
<li><a href="#org7f69ee6">8.2. Waker &amp; Context 结构: Waker 最为重要， Waker 在简单的设计中 的操作 即是： 唤醒  thread</a></li>
<li><a href="#orgce740b9">8.3. Future trait:  https://aturon.github.io/blog/2016/08/11/futures/</a></li>
<li><a href="#orge6ecd08">8.4. Reactor: async 的核心， 类似于 epoll： 是链接 fd 与 Task的重要纽带，</a></li>
<li><a href="#org52d7d39">8.5. Executor: 主要包含 Task Struct &amp; TaskState， Queue ， 如何 Handle Panic， &amp; spawn Task</a></li>
<li><a href="#org49629a3">8.6. ？ Arc：</a></li>
<li><a href="#org0fd3ef5">8.7. rust 是如何将 async block 转换为 Task: Future 的poll调用的</a></li>
<li><a href="#org1109378">8.8. 几个重要的 crate: crossbeam, async-std, tokio, 之间的关系，  async-task</a></li>
</ul>
</li>
<li><a href="#org5852902">9. tokio: 全解析：</a>
<ul>
<li><a href="#orgc6d2191">9.1. Tokio useage:</a>
<ul>
<li><a href="#org28cdf32">9.1.1. #[tokio:main]: 将 main函数 转换为  async 然后 自动 构建 let r = runtime::Builder::new(); r.block_on(整体的 func)</a></li>
<li><a href="#org84970b0">9.1.2. runtime.block_on(async future) 直接收 async  func， 并 调用  exec.block_on(future) 以执行 future</a></li>
<li><a href="#orga9a1ffa">9.1.3. .await 只能在 async function中 调用, 即: 1) await 只为 async fun 准备, 2) await 将 future  转换为  Generator 的状态机 3) await 顺序执行, 执行一次, loop 为 server 循环处理 client的 关键逻辑</a></li>
<li><a href="#org75a41d9">9.1.4. block_on(future) 为 阻塞调用, 一直 poll 直到 future完成</a></li>
<li><a href="#org638ecd1">9.1.5. spawn 则直接spawn task,交由 runtime去执行</a></li>
<li><a href="#org49604ea">9.1.6. ? tokio 如何实现的 sleep ? 为什么 Sleep 并没有实现 Future?</a></li>
</ul>
</li>
<li><a href="#orgc203eef">9.2. 在异步中使用  Mutex 并非一个好的主意, 无论是 tokio::sync::Mutex, or std Mutex  都是: 所以最好的方式,依然是 spawn task for all task use, and pass msg for connection</a></li>
<li><a href="#org9076e3c">9.3. 在使用 HashMap&lt;room, TcpStream&gt; 实现的过程中, 存在了如下问题:</a>
<ul>
<li><a href="#org33f5399">9.3.1. 1. std::net::TcpStream, 因为需要保持 socket 的多处ref  &amp; 可写, 导致 需要使用 RefCell, 而 RefCell 是 !Sync 导致, Mutex&lt;RefCell&lt;TcpStream&gt;&gt; 不能够 Send + Sync, 因为 Mutex 的签名 为: impl&lt;T: ?Sized + Send&gt; Send for Mutex&lt;T&gt;, impl&lt;T: ?Sized + Send&gt; Sync for Mutex&lt;T&gt;</a></li>
<li><a href="#org031b2ec">9.3.2. 2. tokio::net::TcpStream 因为 是 Sync &amp; Send, 所以实现了 如下的代码包装: 其中存在的问题为, 经常出现“死锁”情况. 并且 无法避免: 因为 一个read 完成之后,会进入另一个 循环,进行read, 并且 总是在read中, read 会把持 lock, 导致, public_msg 无法进行完全.</a></li>
<li><a href="#org200ca45">9.3.3. 3. 所以, 使用 Mutex 对 Fd 进行加锁的行为, 不可行.(因为无法避免 fd 在等待 read)</a></li>
</ul>
</li>
<li><a href="#orgb1c644e">9.4. mio:</a>
<ul>
<li><a href="#orgdc83150">9.4.1. mio::Poll : 屏蔽 各个平台实现的 EventLoop : (linux epoll)</a></li>
<li><a href="#org994d888">9.4.2. 大概的使用方法为:</a></li>
<li><a href="#org3fb2d64">9.4.3. 经过层层调用, 最终 调用为 Selector.register()</a></li>
<li><a href="#org8c770ef">9.4.4. Poll.poll(&amp;mut events) 中的代码比较复杂:  需要重新看</a></li>
<li><a href="#org9558c7a">9.4.5. Poll.register 方法比较 有意思:  这其中隐含着 rust的代码设计模式, 值得思考, 如何范化 参数限制</a></li>
<li><a href="#orge70b543">9.4.6. </a></li>
</ul>
</li>
<li><a href="#orgddde8a0">9.5. tokio: source code</a>
<ul>
<li><a href="#org37166a7">9.5.1. Events: A collection of readiness events</a></li>
<li><a href="#org875a2fd">9.5.2. Runtime:</a></li>
<li><a href="#org52f0a88">9.5.3. source code</a></li>
<li><a href="#orgbcc2d09">9.5.4. CpuPool 的使用方法为：</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org291be13">10. Mutex &amp; Condvar</a></li>
<li><a href="#orgbf9be3c">11. r2d2: 链接池管理工具</a>
<ul>
<li>
<ul>
<li><a href="#orgbd1293c">11.0.1. 1. Pool: pub struct Pool&lt;M: ManageConnection&gt;(Arc&lt;SharedPool&lt;M&gt;&gt;);</a></li>
<li><a href="#org8cf0c5b">11.0.2. Pool 的适用方法 pool.get() -&gt; Result&lt;PooledConnection&lt;M&gt;, Error&gt;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8c31f50">12. daom_rs 项目中 ENV.spawn_fn 如何与 gate core进行同步的， 应该说是： 没有，因为 futures-cpupool 只会讲 spawn_fun中的block进行封装，然后 执行， 根 core 完全没关系了</a></li>
<li><a href="#org8a7df40">13. tokio:</a>
<ul>
<li><a href="#orgaf536a6">13.1. SourceCode:</a></li>
<li><a href="#orga39814b">13.2. worker::create, workers 的数量 与 Runtime::worker_threads 的数量 相同</a>
<ul>
<li><a href="#org33a802b">13.2.1. 1. queue::local 分配 queue 空间： local</a></li>
<li><a href="#org10f2e4e">13.2.2. 2. 组装 cores: Array&lt;Core&gt;, 其结构中：run_queue 为接受 Task的 队列， 比较重要</a></li>
<li><a href="#org4abb89f">13.2.3. 3. 构建 了 1 个 Handle {}  为 n 个 workers 共享</a></li>
<li><a href="#org92d38bd">13.2.4. 4. 组装为： pub(crate) struct Launch(Vec&lt;Arc&lt;Worker&gt;&gt;);</a></li>
<li><a href="#orgce09943">13.2.5. ? MutlThread::Handle  类型的作用是？</a></li>
<li><a href="#orga721abb">13.2.6. runtime::spawn_blocking(move run(worker))</a></li>
<li><a href="#orgf3942d2">13.2.7. cx.run 最终 在一个while 循环中 进行</a></li>
</ul>
</li>
<li><a href="#org87b8a81">13.3. lanch.launch thread::spawn 的时候，创建 thread 与 worker关联的地方</a>
<ul>
<li><a href="#org29c875d">13.3.1. Launch  结构为：</a></li>
</ul>
</li>
<li><a href="#orgad36766">13.4. 在 runtime::spawn_blocking(move || run(worker)); 中 的几个关键点：</a>
<ul>
<li><a href="#orgc5d444e">13.4.1. block {run(worker)}  =&gt; fut 的转换</a></li>
</ul>
</li>
<li><a href="#orgd926cff">13.5. Blocking_pool:  blocking::create_blocking_pool(self, self.max_blocking_threads + core_threads);</a>
<ul>
<li><a href="#org82091b7">13.5.1. 结构：</a></li>
<li><a href="#orgadd6944">13.5.2. 调用：</a></li>
</ul>
</li>
<li><a href="#org6a2559f">13.6. Worker#run</a></li>
<li><a href="#orgad5b525">13.7. Task: 的 结构类型： 其中woker.next_local_task(&amp;self) -&gt; Option&lt;Notified&gt; ， Notified 为: type Notified = task::Notified&lt;Arc&lt;Handle&gt;&gt;;</a>
<ul>
<li><a href="#orge2e9a8d">13.7.1. pub(crate) struct task::Notified&lt;S: 'static&gt;(Task&lt;S&gt;);</a></li>
<li><a href="#orgad662df">13.7.2. pub(crate) struct Task&lt;S: 'static&gt; {  raw: RawTask,   _p: PhantomData&lt;S&gt; }</a></li>
<li><a href="#orgbf2bcff">13.7.3. 这里面的 Notified 非常奇怪: 其包含了一个 raw: RawTask 以及 _p: PhantomData， 不占用空间， 就是说 Notified基本等同于 RawTask, 至于, 为什么需要带上 &lt;S&gt;， 仅仅是 传递 Sync, 等属性 吗？</a></li>
<li><a href="#orgbcb19cb">13.7.4. 另外 需要注意： Task 与  blocking/pool.rs 中的 pub(crate) struct Task {    task: task::UnownedTask&lt;BlockingSchedule&gt;,    mandatory: Mandatory,}  结构不同，</a></li>
<li><a href="#orgf56cfee">13.7.5. 说明 blocking_spawn 与 worker.spawn 产生的Task 不同</a></li>
</ul>
</li>
<li><a href="#org86c4f57">13.8. derive#Handle: 主要为 Epoll， 或者其他  IO事件 注册器</a>
<ul>
<li><a href="#orgae2c33e">13.8.1. source code:</a></li>
</ul>
</li>
<li><a href="#orgf0738af">13.9. Lanch workers: pub(crate) struct Launch(Vec&lt;Arc&lt;Worker&gt;&gt;);</a></li>
<li><a href="#orgc256470">13.10. ?scheduler？  区分与 runtime/handle.rs 这里面就是 Runtime的一个包装，</a></li>
<li><a href="#org7aa8d8c">13.11. Context Switch： rust async runtime like tokio 并不需要 Context Switch https://users.rust-lang.org/t/where-the-tokio-task-context-switch-code/94984/11</a>
<ul>
<li><a href="#org84c7e67">13.11.1. Rust 将 .await, async  转换为 状态机， 即便是 多层的嵌套 .await 调用， 依然 可以转换为 状态机 无非是 状态多一点</a></li>
<li><a href="#orgbb8da70">13.11.2. 状态机的转换中， 跨越 .await 的变量使用 保存在 状态机中, 对于 如下 foo 内调用 bar， 将转换为 FooState (其内嵌 BarState）</a></li>
<li><a href="#org6cee76c">13.11.3. 所以 一个 Future 的最终结果为 一个巨大的 Enum 包含各种状态, fn  的内嵌调用将会被 压平 为一个函数，（此处错误）  函数不用压平， 还是 各种源代码， pc保持 代码位置。</a></li>
<li><a href="#orgf35af49">13.11.4. 一个 函数 是如何处理 heap以及 stack变量的。</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8e4e1c7">14. codec:</a>
<ul>
<li><a href="#org7bb3b59">14.1. Frame <i>/</i> 主要作用为 实现 Stream &amp; Sink Trait</a>
<ul>
<li><a href="#org6914d57">14.1.1. Stream / Sink: Stream 用于 read， Sink用于 write Sink 中异步发送， 其中包含data的 cache</a></li>
<li><a href="#orgea5445c">14.1.2. FramedImpl 为 主要实现</a></li>
</ul>
</li>
<li><a href="#org911356d">14.2. impl Stream for Frame&lt;T, U&gt;  最终转移到 FramedImpl 中</a></li>
<li><a href="#org29121e6">14.3. </a></li>
</ul>
</li>
<li><a href="#orgba57545">15. await/async 的使用疑问：</a>
<ul>
<li><a href="#org2031434">15.1. async 将 fun 转换为 一个 Future</a></li>
</ul>
</li>
<li><a href="#orgd8d9147">16. wasm: Wasm: 看起来使用比较复杂， 已经很难在手写了</a>
<ul>
<li><a href="#org6b49877">16.1. wasm 为什么会快： 整体上看 wasm 特别像是OS，但是没有提供任何抽象</a></li>
<li><a href="#org267f3dd">16.2. wasm 在broswer  快速使用的原因：</a></li>
<li><a href="#orgfddc801">16.3. 周边工具:</a></li>
<li><a href="#org20d8c07">16.4. 格式： 参考  text format mdn</a></li>
<li><a href="#orgad9b1dc">16.5. key Concepts:</a></li>
<li><a href="#orgade61d7">16.6. rust &lt;-&gt;  wasm: mdn, rustwasm  wasm-pack: 是rust 与js 沟通的重要桥梁， 应该试试更高级的沟通，比如 Js中的类型， Rust中的类型 互相调用</a></li>
<li><a href="#org3a18b7a">16.7. wasmtime:  使用rust编写的 wasm 运行时， 即： 符合wasm标准的 rust实现:</a></li>
<li><a href="#org308adcb">16.8. lldb 使用：</a></li>
<li><a href="#org31fd5c5">16.9. lldb 使用方法：  注意 xxx.file 为  source code file</a></li>
<li><a href="#org46f5a2c">16.10. rust-lldb:</a></li>
</ul>
</li>
<li><a href="#orgfa77240">17. ----------&#x2013;&#x2014; ^^^^^ the trait `Speak` is not implemented for `&amp;dyn Speak`</a></li>
<li><a href="#org61856f6">18. rust 资源:</a></li>
<li><a href="#org06b30ac">19. ? 待探索问题：</a>
<ul>
<li><a href="#org02ea20d">19.1. 标准库的 thread 使用</a></li>
<li><a href="#org8e529d7">19.2. mspc 使用 +  内部实现原理 （channel）</a></li>
<li><a href="#org913f5c1">19.3. <span class="todo HOLD">HOLD</span> tokio example</a></li>
<li><a href="#org18f41ea">19.4. tokio inner</a></li>
<li><a href="#org5319bf5">19.5. error handle 方式</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org726553a" class="outline-2">
<h2 id="org726553a"><span class="section-number-2">1.</span> Rust</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgfd6ad98" class="outline-3">
<h3 id="orgfd6ad98"><span class="section-number-3">1.1.</span> Rust基础 知识：</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org3224d36" class="outline-4">
<h4 id="org3224d36"><span class="section-number-4">1.1.1.</span> std::fmt:</h4>
<div class="outline-text-4" id="text-1-1-1">
</div>
<ol class="org-ol">
<li><a id="org66f01ca"></a>format! 的使用 方法：  positional params：， named params： ， formating params：<br /></li>
<li><a id="org1589986"></a>示例<br />
<div class="outline-text-7" id="text-1-1-1-0-0-2">
<pre class="example">
format!("Hello, {}!", "world");   // =&gt; "Hello, world!"
format!("{1} {} {0} {}", 1, 2); // =&gt; "2 1 1 2"
format!("{argument}", argument = "test");
println!("Hello {:1$}!", "x", 5);
</pre>
</div>
</li>
<li><a id="org470a7c9"></a>formating trait: 实践显式 对于外部的Type  {}确实需要impl Display， 而{:?} 需要 impl Debug<br />
<ol class="org-ol">
<li><a id="org1f5713e"></a>{} =&gt; Display<br /></li>
<li><a id="org19e035d"></a>{:?} =&gt; Debug<br /></li>
<li><a id="orgf373d34"></a>{:o} =&gt; Octal<br /></li>
<li><a id="org392d370"></a>{:p} =&gt; Pointer<br /></li>
</ol>
</li>
<li><a id="org5a74010"></a>fmt::Display vs fmt::Debug<br />
<ol class="org-ol">
<li><a id="orga335895"></a>Display: 断言 实现者 总是返回 UTF-8 的字符串， 并非所有的 都实现了 Display<br /></li>
<li><a id="org43b31d8"></a>Debug：  应该为所有pub type 实现， 输出为 内部状态， 该Trait 的目的是为了方便Rust Debug， 可以 使用#[derive(Debug)] 来使用默认的内部实现<br /></li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-orga44aa37" class="outline-4">
<h4 id="orga44aa37"><span class="section-number-4">1.1.2.</span> array &amp; Slice</h4>
<div class="outline-text-4" id="text-1-1-2">
</div>
<ol class="org-ol">
<li><a id="orga48d64b"></a>array的类型为： [T: len], let mut array: [i32; 3] = [0; 3];<br /></li>
<li><a id="org356f7a3"></a>Slice: [T]<br /></li>
</ol>
</div>
<div id="outline-container-org4853a33" class="outline-4">
<h4 id="org4853a33"><span class="section-number-4">1.1.3.</span> structures： 有三种类型： 1） Tuple struct, 2) classic struct 3) Unit structs</h4>
<div class="outline-text-4" id="text-1-1-3">
</div>
<ol class="org-ol">
<li><a id="org57926cc"></a>struct Pair(i32, f32);<br /></li>
<li><a id="orgd0d0426"></a>struct Person {  name: String,    age: u8}<br /></li>
<li><a id="orgd0431d3"></a>struct Unit; unit Struct 没有任何的 field<br /></li>
</ol>
</div>
<div id="outline-container-org77b79d0" class="outline-4">
<h4 id="org77b79d0"><span class="section-number-4">1.1.4.</span> Enums： 包含多个 变体 的 组合项， 任何一个变体 都是一个 正确的 enum 类型</h4>
<div class="outline-text-4" id="text-1-1-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">WebEvent</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">An `enum` may either be `unit-like`,</span>
    <span style="color: #98f5ff;">PageLoad</span>,
    <span style="color: #98f5ff;">PageUnload</span>,
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">like tuple structs,</span>
    <span style="color: #98f5ff;">KeyPress</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">char</span><span style="color: #93a8c6;">)</span>,
    <span style="color: #98f5ff;">Paste</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>,
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">or c-like structures.</span>
    <span style="color: #98f5ff;">Click</span> <span style="color: #93a8c6;">{</span> <span style="color: #4eee94;">x</span>: <span style="color: #98f5ff;">i64</span>, <span style="color: #4eee94;">y</span>: <span style="color: #98f5ff;">i64</span> <span style="color: #93a8c6;">}</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">A function which takes a `WebEvent` enum as an argument and</span>
<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">returns nothing.</span>
<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">inspect</span><span style="color: #8c8c8c;">(</span><span style="color: #4eee94;">event</span>: <span style="color: #98f5ff;">WebEvent</span><span style="color: #8c8c8c;">)</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">match</span> event <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">WebEvent</span>::<span style="color: #98f5ff;">PageLoad</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"page loaded"</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #98f5ff;">WebEvent</span>::<span style="color: #98f5ff;">PageUnload</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"page unloaded"</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Destructure `c` from inside the `enum`.</span>
        <span style="color: #98f5ff;">WebEvent</span>::<span style="color: #98f5ff;">KeyPress</span><span style="color: #b0b1a3;">(</span>c<span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"pressed '</span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">'."</span>, c<span style="color: #b0b1a3;">)</span>,
        <span style="color: #98f5ff;">WebEvent</span>::<span style="color: #98f5ff;">Paste</span><span style="color: #b0b1a3;">(</span>s<span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"pasted \"{}\"."</span>, s<span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Destructure `Click` into `x` and `y`.</span>
        <span style="color: #98f5ff;">WebEvent</span>::<span style="color: #98f5ff;">Click</span> <span style="color: #b0b1a3;">{</span> x, y <span style="color: #b0b1a3;">}</span> =&gt; <span style="color: #b0b1a3;">{</span>
            <span style="color: #f08080;">println!</span><span style="color: #97b098;">(</span><span style="color: #deb887;">"clicked at x=</span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">, y=</span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">."</span>, x, y<span style="color: #97b098;">)</span>;
        <span style="color: #b0b1a3;">}</span>,
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge2d81f3" class="outline-4">
<h4 id="orge2d81f3"><span class="section-number-4">1.1.5.</span> Type Alias：type 关键字能够 使用 type Name = ExistingType； 语法来 使用 Name 代替 ExistingType 使用。 Self 是一种Type Alias</h4>
</div>
<div id="outline-container-orgd90f443" class="outline-4">
<h4 id="orgd90f443"><span class="section-number-4">1.1.6.</span> const， static</h4>
</div>
<div id="outline-container-org3e1a89d" class="outline-4">
<h4 id="org3e1a89d"><span class="section-number-4">1.1.7.</span> Variable Bindings： 1）变量默认 是不可修改的， 使用mut 改变 2） 可以在内部的scope中 其同样的名字来shadow 外部的变量 3）可以使用 先声明 后设定数值的形式 使用变量，但是rust 会检查 使用 未定义变量的错误， 来预防因此产生的问题</h4>
</div>
<div id="outline-container-org5a15a6c" class="outline-4">
<h4 id="org5a15a6c"><span class="section-number-4">1.1.8.</span> Types: 1）转换 as关键字  2） type alias： type NanoSecond = u64; 3） 数值的类型，可以添加到  后面最为后缀使用， 例如： 42i32</h4>
</div>
<div id="outline-container-orgc506251" class="outline-4">
<h4 id="orgc506251"><span class="section-number-4">1.1.9.</span> Conversion： rust 的struct 以及 enum 等自定义类型的 type转换</h4>
<div class="outline-text-4" id="text-1-1-9">
</div>
<ol class="org-ol">
<li><a id="org56727ae"></a>From &amp; Into:<br />
<ol class="org-ol">
<li><a id="org68c02dd"></a>From 为一个类型定义， 如何create self 从 另一个type中转变<br /></li>
<li><a id="orgcd2bdd6"></a>Into 则是From 的 调用者， From&lt;T&gt; for U 自动实现了 Into&lt;U&gt; for T， blank implement<br /></li>
</ol>
</li>
<li><a id="org7a3e969"></a>TryFrom &amp; TryInto: 类似于 From &amp; Into 不同的是， 转换可能失败，返回Result<br /></li>
<li><a id="orge0d5867"></a>ToString &amp; FromStr:<br />
<ol class="org-ol">
<li><a id="org52805d2"></a>ToString： 单独为 String 类型 定义了一个 ToString Trait，但是并不需要直接实现 ToString，而是实现了 fmt::Display 之后 就自动了提供了 ToString 中的to_string 方法<br />
<div class="outline-text-8" id="text-1-1-9-0-0-3-1">
<div class="org-src-container">
<pre class="src src-rust">        <span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">stable</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"rust1"</span><span style="color: #ffd700;">, since = </span><span style="color: #deb887;">"1.0.0"</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span> + <span style="color: #f08080; font-weight: bold;">?</span><span style="color: #98f5ff;">Sized</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">ToString</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">T</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">A common guideline is to not inline generic functions. However,</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">removing `#[inline]` from this method causes non-negligible regressions.</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">See <a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">&lt;https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt</a></span><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">
    </a><span style="color: #7f7f7f;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">// </a></span><span style="color: #7f7f7f;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">to try to remove it.</a></span><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">
    </a><span style="color: #ffd700;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">#</a></span><span style="color: #93a8c6;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">[</a></span><span style="color: #ffd700;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">inline</a></span><span style="color: #93a8c6;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">]</a></span><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">
    </a><span style="color: #00bfff;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">default</a></span><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -"> </a><span style="color: #00bfff;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">fn</a></span><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -"> </a><span style="color: #daa520;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">to_string</a></span><span style="color: #93a8c6;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">(</a></span><span style="color: #cccccc; background-color: #181a26;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">&amp;</a></span><span style="color: #00bfff;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">self</a></span><span style="color: #93a8c6;"><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -">)</a></span><a href="https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -"> -&gt;</a> <span style="color: #98f5ff;">String</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Write</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">buf</span> = <span style="color: #98f5ff;">String</span>::new<span style="color: #b0b1a3;">()</span>;
        buf.write_fmt<span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">format_args!</span><span style="color: #97b098;">(</span><span style="color: #deb887;">"{}"</span>, <span style="color: #00bfff;">self</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
            .expect<span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"a Display implementation returned an error unexpectedly"</span><span style="color: #b0b1a3;">)</span>;
        buf
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgf137af7"></a>FromStr &amp; parse: 将String 转换为其他类型， 只需要实现了 FromStr for struct, 而String 中的parse 方法 只是 对FromStr::from_str(&amp;string) 的调用<br /></li>
<li><a id="orgba09d4f"></a><br /></li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgbff0c1d" class="outline-4">
<h4 id="orgbff0c1d"><span class="section-number-4">1.1.10.</span> Expression： 程序是由一系列表达式组成的， 1） 赋值表达式 用; 结尾， 2） {} 也是表达式， 如果最后一个表达式 以; 结尾，则返回  (), 否则为最后一个表达式的 结果</h4>
</div>
<div id="outline-container-org4f54f3a" class="outline-4">
<h4 id="org4f54f3a"><span class="section-number-4">1.1.11.</span> Flow of control：</h4>
<div class="outline-text-4" id="text-1-1-11">
</div>
<ol class="org-ol">
<li><a id="org4978b91"></a>if-else  也是表达式， 所有的分支必须返回同样的类型<br /></li>
<li><a id="org6c5f846"></a>loop： loop break continue。 break 用来随时中断退出loop， continue 则用于 用于 跳过剩下的 代码，重新开始一个 循环<br />
<ol class="org-ol">
<li><a id="orgffa781c"></a>loop 是可以嵌套的，并起名字, break ，以及continue 可以使用名字来进行 break， 或者continue<br />
<div class="outline-text-8" id="text-1-1-11-0-0-2-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #ffd700;">#!</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">allow</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">unreachable_code</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    '<span style="color: #4eee94;">outer</span>: <span style="color: #00bfff;">loop</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Entered the outer loop"</span><span style="color: #b0b1a3;">)</span>;

        '<span style="color: #4eee94;">inner</span>: <span style="color: #00bfff;">loop</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #f08080;">println!</span><span style="color: #97b098;">(</span><span style="color: #deb887;">"Entered the inner loop"</span><span style="color: #97b098;">)</span>;

            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This would break only the inner loop</span>
            <span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">break;</span>

            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This breaks the outer loop</span>
            <span style="color: #00bfff;">break</span> '<span style="color: #4eee94;">outer</span>;
        <span style="color: #b0b1a3;">}</span>

        <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"This point will never be reached"</span><span style="color: #b0b1a3;">)</span>;
    <span style="color: #93a8c6;">}</span>

    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"Exited the outer loop"</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">counter</span> = 0;

    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">result</span> = <span style="color: #00bfff;">loop</span> <span style="color: #93a8c6;">{</span>
        counter += 1;

        <span style="color: #00bfff;">if</span> counter == 10 <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">break</span> counter * 2;
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>;

    <span style="color: #ffd700;">assert_eq!</span><span style="color: #93a8c6;">(</span>result, 20<span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</li>
<li><a id="org6c63888"></a>loop 也是可以 返回数值的， 放到break 后面<br /></li>
</ol>
</li>
<li><a id="org9880daa"></a>while<br /></li>
<li><a id="org014b1f4"></a>for: for in 结构用来 遍历 所有实现了 IntoIterator 的对象， 比如简单 range形式： a..b, a..=b<br />
<ol class="org-ol">
<li><a id="orga2aae9e"></a>for loop 会自动调用 into_iter 在参数上，我们可以主动产生下面几类实现IntoIterator 的 Iterator：<br />
<ol class="org-ol">
<li><a id="org2f5654d"></a>iter: 产生 引用的 Iterator, 对 ownership不产生影响<br /></li>
<li><a id="orga98038c"></a>into_iter: 将ownership 交给 Iterator， 调用过之后的对象，将不再可用。产生<br /></li>
<li><a id="org12fe6f5"></a>iter_mut: 产生mut 引用的Iterator， 可以进行修改<br /></li>
</ol>
</li>
</ol>
</li>
<li><a id="org6e1ff94"></a>match:<br />
<ol class="org-ol">
<li><a id="orgd1221e5"></a>c like 方式： 即 match  number<br /></li>
<li><a id="org936d3a9"></a>解构对象：<br />
<ol class="org-ol">
<li><a id="org4c8ec6f"></a>Tuples：  使用.. 来 忽略剩余所有的 tuple<br /></li>
<li><a id="orge4468fa"></a>Enums:<br /></li>
<li><a id="org0c2a0d7"></a>Pointers: *  &amp; ref ref mut 见下面示例<br /></li>
<li><a id="org97d2bf7"></a>Structs: struct 同样可以被match<br /></li>
</ol>
</li>
<li><a id="org028a7d2"></a>Guards: 在match 对象的arm中，同样可以 使用 if 条件判断 即是 guards<br /></li>
<li><a id="org8ed8b56"></a>Bindings： match 在 arm中，除了解构对象的同时 可以将变量整体绑定 到一个变量上<br />
<div class="outline-text-8" id="text-1-1-11-0-0-5-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">triple</span> = <span style="color: #93a8c6;">(</span>0, -2, 3<span style="color: #93a8c6;">)</span>;
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO ^ Try different values for `triple`</span>

    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"Tell me about </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, triple<span style="color: #93a8c6;">)</span>;
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Match can be used to destructure a tuple</span>
    <span style="color: #00bfff;">match</span> triple <span style="color: #93a8c6;">{</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Destructure the second and third elements</span>
        <span style="color: #b0b1a3;">(</span>0, y, z<span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"First is `0`, `y` is </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">, and `z` is </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, y, z<span style="color: #b0b1a3;">)</span>,
        <span style="color: #b0b1a3;">(</span>1, ..<span style="color: #b0b1a3;">)</span>  =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"First is `1` and the rest doesn't matter"</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">`..` can be the used ignore the rest of the tuple</span>
        _      =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"It doesn't matter what they are"</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">`_` means don't bind the value to a variable</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">point s </span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Assign a reference of type `i32`. The `&amp;` signifies there</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">is a reference being assigned.</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">reference</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span>4;

    <span style="color: #00bfff;">match</span> reference <span style="color: #93a8c6;">{</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">If `reference` is pattern matched against `&amp;val`, it results</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">in a comparison like:</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">`&amp;i32`</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">`&amp;val`</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">^ We see that if the matching `&amp;`s are dropped, then the `i32`</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">should be assigned to `val`.</span>
        <span style="color: #cccccc; background-color: #181a26;">&amp;</span>val =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Got a value via destructuring: </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, val<span style="color: #b0b1a3;">)</span>,
    <span style="color: #93a8c6;">}</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">To avoid the `&amp;`, you dereference before matching.</span>
    <span style="color: #00bfff;">match</span> *reference <span style="color: #93a8c6;">{</span>
        val =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Got a value via dereferencing: </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, val<span style="color: #b0b1a3;">)</span>,
    <span style="color: #93a8c6;">}</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">What if you don't start with a reference? `reference` was a `&amp;`</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">because the right side was already a reference. This is not</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">a reference because the right side is not one.</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_not_a_reference</span> = 3;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Rust provides `ref` for exactly this purpose. It modifies the</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">assignment so that a reference is created for the element; this</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">reference is assigned.</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">_is_a_reference</span> = 3;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Accordingly, by defining 2 values without references, references</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">can be retrieved via `ref` and `ref mut`.</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">value</span> = 5;
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">mut_value</span> = 6;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Use `ref` keyword to create a reference.</span>
    <span style="color: #00bfff;">match</span> value <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">r</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Got a reference to a value: </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, r<span style="color: #b0b1a3;">)</span>,
    <span style="color: #93a8c6;">}</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Use `ref mut` similarly.</span>
    <span style="color: #00bfff;">match</span> mut_value <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">ref</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">m</span> =&gt; <span style="color: #b0b1a3;">{</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Got a reference. Gotta dereference it before we can</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">add anything to it.</span>
            *m += 10;
            <span style="color: #f08080;">println!</span><span style="color: #97b098;">(</span><span style="color: #deb887;">"We added 10. `mut_value`: </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, m<span style="color: #97b098;">)</span>;
        <span style="color: #b0b1a3;">}</span>,
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Foo</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #4eee94;">x</span>: <span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">u32</span>, <span style="color: #98f5ff;">u32</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #4eee94;">y</span>: <span style="color: #98f5ff;">u32</span>,
    <span style="color: #93a8c6;">}</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Try changing the values in the struct to see what happens</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">foo</span> = <span style="color: #98f5ff;">Foo</span> <span style="color: #93a8c6;">{</span> <span style="color: #4eee94;">x</span>: <span style="color: #b0b1a3;">(</span>1, 2<span style="color: #b0b1a3;">)</span>, <span style="color: #4eee94;">y</span>: 3 <span style="color: #93a8c6;">}</span>;

    <span style="color: #00bfff;">match</span> foo <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Foo</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">x</span>: <span style="color: #97b098;">(</span>1, b<span style="color: #97b098;">)</span>, y <span style="color: #b0b1a3;">}</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"First of x is 1, b = </span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">,  y = </span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;"> "</span>, b, y<span style="color: #b0b1a3;">)</span>,

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">you can destructure structs and rename the variables,</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">the order is not important</span>
        <span style="color: #98f5ff;">Foo</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">y</span>: 2, <span style="color: #4eee94;">x</span>: i <span style="color: #b0b1a3;">}</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"y is 2, i = </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, i<span style="color: #b0b1a3;">)</span>,

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">and you can also ignore some variables:</span>
        <span style="color: #98f5ff;">Foo</span> <span style="color: #b0b1a3;">{</span> y, .. <span style="color: #b0b1a3;">}</span> =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"y = </span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">, we don't care about x"</span>, y<span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">this will give an error: pattern does not mention field `x`</span>
        <span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">Foo { y } =&gt; println!("y = {}", y),</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>


<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">pair</span> = <span style="color: #93a8c6;">(</span>2, -2<span style="color: #93a8c6;">)</span>;
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO ^ Try different values for `pair`</span>

    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"Tell me about </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, pair<span style="color: #93a8c6;">)</span>;
    <span style="color: #00bfff;">match</span> pair <span style="color: #93a8c6;">{</span>
        <span style="color: #b0b1a3;">(</span>x, y<span style="color: #b0b1a3;">)</span> <span style="color: #00bfff;">if</span> x == y =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"These are twins"</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">The ^ `if condition` part is a guard</span>
        <span style="color: #b0b1a3;">(</span>x, y<span style="color: #b0b1a3;">)</span> <span style="color: #00bfff;">if</span> x + y == 0 =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Antimatter, kaboom!"</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #b0b1a3;">(</span>x, _<span style="color: #b0b1a3;">)</span> <span style="color: #00bfff;">if</span> x % 2 == 1 =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"The first one is odd"</span><span style="color: #b0b1a3;">)</span>,
        _ =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"No correlation..."</span><span style="color: #b0b1a3;">)</span>,
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>


<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">A function `age` which returns a `u32`.</span>
<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">age</span><span style="color: #8c8c8c;">()</span> -&gt; <span style="color: #98f5ff;">u32</span> <span style="color: #8c8c8c;">{</span>
    15
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"Tell me what type of person you are"</span><span style="color: #93a8c6;">)</span>;

    <span style="color: #00bfff;">match</span> age<span style="color: #93a8c6;">()</span> <span style="color: #93a8c6;">{</span>
        0             =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"I haven't celebrated my first birthday yet"</span><span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Could `match` 1 ..= 12 directly but then what age</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">would the child be? Instead, bind to `n` for the</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">sequence of 1 ..= 12. Now the age can be reported.</span>
        n @ 1  ..= 12 =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"I'm a child of age </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, n<span style="color: #b0b1a3;">)</span>,
        n @ 13 ..= 19 =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"I'm a teen of age </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, n<span style="color: #b0b1a3;">)</span>,
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Nothing bound. Return the result.</span>
        n             =&gt; <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"I'm an old person of age </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, n<span style="color: #b0b1a3;">)</span>,
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org72eadfb"></a>if let: 在判断的同时 进行match<br /></li>
<li><a id="org835c60b"></a>while let<br /></li>
</ol>
</div>
<div id="outline-container-orgf6ad3d5" class="outline-4">
<h4 id="orgf6ad3d5"><span class="section-number-4">1.1.12.</span> Functions:</h4>
<div class="outline-text-4" id="text-1-1-12">
</div>
<ol class="org-ol">
<li><a id="orgd6e69b6"></a>methods: 依附于 对象的函数， 在methods 的block中，能够 通过self使用 对象的 数据<br /></li>
<li><a id="orgb740a5a"></a>closures:  |val| {val + x}<br />
<ol class="org-ol">
<li><a id="orgc0d8d74"></a>Capturing： 捕获， 其可以 捕获环境中的 变量， 可以是： &amp;T, &amp;mut T , T（by value）<br /></li>
<li><a id="org18d618c"></a>作为参数： 分为三类： Fn, FnMut, FnOnce， 对应ownership  的 &amp;T, &amp;mut T, T. Fn 可以无限次执行， FnMut 则要求 capture 变量的 mut 引用， FnOnce 则 只能执行一次<br />
<ol class="org-ol">
<li><a id="orgd6de08f"></a>疑问：<br />
<ol class="org-ol">
<li><a id="orgca62ee7"></a>1. 如何 区分  Fn(i64, i64) -&gt; i64 与Fn(&amp;String) -&gt; i64<br /></li>
<li><a id="org126e6c3"></a>2. FnOnce 是如何确定的， 有些函数，即便将变量 move 到了block中， 然而依然可以调用多次， 这些优势如何判断的？ 根据内部函数调用的 Fn 属性吗？ 比如mem::drop(p) 则 包含其调用的函数 则为 FnOnce?<br /></li>
<li><a id="org738e186"></a>3. 如何断定 Cloosure 为 Fn or FnMut ?<br />
<div class="outline-text-11" id="text-1-1-12-0-0-2-0-2-1-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Point</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">x</span>: <span style="color: #98f5ff;">f64</span>,
    <span style="color: #4eee94;">y</span>: <span style="color: #98f5ff;">f64</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Implementation block, all `Point` methods go in here</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Point</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This is a static method</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Static methods don't need to be called by an instance</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">These methods are generally used as constructors</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">origin</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">Point</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Point</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">x</span>: 0.0, <span style="color: #4eee94;">y</span>: 0.0 <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Another static method, taking two arguments:</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">x</span>: <span style="color: #98f5ff;">f64</span>, <span style="color: #4eee94;">y</span>: <span style="color: #98f5ff;">f64</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Point</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Point</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">x</span>: x, <span style="color: #4eee94;">y</span>: y <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org9f2032c" class="outline-4">
<h4 id="org9f2032c"><span class="section-number-4">1.1.13.</span> Modules:</h4>
<div class="outline-text-4" id="text-1-1-13">
</div>
<ol class="org-ol">
<li><a id="org94272ac"></a>mod visibility: mod 的可见性， mod 默认只能在本mod 可见， 需要使用 pub 来对外可见， 定义其中的fn， struct 使用同样的规则， 因为mod 可以nest， 所以 存在pub(self) (等同于private) pub(super) 即让super mod 可见,  而pub(crate)则让crate 可见<br /></li>
<li><a id="org342b393"></a>struct visibility: struct 中包含fn 以及 field，默认都为 对 所在 定义的mod可见， pub 则开放为对外部的 mod可见<br /></li>
<li><a id="org52cdc2e"></a>mod vs struct: struct 的控制比较弱， mod的控制则相对复杂， struct 可能并不需要如此复杂的规则吧<br /></li>
<li><a id="orgb30ca3b"></a>关键字 use： 我们可以使用 use mod::struct as another_struct 来 减少路径的拼写， 使用as 更可以 启用别名<br /></li>
<li><a id="orgbb9c6e6"></a>mod 的 使用类似于 Unix下的 目录 安排， super 代表 .. self 则代表 本mod<br /></li>
</ol>
</div>

<div id="outline-container-org4508843" class="outline-4">
<h4 id="org4508843"><span class="section-number-4">1.1.14.</span> Attributes: 可以用来作什么？ 1） 条件编译， 2）设定crate 属性， 3）关闭 warning 4)启用编译器特性(maros etc) 5） link to a foreign library 6) 设定unit test</h4>
<div class="outline-text-4" id="text-1-1-14">
</div>
<ol class="org-ol">
<li><a id="org524b95e"></a>形式： 当应用到 整个crate： #![crate_attribute], 应用到module 或者 item ： #[item_attribute]<br /></li>
<li><a id="org31113f2"></a>还可以接受参数： 1) #[attribute = "value"] 2) #[attribute(key = "value")] 3) #[attribute(value)]<br /></li>
<li><a id="org1b8c3e9"></a>示例：<br />
<ol class="org-ol">
<li><a id="org297f132"></a>#[allow(dead_code)]： 关闭rust 关于没有调用函数的提示<br /></li>
<li><a id="org9066806"></a>#![crate_name = "rary"]<br /></li>
<li><a id="orgf089893"></a>cfg(Configuration): 1） #[cfg(&#x2026;)] 条件编译 2） cfg!(&#x2026;) 在运行阶段的条件判断， 返回bool值<br />
<div class="outline-text-9" id="text-1-1-14-0-0-3-0-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This function only gets compiled if the target OS is linux</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">target_os = </span><span style="color: #deb887;">"linux"</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">are_you_on_linux</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"You are running linux!"</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">And this function only gets compiled if the target OS is *not* linux</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">not</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">target_os = </span><span style="color: #deb887;">"linux"</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">are_you_on_linux</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"You are *not* running linux!"</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    are_you_on_linux<span style="color: #93a8c6;">()</span>;

    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"Are you sure?"</span><span style="color: #93a8c6;">)</span>;
    <span style="color: #00bfff;">if</span> <span style="color: #ffd700;">cfg!</span><span style="color: #93a8c6;">(</span>target_os = <span style="color: #deb887;">"linux"</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Yes. It's definitely linux!"</span><span style="color: #b0b1a3;">)</span>;
    <span style="color: #93a8c6;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Yes. It's definitely *not* linux!"</span><span style="color: #b0b1a3;">)</span>;
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org8c0d511"></a><br /></li>
</ol>
</div>
<div id="outline-container-org0c2ed42" class="outline-4">
<h4 id="org0c2ed42"><span class="section-number-4">1.1.15.</span> Smart Pointer:</h4>
<div class="outline-text-4" id="text-1-1-15">
</div>
<ol class="org-ol">
<li><a id="org6282888"></a>Box: heap store<br /></li>
<li><a id="org3e7f3e1"></a>Rc&lt;T&gt;: Reference Counter<br />
<ol class="org-ol">
<li><a id="orgab0fd0a"></a>Rc::clone(&amp;rc) || rc.clone()<br /></li>
<li><a id="org78d58ef"></a>Rc::strong_count<br /></li>
<li><a id="org00c08da"></a>Rc::weak_count<br />
<div class="outline-text-7" id="text-1-1-15-0-2-3">
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-org4c240ee" class="outline-4">
<h4 id="org4c240ee"><span class="section-number-4">1.1.16.</span> OIBITs:</h4>
</div>
<div id="outline-container-org185fcd5" class="outline-4">
<h4 id="org185fcd5"><span class="section-number-4">1.1.17.</span> stand for “opt-in builtin trait”: 比如 Send， Sync， 该种 Trait 默认 为所有的 struct enum 提供默认实现，  即： 如果 struct A 中的field 都impl Trait 则 struct A 也同样 impl Trait。</h4>
</div>
<div id="outline-container-org17e19e2" class="outline-4">
<h4 id="org17e19e2"><span class="section-number-4">1.1.18.</span> <a href="https://internals.rust-lang.org/t/pre-rfc-renaming-oibits-and-changing-their-declaration-syntax/3086">参考链接</a>, <a href="https://github.com/rust-lang/rfcs/blob/master/text/0019-opt-in-builtin-traits.md">参考链接1</a></h4>
</div>
<div id="outline-container-orgcd1971c" class="outline-4">
<h4 id="orgcd1971c"><span class="section-number-4">1.1.19.</span> impl Trait: 目前 可以在 fn xxx() -&gt; impl Trait</h4>
<div class="outline-text-4" id="text-1-1-19">
<ul class="org-ul">
<li>带来了一系列的问题： 主要为 隐藏Trait 具体实现 + 避免 trait 带来的 dynamic dispatch， original proposal 在这里 <a href="http://aturon.github.io/blog/2015/09/28/impl-trait/?utm_source=pocket_mylist">http://aturon.github.io/blog/2015/09/28/impl-trait/?utm_source=pocket_mylist</a></li>
<li>由此 带出得一些列扩展有： 悬而未决的问题为： params impl Trait 是否 于  return impl Trait 一样， 没有dynamic dispatch 的代价呢？  rfc 比较长， 英文阅读能力有待提高</li>
<li>fn return impl Trait: <a href="https://github.com/rust-lang/rfcs/blob/master/text/1522-conservative-impl-trait.md">https://github.com/rust-lang/rfcs/blob/master/text/1522-conservative-impl-trait.md</a></li>
</ul>
</div>
</div>
<div id="outline-container-org8c2ebe9" class="outline-4">
<h4 id="org8c2ebe9"><span class="section-number-4">1.1.20.</span> Box&lt;Trait&gt; vs Box&lt;T&gt; where T: Trait vs &amp;Trait 的区别：</h4>
<div class="outline-text-4" id="text-1-1-20">
<ul class="org-ul">
<li>Box&lt;Trait&gt;: 并非 Generic Type， 而是 Trait的 fat Pointer， 在 <a href="https://stackoverflow.com/questions/45151770/what-is-the-difference-between-t-trait-boxt-and-trait-boxtrait">stack over flow</a>  有明显的比较， 在 <a href="https://doc.rust-lang.org/1.30.0/book/first-edition/trait-objects.html">the rust book</a> 中 在讲解了 Trait为 dynamic dispatch 的fat pointer &amp; 其中可能包含 destructor 指针</li>
<li>Box&lt;T&gt; where T: Trait 是 Generic Type</li>
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Box&lt;T&gt; where T: Trait</span>
<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Debug</span>;

<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Wrapper</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">contents</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #98f5ff;">Debug</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Wrapper</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">Wrapper</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Wrapper</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">contents</span>: <span style="color: #98f5ff;">None</span> <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">insert</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">val</span>: <span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">w</span> = <span style="color: #98f5ff;">Wrapper</span>::new<span style="color: #93a8c6;">()</span>;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">makes T for w be an integer type, e.g. Box&lt;i64&gt;</span>
    w.insert<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Box</span>::new<span style="color: #b0b1a3;">(</span>5<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">type error, &amp;str is not an integer type</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">w.insert(Box::new("hello"));</span>
<span style="color: #8c8c8c;">}</span>


<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Box&lt;Trait&gt;</span>
<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Debug</span>;

<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Wrapper</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">contents</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Debug</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Wrapper</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">Wrapper</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Wrapper</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">contents</span>: <span style="color: #98f5ff;">None</span> <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">insert</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">val</span>: <span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Debug</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">w</span> = <span style="color: #98f5ff;">Wrapper</span>::new<span style="color: #93a8c6;">()</span>;
    w.insert<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Box</span>::new<span style="color: #b0b1a3;">(</span>5<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>;
    w.insert<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Box</span>::new<span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"hello"</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge6ec2e0" class="outline-4">
<h4 id="orge6ec2e0"><span class="section-number-4">1.1.21.</span> dyn trait:</h4>
<div class="outline-text-4" id="text-1-1-21">
<ul class="org-ul">
<li>（与 return impl Trait 完全不同） 为了区分 Box&lt;Trait&gt;, Box&lt;Struct&gt; 所以将 Box&lt;Trait&gt; -&gt; Box&lt;dyn Trait&gt;, &amp;Trait -&gt; &amp; dyn Trait, &amp;mut Trait -&gt; &amp;mut dyn Trait</li>
<li>dyn Trait 只是为了 解决  Box&lt;Trait&gt; vs Box&lt;Struct&gt; 的区分问题， 即：  Box&lt;Trait&gt; 时候 需要添加 dyn 关键字 =&gt; Box&lt;dyn Trait&gt;</li>
<li>为什么能够是Sized? 参考 <a href="https://quinedot.github.io/rust-learning/dyn-trait.html">https://quinedot.github.io/rust-learning/dyn-trait.html</a>, <a href="https://smallcultfollowing.com/babysteps//blog/2022/03/29/dyn-can-we-make-dyn-sized/#fn:1">https://smallcultfollowing.com/babysteps//blog/2022/03/29/dyn-can-we-make-dyn-sized/#fn:1</a> <a href="https://users.rust-lang.org/t/question-about-dyn-trait-coercions/98256/10">https://users.rust-lang.org/t/question-about-dyn-trait-coercions/98256/10</a></li>
</ul>
</div>
</div>
<div id="outline-container-org19651b9" class="outline-4">
<h4 id="org19651b9"><span class="section-number-4">1.1.22.</span> rust stackoverflow 问题： 使用 lldb target/debug/deps/smoke-910c8a3208aec5c7 ，跟gdb 调试一样，定义定位到 callstack的相关信息</h4>
</div>
</div>

<div id="outline-container-org6efc2cd" class="outline-3">
<h3 id="org6efc2cd"><span class="section-number-3">1.2.</span> rust mut var &amp; mut ref 的含义</h3>
<div class="outline-text-3" id="text-1-2">
<p>
let mut a = xx; 是否 意味着 a 可以被替换为 其他的同类型的 var, 还是仅仅意味着 可以 a.xx 调用xx mut方法？
</p>

<div class="org-center">
<p>
mut x: &amp;mut i32    x = &amp;y    *x = 123
mut x: &amp;i32        x = &amp;y    ---&#x2013;&#x2014;
    x: &amp;mut i32    -&#x2013;&#x2014;    *x = 123
    x: &amp;i32        -&#x2013;&#x2014;    ---&#x2013;&#x2014;
</p>

<p>
int *x;
cont int *x;
int * const x;
const int * const x;
</p>
</div>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">ix</span> = 10;
<span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">iy</span> = 20;
<span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">x</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> ix;
    *x = 100;
    x = <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> iy;
    *x = 200;
<span style="color: #8c8c8c;">}</span>
<span style="color: #f08080;">println!</span><span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"x: </span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">, iy: </span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">"</span>, ix, iy<span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb71b8b9" class="outline-3">
<h3 id="orgb71b8b9"><span class="section-number-3">1.3.</span> const &amp; static : <a href="https://users.rust-lang.org/t/using-const-or-static/78676">参考</a></h3>
</div>
<div id="outline-container-org088697d" class="outline-3">
<h3 id="org088697d"><span class="section-number-3">1.4.</span> Rust 周边工具</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-orgdd42e6a" class="outline-4">
<h4 id="orgdd42e6a"><span class="section-number-4">1.4.1.</span> rustup: rust complier 的管理工具， 可以方便的切换 stable, beta, and nightly</h4>
</div>
<div id="outline-container-orga1095cc" class="outline-4">
<h4 id="orga1095cc"><span class="section-number-4">1.4.2.</span> cargo: 是rust的包管理工具， 用来 下载 rust的依赖， 编译， 以及 分发 到 crates.io</h4>
<div class="outline-text-4" id="text-1-4-2">
</div>
<ol class="org-ol">
<li><a id="org0d01d03"></a>在安装 rust 之后， cargo 也会被自动安装上，<br /></li>
<li><a id="org6d9c5c2"></a>cargo 提供了一些有用的工具有:<br />
<ol class="org-ol">
<li><a id="orga25d5ad"></a>cargo new package # default &#x2013;bin 生成 可执行 program, 可以pass &#x2013;lib 来产生库程序<br /></li>
<li><a id="org137808b"></a>cargo build<br /></li>
<li><a id="orgef17aaa"></a>cargo 存在的意义：<br />
<ol class="org-ol">
<li><a id="org9f6167f"></a>剥离 rustc 的复杂度， 类似 make 与 c 一样<br /></li>
<li><a id="orgf9afbe0"></a>cargo 最终调用rustc 来编译 项目， 当然可以 直接使用 rustc 来编译项目，但是 需要出入 复杂的参数 来 添加项目 依赖关系， 编译文件， 依赖关系 等，并精心安排顺序 来进行调用。<br /></li>
<li><a id="orga8764dd"></a>所以使用cargo： make工具， cargo 的功能<br />
<ol class="org-ol">
<li><a id="org936e830"></a>1. 使用两个文件 来 包含 package的信息<br /></li>
<li><a id="orgf72d348"></a>2. 拉取，构建  package 依赖<br /></li>
<li><a id="org6650dd4"></a>3. 使用正确的参数 来调用rustc 或者其他 tool， 来构建项目<br /></li>
<li><a id="org282c3d8"></a>4. 引用约定，方便package 构建<br /></li>
</ol>
</li>
<li><a id="orga81f6a7"></a>cargo 使用笔记：<br />
<ol class="org-ol">
<li><a id="org43828ae"></a>cargo new hello_world &#x2013;bin<br />
<ol class="org-ol">
<li><a id="orgf05ab13"></a><br />
<div class="outline-text-10" id="text-1-4-2-0-2-3-4-1-1">
<pre class="example">
$ cd hello_world
$ tree .
.
├── Cargo.toml
└── src
    └── main.rs

1 directory, 2 files
</pre>
</div>
</li>
</ol>
</li>
<li><a id="org8c14d8a"></a>其中 Cargo.toml 被称为 manifest,包含package的元数据<br />
<ol class="org-ol">
<li><a id="org790f4dd"></a><br />
<div class="outline-text-10" id="text-1-4-2-0-2-3-4-2-1">
<pre class="example">
fn main() {
    println!("Hello, world!");
}


$ cargo build
   Compiling hello_world v0.1.0 (file:///path/to/package/hello_world)

$ ./target/debug/hello_world
Hello, world!


$ cargo run
   Compiling hello_world v0.1.0 (file:///path/to/package/hello_world)
     Running `target/debug/hello_world`
Hello, world!



$ cargo build --release
   Compiling hello_world v0.1.0 (file:///path/to/package/hello_world)

</pre>
</div>
</li>
</ol>
</li>
<li><a id="org593ef9d"></a>cargo build  将会 构建 package<br /></li>
<li><a id="orge756765"></a>cargo run 则 构建并运行它<br /></li>
<li><a id="org342ea6c"></a>cargo build &#x2013;release 将 构建 优化的代码<br /></li>
<li><a id="org145ecb3"></a>cargo 默认的构建 代码优化级别 为 debug, 存在的目录为 target/debug, 构建 优化后的代码需要 显式传递 参数 &#x2013;release 生成的文件目录为 target/release<br /></li>
<li><a id="org54c61da"></a>Dependencies：<br />
<ol class="org-ol">
<li><a id="org1da55d6"></a>crate.io 为 rust 中间的 package 机构， 用于发现 下载 更新package<br /></li>
<li><a id="org0fdcbb9"></a>添加依赖关系： 在 Cargo.toml 中 的dependencies 下，添加项目<br />
<ol class="org-ol">
<li><a id="org84e2dc8"></a><br />
<div class="outline-text-11" id="text-1-4-2-0-2-3-4-7-2-1">
<pre class="example">
[package]
name = "hello_world"
version = "0.1.0"
authors = ["Your Name &lt;you@example.com&gt;"]
edition = "2018"

[dependencies]
time = "0.1.12"
regex = "0.1.41"
</pre>
</div>
</li>
</ol>
</li>
</ol>
</li>
<li><a id="org7a33696"></a>之后的 cargo build 过程<br />
<ol class="org-ol">
<li><a id="org870da49"></a><br />
<div class="outline-text-10" id="text-1-4-2-0-2-3-4-8-1">
<pre class="example">
$ cargo build
      Updating crates.io index
   Downloading memchr v0.1.5
   Downloading libc v0.1.10
   Downloading regex-syntax v0.2.1
   Downloading memchr v0.1.5
   Downloading aho-corasick v0.3.0
   Downloading regex v0.1.41
     Compiling memchr v0.1.5
     Compiling libc v0.1.10
     Compiling regex-syntax v0.2.1
     Compiling memchr v0.1.5
     Compiling aho-corasick v0.3.0
     Compiling regex v0.1.41
     Compiling hello_world v0.1.0 (file:///path/to/package/hello_world)
</pre>
</div>
</li>
</ol>
</li>
<li><a id="org97dcd4b"></a>package 构成：<br />
<ol class="org-ol">
<li><a id="orgbc7c3da"></a><br />
<div class="outline-text-10" id="text-1-4-2-0-2-3-4-9-1">
<pre class="example">
.
├── Cargo.lock
├── Cargo.toml
├── src/
│   ├── lib.rs
│   ├── main.rs
│   └── bin/
│       ├── named-executable.rs
│       ├── another-executable.rs
│       └── multi-file-executable/
│           ├── main.rs
│           └── some_module.rs
├── benches/
│   ├── large-input.rs
│   └── multi-file-bench/
│       ├── main.rs
│       └── bench_module.rs
├── examples/
│   ├── simple.rs
│   └── multi-file-example/
│       ├── main.rs
│       └── ex_module.rs
└── tests/
    ├── some-integration-tests.rs
    └── multi-file-test/
        ├── main.rs
        └── test_module.rs
</pre>
</div>
</li>
<li><a id="org0ebf332"></a>Cargo.toml and Cargo.lock 在项目的根目录<br /></li>
<li><a id="org9957bc2"></a>src 下 为源代码<br /></li>
<li><a id="org3003768"></a>默认的 library file 为 src/lib.rs<br /></li>
<li><a id="org643c7e9"></a>默认的 executable file 是 src/main.rc, 其他的 放在 src/bin/<br /></li>
<li><a id="org00c2eb4"></a>基准测试 放在benches 目录下<br /></li>
<li><a id="orgf5690c2"></a>示例代码放在examples 目录下<br /></li>
<li><a id="org7142a5e"></a>集成测试 放在 tests 目录下<br /></li>
<li><a id="orgb5f9703"></a>其他详细的需要参看 <a href="https://doc.rust-lang.org/book/ch07-00-managing-growing-projects-with-packages-crates-and-modules.html">https://doc.rust-lang.org/book/ch07-00-managing-growing-projects-with-packages-crates-and-modules.html</a><br /></li>
<li><a id="orgf23a4b0"></a><br /></li>
</ol>
</li>
<li><a id="org4d336a7"></a>Cargo.toml 与 Cargo.lock: 两种目的，<br />
<ol class="org-ol">
<li><a id="org4afbf45"></a>cargo.toml 描述 大概的依赖关系 并不准确，是由 人来确定的<br /></li>
<li><a id="org5d64c51"></a>Cargo.lock 包含准确的依赖关系， 由cargo 来维护<br /></li>
<li><a id="orgb92a17d"></a><a href="https://doc.rust-lang.org/cargo/faq.html#why-do-binaries-have-cargolock-in-version-control-but-not-libraries">https://doc.rust-lang.org/cargo/faq.html#why-do-binaries-have-cargolock-in-version-control-but-not-libraries</a><br /></li>
</ol>
</li>
<li><a id="orgeedbb37"></a>示例:<br />
<ol class="org-ol">
<li><a id="org76efe29"></a><br />
<div class="outline-text-10" id="text-1-4-2-0-2-3-4-11-1">
<pre class="example">
Cargo.toml

[package]
name = "hello_world"
version = "0.1.0"
authors = ["Your Name &lt;you@example.com&gt;"]

[dependencies]
rand = { git = "https://github.com/rust-lang-nursery/rand.git", rev = "9f35b8e" }


Cargo.lock


[[package]]
name = "hello_world"
version = "0.1.0"
dependencies = [
 "rand 0.1.0 (git+https://github.com/rust-lang-nursery/rand.git#9f35b8e439eeedd60b9414c58f389bdc6a3284f9)",
]

[[package]]
name = "rand"
version = "0.1.0"
source = "git+https://github.com/rust-lang-nursery/rand.git#9f35b8e439eeedd60b9414c58f389bdc6a3284f9"
</pre>
</div>
</li>
</ol>
</li>
<li><a id="org84df569"></a>Cargo.lock 中包含 依赖的确定的 version， 当其他人使用的时候， 他们将使用相同的 sha，即便我们并没有在Cargo.toml 中使用<br /></li>
<li><a id="org7108df5"></a>cargo update 更新全部的依赖， cargo update -p rand 只更新依赖 rand<br /></li>
<li><a id="org8e3e8e8"></a>Test:<br />
<ol class="org-ol">
<li><a id="orgb358069"></a>cargo test 执行 package中的所有test， test主要有两种： 1) 在每个 src 目录中的文件， 2） tests/ 目录下的所有文件。 1）中的为单元测试， 2）则为 集成测试，<br /></li>
<li><a id="orgf14c0a4"></a><br />
<div class="outline-text-10" id="text-1-4-2-0-2-3-4-14-2">
<pre class="example">
$ cargo test
   Compiling rand v0.1.0 (https://github.com/rust-lang-nursery/rand.git#9f35b8e)
   Compiling hello_world v0.1.0 (file:///path/to/package/hello_world)
     Running target/test/hello_world-9c2b65bbb79eabce

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</pre>
</div>
</li>
<li><a id="org500add7"></a>cargo test foo  可以单独执行 名字为foo的测试，<br /></li>
<li><a id="org888953c"></a>cargo test 其实还会执行 额外的测试，包含在 src中的部分 文档中的测试（并不重要，为补充部分）<br /></li>
<li><a id="orgba689d7"></a>Cargo Home： 当build package的时候， cargo 将下载的依赖package 存储到 Cargo home 下。当做cache 使用。<br /></li>
<li><a id="org4b4f4a0"></a>可以通过 改变 环境变量 CARGO_HOME 来改变 cargo home的值， 默认 为 $HOME/.cargo/<br /></li>
<li><a id="org0292802"></a>Cargo Home 目录下的 数据：<br />
<ol class="org-ol">
<li><a id="orgc4d93f4"></a>bin 目录： 可执行crate， 包括cargo install 或者 rustup 安装的<br /></li>
<li><a id="org07fed7f"></a>git/db: crate 依赖git 项目时， cargo clone 项目到 该目录下<br /></li>
<li><a id="orgec205f1"></a>git/checkouts： git/db 项目中的检出到该文件， 比如 依赖于特定的commit<br /></li>
<li><a id="orgcf4fef7"></a>registry： 项目依赖于 crate.io 中的crate 存放在该目录下<br />
<ol class="org-ol">
<li><a id="org0f38063"></a>registry/index： crate 的原数据， 包括： version， dependencies 等<br /></li>
<li><a id="org3a385e5"></a>registry/cache： 下载的crate 储存到该目录下， 存储形式为 .crate 的gzip压缩文件<br /></li>
<li><a id="orgcc1d314"></a>registry/src： cache 的解压形式 存放在 该文件中<br /></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li><a id="org82adc1c"></a>指定 Dependencies：<br />
<ol class="org-ol">
<li><a id="org3bc7264"></a>依赖版本： 版本号各个位置数字的含义： <a href="https://semver.org/">SemVer compatible</a> 与 link 中讲的同样， major.minor.patch<br />
<ol class="org-ol">
<li><a id="orge5d92e2"></a>Caret requirements： 指定 可以使用 一个 major 版本号 不变的更新， 但是 0 是 一个特殊的数字，标识不与 任何 数字兼容。即是： 0.0.1， 与 0.1.x 不兼容<br />
<ol class="org-ol">
<li><a id="org743d235"></a>下面为兼容样例：<br /></li>
<li><a id="org0475682"></a><br />
<div class="outline-text-12" id="text-1-4-2-0-2-3-4-15-1-1-2">
<pre class="example">
^1.2.3  :=  &gt;=1.2.3, &lt;2.0.0
^1.2    :=  &gt;=1.2.0, &lt;2.0.0
^1      :=  &gt;=1.0.0, &lt;2.0.0
^0.2.3  :=  &gt;=0.2.3, &lt;0.3.0
^0.2    :=  &gt;=0.2.0, &lt;0.3.0
^0.0.3  :=  &gt;=0.0.3, &lt;0.0.4
^0.0    :=  &gt;=0.0.0, &lt;0.1.0
^0      :=  &gt;=0.0.0, &lt;1.0.0
</pre>
</div>
</li>
</ol>
</li>
<li><a id="org91b45b0"></a>Tilde requirements:  分为以下情况:<br />
<ol class="org-ol">
<li><a id="org86baf4d"></a>有 major.minor.patch 或者  major.minor 只有patch version 的升级是允许的<br /></li>
<li><a id="org94a2175"></a>有major情况下, minor patch verison的升级 是允许的<br /></li>
<li><a id="org4101fbd"></a>for example<br /></li>
<li><a id="orgdf2ffbc"></a><br />
<div class="outline-text-12" id="text-1-4-2-0-2-3-4-15-1-2-4">
<pre class="example">
~1.2.3  := &gt;=1.2.3, &lt;1.3.0
~1.2    := &gt;=1.2.0, &lt;1.3.0
~1      := &gt;=1.0.0, &lt;2.0.0
</pre>
</div>
</li>
</ol>
</li>
<li><a id="org257e20e"></a>Wildcard requirements:<br />
<ol class="org-ol">
<li><a id="org0c2d711"></a>允许所在位置上的 任何版本<br /></li>
<li><a id="org22c4116"></a>for example<br /></li>
<li><a id="orgf0f38bc"></a><br />
<div class="outline-text-12" id="text-1-4-2-0-2-3-4-15-1-3-3">
<pre class="example">
\*     := &gt;=0.0.0
1.*   := &gt;=1.0.0, &lt;2.0.0
1.2.* := &gt;=1.2.0, &lt;1.3.0
</pre>
</div>
</li>
</ol>
</li>

<li><a id="orgd5fb4e6"></a>Workspaces: workspace 下的一系列package 共享同样的Cargo.lock， output dir， 多样的配置（比如profile）， workspace下的packages 被称为 workspace members<br />
<ol class="org-ol">
<li><a id="orga530946"></a>存在两种形式： 1） [package] 与 [workspace] 共存在 Cargo.toml 中 2） 只有 [workspace] 存在Cargo.toml 中， 被称作 Virtual manifest<br /></li>
<li><a id="orgd4bdc6e"></a>主要作用：<br />
<ol class="org-ol">
<li><a id="orgfee25b4"></a>1. 共享Cargo.lock<br /></li>
<li><a id="org3dbd98a"></a>2. 共享output dir， Cargo.toml 中 [target]<br /></li>
<li><a id="org33cbc63"></a>3. [patch], [replace] and [profile.*] sections in Cargo.toml 只能在 识别 workspace 中的 manifest，member package 中的被忽略<br /></li>
</ol>
</li>
<li><a id="orgd2a3e84"></a>workspace section 中的配置<br /></li>
<li><a id="org94e424e"></a><br />
<div class="outline-text-12" id="text-1-4-2-0-2-3-4-15-1-4-4">
<pre class="example">
[workspace]
members = ["member1", "path/to/member2", "crates/*"]
exclude = ["crates/foo", "path/to/other"]
</pre>
</div>
<ol class="org-ol">
<li><a id="orgdfbe734"></a>members 为 成员package 列表， exclude 排除 member<br /></li>
</ol>
</li>
<li><a id="orgaa66a5f"></a>workspace 寻找： Cargo 自动的 向上目录 寻找 含有 [workspace] 的Cargo.toml， 在 member中可以指定 package.workspace 来 直接指定 workspace 的位置， 来防止自动查找， 这个对于 没有在 workspace 目录下的member package 非常有用<br /></li>
<li><a id="orgbdac6a4"></a>member package： cargo commadn -p package 可以指定 package 来 执行命令， 如果没有指定 package， 则 选择当前所在目录的package， default-members = ["path/to/member2", "path/to/member3/"] 可以指定默认的 操作的member package<br /></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org38c45d1" class="outline-4">
<h4 id="org38c45d1"><span class="section-number-4">1.4.3.</span> rustup： 从官方下载rustc， 使能够随意的在 stable, beta, nightly 中切换。 让 cross-compiling 编译变的简单</h4>
<div class="outline-text-4" id="text-1-4-3">
</div>
<ol class="org-ol">
<li><a id="org3d26642"></a>工作原理：  rustup 通过 ~/.cargo/bin 下的工具 来实现其功能， 比如 安装在~/.cargo/bin   下的  rustc cargo  只是一个 到真正执行工具的 代理，<br />
<ol class="org-ol">
<li><a id="org794c014"></a>rustup 提供了一个方便的机制来 控制 这些代理的行为， 比如 通过执行rustup default nightly 来切换 nightly 下的工具<br /></li>
</ol>
</li>
<li><a id="org66c013a"></a>概念:<br />
<ol class="org-ol">
<li><a id="org983288b"></a>channel: rustc 按照 beta, night, stable 三个 channel 进行发布， channel 并没有什么用， 只是个概念而已。<br /></li>
<li><a id="org5de3a51"></a>toolchain： rustc and cargo 等相关工具。 因为能够控制rustc 即是channel概念下的实际应用。<br /></li>
<li><a id="orgd18b359"></a>target： rustc 可以为多个平台生成代码。 默认的 rustc 使用host 作为target， 为了生成不同target的代码，我们需要 使用rustup target 来安装目标target<br /></li>
<li><a id="org710fa46"></a>component: 每个rust版本的发布，都会包含一些 组件， 包括，rustc， clippy 等<br /></li>
<li><a id="org45eb79c"></a>profile： 为了更好的与component 工作， profile 定义了 一组component，<br /></li>
</ol>
</li>
<li><a id="org9a29554"></a>toolchain：  rustup 不仅可以 安装stable, beta, nightly 三个channel， 还可以安装 其他的 官方 历史版本<br />
<ol class="org-ol">
<li><a id="orgfc91a92"></a>channel 的命令规则:<br />
<div class="outline-text-7" id="text-1-4-3-0-3-1">
<pre class="example">
&lt;channel&gt;[-&lt;date&gt;][-&lt;host&gt;]

&lt;channel&gt;       = stable|beta|nightly|&lt;major.minor&gt;|&lt;major.minor.patch&gt;
&lt;date&gt;          = YYYY-MM-DD
&lt;host&gt;          = &lt;target-triple&gt;

</pre>
</div>
</li>
</ol>
</li>
<li><a id="orgd4914de"></a>其他命令： 保持 rust 更新：<br />
<div class="outline-text-6" id="text-1-4-3-0-4">
<pre class="example">
$ rustup update
info: syncing channel updates for 'stable'
info: downloading component 'rustc'
info: downloading component 'rust-std'
info: downloading component 'rust-docs'
info: downloading component 'cargo'
info: installing component 'rustc'
info: installing component 'rust-std'
info: installing component 'rust-docs'
info: installing component 'cargo'
info: checking for self-updates
info: downloading self-updates

  stable updated: rustc 1.7.0 (a5d1e7a59 2016-02-29)
</pre>
</div>
</li>
<li><a id="orgb741254"></a>如上， rustup update 会更新 stable， component， 以及 rustup self， 可以使用 rustup self update 来手动更新rustup<br /></li>
</ol>
</div>
</div>

<div id="outline-container-org52a560a" class="outline-3">
<h3 id="org52a560a"><span class="section-number-3">1.5.</span> 工具 Trait:</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org934ae4b" class="outline-4">
<h4 id="org934ae4b"><span class="section-number-4">1.5.1.</span> Drop</h4>
<div class="outline-text-4" id="text-1-5-1">
</div>
<ol class="org-ol">
<li><a id="org9e2bfa7"></a>调用时机： Value drop的时候， 在struct 内部 field drop之前， drop func 内 可以使用 field， struct drop之后，内部的field 的drop func 依次调用<br /></li>
<li><a id="org1c5a620"></a>何时需要： struct 存在rust 不能够理解的资源时<br /></li>
</ol>
</div>
<div id="outline-container-org832217e" class="outline-4">
<h4 id="org832217e"><span class="section-number-4">1.5.2.</span> Sized: marker trait , rust 用来标记 在 compile时期， size 能够确定的 type</h4>
<div class="outline-text-4" id="text-1-5-2">
</div>
<ol class="org-ol">
<li><a id="org5faa9ec"></a>unsized  de type 有： str, [T] （变长， 但 &amp;str, &amp;[T] 指针 依然是 Sized）<br /></li>
<li><a id="org734a98a"></a>unsized 的type 不能够存储变量， 所以不能够作为 function 的 args 使用， 需要 使用 指针引用<br /></li>
<li><a id="org1ffb8f8"></a>可以使用 T:Sized, T:?Sized 来限制type 的类型， ?Sized 表示 可以为 unsized type<br /></li>
</ol>
</div>
<div id="outline-container-org663a623" class="outline-4">
<h4 id="org663a623"><span class="section-number-4">1.5.3.</span> Clone:</h4>
<div class="outline-text-4" id="text-1-5-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">fn</span> <span style="color: #daa520;">clone</span><span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">Self</span>;
<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">clone_from</span><span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> slef, <span style="color: #4eee94;">source</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Self</span><span style="color: #8c8c8c;">)</span>;  <span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">&#29992; source &#21464;&#37327;&#20013;&#30340;data &#26469;&#35013;&#22791;&#33258;&#24049;&#65292; &#27604; clone &#35201;&#24555;</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org762636d"></a>#[derive(Clone)]<br /></li>
<li><a id="orge66dad2"></a>std::fs::File, sync::mutex 不支持 clone<br /></li>
</ol>
</div>
<div id="outline-container-org99ca1c3" class="outline-4">
<h4 id="org99ca1c3"><span class="section-number-4">1.5.4.</span> Copy: 基本类型  i32， i64 etc</h4>
<div class="outline-text-4" id="text-1-5-4">
</div>
<ol class="org-ol">
<li><a id="org753d049"></a>A = B 不是 Ownership的转移 ， 而是 clone B -&gt; A<br /></li>
<li><a id="org77238d3"></a>Copy: Clone, Clone 是copy的 super trait<br /></li>
<li><a id="org741a08a"></a>#[derive(Copy, Clone)]<br /></li>
<li><a id="org0f79749"></a>Clone 为 复制 复杂数据结构，耗时操作 提供 clone 方法 #[derive(Clone)]<br /></li>
<li><a id="org4af5102"></a>Copy 有一些特殊，除非member 包含简单的数据结构类型，否则不能够实现 Copy<br /></li>
<li><a id="org0a8d6ba"></a>Copy 只能够 通过标记 #[derive(Copy)] 来实现<br /></li>
</ol>
</div>
<div id="outline-container-orga6edccc" class="outline-4">
<h4 id="orga6edccc"><span class="section-number-4">1.5.5.</span> Deref &amp; DerefMut : rust 自动尝试 插入 deref() 代码，当类型不匹配时， 可以经过多次插入</h4>
<div class="outline-text-4" id="text-1-5-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">Deref</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">type</span> <span style="color: #4eee94;">target</span>: <span style="color: #f08080; font-weight: bold;">?</span><span style="color: #98f5ff;">Sized</span>;

  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">deref</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Self</span>::target;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="orgc4a4228"></a>1. 为 Smart Pointer 设计. Box, Rc, Arc<br /></li>
<li><a id="org0750502"></a>2. 模版参数， 不提供代码插入。<br /></li>
</ol>
</div>
<div id="outline-container-orgf3c457b" class="outline-4">
<h4 id="orgf3c457b"><span class="section-number-4">1.5.6.</span> Default</h4>
<div class="outline-text-4" id="text-1-5-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">Default</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span>  <span style="color: #daa520;">default</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">Self</span>;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org01d3f21"></a>String,  Collections 都实现了Default;<br /></li>
<li><a id="org1d6caad"></a>#[derive(Default)] 如果 struct 各个field 都实现了 Default<br /></li>
</ol>
</div>
<div id="outline-container-org33bac2b" class="outline-4">
<h4 id="org33bac2b"><span class="section-number-4">1.5.7.</span> AsRef &amp; AsMut:</h4>
<div class="outline-text-4" id="text-1-5-7">
</div>
<ol class="org-ol">
<li><a id="org94ff6f8"></a>定义<br />
<div class="outline-text-5" id="text-1-5-7-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">AsRef</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #98f5ff;">Sized</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span> 
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">as_ref</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">T</span>;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgbb49dd1"></a>对比 Deref， rust不提供代码插入<br /></li>
<li><a id="org3cb198f"></a>从 A 中 as_ref B 出来， 扩大参数接受范围<br />
<div class="outline-text-5" id="text-1-5-7-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">fn</span> <span style="color: #daa520;">open</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">P</span>: <span style="color: #98f5ff;">AsRef</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Path</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">(</span><span style="color: #4eee94;">path</span>: <span style="color: #98f5ff;">P</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">File</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
   <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">path</span>: <span style="color: #98f5ff;">Path</span> = path.as_ref<span style="color: #93a8c6;">()</span>:
   <span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">....</span>
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">fs</span> = <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fs</span>::<span style="color: #98f5ff;">File</span>::open<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"xxxxxx.txt"</span><span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="orgd6f7962"></a>减少 具体的 type 定义，  在写 Trait AsFoo之前 应该尝试 AsRef&lt;Foo&gt;<br /></li>
</ol>
</div>
<div id="outline-container-org4b8a518" class="outline-4">
<h4 id="org4b8a518"><span class="section-number-4">1.5.8.</span> Borrow &amp; BorrowMut</h4>
<div class="outline-text-4" id="text-1-5-8">
</div>
<ol class="org-ol">
<li><a id="org085ac83"></a>定义：<br />
<div class="outline-text-5" id="text-1-5-8-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">Borrow</span><span style="color: #8c8c8c;">(</span><span style="color: #4eee94;">Borrowed</span>: <span style="color: #f08080; font-weight: bold;">?</span><span style="color: #98f5ff;">Sized</span><span style="color: #8c8c8c;">)</span>    <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">borrow</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span>-&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #4eee94;">Borrowed</span>:
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">HashMap</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">K</span>, <span style="color: #98f5ff;">V</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">K</span>: <span style="color: #98f5ff;">Eq</span> + <span style="color: #98f5ff;">Hash</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">get</span><span style="color: #93a8c6;">&lt;</span><span style="color: #4eee94;">Q</span>: <span style="color: #f08080; font-weight: bold;">?</span><span style="color: #98f5ff;">Sized</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">key</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Q</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">V</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
       <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">K</span>: <span style="color: #98f5ff;">Borrow</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Q</span><span style="color: #b0b1a3;">&gt;</span>,
             <span style="color: #4eee94;">Q</span>: <span style="color: #98f5ff;">Eq</span> + <span style="color: #98f5ff;">Hash</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">...</span>
     <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</li>
<li><a id="orgecb0ab9"></a>与AsRef 相似， 但是添加了 Hash Trait impl 的限制<br /></li>
<li><a id="org88978f2"></a>限制 HashMap&lt;K, V&gt;.get(key: &amp;Q) Q为 HashMap 中的 key 能够 Borrow 出来，不影响 HashMap中的K 的ownership, 从而能够 loopup 到对应的key， 扩大 get(&amp;Q) 的参数范围。<br /></li>
<li><a id="org550f7ed"></a>比如 HashMap&lt;String, String&gt; 可以  hashmap.get("xx")<br /></li>
</ol>
</div>
<div id="outline-container-org3e70b6f" class="outline-4">
<h4 id="org3e70b6f"><span class="section-number-4">1.5.9.</span> From &amp; Into:</h4>
<div class="outline-text-4" id="text-1-5-9">
</div>
<ol class="org-ol">
<li><a id="orgaa02ee9"></a>定义：<br />
<div class="outline-text-5" id="text-1-5-9-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">Into</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #98f5ff;">Sized</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
   <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">into</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">T</span>;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="org80c07c5"></a>消耗 Type A ownership  返回 type B<br /></li>
<li><a id="orgdbbf20b"></a>if A imp From&lt;B&gt; 则  rust 自动impl  B impl Into&lt;A&gt;<br /></li>
<li><a id="org99779f9"></a>使用场景： Into 作为 fun 的args， 使 args 更加灵活， From 作为 构造函数  从多个 类型 -&gt; Self<br /></li>
<li><a id="orgbe68c11"></a>因为 Into 需要消耗 ownership 所以 “重”， 因为可能会产生内存分配<br /></li>
</ol>
</div>
<div id="outline-container-orgfb777ff" class="outline-4">
<h4 id="orgfb777ff"><span class="section-number-4">1.5.10.</span> ToOwned:</h4>
<div class="outline-text-4" id="text-1-5-10">
</div>
<ol class="org-ol">
<li><a id="org9a87929"></a>定义：<br />
<div class="outline-text-5" id="text-1-5-10-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">ToOwned</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">type</span> <span style="color: #4eee94;">Owned</span>: <span style="color: #98f5ff;">Borrow</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Self</span><span style="color: #93a8c6;">&gt;</span>; <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#20027;&#24847;&#35813;&#38480;&#21046;</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">to_owned</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Owned</span>;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgdbb9d2a"></a>解决 clone limit, 因为 &amp;A.clone() -&gt; A, 所以 &amp;str 不能够 impl Clone Trait (因为 无法返回 str: unsized 类型)<br /></li>
<li><a id="orge6fba08"></a>所以 &amp;str 可以 .to_owned -&gt; String<br /></li>
</ol>
</div>
<div id="outline-container-orgc21693c" class="outline-4">
<h4 id="orgc21693c"><span class="section-number-4">1.5.11.</span> Send, Sync</h4>
<div class="outline-text-4" id="text-1-5-11">
</div>
<ol class="org-ol">
<li><a id="orgf7e4607"></a>Send: 1. safe pass value between threads 2. move ownership cross threads<br /></li>
<li><a id="orga8c3e45"></a>Sync: 1. safe pass none mut ref between threads. 2. share cross threads, only &amp;T is Send, then T is Sync, 所以Sync 与 Send之间必然存在一些联系。<br /></li>
<li><a id="orgae8da0c"></a>Send 应该 &gt; Sync<br /></li>
<li><a id="orgbbb658c"></a>? 如果实现 &amp;T Send， 则 T 必须 Sync, 说明 在 不同的thread 之间 Send的时候， 至少 可能跟 Rc 一样，会改变计数，来决定 哪一个Thread会进行释放， 但是 Arc&lt;T&gt; if T impl Sync， 才能 impl Send， 所以T: Sync 到底意味着什么？<br /></li>
<li><a id="org9bd3d95"></a>不需要 #[derive] rust 自动提供 marker<br /></li>
<li><a id="orgd15d912"></a>但依然可以  手动 impl  for Struct，即自由的控制type 是否可以Send， Sync：<br />
<ol class="org-ol">
<li><a id="org7a3b410"></a>unsafe impl Send for MyBox {} ;<br /></li>
<li><a id="org307e4a5"></a>unsafe impl Sync for MyBox {} ;<br /></li>
<li><a id="org3705ec2"></a>impl !Send for MyBox {};<br /></li>
<li><a id="org6649965"></a>impl !Sync for MyBox {};<br /></li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org590d6ae" class="outline-4">
<h4 id="org590d6ae"><span class="section-number-4">1.5.12.</span> Ref Pointer:</h4>
<div class="outline-text-4" id="text-1-5-12">
</div>
<ol class="org-ol">
<li><a id="org7fd646f"></a>Cell, RefCell: 增加 borrow checker（runtime）<br />
<ol class="org-ol">
<li><a id="orgb9d6a69"></a>内部可变, 使用场景： 1. 内部可变化，外部不可变 2. Rc.clone(&amp;ref) 方法，  ref 不可变，但是内部增加了 引用计数<br /></li>
</ol>
</li>
<li><a id="orgf06c6f7"></a>Rc: reference counter， smart pointer (管理 Heap Memory)<br />
<div class="outline-text-5" id="text-1-5-12-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">let</span> <span style="color: #4eee94;">rc</span> = <span style="color: #98f5ff;">Rec</span>::new<span style="color: #8c8c8c;">(</span>data<span style="color: #8c8c8c;">)</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">rc1</span> = <span style="color: #98f5ff;">Rc</span>::clone<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>rc<span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="orge70efb6"></a>Arc: atomicaly  Reference counter （多线程 版本Rc）<br />
<ol class="org-ol">
<li><a id="org5ff241f"></a>默认 unmut, Arc 需要 配合 Mutex, RwLock, Atomic 使用<br /></li>
<li><a id="orge17e8c7"></a>Arc&lt;T&gt; if T impl Send &amp; Sync  则  Arc&lt;T&gt; impl Send &amp; Sync<br /></li>
<li><a id="org96b6b34"></a>Arc 永远 thread safe 指的是其中的counter， 但是没有 add thread safe to &lt;T&gt; （内部的data）<br /></li>
<li><a id="org3bb0b08"></a>例如 Arc&lt;RefCell&lt;T&gt;&gt; 并不是 thread safe Arc 是， 但RefCell 并不是，所以 Arc&lt;RefCell&lt;T&gt; 并不是 thread safe<br /></li>
</ol>
</li>
<li><a id="org30bf905"></a>Reference Counter（包括 Rc, Arc） 都存在对应的 Weak 类型，已解决环问题: downgrade -&gt; Weak&lt;T&gt; -&gt; upgrade -&gt; Option&lt;Rc&lt;T&gt;&gt;<br /></li>
</ol>
</div>
</div>
<div id="outline-container-orgd9634aa" class="outline-3">
<h3 id="orgd9634aa"><span class="section-number-3">1.6.</span> rust std 阅读</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-orge5b84bb" class="outline-4">
<h4 id="orge5b84bb"><span class="section-number-4">1.6.1.</span> doc 中经常出现 primitive type 与 std:: 的问题， 是因为 primitive type是 compiler 实现的。 而 std 也实现了同样名字的一部分。所以是此现象</h4>
</div>
<div id="outline-container-orgc816dec" class="outline-4">
<h4 id="orgc816dec"><span class="section-number-4">1.6.2.</span> rust prelude:</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
是 避免 繁琐的 use  std:: 的一个 包装，如此可以简单的 use std::prelude:: 即可包含 起 包含的集合
</p>
<ol class="org-ol">
<li>存在多种 mod 下的 prelude, 如： std::io::prelude, core::prelude, std::os::unix::prelude etc..</li>
</ol>
</div>
</div>
<div id="outline-container-org540515b" class="outline-4">
<h4 id="org540515b"><span class="section-number-4">1.6.3.</span> iter module: 是一个 关于 iter 的模块，包含了 一系列的 trait， struct  用于支持 Iterator</h4>
</div>
<div id="outline-container-orga5d5a83" class="outline-4">
<h4 id="orga5d5a83"><span class="section-number-4">1.6.4.</span> Vev Iter, Iterator, Enumerate 函数中 find, map block中的参数类型，是否 为 &amp;T, &amp;mut T</h4>
<div class="outline-text-4" id="text-1-6-4">
</div>
<ol class="org-ol">
<li><a id="org4d9c3c1"></a>其中 &amp;T 可以 被 x 或者 &amp;x 匹配，&amp;mut T 可以被 x 或者 &amp;mut x 匹配， 如果其中的 T 不能够borrow 出来的话，<br /></li>
<li><a id="org340858a"></a>需要使用 ref x 或者 ref mut x ， 这时候 x 的类型为 &amp;&amp; T 或者 &amp;&amp;mut T。ref 的含义为： 设定x为 目标的引用<br /></li>
<li><a id="org0b0e946"></a>所以并不会如 &amp;x 一样 将 &amp;T 中的T borrow出来。<br /></li>
<li><a id="org29a8217"></a>下面的代码可以查看 对应的type_of(&amp;var) 的具体类型。<br />
<div class="outline-text-5" id="text-1-6-4-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">any</span>::type_name;

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">type_of</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #4eee94;">_</span>: <span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #00bfff;">static</span> <span style="color: #98f5ff;">str</span> <span style="color: #8c8c8c;">{</span>
    type_name::<span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">&gt;()</span>
<span style="color: #8c8c8c;">}</span>


<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#38656;&#35201;&#27880;&#24847;&#65292;&#36825;&#37324;&#38754; iter &#34987;find&#20043;&#21518;&#65292;players &#34987;&#28040;&#32791;&#25481;&#20102;.</span>
<span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">players</span> = <span style="color: #a2cd5a;">player</span>::<span style="color: #98f5ff;">Player</span>::get_many<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>realm_mysql, <span style="color: #cccccc; background-color: #181a26;">&amp;</span>ary<span style="color: #8c8c8c;">)</span><span style="color: #f08080; font-weight: bold;">?</span>.into_iter<span style="color: #8c8c8c;">()</span>;
<span style="color: #f08080;">println!</span><span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"players is ---------- </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">, </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">, </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, players, sender_id, recipient_id<span style="color: #8c8c8c;">)</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">i_data</span> = players.find<span style="color: #8c8c8c;">(</span>|x| x.id == sender_id<span style="color: #8c8c8c;">)</span>;
<span style="color: #f08080;">println!</span><span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"players is ---------- </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, i_data<span style="color: #8c8c8c;">)</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">sender</span> = <span style="color: #00bfff;">match</span> i_data <span style="color: #8c8c8c;">{</span>
  <span style="color: #98f5ff;">Some</span><span style="color: #93a8c6;">(</span>data<span style="color: #93a8c6;">)</span> =&gt; data,
  <span style="color: #98f5ff;">None</span> =&gt; <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">None</span><span style="color: #93a8c6;">)</span>,
<span style="color: #8c8c8c;">}</span>;

<span style="color: #f08080;">println!</span><span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"players is ---------- </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, players<span style="color: #8c8c8c;">)</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">i_data</span> = players.find<span style="color: #8c8c8c;">(</span>|x| x.id == recipient_id<span style="color: #8c8c8c;">)</span>;
<span style="color: #f08080;">println!</span><span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"players is ---------- </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, i_data<span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgc482bfb" class="outline-4">
<h4 id="orgc482bfb"><span class="section-number-4">1.6.5.</span> Box: Box::new(T) 方法</h4>
</div>
<div id="outline-container-org132aacc" class="outline-4">
<h4 id="org132aacc"><span class="section-number-4">1.6.6.</span> Borrow Trait 的错误使用： 下面为代码的 正确使用示例： 为什么会如此设计？</h4>
<div class="outline-text-4" id="text-1-6-6">
</div>
<ol class="org-ol">
<li><a id="orgc92cc65"></a>1. HashMap&lt;K, V&gt; 因为K 能为一个 heap分配的对象，比较 heavy，所以 我们采用 Borrow&lt;Q&gt; for K, 来实现 .get(Q) ， 例如 Borrow&lt;str&gt; for String<br /></li>
<li><a id="orgafc44a6"></a>2. 对于 Hash的 impl， 对于 使用于HashMap的K，实现 Borrow&lt;Q&gt; for K 比较 特殊，需要保证 Q 与 K hash 数值的相同。<br /></li>
<li><a id="org11c64e6"></a>3. 点 2 在 <a href="https://github.com/rust-lang/hashbrown/blob/1d2c1a81d1b53285decbd64410a21a90112613d7/src/map.rs#L1262">hash map inner impl</a> 中 有所体现 , 即 HashMap.get(Q) 中 get_inner&lt;Q: ?Sized&gt;(&amp;self, k: &amp;Q) -&gt; Option&lt;&amp;(K, V)&gt; 中 let hash = make_hash::&lt;K, Q, S&gt;(&amp;self.hash_builder, k);  直接 使用了 k: &amp;Q 做了 hash， 所以 &amp;Q 与 K 的hash 必然一致才行<br />
<div class="outline-text-5" id="text-1-6-6-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">borrow</span>::<span style="color: #98f5ff;">Borrow</span>;
<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">collections</span>::<span style="color: #98f5ff;">HashMap</span>;
<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">hash</span>::<span style="color: #8c8c8c;">{</span><span style="color: #98f5ff;">Hash</span>, <span style="color: #98f5ff;">Hasher</span><span style="color: #8c8c8c;">}</span>;

<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Debug, Clone, Copy, PartialEq, Eq</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">AbType</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #98f5ff;">Rss</span>,
    <span style="color: #98f5ff;">Gold</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Borrow</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">str</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">AbType</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">borrow</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">AbType</span>::<span style="color: #98f5ff;">Gold</span> =&gt; <span style="color: #deb887;">"gold"</span>,
            <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">AbType</span>::<span style="color: #98f5ff;">Rss</span> =&gt; <span style="color: #deb887;">"rss"</span>,
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Hash</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">AbType</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">hash</span><span style="color: #93a8c6;">&lt;</span><span style="color: #4eee94;">H</span>: <span style="color: #98f5ff;">Hasher</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">state</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">H</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">s</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span> = <span style="color: #00bfff;">self</span>.borrow<span style="color: #b0b1a3;">()</span>;
        s.hash<span style="color: #b0b1a3;">(</span>state<span style="color: #b0b1a3;">)</span>;
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">hash</span> = <span style="color: #98f5ff;">HashMap</span>::new<span style="color: #93a8c6;">()</span>;
    hash.insert<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">AbType</span>::<span style="color: #98f5ff;">Gold</span>, 10<span style="color: #93a8c6;">)</span>;

    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">val</span> = hash.get<span style="color: #93a8c6;">(</span><span style="color: #deb887;">"gold"</span><span style="color: #93a8c6;">)</span>;
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">gold_val</span> = hash.get<span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">AbType</span>::<span style="color: #98f5ff;">Gold</span><span style="color: #93a8c6;">)</span>;
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"val: </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">, goldVal: </span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, val, gold_val<span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org693ce0b" class="outline-4">
<h4 id="org693ce0b"><span class="section-number-4">1.6.7.</span> FromIterator: 定义如下:</h4>
<div class="outline-text-4" id="text-1-6-7">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">FromIterator</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">A</span><span style="color: #8c8c8c;">&gt;</span>: <span style="color: #98f5ff;">Sized</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from_iter</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">iter</span>: <span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span>
&#160;&#160;&#160;&#160;<span style="color: #00bfff;">where</span>
<span style="color: #4eee94;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;T</span>: <span style="color: #98f5ff;">IntoIterator</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Item</span> = <span style="color: #98f5ff;">A</span><span style="color: #93a8c6;">&gt;</span>;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="orgaddb90f"></a>主要用于 提供 从 Iterator 构建 Self 的一种方法, T 需要 impl IntoIterator&lt;Item&gt;<br /></li>
<li><a id="org37cd094"></a>主要实现有: String, HashMap, Vec, 以及  Option&lt;V&gt; , Result&lt;V, E&gt;<br /></li>
</ol>
</div>
<div id="outline-container-orgbadb20f" class="outline-4">
<h4 id="orgbadb20f"><span class="section-number-4">1.6.8.</span> Vec: 的使用</h4>
<div class="outline-text-4" id="text-1-6-8">
<p>
rust Vec&lt;&amp;str&gt;.join(",") 与  Vec&lt;String&gt;  存在一些问题, 这里面没有问题， 问题在于 String.split 会出现 "".split(',')  [""] 的情况, 即 rust 使用 String::default.split(",") 会出现 ['']情况* rust 使用
</p>
</div>
</div>
<div id="outline-container-orgdefbcef" class="outline-4">
<h4 id="orgdefbcef"><span class="section-number-4">1.6.9.</span> rust thread unwrap 的问题</h4>
<div class="outline-text-4" id="text-1-6-9">
<p>
（之前的概念存在错误， rust 中的 Error就是Exception， Error/Exception 是可以被处理，return/throw  的， 并不会造成 thread 的崩溃， 只有panic/unwrap才会造成thread的崩溃，而导致， thread 进行stack 的unwind， 并在JoinHandler.join 时候返回 Result
所以 如何防止 thread 代码中依赖的库 中不存在panic ? 答案是没有方法, 但是存在 panic::catch_unwind / std::panic::set_hook 来对panic 进行处理， catch_unwind 能够防止  thread 的panic ， set_hook 则定义你 panic 时的callback
虽然有 panic::catch_unwind 但是 更好的解决方法是 return Result（返回Error） 交给 Appliation level 处理，而不是 panic
</p>
</div>
</div>
</div>
<div id="outline-container-org408ac94" class="outline-3">
<h3 id="org408ac94"><span class="section-number-3">1.7.</span> <a href="https://en.cppreference.com/w/cpp/atomic/memory_order">Atomic</a>: rust 使用c++ 20 的 atomic 内存模型（并非c++ 非常好，而是 atomic 非常复杂，使用现有的有利于 学习使用）， 为了 弥补 complier 与 hardwre 之间优化的差异。</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-org5a8576c" class="outline-4">
<h4 id="org5a8576c"><span class="section-number-4">1.7.1.</span> Compiler Reordering: 编译器 将分析 程序，并重新排列 指令 以优化 程序性能， example：</h4>
<div class="outline-text-4" id="text-1-7-1">
<div class="org-src-container">
<pre class="src src-c">  x = 1;
  y = 3;
  x = 2;
<span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">------------</span>
  x = 2;
  y = 3;

</pre>
</div>
</div>
</div>
<div id="outline-container-orgd490a30" class="outline-4">
<h4 id="orgd490a30"><span class="section-number-4">1.7.2.</span> Hardware Reordering: 因为cpu的内存层次结构设计， 比如 每个Cpu都存在L1，共用 L2， 同样将导致问题。example：</h4>
<div class="outline-text-4" id="text-1-7-2">
<p>
#+begin_src c
initial state: x = 0, y = 1
</p>

<p>
THREAD 1        THREAD2
y = 3;          if x <code>= 1 {
    x = 1;              y *</code> 2;
                }
</p>

<p>
// 理想情况下： 将存在两种情况： 
y = 3: (thread 2 did the check before thread 1 completed)
y = 6: (thread 2 did the check after thread 1 completed)
</p>

<p>
<i>/ 然而 因为 hardware优化问题，可能存在 下面情况：
y = 2: (thread 2 saw x = 1, but not y = 3, and then overwrote y = 3)
/</i> 即 运行两个 thread 的两个cpu， L1, L2 缓存问题，导致 两边看到的数据不一致（没有同步）
#+end_center
</p>
</div>
</div>
<div id="outline-container-org488d160" class="outline-4">
<h4 id="org488d160"><span class="section-number-4">1.7.3.</span> 不同的 cpu 存在不同的 保证： strongly-ordered(Inter) and weakly-ordered(Arm)</h4>
<div class="outline-text-4" id="text-1-7-3">
</div>
<ol class="org-ol">
<li><a id="orgdaddcd0"></a>在提供 strongly-ordered 的cpu 上，要求强order，花费非常小， 在weakly-ordered 的cpu上，要求强order， 则代价非常大。<br /></li>
</ol>
</div>
<div id="outline-container-org5dfba25" class="outline-4">
<h4 id="org5dfba25"><span class="section-number-4">1.7.4.</span> C++ 内存模型通过 因果一致  （causality result） 来弥补 cpu/ compiler 之间的差异。</h4>
</div>
<div id="outline-container-orgc8830bc" class="outline-4">
<h4 id="orgc8830bc"><span class="section-number-4">1.7.5.</span> data access：</h4>
<div class="outline-text-4" id="text-1-7-5">
</div>
<ol class="org-ol">
<li><a id="org67040d5"></a>基础的数据访问是 不同步的， compiler 可以自由的优化，cpu 可以自由的 将 数据更改 传播到 其他线程，<br /></li>
<li><a id="org8417767"></a>关键的是： 数据访问是 竞争（race）发生的重要方式。<br /></li>
<li><a id="orgd864276"></a>在没有限制的数据访问 基础之上 是不可能构建出 sync 代码的。<br /></li>
<li><a id="org92a4955"></a>Atomic 告诉 hardware/compiler 程序是 多线程的。<br /></li>
<li><a id="orgb038c55"></a>通过 限制  compiler / hardware 不能做的事情， 来实现 正确的数据访问。 分为 限制 compiler 指令重排 , 以及 hardward 如何将变量更改传播到其他 thread<br /></li>
</ol>
</div>
<div id="outline-container-org9bee49f" class="outline-4">
<h4 id="org9bee49f"><span class="section-number-4">1.7.6.</span> rust 的 Ordering: 类型</h4>
<div class="outline-text-4" id="text-1-7-6">
</div>
<ol class="org-ol">
<li><a id="org6db86b7"></a>Sequentially Consistent (SeqCst)<br /></li>
<li><a id="orgfd7e0cf"></a>Release<br /></li>
<li><a id="orgf33a543"></a>Acquire<br /></li>
<li><a id="orge940a5e"></a>Relaxed<br /></li>
</ol>
</div>
<div id="outline-container-orgebceaec" class="outline-4">
<h4 id="orgebceaec"><span class="section-number-4">1.7.7.</span> Sequentially Consistent: 最为安全的模式，将限制Compiler 对于指令的重排，Hardware则将更改完全同步到 其他 thread。代价： 即便是 strongly-ordered cpu 依然 可能需要使用 momory fences(内存栅栏) 来实现</h4>
</div>
<div id="outline-container-org4bff3de" class="outline-4">
<h4 id="org4bff3de"><span class="section-number-4">1.7.8.</span> Acquire-Release: 非常适合 lock 的 acquire/release, 确保关键部分内容 不会重叠（overlap）</h4>
<div class="outline-text-4" id="text-1-7-8">
</div>
<ol class="org-ol">
<li><a id="orgb538136"></a>Acquire: 保证之后的每个访问 都发生在 之后（compiler 不会重排它之后的指令到 之前， 但是可以 将 它之前的访问指令 重排到 它之后）<br /></li>
<li><a id="org2ee5a2d"></a>Release: 保证之前的指令 都发生在它之前（compiler 不会重排它 之前的指令到 之后， 但是可以将 它 之后发生的指令 重排 到它之前）<br /></li>
<li><a id="org0b1f1cf"></a>hardware 保证 对于 相同变量的更改 将由所有 thread 观察到<br />
<div class="outline-text-5" id="text-1-7-8-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">sync</span>::<span style="color: #98f5ff;">Arc</span>;
<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">sync</span>::<span style="color: #a2cd5a;">atomic</span>::<span style="color: #8c8c8c;">{</span><span style="color: #98f5ff;">AtomicBool</span>, <span style="color: #98f5ff;">Ordering</span><span style="color: #8c8c8c;">}</span>;
<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">std</span>::thread;

<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">main</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">lock</span> = <span style="color: #98f5ff;">Arc</span>::new<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">AtomicBool</span>::new<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">false</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>; <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">value answers "am I locked?"</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">... distribute lock to threads somehow ...</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Try to acquire the lock by setting it to true</span>
    <span style="color: #00bfff;">while</span> lock.compare_and_swap<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">false</span>, <span style="color: #00bfff;">true</span>, <span style="color: #98f5ff;">Ordering</span>::<span style="color: #98f5ff;">Acquire</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span> <span style="color: #93a8c6;">}</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">broke out of the loop, so we successfully acquired the lock!</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">... scary data accesses ...</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">ok we're done, release the lock</span>
    lock.store<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">false</span>, <span style="color: #98f5ff;">Ordering</span>::<span style="color: #98f5ff;">Release</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</li>
<li><a id="org878f13a"></a>使用 Acquire 以及 Release 的组合，能够保证在 范围内的 代码 始终在  acquire/realse 范围包围内。<br /></li>
</ol>
</div>
<div id="outline-container-org4d634d4" class="outline-4">
<h4 id="org4d634d4"><span class="section-number-4">1.7.9.</span> Relaxed： 最弱的atomic order， 但依然是 atomic， read-modify-write 依然是原子操作， 不能够提供 Acquire/Release 提供的保证。对于  weakly-order cpu 非常好用</h4>
</div>
<div id="outline-container-orge1dc00e" class="outline-4">
<h4 id="orge1dc00e"><span class="section-number-4">1.7.10.</span> fense: 栅栏，rust还提供了  fense 操作， 在Arc 的Drop 操作中，使用 来保证 代码顺序的发生</h4>
<div class="outline-text-4" id="text-1-7-10">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Drop</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Arc</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">drop</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">inner</span> = <span style="color: #ff0000;">unsafe</span> <span style="color: #b0b1a3;">{</span> <span style="color: #00bfff;">self</span>.ptr.as_ref<span style="color: #97b098;">()</span> <span style="color: #b0b1a3;">}</span>;
        <span style="color: #00bfff;">if</span> inner.rc.fetch_sub<span style="color: #b0b1a3;">(</span>1, <span style="color: #98f5ff;">Ordering</span>::<span style="color: #98f5ff;">Release</span><span style="color: #b0b1a3;">)</span> != 1 <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">return</span>;
        <span style="color: #b0b1a3;">}</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This fence is needed to prevent reordering of the use and deletion</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">of the data.</span>
        <span style="color: #a2cd5a;">atomic</span>::fence<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Ordering</span>::<span style="color: #98f5ff;">Acquire</span><span style="color: #b0b1a3;">)</span>;
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This is safe as we know we have the last pointer to the `ArcInner`</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">and that its pointer is valid.</span>
        <span style="color: #ff0000;">unsafe</span> <span style="color: #b0b1a3;">{</span> <span style="color: #98f5ff;">Box</span>::from_raw<span style="color: #97b098;">(</span><span style="color: #00bfff;">self</span>.ptr.as_ptr<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span>; <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcd419d6" class="outline-3">
<h3 id="orgcd419d6"><span class="section-number-3">1.8.</span> STD::Thread 标准库中的thread</h3>
<div class="outline-text-3" id="text-1-8">
</div>
<div id="outline-container-org9000e87" class="outline-4">
<h4 id="org9000e87"><span class="section-number-4">1.8.1.</span> 1. Builder  用来 自定义Thread name, stack_size 参数配置</h4>
</div>
<div id="outline-container-orgcbb0787" class="outline-4">
<h4 id="orgcbb0787"><span class="section-number-4">1.8.2.</span> 2. ::spawn(f) 经过层层调用, 最终为: <a href="file:///Users/lishaohua/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/std/src/thread/mod.rs:463">spawn_unchecked_</a> 其 内部 组装 main函数, __rust_begin_short_backtrace(f), 并调用  imp::Thread::new(stack_size, Box::new(main)) //可能为 系统native调用</h4>
<div class="outline-text-4" id="text-1-8-2">
<pre class="example" id="orgfd4933d">

// just build a Thread struct ,no spawn, 其中 包含 Parker Object
let my_thread = Thread::new(name.map(|name| {
    CString::new(name).expect("thread name may not contain interior null bytes")
}));

let main = move || {
    if let Some(name) = their_thread.cname() {
        imp::Thread::set_name(name);
    }

    crate::io::set_output_capture(output_capture);

    // SAFETY: the stack guard passed is the one for the current thread.
    // This means the current thread's stack and the new thread's stack
    // are properly set and protected from each other.
    thread_info::set(unsafe { imp::guard::current() }, their_thread);
    let try_result = panic::catch_unwind(panic::AssertUnwindSafe(|| {
        crate::sys_common::backtrace::__rust_begin_short_backtrace(f)
    }));
    // SAFETY: `their_packet` as been built just above and moved by the
    // closure (it is an Arc&lt;...&gt;) and `my_packet` will be stored in the
    // same `JoinInner` as this closure meaning the mutation will be
    // safe (not modify it and affect a value far away).
    unsafe { *their_packet.result.get() = Some(try_result) };
};

if let Some(scope_data) = &amp;my_packet.scope {
    scope_data.increment_num_running_threads();
}

Ok(JoinInner {
    // SAFETY:
    //
    // `imp::Thread::new` takes a closure with a `'static` lifetime, since it's passed
    // through FFI or otherwise used with low-level threading primitives that have no
    // notion of or way to enforce lifetimes.
    //
    // As mentioned in the `Safety` section of this function's documentation, the caller of
    // this function needs to guarantee that the passed-in lifetime is sufficiently long
    // for the lifetime of the thread.
    //
    // Similarly, the `sys` implementation must guarantee that no references to the closure
    // exist after the thread has terminated, which is signaled by `Thread::join`
    // returning.
    native: unsafe {
        imp::Thread::new(
            stack_size,
            mem::transmute::&lt;Box&lt;dyn FnOnce() + 'a&gt;, Box&lt;dyn FnOnce() + 'static&gt;&gt;(
                Box::new(main),
            ),
        )?
    },
    thread: my_thread,
    packet: my_packet,
})
</pre>
</div>
</div>
<div id="outline-container-org80d81a1" class="outline-4">
<h4 id="org80d81a1"><span class="section-number-4">1.8.3.</span> 3. thread::park()  的实现, Parker 结构如下:</h4>
<div class="outline-text-4" id="text-1-8-3">
<pre class="example" id="org52ad6c6">
pub struct Parker {
    state: AtomicUsize, // aotmic 变量
    lock: UnsafeCell&lt;libc::pthread_mutex_t&gt;,// 锁,  对于park()的实现 尤为重要
    cvar: UnsafeCell&lt;libc::pthread_cond_t&gt;,//  条件变量
    // The `pthread` primitives require a stable address, so make this struct `!Unpin`.
    _pinned: PhantomPinned,
}
</pre>
</div>
<ol class="org-ol">
<li><a id="org3159095"></a>所以 Thread::spawn 的整体过程为: 1) builder &amp; spawn, spawn 过程中, native::spawn  +  构建 Thread 对象  2) park: 使用 Thread 对象 中的 Parker 对象, 进行 lock 操作 3) unpark<br /></li>
<li><a id="org5cd3ac8"></a>同 Linux Programing Interface 中的 基本一致 , 只是 将 cvar lock 封装到了 同一个 Thread 中, 方便了 操作, 并扩展了 原生 Thread 的 功能<br /></li>
</ol>
</div>
</div>

<div id="outline-container-org5db8131" class="outline-3">
<h3 id="org5db8131"><span class="section-number-3">1.9.</span> STD: mpsc;:channel :  是如何 实现的</h3>
<div class="outline-text-3" id="text-1-9">
</div>
<div id="outline-container-org146d36a" class="outline-4">
<h4 id="org146d36a"><span class="section-number-4">1.9.1.</span> 代码整体</h4>
<div class="outline-text-4" id="text-1-9-1">
<pre class="example" id="org345fe00">
pub struct Sender&lt;T&gt; {
  inner: UnsafeCell&lt;Flavor&lt;T&gt;&gt;,
}

pub struct Receiver&lt;T&gt; {
    inner: UnsafeCell&lt;Flavor&lt;T&gt;&gt;,
}

enum Flavor&lt;T&gt; {
    Oneshot(Arc&lt;oneshot::Packet&lt;T&gt;&gt;),
    Stream(Arc&lt;stream::Packet&lt;T&gt;&gt;),
    Shared(Arc&lt;shared::Packet&lt;T&gt;&gt;),
    Sync(Arc&lt;sync::Packet&lt;T&gt;&gt;),
}

pub fn channel&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let a = Arc::new(oneshot::Packet::new());
    (Sender::new(Flavor::Oneshot(a.clone())), Receiver::new(Flavor::Oneshot(a)))
}

// stream
pub struct Packet&lt;T&gt; {
    // internal queue for all messages
    queue: spsc::Queue&lt;Message&lt;T&gt;, ProducerAddition, ConsumerAddition&gt;,
}

</pre>
</div>
</div>
<div id="outline-container-org7db995a" class="outline-4">
<h4 id="org7db995a"><span class="section-number-4">1.9.2.</span> mpsc::channel 将创建 一个 onshot::Packet(), 所以为何怒在 Flavor的多种enum?</h4>
</div>
<div id="outline-container-orgb911ad9" class="outline-4">
<h4 id="orgb911ad9"><span class="section-number-4">1.9.3.</span> Flavor::OneShot() 为 只send(T) 一次 的优化版本, 当第二次 进行send调用时候, 将进行 upgrade 到 Flavor&lt;Stream&gt;</h4>
<div class="outline-text-4" id="text-1-9-3">
<pre class="example" id="org91ae2ee">
pub fn send(&amp;self, t: T) -&gt; Result&lt;(), SendError&lt;T&gt;&gt; {
    let (new_inner, ret) = match *unsafe { self.inner() } {
        Flavor::Oneshot(ref p) =&gt; {
            if !p.sent() { // 只能通过一次 
                return p.send(t).map_err(SendError);
            } else {
                let a = Arc::new(stream::Packet::new()); // Receiver 升级到 Stream::Packet, 这里面 的 memory layout设计 应该比较复杂,难以理解, 是否涉及到 memory 的增长方向呢? 
                let rx = Receiver::new(Flavor::Stream(a.clone()));
                match p.upgrade(rx) { // 进行upgrade
                    oneshot::UpSuccess =&gt; {
                        let ret = a.send(t);
                        (a, ret)
                    }
                    oneshot::UpDisconnected =&gt; (a, Err(t)),
                    oneshot::UpWoke(token) =&gt; {
                        // This send cannot panic because the thread is
                        // asleep (we're looking at it), so the receiver
                        // can't go away.
                        a.send(t).ok().unwrap();
                        token.signal();
                        (a, Ok(()))
                    }
                }
            }
        }
        Flavor::Stream(ref p) =&gt; return p.send(t).map_err(SendError),
        Flavor::Shared(ref p) =&gt; return p.send(t).map_err(SendError),
        Flavor::Sync(..) =&gt; unreachable!(),
    };

    unsafe {
        let tmp = Sender::new(Flavor::Stream(new_inner)); // Sender 进行升级 
        mem::swap(self.inner_mut(), tmp.inner_mut());
    }
    ret.map_err(SendError)
}
</pre>
</div>
</div>
<div id="outline-container-org08e7546" class="outline-4">
<h4 id="org08e7546"><span class="section-number-4">1.9.4.</span> 整体逻辑为: 将 替换  Receiver, Sender 中的 inner  Receiver { inner: UnsafeCell&lt;Flavor::Oneshot(Arc&lt;oneshot::Packet&lt;T&gt;&gt;)&gt; } -&gt;  Receiver { inner: UnsafeCell&lt;Flavor::Stream(Arc&lt;stream::Packet&lt;T&gt;&gt;)&gt; } , sender 类似</h4>
</div>
<div id="outline-container-org21b9663" class="outline-4">
<h4 id="org21b9663"><span class="section-number-4">1.9.5.</span> stream  即为 queue: 需要详细分析一下:</h4>
</div>
<div id="outline-container-orgd09e683" class="outline-4">
<h4 id="orgd09e683"><span class="section-number-4">1.9.6.</span> 代码如下:</h4>
<div class="outline-text-4" id="text-1-9-6">
<pre class="example" id="org414535b">
pub fn channel&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let a = Arc::new(oneshot::Packet::new());
    (Sender::new(Flavor::Oneshot(a.clone())), Receiver::new(Flavor::Oneshot(a)))
}

pub struct Sender&lt;T&gt; {
    inner: UnsafeCell&lt;Flavor&lt;T&gt;&gt;,
}

enum Flavor&lt;T&gt; {
    Oneshot(Arc&lt;oneshot::Packet&lt;T&gt;&gt;),
    Stream(Arc&lt;stream::Packet&lt;T&gt;&gt;),
    Shared(Arc&lt;shared::Packet&lt;T&gt;&gt;),
    Sync(Arc&lt;sync::Packet&lt;T&gt;&gt;),
}

// stream::Packet&lt;T&gt;
pub struct Packet&lt;T&gt; {
    // internal queue for all messages
    queue: spsc::Queue&lt;Message&lt;T&gt;, ProducerAddition, ConsumerAddition&gt;,
}

pub struct Queue&lt;T, ProducerAddition = (), ConsumerAddition = ()&gt; {
    // consumer fields
    consumer: CacheAligned&lt;Consumer&lt;T, ConsumerAddition&gt;&gt;,

    // producer fields
    producer: CacheAligned&lt;Producer&lt;T, ProducerAddition&gt;&gt;,
}
pub(super) struct CacheAligned&lt;T&gt;(pub T);

struct Consumer&lt;T, Addition&gt; {
    tail: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;, // where to pop from
    tail_prev: AtomicPtr&lt;Node&lt;T&gt;&gt;,  // where to pop from
    cache_bound: usize,             // maximum cache size
    cached_nodes: AtomicUsize,      // number of nodes marked as cacheable
    addition: Addition,
}

struct Producer&lt;T, Addition&gt; {
    head: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,      // where to push to
    first: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,     // where to get new nodes from
    tail_copy: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;, // between first/tail
    addition: Addition,
}

struct ProducerAddition {
    cnt: AtomicIsize,       // How many items are on this channel
    to_wake: AtomicPtr&lt;u8&gt;, // SignalToken for the blocked thread to wake up

    port_dropped: AtomicBool, // flag if the channel has been destroyed.
}

struct ConsumerAddition {
    steals: UnsafeCell&lt;isize&gt;, // How many times has a port received without blocking?
}

// so the sender &amp; receiver 's type is:

Sender {
 inner: UnsafeCell&lt;Flavor::Stream&lt;Arc&lt;stream::Packet {
     queue: spsc::Queue {
        consumer: CacheAligned(pub Consumer&lt;T, ConsumerAddition&gt; {
           tail: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,
           tail_prev: AtomicPtr&lt;Node&lt;T&gt;&gt;,
           cache_bound: usize,
           cached_nodes: AotmicUsize,
           addition: ConsumerAddition,
        })
        producer: Producer&lt;T, ProducerAddition&gt; {
          head: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,      // where to push to
          first: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,     // where to get new nodes from
          tail_copy: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;, // between first/tail
          addition: ProducerAddition,
        }
      },
    }&gt;&gt;&gt;
}

Receiver {
 inner: UnsafeCell&lt;Flavor::Stream&lt;Arc&lt;stream::Packet {
     queue: spsc::Queue {
        consumer: CacheAligned(pub Consumer&lt;T, ConsumerAddition&gt; {
           tail: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,
           tail_prev: AtomicPtr&lt;Node&lt;T&gt;&gt;,
           cache_bound: usize,
           cached_nodes: AotmicUsize,
           addition: ConsumerAddition,
        })
        producer: Producer&lt;T, ProducerAddition&gt; {
          head: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,      // where to push to
          first: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;,     // where to get new nodes from
          tail_copy: UnsafeCell&lt;*mut Node&lt;T&gt;&gt;, // between first/tail
          addition: ProducerAddition,
        }
      },
    }&gt;&gt;&gt;

impl&lt;T&gt; Packet&lt;T&gt; {
    pub fn new() -&gt; Packet&lt;T&gt; {
        Packet {
            queue: unsafe {
                spsc::Queue::with_additions(
                    128,
                    ProducerAddition {
                        cnt: AtomicIsize::new(0),
                        to_wake: AtomicPtr::new(EMPTY),

                        port_dropped: AtomicBool::new(false),
                    },
                    ConsumerAddition { steals: UnsafeCell::new(0) },
                )
            },
        }
    }
  }
}

</pre>
</div>
</div>
<div id="outline-container-orgf2a3192" class="outline-4">
<h4 id="orgf2a3192"><span class="section-number-4">1.9.7.</span> Sender &amp; Receiver 共享 inner 中的 Arc&lt;stream::Packet&gt;, 主要为queue</h4>
</div>
<div id="outline-container-org779c698" class="outline-4">
<h4 id="org779c698"><span class="section-number-4">1.9.8.</span> Queue: 中  consumer &amp; producer 使用链表, 共享 同样的内存空间</h4>
</div>
<div id="outline-container-orgd4146a8" class="outline-4">
<h4 id="orgd4146a8"><span class="section-number-4">1.9.9.</span> ConsumerAddition, ProducerAddition: ProducerAddition 中比较重要,</h4>
<div class="outline-text-4" id="text-1-9-9">
</div>
<ol class="org-ol">
<li><a id="orgdf44ccf"></a>1. 其中的 to_wake 为 SignalToken的指针, 当 Receiver 在 recv() 阻塞时候,会 填充 producer.addition.to_wake, 当producer.send() 时候,会 唤醒 recv<br /></li>
<li><a id="orgfa8790f"></a>2. sender.send 并不会 阻塞, 因为 多个 Sender ? 反而 阻塞 receiver.recv ? 为什么 会如此设计?<br /></li>
<li><a id="orgcc1320e"></a><a href="https://doc.rust-lang.org/std/sync/mpsc/">https://doc.rust-lang.org/std/sync/mpsc/</a>  查询 文档 可知,<br /></li>
<li><a id="org5799908"></a>channnel 存在 1) 无bound 即 有 infinite buffer 2) bound buff, 即 pre-allocate fixed buff<br /></li>
<li><a id="orgd4764f9"></a>bound buff 会阻塞 Sender.send 操作<br /></li>
<li><a id="orgcaedb18"></a>sync_channle 中的 Buffer 为一个 ring buff<br />
<ol class="org-ol">
<li><a id="org1d47238"></a>环形 buff, 只需要 保持 start + size 两个变量, 即可<br /></li>
<li><a id="orgc7407db"></a>1. push/enqueue: 将size + 1, pos = (start + size) / buff.len<br /></li>
<li><a id="orge7008e0"></a>2. pop/denque: 将 pos = start, start += 1, size - 1<br /></li>
<li><a id="org7974d6f"></a>可以保持 size 永远小于 buff.len()<br /></li>
<li><a id="org9589cb5"></a>start  为 首, (start + size) / buff.len() 为 尾部<br /></li>
<li><a id="org28387c6"></a>但是 该种 实现, 导致 每次操作 都需要 lock的帮助, 实现完全的互斥, 才能 保证操作完整<br />
<div class="outline-text-6" id="text-1-9-9-6-6">
<pre class="example" id="orga95a75c">
impl&lt;T&gt; Buffer&lt;T&gt; {
    fn enqueue(&amp;mut self, t: T) {
        let pos = (self.start + self.size) % self.buf.len();
        self.size += 1;
        let prev = mem::replace(&amp;mut self.buf[pos], Some(t));
        assert!(prev.is_none());
    }

    fn dequeue(&amp;mut self) -&gt; T {
        let start = self.start;
        self.size -= 1;
        self.start = (self.start + 1) % self.buf.len();
        let result = &amp;mut self.buf[start];
        result.take().unwrap()
    }

    fn size(&amp;self) -&gt; usize {
        self.size
    }
    fn capacity(&amp;self) -&gt; usize {
        self.buf.len()
    }
}
</pre>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org500cd46" class="outline-4">
<h4 id="org500cd46"><span class="section-number-4">1.9.10.</span> </h4>
</div>
</div>
</div>

<div id="outline-container-orgd64c1d9" class="outline-2">
<h2 id="orgd64c1d9"><span class="section-number-2">2.</span> Error handle, rust 是如何处理error的?</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org82aae61" class="outline-3">
<h3 id="org82aae61"><span class="section-number-3">2.1.</span> ? : operator expression &amp; From 机制:</h3>
<div class="outline-text-3" id="text-2-1">
<p>
参考资料： ?  <a href="https://web.mit.edu/rust-lang_v1.25/arch/amd64_ubuntu1404/share/doc/rust/html/reference/expressions/operator-expr.html#the-question-mark-operator">详细解释</a>  <a href="https://github.com/rust-lang/rfcs/blob/master/text/0243-trait-based-exception-handling.md">rfc</a> <a href="https://stackoverflow.com/questions/40545332/is-the-question-mark-operator-equivalent-to-the-try-macro">stackoverflow</a>
? 主要为了解决 Error throw 的问题，即是： 一个函数 声明返回  一个Type，那个返回其subType 依然是可以的， rust中使用 From trait 来实现
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">f</span> = <span style="color: #98f5ff;">File</span>::open<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"foo.txt"</span><span style="color: #8c8c8c;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;

<span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">&#31561;&#20215;&#20110;&#19979;&#38754;</span>
<span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">f</span> = <span style="color: #00bfff;">match</span> <span style="color: #98f5ff;">File</span>::<span style="color: #98f5ff;">Open</span><span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"foo.txt"</span><span style="color: #8c8c8c;">)</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #98f5ff;">Ok</span><span style="color: #93a8c6;">(</span>v<span style="color: #93a8c6;">)</span> =&gt; v,
    <span style="color: #98f5ff;">Err</span><span style="color: #93a8c6;">(</span>e<span style="color: #93a8c6;">)</span> =&gt; <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">From</span>::from<span style="color: #b0b1a3;">(</span>e<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span> <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#36825;&#37324;&#36827;&#34892;&#20102; From::from(e) &#30340;&#36716;&#36716;&#25442;&#35843;&#29992;&#65292;</span>
<span style="color: #8c8c8c;">}</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org39bbbc8" class="outline-3">
<h3 id="org39bbbc8"><span class="section-number-3">2.2.</span> std: 标准库 中是如何使用 实现的?</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org5789ea0" class="outline-4">
<h4 id="org5789ea0"><span class="section-number-4">2.2.1.</span> <a href="file:///Users/lishaohua/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/result.rs:504">Result</a> core 中自定义了 Result  为一个 enum, 而并没有定义E 的类型</h4>
</div>
<div id="outline-container-orgc31ac37" class="outline-4">
<h4 id="orgc31ac37"><span class="section-number-4">2.2.2.</span> std 库 定义了 多种 Error 类型, 包括 <a href="file:///Users/lishaohua/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/std/src/io/error.rs:68">std::io::Error</a>, std::fmt::Error,  <a href="file:///Users/lishaohua/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/num/error.rs:69">std::num::ParseIntError</a> &#x2026; etc,每种 自定义Error 不尽相同:</h4>
</div>
<div id="outline-container-orgb5db33c" class="outline-4">
<h4 id="orgb5db33c"><span class="section-number-4">2.2.3.</span> std::error: 提供 构建、 handle、 report、 propagating Rust 错误,  构建(表示 ) 即为: Result, error trait , custome  types  &amp; failure 处理模式:</h4>
</div>
<div id="outline-container-org19895eb" class="outline-4">
<h4 id="org19895eb"><span class="section-number-4">2.2.4.</span> trait: Error : Debug + Display {} 表达错误的基本结构, description(), cause(), type_id() etc&#x2026;</h4>
</div>
<div id="outline-container-org3853bc0" class="outline-4">
<h4 id="org3853bc0"><span class="section-number-4">2.2.5.</span> Box&lt;dyn Error + 'a&gt;  {fn from(err: E) -&gt; Box&lt;dyn Error + 'a&gt; {Box::new(err)};</h4>
</div>
<div id="outline-container-org670e36f" class="outline-4">
<h4 id="org670e36f"><span class="section-number-4">2.2.6.</span> <a href="file:///Users/lishaohua/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/std/src/error.rs:1313">Report:</a>  提供 error 的格式化工作, (通过配置 来控制 )</h4>
</div>
</div>
<div id="outline-container-orgc8378fd" class="outline-3">
<h3 id="orgc8378fd"><span class="section-number-3">2.3.</span> Result::unwrap/expect 的区别: expect 接受参数, 来自定义 panic时候的 错误输出</h3>
</div>
<div id="outline-container-org56c4e0f" class="outline-3">
<h3 id="org56c4e0f"><span class="section-number-3">2.4.</span> error-chain: impl details:</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-rust">    <span style="color: #ffd700;">error_chain!</span> <span style="color: #8c8c8c;">{</span>
        foreign_links <span style="color: #93a8c6;">{</span>
            <span style="color: #98f5ff;">IoErr</span><span style="color: #b0b1a3;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">)</span>;
        <span style="color: #93a8c6;">}</span>

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#23450;&#20041;&#26032;&#30340;  ErrorKind enum; enum { InvalidToken(String) }</span>
        errors <span style="color: #93a8c6;">{</span>
            <span style="color: #98f5ff;">InvalidToken</span><span style="color: #b0b1a3;">(</span><span style="color: #4eee94;">t</span>: <span style="color: #98f5ff;">String</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">{</span>
                description<span style="color: #97b098;">(</span><span style="color: #deb887;">"invalid token"</span><span style="color: #97b098;">)</span>
                display<span style="color: #97b098;">(</span><span style="color: #deb887;">"invalid token display"</span><span style="color: #97b098;">)</span>
            <span style="color: #b0b1a3;">}</span>
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>
<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#23637;&#24320;&#22914;&#19979; expand</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" The Error type."</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">""</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" This tuple struct is made of two elements:"</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">""</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" - an `ErrorKind` which is used to determine the type of the error."</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" - An internal `State`, not meant for direct use outside of `error_chain`"</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">"   internals, containing:"</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">"   - a backtrace, generated when the error is created."</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">"   - an error chain, used for the implementation of `Error::cause()`."</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Debug</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Error</span><span style="color: #8c8c8c;">(</span><span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" The kind of the error."</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #98f5ff;">ErrorKind</span>, <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Contains the error chain and the backtrace."</span><span style="color: #93a8c6;">]</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">hidden</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">pub</span> $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">State</span>, <span style="color: #7f7f7f;">//// </span><span style="color: #7f7f7f;">State &#30340;&#20316;&#29992;&#26159;&#20160;&#20040;</span>
<span style="color: #8c8c8c;">)</span>;

<span style="color: #00bfff;">impl</span> $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">ChainedError</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">ErrorKind</span> = <span style="color: #98f5ff;">ErrorKind</span>;
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">kind</span>:<span style="color: #98f5ff;">ErrorKind</span>,<span style="color: #4eee94;">state</span>:$<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">State</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Error</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">(</span>kind,state<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from_kind</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">kind</span>:<span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Self</span>::from_kind<span style="color: #b0b1a3;">(</span>kind<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">with_chain</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">E</span>,<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">error</span>:<span style="color: #98f5ff;">E</span>,<span style="color: #4eee94;">kind</span>:<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">E</span>: ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span>+<span style="color: #98f5ff;">Send</span>+ '<span style="color: #00bfff;">static</span>,<span style="color: #4eee94;">K</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #98f5ff;">Self</span>::with_chain<span style="color: #b0b1a3;">(</span>error,kind<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">kind</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt;  <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">ErrorKind</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #00bfff;">self</span>.kind<span style="color: #b0b1a3;">()</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">iter</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">Iter</span> <span style="color: #93a8c6;">{</span>
    $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">Iter</span>::new<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">self</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">chain_err</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>,<span style="color: #98f5ff;">EK</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">error</span>:<span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>:<span style="color: #98f5ff;">FnOnce</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">EK</span>,<span style="color: #4eee94;">EK</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #00bfff;">self</span>.chain_err<span style="color: #b0b1a3;">(</span>error<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">backtrace</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>$<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">Backtrace</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #00bfff;">self</span>.backtrace<span style="color: #b0b1a3;">()</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">unknown_lints,renamed_and_removed_lints,bare_trait_objects</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">unused_doc_comment,unused_doc_comments</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">extract_backtrace</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #b0b1a3;">(</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span>+<span style="color: #98f5ff;">Send</span>+ '<span style="color: #00bfff;">static</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span>$<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">InternalBacktrace</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #b0b1a3;">(</span>e<span style="color: #b0b1a3;">)</span> = e.downcast_ref::<span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">&gt;(){</span>
      <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>e.1.backtrace.clone<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span>;

    <span style="color: #b0b1a3;">}</span><span style="color: #98f5ff;">None</span>
  <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">allow</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">dead_code</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Constructs an error from a kind, and generates a backtrace."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from_kind</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">kind</span>:<span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Error</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">(</span>kind,$<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">State</span>::default<span style="color: #97b098;">()</span>,<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Constructs a chained error from another error and a kind, and generates a backtrace."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">with_chain</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">E</span>,<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">error</span>:<span style="color: #98f5ff;">E</span>,<span style="color: #4eee94;">kind</span>:<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Error</span> <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">E</span>: ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span>+<span style="color: #98f5ff;">Send</span>+ '<span style="color: #00bfff;">static</span>,<span style="color: #4eee94;">K</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #98f5ff;">Error</span>::with_boxed_chain<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Box</span>::new<span style="color: #97b098;">(</span>error<span style="color: #97b098;">)</span>,kind<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Construct a chained error from another boxed error and a kind, and generates a backtrace"</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">unknown_lints,bare_trait_objects</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">with_boxed_chain</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">error</span>:<span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span>+<span style="color: #98f5ff;">Send</span><span style="color: #b0b1a3;">&gt;</span>,<span style="color: #4eee94;">kind</span>:<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Error</span> <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">K</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">(</span>kind.into<span style="color: #97b098;">()</span>,$<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">State</span>::new::<span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">Error</span><span style="color: #97b098;">&gt;(</span>error,<span style="color: #97b098;">)</span>,<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Returns the kind of the error."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">kind</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt;  <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">ErrorKind</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.0
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Iterates over the error chain."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">iter</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">Iter</span> <span style="color: #93a8c6;">{</span>
    $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">ChainedError</span>::iter<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Returns the backtrace associated with this error."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">backtrace</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>$<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">Backtrace</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #00bfff;">self</span>.1.backtrace<span style="color: #b0b1a3;">()</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Extends the error chain with a new entry."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">chain_err</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>,<span style="color: #98f5ff;">EK</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">error</span>:<span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Error</span> <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>:<span style="color: #98f5ff;">FnOnce</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">EK</span>,<span style="color: #4eee94;">EK</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #98f5ff;">Error</span>::with_chain<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>,<span style="color: #98f5ff;">Self</span>::from_kind<span style="color: #97b098;">(</span>error<span style="color: #aebed8;">()</span>.into<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" A short description of the error."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" This method is identical to [`Error::description()`](https://doc.rust-lang.org/nightly/std/error/trait.Error.html#tymethod.description)"</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">description</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt;  <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #00bfff;">self</span>.0.description<span style="color: #b0b1a3;">()</span>
  <span style="color: #93a8c6;">}</span>

 <span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">not</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">has_error_description_deprecated</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">description</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt;  <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #00bfff;">self</span>.description<span style="color: #b0b1a3;">()</span>
  <span style="color: #93a8c6;">}</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">unknown_lints,renamed_and_removed_lints,bare_trait_objects</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">unused_doc_comment,unused_doc_comments</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">source</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #b0b1a3;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span>+ '<span style="color: #00bfff;">static</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.1.next_error <span style="color: #b0b1a3;">{</span>
      <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">c</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>**c<span style="color: #97b098;">)</span>,
      <span style="color: #98f5ff;">None</span> =&gt; <span style="color: #97b098;">{</span>
        <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.0 <span style="color: #aebed8;">{</span>
          <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">IoErr</span><span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">foreign_err</span><span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
            foreign_err.source<span style="color: #90a890;">()</span>
          <span style="color: #b0b0b3;">}</span>
          _ =&gt; <span style="color: #98f5ff;">None</span>
          <span style="color: #aebed8;">}</span>
      <span style="color: #97b098;">}</span>
    <span style="color: #b0b1a3;">}</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" The kind of an error."</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Debug</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span> <span style="color: #7f7f7f;">//// </span><span style="color: #7f7f7f;">Error&#20013; &#20026;&#20160;&#20040;&#19981;&#30452;&#25509; &#23450;&#20041;enum&#65292; &#32780;&#26159;&#20351;&#29992;ErrorKind&#65311; &#20026;&#20102;&#35774;&#35745;&#21543;&#65292; std&#20013;&#20063;&#23384;&#22312;&#31867;&#20284;&#30340;ErrorKind &#22312;io::error &#20013;</span>
  <span style="color: #98f5ff;">IoErr</span><span style="color: #93a8c6;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">)</span>, <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" A convenient variant for String."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #98f5ff;">Msg</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>,
  <span style="color: #98f5ff;">InvalidToken</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>, <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">hidden</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  __Nonexhaustive<span style="color: #93a8c6;">{}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Error &#30340;From  impl&#65292; &#21487;&#20197;&#23558; std error &#31867;&#22411;&#36716;&#25442;&#20026; Error&#65292; &#22312;&#20989;&#25968;&#20013; &#21487;&#20197;&#30452;&#25509;&#25243;&#20986; std Error</span>
<span style="color: #00bfff;">impl</span> ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">fmt</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">f</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Formatter</span><span style="color: #93a8c6;">)</span> -&gt;  ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Result</span> <span style="color: #93a8c6;">{</span>
    ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.0,f<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span>::from_kind<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">IoErr</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span>::from_kind<span style="color: #b0b1a3;">(</span>e<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #8c8c8c;">&lt;</span> '<span style="color: #4eee94;">a</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span>&amp; '<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>: &amp; '<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #b0b1a3;">(</span>s.into<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>

  <span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>:<span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #b0b1a3;">(</span>s<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>
<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#31616;&#21270; Error&#30340;&#20135;&#29983;&#65292;&#20351;&#29992; str&#65292; String &#36716;&#21270;&#20026; Error&#65292; &#26041;&#20415;&#24322;&#24120;&#30340;throw, &#22240;&#20026;Error &#30001; ErrorKind &#26500;&#25104;&#65292;&#25152;&#20197;&#38656;&#35201;&#23454;&#29616; From&lt;&amp;str&gt; for ErrorKind</span>
<span style="color: #00bfff;">impl</span> <span style="color: #8c8c8c;">&lt;</span> '<span style="color: #4eee94;">a</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span>&amp; '<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>: &amp; '<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Self</span>::from_kind<span style="color: #b0b1a3;">(</span>s.into<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>:<span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Self</span>::from_kind<span style="color: #b0b1a3;">(</span>s.into<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">format display</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">allow</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">unknown_lints,unused,renamed_and_removed_lints</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">allow</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">unused_doc_comment,unused_doc_comments</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">impl</span> ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">fmt</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">fmt</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Formatter</span><span style="color: #93a8c6;">)</span> -&gt;  ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Result</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #00bfff;">match</span>*<span style="color: #00bfff;">self</span> <span style="color: #b0b1a3;">{</span>
      <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">IoErr</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">err</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #97b098;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">display_fn</span> = |_,<span style="color: #4eee94;">f</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Formatter</span>|<span style="color: #aebed8;">{</span>
          f.write_fmt<span style="color: #b0b0b3;">(</span><span style="color: #ff0000;">unsafe</span> <span style="color: #90a890;">{</span>
            <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Arguments</span>::new_v1<span style="color: #a2b6da;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">[]</span>, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">[</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #93a8c6;">(</span>err<span style="color: #93a8c6;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #8c8c8c;">)</span>,<span style="color: #9cb6ad;">]</span><span style="color: #a2b6da;">)</span>
          <span style="color: #90a890;">}</span><span style="color: #b0b0b3;">)</span>
        <span style="color: #aebed8;">}</span>;
        display_fn<span style="color: #aebed8;">(</span><span style="color: #00bfff;">self</span>,fmt<span style="color: #aebed8;">)</span>
      <span style="color: #97b098;">}</span>
      <span style="color: #ffd700;">#</span><span style="color: #97b098;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" A convenient variant for String."</span><span style="color: #97b098;">]</span>
      <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">s</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #97b098;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">display_fn</span> = |_,<span style="color: #4eee94;">f</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Formatter</span>|<span style="color: #aebed8;">{</span>
          f.write_fmt<span style="color: #b0b0b3;">(</span><span style="color: #ff0000;">unsafe</span> <span style="color: #90a890;">{</span>
            <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Arguments</span>::new_v1<span style="color: #a2b6da;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">[]</span>, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">[</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #93a8c6;">(</span>s<span style="color: #93a8c6;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #8c8c8c;">)</span>,<span style="color: #9cb6ad;">]</span><span style="color: #a2b6da;">)</span>
          <span style="color: #90a890;">}</span><span style="color: #b0b0b3;">)</span>
        <span style="color: #aebed8;">}</span>;
        display_fn<span style="color: #aebed8;">(</span><span style="color: #00bfff;">self</span>,fmt<span style="color: #aebed8;">)</span>
      <span style="color: #97b098;">}</span>
      <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">InvalidToken</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">t</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #97b098;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">display_fn</span> = |_,<span style="color: #4eee94;">f</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Formatter</span>|<span style="color: #aebed8;">{</span>
          f.write_fmt<span style="color: #b0b0b3;">(</span><span style="color: #ff0000;">unsafe</span> <span style="color: #90a890;">{</span>
            <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Arguments</span>::new_v1<span style="color: #a2b6da;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">[]</span>, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">[]</span><span style="color: #a2b6da;">)</span>
          <span style="color: #90a890;">}</span><span style="color: #b0b0b3;">)</span>
        <span style="color: #aebed8;">}</span>;
        display_fn<span style="color: #aebed8;">(</span><span style="color: #00bfff;">self</span>,fmt<span style="color: #aebed8;">)</span>
      <span style="color: #97b098;">}</span>
      _ =&gt; <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span><span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span>
      <span style="color: #b0b1a3;">}</span>
  <span style="color: #93a8c6;">}</span>

  <span style="color: #8c8c8c;">}</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">allow</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">unknown_lints,unused,renamed_and_removed_lints</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">allow</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">unused_doc_comment,unused_doc_comments</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" A string describing the error kind."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">description</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt;  <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #00bfff;">match</span>*<span style="color: #00bfff;">self</span> <span style="color: #b0b1a3;">{</span>
      <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">IoErr</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">err</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #97b098;">{</span>
        <span style="color: #aebed8;">(</span><span style="color: #deb887;">""</span><span style="color: #aebed8;">)</span>
      <span style="color: #97b098;">}</span>
      <span style="color: #ffd700;">#</span><span style="color: #97b098;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" A convenient variant for String."</span><span style="color: #97b098;">]</span>
      <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">s</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #97b098;">{</span>
        <span style="color: #aebed8;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>s<span style="color: #aebed8;">)</span>
      <span style="color: #97b098;">}</span>
      <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">InvalidToken</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">t</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #97b098;">{</span>
        <span style="color: #deb887;">"invalid token"</span>
      <span style="color: #97b098;">}</span>
      _ =&gt; <span style="color: #deb887;">""</span>,

      <span style="color: #b0b1a3;">}</span>
  <span style="color: #93a8c6;">}</span>

  <span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">Error</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    e.0
  <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Additional methods for `Result`, for easy interaction with this crate."</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">ResultExt</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;{</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" If the `Result` is an `Err` then `chain_err` evaluates the closure,"</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" which returns *some type that can be converted to `ErrorKind`*, boxes"</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" the original error to store as the cause, then returns a new error"</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" containing the original error."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">chain_err</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>,<span style="color: #98f5ff;">EK</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">callback</span>:<span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt;  ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">result</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span>,<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span><span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>:<span style="color: #98f5ff;">FnOnce</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">EK</span>,<span style="color: #4eee94;">EK</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;</span>;


  <span style="color: #8c8c8c;">}</span><span style="color: #00bfff;">impl</span> <span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span>,<span style="color: #98f5ff;">E</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #98f5ff;">ResultExt</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">result</span>::<span style="color: #98f5ff;">Result</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span>,<span style="color: #98f5ff;">E</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">where</span> <span style="color: #4eee94;">E</span>: ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span>+<span style="color: #98f5ff;">Send</span>+ '<span style="color: #00bfff;">static</span><span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">chain_err</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>,<span style="color: #98f5ff;">EK</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">callback</span>:<span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt;  ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">result</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span>,<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span><span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>:<span style="color: #98f5ff;">FnOnce</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">EK</span>,<span style="color: #4eee94;">EK</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #00bfff;">self</span>.map_err<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">move</span>|e|<span style="color: #97b098;">{</span>
      <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">state</span> = $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">State</span>::new::<span style="color: #aebed8;">&lt;</span><span style="color: #98f5ff;">Error</span><span style="color: #aebed8;">&gt;(</span><span style="color: #98f5ff;">Box</span>::new<span style="color: #b0b0b3;">(</span>e<span style="color: #b0b0b3;">)</span>,<span style="color: #aebed8;">)</span>;
      $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">ChainedError</span>::new<span style="color: #aebed8;">(</span>callback<span style="color: #b0b0b3;">()</span>.into<span style="color: #b0b0b3;">()</span>,state<span style="color: #aebed8;">)</span>
    <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>

  <span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #98f5ff;">ResultExt</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">option</span>::<span style="color: #98f5ff;">Option</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">chain_err</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>,<span style="color: #98f5ff;">EK</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">callback</span>:<span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt;  ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">result</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span>,<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span><span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>:<span style="color: #98f5ff;">FnOnce</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">EK</span>,<span style="color: #4eee94;">EK</span>:<span style="color: #98f5ff;">Into</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #00bfff;">self</span>.ok_or_else<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">move</span>||<span style="color: #97b098;">{</span>
      $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">ChainedError</span>::from_kind<span style="color: #aebed8;">(</span>callback<span style="color: #b0b0b3;">()</span>.into<span style="color: #b0b0b3;">()</span><span style="color: #aebed8;">)</span>
    <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>

<span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Convenient wrapper around `std::Result`."</span><span style="color: #93a8c6;">]</span>
<span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">unused</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">&gt;</span>  =  ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">result</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgffb7c4a" class="outline-3">
<h3 id="orgffb7c4a"><span class="section-number-3">2.5.</span> error_chain! macro 主要有3步骤:</h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-org437db8d" class="outline-4">
<h4 id="org437db8d"><span class="section-number-4">2.5.1.</span> 1. 定义: struct Error, enum ErrorKind, Error(ErrorKind, State)</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
其中 ErrorKind 最为重要, 基本所有的转换都通过 ErrorKind 发生
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">enum</span> <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #98f5ff;">IoErr</span><span style="color: #93a8c6;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">)</span>,
  <span style="color: #98f5ff;">Msg</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>,
  <span style="color: #98f5ff;">InvalidToken</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>,
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org59cc8a1" class="outline-4">
<h4 id="org59cc8a1"><span class="section-number-4">2.5.2.</span> 2. impl From&lt;xxx&gt; for Error {}, 实现 ?</h4>
<div class="outline-text-4" id="text-2-5-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">impl</span> <span style="color: #8c8c8c;">&lt;</span>'<span style="color: #4eee94;">a</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Self</span>::from_kind<span style="color: #b0b1a3;">(</span>s.into<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>:<span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Self</span>::from_kind<span style="color: #b0b1a3;">(</span>s.into<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span>::from_kind<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">IoErr</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
 <span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">num</span>::<span style="color: #98f5ff;">ParseIntError</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">num</span>::<span style="color: #98f5ff;">ParseIntError</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span>::from_kind<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">ParseErr</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #8c8c8c;">&lt;</span>'<span style="color: #4eee94;">a</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #b0b1a3;">(</span>s.into<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>:<span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #b0b1a3;">(</span>s<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge739c20" class="outline-4">
<h4 id="orge739c20"><span class="section-number-4">2.5.3.</span> 3. 重新定义 Result:  pub type Result&lt;T&gt;  =  ::std::result::Result&lt;T,Error&gt;;</h4>
</div>
</div>
<div id="outline-container-org8d6dc96" class="outline-3">
<h3 id="org8d6dc96"><span class="section-number-3">2.6.</span> error_chain! {} 中各个组成部分:  通过 expand-macro 来进行分析</h3>
<div class="outline-text-3" id="text-2-6">
<ol class="org-ol">
<li>rust macro 可以写到 如此复杂的地步</li>
<li>error-chain 通过macro 生成了大量的 样板式 代码</li>
</ol>
</div>
<div id="outline-container-orgfd95c83" class="outline-4">
<h4 id="orgfd95c83"><span class="section-number-4">2.6.1.</span> types: 从macro的展开结果看：  为 自定义 Error， ErrorKind, Result 名称, 不应该自定义 Result名字，而应该使用 Result</h4>
<div class="outline-text-4" id="text-2-6-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #ffd700;">error_chain!</span> <span style="color: #8c8c8c;">{</span>
    types <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">MyError</span>, <span style="color: #98f5ff;">MyErrorKind</span>, <span style="color: #98f5ff;">MyResult</span>;
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">expand &#23637;&#24320;&#22914;&#19979;&#65306;</span>

<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">MyError</span><span style="color: #8c8c8c;">(</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #98f5ff;">MyErrorKind</span>,
  <span style="color: #00bfff;">pub</span> $<span style="color: #a2cd5a;">crate</span>::<span style="color: #98f5ff;">State</span>,
<span style="color: #8c8c8c;">)</span>;

<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">MyErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #98f5ff;">Msg</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>,
  __Nonexhaustive<span style="color: #93a8c6;">{}</span>

<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfb0aba8" class="outline-4">
<h4 id="orgfb0aba8"><span class="section-number-4">2.6.2.</span> errors: 为 ErrorKind 增加 ErrorKind 类型, 如下: 主要为 chain_err(error: F) F: FnOnce() -&gt; EK: Into&lt;ErrorKind&gt; 使用</h4>
<div class="outline-text-4" id="text-2-6-2">
<div class="org-src-container">
<pre class="src src-rust">  <span style="color: #ffd700;">error_chain!</span> <span style="color: #8c8c8c;">{</span>
      foreign_links <span style="color: #93a8c6;">{</span>
          <span style="color: #98f5ff;">IoErr</span><span style="color: #b0b1a3;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">)</span>;
          <span style="color: #98f5ff;">ParseErr</span><span style="color: #b0b1a3;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">num</span>::<span style="color: #98f5ff;">ParseIntError</span><span style="color: #b0b1a3;">)</span>;
      <span style="color: #93a8c6;">}</span>

      <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#23450;&#20041;&#26032;&#30340;  ErrorKind enum; enum { InvalidToken(String) }</span>
      errors <span style="color: #93a8c6;">{</span>
          <span style="color: #98f5ff;">InvalidToken</span><span style="color: #b0b1a3;">(</span><span style="color: #4eee94;">t</span>: <span style="color: #98f5ff;">String</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">{</span>
              description<span style="color: #97b098;">(</span><span style="color: #deb887;">"invalid token"</span><span style="color: #97b098;">)</span>
              display<span style="color: #97b098;">(</span><span style="color: #deb887;">"invalid token display"</span><span style="color: #97b098;">)</span>
          <span style="color: #b0b1a3;">}</span>
      <span style="color: #93a8c6;">}</span>
  <span style="color: #8c8c8c;">}</span>

 errors <span style="color: #8c8c8c;">{</span>
     <span style="color: #98f5ff;">InvalidToken</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">t</span>: <span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
         description<span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"invalid token"</span><span style="color: #b0b1a3;">)</span>
         display<span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"invalid token display"</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #93a8c6;">}</span>
 <span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #98f5ff;">IoErr</span><span style="color: #93a8c6;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">)</span>, <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" A convenient variant for String."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #98f5ff;">Msg</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>,<span style="color: #98f5ff;">InvalidToken</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>, <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">hidden</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  __Nonexhaustive<span style="color: #93a8c6;">{}</span>

<span style="color: #8c8c8c;">}</span>
xx.chain_err<span style="color: #8c8c8c;">(</span>|| <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">InvalidToken</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"xx"</span>.to_string<span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgecc8623" class="outline-4">
<h4 id="orgecc8623"><span class="section-number-4">2.6.3.</span> foreign_links: 实现 foreign error(外部的error定义) 到 ErrorKind的转换:</h4>
<div class="outline-text-4" id="text-2-6-3">
<div class="org-src-container">
<pre class="src src-rust">
 <span style="color: #ffd700;">error_chain!</span> <span style="color: #8c8c8c;">{</span>
     foreign_links <span style="color: #93a8c6;">{</span>
         <span style="color: #98f5ff;">IoErr</span><span style="color: #b0b1a3;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">)</span>;
         <span style="color: #98f5ff;">ParseErr</span><span style="color: #b0b1a3;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">num</span>::<span style="color: #98f5ff;">ParseIntError</span><span style="color: #b0b1a3;">)</span>;
     <span style="color: #93a8c6;">}</span>
 <span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">expand &#22914;&#19979;&#65306;</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span>::from_kind<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">IoErr</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">num</span>::<span style="color: #98f5ff;">ParseIntError</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">num</span>::<span style="color: #98f5ff;">ParseIntError</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">Error</span>::from_kind<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">ParseErr</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgaf525ac" class="outline-4">
<h4 id="orgaf525ac"><span class="section-number-4">2.6.4.</span> ErrorKind::Msg 为 方便 使用 &amp;str, String 定义error 而定义的ErrorKind Variant,</h4>
<div class="outline-text-4" id="text-2-6-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">impl</span> <span style="color: #8c8c8c;">&lt;</span> '<span style="color: #4eee94;">a</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span>&amp; '<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>: &amp; '<span style="color: #4eee94;">a</span> <span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #b0b1a3;">(</span>s.into<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #8c8c8c;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>:<span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Msg</span><span style="color: #b0b1a3;">(</span>s<span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orga7e8fc7" class="outline-4">
<h4 id="orga7e8fc7"><span class="section-number-4">2.6.5.</span> links: 将其他的  error_chain 中定义的 Error 转换到 当前的Error中</h4>
<div class="outline-text-4" id="text-2-6-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">mod</span> <span style="color: #a2cd5a;">errors</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Create the Error, ErrorKind, ResultExt, and Result types</span>
    <span style="color: #ffd700;">error_chain!</span> <span style="color: #93a8c6;">{</span>
        foreign_links <span style="color: #b0b1a3;">{</span>
            <span style="color: #98f5ff;">IoErr</span><span style="color: #97b098;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span><span style="color: #97b098;">)</span>;
            <span style="color: #98f5ff;">ParseErr</span><span style="color: #97b098;">(</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">num</span>::<span style="color: #98f5ff;">ParseIntError</span><span style="color: #97b098;">)</span>;
        <span style="color: #b0b1a3;">}</span>
<span style="color: #93a8c6;">}</span>

<span style="color: #ffd700;">error_chain!</span> <span style="color: #93a8c6;">{</span>
  links <span style="color: #b0b1a3;">{</span>
    <span style="color: #98f5ff;">Other</span><span style="color: #97b098;">(</span><span style="color: #a2cd5a;">errors</span>::<span style="color: #98f5ff;">Error</span>, <span style="color: #a2cd5a;">errors</span>::<span style="color: #98f5ff;">ErrorKind</span><span style="color: #97b098;">)</span>
  <span style="color: #b0b1a3;">}</span>
<span style="color: #93a8c6;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">expand &#22914;&#19979;</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #93a8c6;">{</span>
  <span style="color: #98f5ff;">Other</span><span style="color: #b0b1a3;">(</span><span style="color: #a2cd5a;">errors</span>::<span style="color: #98f5ff;">ErrorKind</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #98f5ff;">Msg</span><span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">String</span><span style="color: #b0b1a3;">)</span>, <span style="color: #ffd700;">#</span><span style="color: #b0b1a3;">[</span><span style="color: #ffd700;">doc</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">hidden</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">]</span>
  __Nonexhaustive<span style="color: #b0b1a3;">{}</span>
<span style="color: #93a8c6;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #93a8c6;">&lt;</span><span style="color: #a2cd5a;">errors</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Error</span> <span style="color: #93a8c6;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #b0b1a3;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #a2cd5a;">errors</span>::<span style="color: #98f5ff;">Error</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #b0b1a3;">{</span>
    <span style="color: #98f5ff;">Error</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Other</span><span style="color: #aebed8;">(</span>e.0<span style="color: #aebed8;">)</span>,e.1,<span style="color: #97b098;">)</span>
  <span style="color: #b0b1a3;">}</span>
<span style="color: #93a8c6;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">From</span><span style="color: #93a8c6;">&lt;</span><span style="color: #a2cd5a;">errors</span>::<span style="color: #98f5ff;">ErrorKind</span><span style="color: #93a8c6;">&gt;</span><span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">ErrorKind</span> <span style="color: #93a8c6;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from</span><span style="color: #b0b1a3;">(</span><span style="color: #4eee94;">e</span>:<span style="color: #a2cd5a;">errors</span>::<span style="color: #98f5ff;">ErrorKind</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #b0b1a3;">{</span>
    <span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">Other</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span>
  <span style="color: #b0b1a3;">}</span>
<span style="color: #93a8c6;">}</span>

</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd9ea381" class="outline-2">
<h2 id="orgd9ea381"><span class="section-number-2">3.</span> Rust diesel  还有 InsertAble 未掌握</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgffc3305" class="outline-3">
<h3 id="orgffc3305"><span class="section-number-3">3.1.</span> 其中table! macro 的作用 在于 其提供的dsl模块， 其中可以 方便的构建 query_dsl::QueryDsl,即是sql 构建工厂，</h3>
</div>
<div id="outline-container-orgb13087c" class="outline-3">
<h3 id="orgb13087c"><span class="section-number-3">3.2.</span> diesel::query_dsl::RunQueryDsl 则 实现了 load, execute, get_result 函数，来获取sql查询结果。</h3>
</div>
<div id="outline-container-org631de34" class="outline-3">
<h3 id="org631de34"><span class="section-number-3">3.3.</span> QueryDsl 已经实现了  RunQueryDsl</h3>
</div>
<div id="outline-container-org14edefd" class="outline-3">
<h3 id="org14edefd"><span class="section-number-3">3.4.</span> 示例代码为：</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #ffd700;">table!</span> <span style="color: #8c8c8c;">{</span>
    arena_store_realms <span style="color: #93a8c6;">(</span>id<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
        id -&gt; <span style="color: #98f5ff;">Integer</span>,
        arena_store_id -&gt; <span style="color: #98f5ff;">Integer</span>,
        realm_id -&gt; <span style="color: #98f5ff;">Integer</span>,
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>


<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Queryable, Debug</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">ArenaStoreRealms</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">id</span>: <span style="color: #98f5ff;">i32</span>,
    <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">arena_store_id</span>: <span style="color: #98f5ff;">i32</span>,
    <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">realm_id</span>: <span style="color: #98f5ff;">i32</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">arena_store_realms</span>::<span style="color: #a2cd5a;">dsl</span>::*;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">result</span> = arena_store_realms.filter<span style="color: #8c8c8c;">(</span>id.eq<span style="color: #93a8c6;">(</span>1<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>.first<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>conn<span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orge1a910a" class="outline-3">
<h3 id="orge1a910a"><span class="section-number-3">3.5.</span> Insertable, macro: diesel::impl_Insertable</h3>
</div>
</div>
<div id="outline-container-org5a776bd" class="outline-2">
<h2 id="org5a776bd"><span class="section-number-2">4.</span> Rust redis;</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org1015e59" class="outline-3">
<h3 id="org1015e59"><span class="section-number-3">4.1.</span> 理解 其 hget command, 其中的impl_commands macro 是如何展开的,能够自动的 添加返回值</h3>
</div>
<div id="outline-container-org9459493" class="outline-3">
<h3 id="org9459493"><span class="section-number-3">4.2.</span> redis 主要有</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-orgd5de01b" class="outline-4">
<h4 id="orgd5de01b"><span class="section-number-4">4.2.1.</span> types(redis 数据类型 到rust 类型的映射), client, connection, cmd, pipeline</h4>
</div>
<div id="outline-container-org6f3eb38" class="outline-4">
<h4 id="org6f3eb38"><span class="section-number-4">4.2.2.</span> connection: 实现了 连接、操作redis的能力</h4>
</div>
<div id="outline-container-org12fd028" class="outline-4">
<h4 id="org12fd028"><span class="section-number-4">4.2.3.</span> types: 如何在redis typeless 到 rust type 之间进行转换</h4>
</div>
<div id="outline-container-org973a4c4" class="outline-4">
<h4 id="org973a4c4"><span class="section-number-4">4.2.4.</span> macro 的使用方法</h4>
</div>
</div>
<div id="outline-container-org365fb7f" class="outline-3">
<h3 id="org365fb7f"><span class="section-number-3">4.3.</span> <a href="file:///Users/lishaohua/.cargo/registry/src/github.com-1ecc6299db9ec823/redis-0.22.1/src/cmd.rs:25">Cmd: struct:</a></h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Cmd</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">data</span>: <span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">u8</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#20027;&#35201; &#23383;&#27573;, &#23384;&#20648; commands &#30340; &#23383;&#31526;&#32534;&#30721;</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Arg::Simple contains the offset that marks the end of the argument</span>
    <span style="color: #4eee94;">args</span>: <span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Arg</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">usize</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #4eee94;">cursor</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">u64</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
<div id="outline-container-org4e0fe3b" class="outline-4">
<h4 id="org4e0fe3b"><span class="section-number-4">4.3.1.</span> 构建Cmd 可以使用 default/cmd("get")</h4>
</div>
<div id="outline-container-org4251292" class="outline-4">
<h4 id="org4251292"><span class="section-number-4">4.3.2.</span> Cmd 直接 get,hget etc&#x2026; 命令在</h4>
</div>
<div id="outline-container-orge574322" class="outline-4">
<h4 id="orge574322"><span class="section-number-4">4.3.3.</span> 为Cmd 增加方法的 主要有  impl Cmd; impl RedisWrite; impl Default, 以及重要的 implement_commands! macro  展开形式如下:</h4>
<div class="outline-text-4" id="text-4-3-3">
<div class="org-src-container">
<pre class="src src-rust">   <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Cmd</span> <span style="color: #8c8c8c;">{</span>
     <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Get the value of a key.  If key is a vec this becomes an `MGET`."</span><span style="color: #93a8c6;">]</span>
     <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">clippy::extra_unused_lifetimes,clippy::needless_lifetimes</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
     <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">get</span><span style="color: #93a8c6;">&lt;</span>'<span style="color: #4eee94;">a</span>,<span style="color: #4eee94;">K</span>:<span style="color: #98f5ff;">ToRedisArgs</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">key</span>:<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
       ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">mem</span>::replace<span style="color: #b0b1a3;">(</span><span style="color: #97b098;">{</span>
         cmd<span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> key.is_single_arg<span style="color: #b0b0b3;">(){</span>
           <span style="color: #deb887;">"GET"</span>
         <span style="color: #b0b0b3;">}</span><span style="color: #00bfff;">else</span> <span style="color: #b0b0b3;">{</span>
           <span style="color: #deb887;">"MGET"</span>
         <span style="color: #b0b0b3;">}</span><span style="color: #aebed8;">)</span>.arg<span style="color: #aebed8;">(</span>key<span style="color: #aebed8;">)</span>
       <span style="color: #97b098;">}</span>,<span style="color: #98f5ff;">Cmd</span>::new<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #93a8c6;">}</span>
     <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Gets all keys matching pattern"</span><span style="color: #93a8c6;">]</span>
     <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">clippy::extra_unused_lifetimes,clippy::needless_lifetimes</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
     <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">keys</span><span style="color: #93a8c6;">&lt;</span>'<span style="color: #4eee94;">a</span>,<span style="color: #4eee94;">K</span>:<span style="color: #98f5ff;">ToRedisArgs</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">key</span>:<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span> <span style="color: #93a8c6;">{</span>
       ::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">mem</span>::replace<span style="color: #b0b1a3;">(</span><span style="color: #97b098;">{</span>
         cmd<span style="color: #aebed8;">(</span><span style="color: #deb887;">"KEYS"</span><span style="color: #aebed8;">)</span>.arg<span style="color: #aebed8;">(</span>key<span style="color: #aebed8;">)</span>
       <span style="color: #97b098;">}</span>,<span style="color: #98f5ff;">Cmd</span>::new<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #93a8c6;">}</span>
  <span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">trait</span> <span style="color: #4eee94;">Commands</span>:<span style="color: #98f5ff;">ConnectionLike</span>+<span style="color: #98f5ff;">Sized</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">doc = </span><span style="color: #deb887;">" Get the value of a key.  If key is a vec this becomes an `MGET`."</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">inline</span><span style="color: #93a8c6;">]</span>
  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">clippy::extra_unused_lifetimes,clippy::needless_lifetimes</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">get</span><span style="color: #93a8c6;">&lt;</span>'<span style="color: #4eee94;">a</span>,<span style="color: #4eee94;">K</span>:<span style="color: #98f5ff;">ToRedisArgs</span>,<span style="color: #4eee94;">RV</span>:<span style="color: #98f5ff;">FromRedisValue</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>,<span style="color: #4eee94;">key</span>:<span style="color: #98f5ff;">K</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">RV</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #98f5ff;">Cmd</span>::get<span style="color: #b0b1a3;">(</span>key<span style="color: #b0b1a3;">)</span>.query<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org79b411f" class="outline-3">
<h3 id="org79b411f"><span class="section-number-3">4.4.</span> 如何 执行 redis 命令?</h3>
<div class="outline-text-3" id="text-4-4">
</div>
<ol class="org-ol">
<li><a id="orgb24d926"></a>1. 构建 Cmd: 可以使用 Cmd::get("xxx") 来进行Cmd的构建, 然后 通过 Cmd.query(con: &amp;mut dyn ConnectionLike) 来执行<br />
<ol class="org-ol">
<li><a id="org90d7951"></a>如何 execute cmd?: 在 impl Cmd 中的 pub fn query&lt;T: FromRedisValue&gt;(&amp;self, con: &amp;mut dyn ConnectionLike) -&gt; RedisResult&lt;T&gt; {}  代码如下:<br />
<div class="outline-text-6" id="text-4-4-0-1-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Cmd</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">query</span><span style="color: #93a8c6;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #98f5ff;">FromRedisValue</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">con</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">dyn</span> <span style="color: #98f5ff;">ConnectionLike</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">match</span> con.req_command<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span>val<span style="color: #97b098;">)</span> =&gt; from_redis_value<span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>val<span style="color: #97b098;">)</span>,
            <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span> =&gt; <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span>,
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">get_packed_command</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">u8</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">cmd</span> = <span style="color: #98f5ff;">Vec</span>::new<span style="color: #b0b1a3;">()</span>;
        <span style="color: #00bfff;">self</span>.write_packed_command<span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> cmd<span style="color: #b0b1a3;">)</span>;
        cmd
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">write_packed_command</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Vec</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">u8</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
        write_command_to_vec<span style="color: #b0b1a3;">(</span>cmd, <span style="color: #00bfff;">self</span>.args_iter<span style="color: #97b098;">()</span>, <span style="color: #00bfff;">self</span>.cursor.unwrap_or<span style="color: #97b098;">(</span>0<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">write_command_to_vec</span><span style="color: #93a8c6;">&lt;</span>'<span style="color: #4eee94;">a</span>, <span style="color: #98f5ff;">I</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Vec</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">u8</span><span style="color: #b0b1a3;">&gt;</span>, <span style="color: #4eee94;">args</span>: <span style="color: #98f5ff;">I</span>, <span style="color: #4eee94;">cursor</span>: <span style="color: #98f5ff;">u64</span><span style="color: #93a8c6;">)</span>
    <span style="color: #00bfff;">where</span>
        <span style="color: #4eee94;">I</span>: <span style="color: #98f5ff;">IntoIterator</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Item</span> = <span style="color: #98f5ff;">Arg</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #97b098;">[</span><span style="color: #98f5ff;">u8</span><span style="color: #97b098;">]</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span> + <span style="color: #98f5ff;">Clone</span> + <span style="color: #98f5ff;">ExactSizeIterator</span>,
    <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">totlen</span> = args_len<span style="color: #b0b1a3;">(</span>args.clone<span style="color: #97b098;">()</span>, cursor<span style="color: #b0b1a3;">)</span>;

        cmd.reserve<span style="color: #b0b1a3;">(</span>totlen<span style="color: #b0b1a3;">)</span>;

        write_command<span style="color: #b0b1a3;">(</span>cmd, args, cursor<span style="color: #b0b1a3;">)</span>.unwrap<span style="color: #b0b1a3;">()</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">write_command</span><span style="color: #93a8c6;">&lt;</span>'<span style="color: #4eee94;">a</span>, <span style="color: #98f5ff;">I</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">impl</span> <span style="color: #f08080; font-weight: bold;">?</span><span style="color: #98f5ff;">Sized</span> + <span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Write</span><span style="color: #b0b1a3;">)</span>, <span style="color: #4eee94;">args</span>: <span style="color: #98f5ff;">I</span>, <span style="color: #4eee94;">cursor</span>: <span style="color: #98f5ff;">u64</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">&gt;</span>
    <span style="color: #00bfff;">where</span>
        <span style="color: #4eee94;">I</span>: <span style="color: #98f5ff;">IntoIterator</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Item</span> = <span style="color: #98f5ff;">Arg</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #97b098;">[</span><span style="color: #98f5ff;">u8</span><span style="color: #97b098;">]</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span> + <span style="color: #98f5ff;">Clone</span> + <span style="color: #98f5ff;">ExactSizeIterator</span>,
    <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">buf</span> = ::<span style="color: #a2cd5a;">itoa</span>::<span style="color: #98f5ff;">Buffer</span>::new<span style="color: #b0b1a3;">()</span>;

        cmd.write_all<span style="color: #b0b1a3;">(</span>b<span style="color: #deb887;">"*"</span><span style="color: #b0b1a3;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">s</span> = buf.format<span style="color: #b0b1a3;">(</span>args.len<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>;

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">....</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">trait</span> <span style="color: #98f5ff;">ConnectionLike</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">req_command</span><span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Cmd</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Value</span><span style="color: #b0b1a3;">&gt;</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">pcmd</span> = cmd.get_packed_command<span style="color: #97b098;">()</span>;
            <span style="color: #00bfff;">self</span>.req_packed_command<span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>pcmd<span style="color: #97b098;">)</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">ConnectionLike</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Connection</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">req_packed_command</span><span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #97b098;">[</span><span style="color: #98f5ff;">u8</span><span style="color: #97b098;">]</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Value</span><span style="color: #b0b1a3;">&gt;</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">self</span>.pubsub <span style="color: #97b098;">{</span>
                <span style="color: #00bfff;">self</span>.exit_pubsub<span style="color: #aebed8;">()</span><span style="color: #f08080; font-weight: bold;">?</span>;
            <span style="color: #97b098;">}</span>

            <span style="color: #00bfff;">self</span>.con.send_bytes<span style="color: #97b098;">(</span>cmd<span style="color: #97b098;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
            <span style="color: #00bfff;">self</span>.read_response<span style="color: #97b098;">()</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">ConnectionLike</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Client</span> <span style="color: #93a8c6;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">req_packed_command</span><span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #97b098;">[</span><span style="color: #98f5ff;">u8</span><span style="color: #97b098;">]</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Value</span><span style="color: #b0b1a3;">&gt;</span> <span style="color: #b0b1a3;">{</span>
        <span style="color: #00bfff;">self</span>.get_connection<span style="color: #97b098;">()</span><span style="color: #f08080; font-weight: bold;">?</span>.req_packed_command<span style="color: #97b098;">(</span>cmd<span style="color: #97b098;">)</span>
    <span style="color: #b0b1a3;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">req_packed_commands</span><span style="color: #b0b1a3;">(</span>
        <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>,
        <span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #97b098;">[</span><span style="color: #98f5ff;">u8</span><span style="color: #97b098;">]</span>,
        <span style="color: #4eee94;">offset</span>: <span style="color: #98f5ff;">usize</span>,
        <span style="color: #4eee94;">count</span>: <span style="color: #98f5ff;">usize</span>,
    <span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Vec</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">Value</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span> <span style="color: #b0b1a3;">{</span>
        <span style="color: #00bfff;">self</span>.get_connection<span style="color: #97b098;">()</span><span style="color: #f08080; font-weight: bold;">?</span>
            .req_packed_commands<span style="color: #97b098;">(</span>cmd, offset, count<span style="color: #97b098;">)</span>
    <span style="color: #b0b1a3;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">get_db</span><span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">i64</span> <span style="color: #b0b1a3;">{</span>
        <span style="color: #00bfff;">self</span>.connection_info.redis.db
    <span style="color: #b0b1a3;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">check_connection</span><span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">bool</span> <span style="color: #b0b1a3;">{</span>
        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">mut</span> conn<span style="color: #97b098;">)</span> = <span style="color: #00bfff;">self</span>.get_connection<span style="color: #97b098;">()</span> <span style="color: #97b098;">{</span>
            conn.check_connection<span style="color: #aebed8;">()</span>
        <span style="color: #97b098;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #97b098;">{</span>
            <span style="color: #00bfff;">false</span>
        <span style="color: #97b098;">}</span>
    <span style="color: #b0b1a3;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">is_open</span><span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #b0b1a3;">)</span> -&gt; <span style="color: #98f5ff;">bool</span> <span style="color: #b0b1a3;">{</span>
        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span>conn<span style="color: #97b098;">)</span> = <span style="color: #00bfff;">self</span>.get_connection<span style="color: #97b098;">()</span> <span style="color: #97b098;">{</span>
            conn.is_open<span style="color: #aebed8;">()</span>
        <span style="color: #97b098;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #97b098;">{</span>
            <span style="color: #00bfff;">false</span>
        <span style="color: #97b098;">}</span>
    <span style="color: #b0b1a3;">}</span>
<span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgd7466ce"></a>使用方法为 let res: RedisResult&lt;i64&gt; = cmd.query(&amp;conn);<br /></li>
<li><a id="org59625bf"></a>所以 cmd的 query 执行的主要路径 为:<br />
<ol class="org-ol">
<li><a id="orgd166ef7"></a>1. 通过conn 进行 实际的 request发送, conn.req_command(Cmd)<br /></li>
<li><a id="org252031e"></a>2. req_command 透过 cmd.get_packed_command()( 将控制权 又转移到 Cmd)  将 Cmd 转化为字节流, 这其中 顺序调用 write_packed_command(Vec) , write_command_to_vec -&gt; write_command<br /></li>
<li><a id="org3731724"></a>3. 调用 ConnectionLike 的 req_packed_command, 然后 调用 conn.req_packed_<br /></li>
</ol>
</li>
</ol>
</li>
<li><a id="org490e0b9"></a>2. impl Commands: (commands 中含有redis 命令,并 直接返回 RedisResult), 在 <a href="file:///Users/lishaohua/.cargo/registry/src/github.com-1ecc6299db9ec823/redis-0.22.1/src/commands/mod.rs:1920">commands/mod.rs</a>  中 存在 Commands blanket impl, 所以任何实现了 ConnectionLike 的 struct 都可以 直接调用 redis methods like get, hget etc&#x2026;<br />
<ol class="org-ol">
<li><a id="org03b2bdb"></a>Client:<br />
<div class="outline-text-6" id="text-4-4-0-2-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">cli</span> = <span style="color: #a2cd5a;">redis</span>::<span style="color: #98f5ff;">Client</span>::open<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"redis://127.0.0.1:6100/1"</span><span style="color: #8c8c8c;">)</span>.unwrap<span style="color: #8c8c8c;">()</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">val</span>: <span style="color: #98f5ff;">RedisResult</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> = cli.get<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"xx"</span><span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="org01764de"></a>Connection:<br />
<div class="outline-text-6" id="text-4-4-0-2-2">
<div class="org-src-container">
<pre class="src src-rust"> <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">client</span> = <span style="color: #a2cd5a;">redis</span>::<span style="color: #98f5ff;">Client</span>::open<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"redis://127.0.0.1/"</span><span style="color: #8c8c8c;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
 <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">con</span> = client.get_connection<span style="color: #8c8c8c;">()</span><span style="color: #f08080; font-weight: bold;">?</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">count</span> : <span style="color: #98f5ff;">i32</span> = con.get<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"my_counter"</span><span style="color: #8c8c8c;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
</pre>
</div>
</div>
</li>
<li><a id="org0b64127"></a>Cmd.query(&amp;mut dyn ConnectionLike)<br />
<div class="outline-text-6" id="text-4-4-0-2-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">first way &#26500;&#24314;  Cmd &#26041;&#27861;</span>
<span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">cmd</span> = <span style="color: #a2cd5a;">redis</span>::cmd<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"get"</span><span style="color: #8c8c8c;">)</span>.arg<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"xx"</span><span style="color: #8c8c8c;">)</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">val</span>: <span style="color: #98f5ff;">RedisResult</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">i64</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> =
    cmd.query<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> cli<span style="color: #8c8c8c;">)</span>;

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">second way</span>
<span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">cmd</span> = <span style="color: #98f5ff;">Cmd</span>::get<span style="color: #8c8c8c;">(</span><span style="color: #deb887;">"xx"</span><span style="color: #8c8c8c;">)</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">val</span>: <span style="color: #98f5ff;">RedisResult</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">i64</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> =
   cmd.query<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> cli<span style="color: #8c8c8c;">)</span>;

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">cmd &#25903;&#25345; get &#36716;&#25442;&#20026; get /  mget &#26041;&#27861;</span>
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">res</span>: <span style="color: #98f5ff;">RedisResult</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Option</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> = <span style="color: #98f5ff;">Cmd</span>::get<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #93a8c6;">[</span><span style="color: #deb887;">"xx"</span>, <span style="color: #deb887;">"age"</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>.query<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> cli<span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org63ba981" class="outline-3">
<h3 id="org63ba981"><span class="section-number-3">4.5.</span> types: 类型转换</h3>
<div class="outline-text-3" id="text-4-5">
</div>
<div id="outline-container-orgea90f68" class="outline-4">
<h4 id="orgea90f68"><span class="section-number-4">4.5.1.</span> ToRedisValue: 不需要看太多内容</h4>
</div>
<div id="outline-container-orgff81b29" class="outline-4">
<h4 id="orgff81b29"><span class="section-number-4">4.5.2.</span> FromRedisValue: 大多 都已 macro 完成: 以 i8 为例:</h4>
</div>
<div id="outline-container-orgf3bfe1a" class="outline-4">
<h4 id="orgf3bfe1a"><span class="section-number-4">4.5.3.</span> 需要注意 nil 的转换, 在对 i8 的转换代码中, 并没有对 Value::Nil 的匹配</h4>
</div>
<div id="outline-container-orge455a3b" class="outline-4">
<h4 id="orge455a3b"><span class="section-number-4">4.5.4.</span> 即简单命令 let res: RedisResult&lt;i64&gt; = cli.get("xx"); 如果xx 没有设定数值的话, 会导致 一直返回错误, 正确的方法是是 let res: RedisResult&lt;Option&lt;i64&gt;&gt; = cli.get("xx");</h4>
</div>
<div id="outline-container-org3eee04a" class="outline-4">
<h4 id="org3eee04a"><span class="section-number-4">4.5.5.</span> 但是: HashMap&lt;String, String&gt;, 以及 Vec, Set 等集合类, 这是一个例外, 即便是 没有 key, 依然返回一个 empty 的集合</h4>
<div class="outline-text-4" id="text-4-5-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">Value</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// A nil response from the server.</span>
    <span style="color: #98f5ff;">Nil</span>,
    <span style="color: #ffe4b5;">/// An integer response.  Note that there are a few situations</span>
    <span style="color: #ffe4b5;">/// in which redis actually returns a string for an integer which</span>
    <span style="color: #ffe4b5;">/// is why this library generally treats integers and strings</span>
    <span style="color: #ffe4b5;">/// the same for all numeric responses.</span>
    <span style="color: #98f5ff;">Int</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">i64</span><span style="color: #93a8c6;">)</span>,
    <span style="color: #ffe4b5;">/// An arbitary binary data.</span>
    <span style="color: #98f5ff;">Data</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Vec</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">u8</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span>,
    <span style="color: #ffe4b5;">/// A bulk response of more data.  This is generally used by redis</span>
    <span style="color: #ffe4b5;">/// to express nested structures.</span>
    <span style="color: #98f5ff;">Bulk</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Vec</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Value</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span>,
    <span style="color: #ffe4b5;">/// A status response.</span>
    <span style="color: #98f5ff;">Status</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">)</span>,
    <span style="color: #ffe4b5;">/// A status response which represents the string "OK".</span>
    <span style="color: #98f5ff;">Okay</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #ffd700;">from_redis_value_for_num!</span><span style="color: #8c8c8c;">(</span><span style="color: #98f5ff;">i8</span><span style="color: #8c8c8c;">)</span>; <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#23637;&#24320;&#32467;&#26500;&#22914;&#19979;:</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">FromRedisValue</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">i8</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">from_redis_value</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">v</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Value</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">i8</span><span style="color: #93a8c6;">&gt;{</span>
    <span style="color: #b0b1a3;">{</span>
      <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">v</span> = v;
      <span style="color: #00bfff;">match</span>*v <span style="color: #97b098;">{</span>
        <span style="color: #98f5ff;">Value</span>::<span style="color: #98f5ff;">Int</span><span style="color: #aebed8;">(</span>val<span style="color: #aebed8;">)</span> =&gt; <span style="color: #98f5ff;">Ok</span><span style="color: #aebed8;">(</span>val <span style="color: #00bfff;">as</span> <span style="color: #98f5ff;">i8</span><span style="color: #aebed8;">)</span>,
        <span style="color: #98f5ff;">Value</span>::<span style="color: #98f5ff;">Status</span><span style="color: #aebed8;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">s</span><span style="color: #aebed8;">)</span> =&gt; <span style="color: #00bfff;">match</span> s.parse::<span style="color: #aebed8;">&lt;</span><span style="color: #98f5ff;">i8</span><span style="color: #aebed8;">&gt;(){</span>
          <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>rv<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>rv<span style="color: #b0b0b3;">)</span>,
          <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>_<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
            <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #90a890;">(</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">convert</span>::<span style="color: #98f5ff;">From</span>::from<span style="color: #a2b6da;">(</span><span style="color: #9cb6ad;">(</span><span style="color: #98f5ff;">RedisError</span>::from<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">TypeError</span>,<span style="color: #deb887;">"Response was of incompatible type"</span>,<span style="color: #b0b1a3;">{</span>
              <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">res</span> = $<span style="color: #a2cd5a;">crate</span>::<span style="color: #a2cd5a;">fmt</span>::format<span style="color: #97b098;">(</span><span style="color: #ff0000;">unsafe</span> <span style="color: #aebed8;">{</span>
                <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Arguments</span>::new_v1<span style="color: #b0b0b3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #90a890;">[]</span>, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #90a890;">[</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #a2b6da;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">(</span><span style="color: #deb887;">"Could not convert from string."</span><span style="color: #9cb6ad;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #a2b6da;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #a2b6da;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">(</span>v<span style="color: #9cb6ad;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #a2b6da;">)</span>,<span style="color: #90a890;">]</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #aebed8;">}</span><span style="color: #97b098;">)</span>;
              res
            <span style="color: #b0b1a3;">}</span>,<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
          <span style="color: #b0b0b3;">}</span>,

          <span style="color: #aebed8;">}</span>,
        <span style="color: #98f5ff;">Value</span>::<span style="color: #98f5ff;">Data</span><span style="color: #aebed8;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">bytes</span><span style="color: #aebed8;">)</span> =&gt; <span style="color: #00bfff;">match</span> from_utf8<span style="color: #aebed8;">(</span>bytes<span style="color: #aebed8;">)</span><span style="color: #f08080; font-weight: bold;">?</span>.parse::<span style="color: #aebed8;">&lt;</span><span style="color: #98f5ff;">i8</span><span style="color: #aebed8;">&gt;(){</span>
          <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>rv<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>rv<span style="color: #b0b0b3;">)</span>,
          <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>_<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
            <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #90a890;">(</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">convert</span>::<span style="color: #98f5ff;">From</span>::from<span style="color: #a2b6da;">(</span><span style="color: #9cb6ad;">(</span><span style="color: #98f5ff;">RedisError</span>::from<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">TypeError</span>,<span style="color: #deb887;">"Response was of incompatible type"</span>,<span style="color: #b0b1a3;">{</span>
              <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">res</span> = $<span style="color: #a2cd5a;">crate</span>::<span style="color: #a2cd5a;">fmt</span>::format<span style="color: #97b098;">(</span><span style="color: #ff0000;">unsafe</span> <span style="color: #aebed8;">{</span>
                <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Arguments</span>::new_v1<span style="color: #b0b0b3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #90a890;">[]</span>, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #90a890;">[</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #a2b6da;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">(</span><span style="color: #deb887;">"Could not convert from string."</span><span style="color: #9cb6ad;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #a2b6da;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #a2b6da;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #9cb6ad;">(</span>v<span style="color: #9cb6ad;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #a2b6da;">)</span>,<span style="color: #90a890;">]</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #aebed8;">}</span><span style="color: #97b098;">)</span>;
              res
            <span style="color: #b0b1a3;">}</span>,<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
          <span style="color: #b0b0b3;">}</span>,

          <span style="color: #aebed8;">}</span>,
        _ =&gt; <span style="color: #aebed8;">{</span>
          <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>::<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">convert</span>::<span style="color: #98f5ff;">From</span>::from<span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span><span style="color: #98f5ff;">RedisError</span>::from<span style="color: #9cb6ad;">(</span><span style="color: #8c8c8c;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">TypeError</span>,<span style="color: #deb887;">"Response was of incompatible type"</span>,<span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">res</span> = $<span style="color: #a2cd5a;">crate</span>::<span style="color: #a2cd5a;">fmt</span>::format<span style="color: #b0b1a3;">(</span><span style="color: #ff0000;">unsafe</span> <span style="color: #97b098;">{</span>
              <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Arguments</span>::new_v1<span style="color: #aebed8;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #b0b0b3;">[]</span>, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #b0b0b3;">[</span><span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #90a890;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #a2b6da;">(</span><span style="color: #deb887;">"Response type not convertible to numeric."</span><span style="color: #a2b6da;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #90a890;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">ArgumentV1</span>::new<span style="color: #90a890;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #a2b6da;">(</span>v<span style="color: #a2b6da;">)</span>,<span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">fmt</span>::<span style="color: #98f5ff;">Display</span>::fmt<span style="color: #90a890;">)</span>,<span style="color: #b0b0b3;">]</span><span style="color: #aebed8;">)</span>
            <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>;
            res
          <span style="color: #93a8c6;">}</span>,<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
        <span style="color: #aebed8;">}</span>,

        <span style="color: #97b098;">}</span>
    <span style="color: #b0b1a3;">}</span>
  <span style="color: #93a8c6;">}</span>

  <span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org4a79c50"></a>更过细节在 Connection.read_response 中, 并调用 self.parser.parse_value(sock) 即: 读取字节流 并进行转换, 代码如下:<br />
<div class="outline-text-5" id="text-4-5-5-1">
<div class="org-src-container">
<pre class="src src-rust">    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">read_response</span><span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">Value</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">result</span> = <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.con <span style="color: #93a8c6;">{</span>
            <span style="color: #98f5ff;">ActualConnection</span>::<span style="color: #98f5ff;">Tcp</span><span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">TcpConnection</span> <span style="color: #97b098;">{</span> <span style="color: #00bfff;">ref</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">reader</span>, .. <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #b0b1a3;">{</span>
                <span style="color: #00bfff;">self</span>.parser.parse_value<span style="color: #97b098;">(</span>reader<span style="color: #97b098;">)</span>
            <span style="color: #b0b1a3;">}</span>
            <span style="color: #ffd700;">#</span><span style="color: #b0b1a3;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"tls"</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">]</span>
            <span style="color: #98f5ff;">ActualConnection</span>::<span style="color: #98f5ff;">TcpTls</span><span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">boxed_tls_connection</span><span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #b0b1a3;">{</span>
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">reader</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> boxed_tls_connection.reader;
                <span style="color: #00bfff;">self</span>.parser.parse_value<span style="color: #97b098;">(</span>reader<span style="color: #97b098;">)</span>
            <span style="color: #b0b1a3;">}</span>
            <span style="color: #ffd700;">#</span><span style="color: #b0b1a3;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">unix</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">]</span>
            <span style="color: #98f5ff;">ActualConnection</span>::<span style="color: #98f5ff;">Unix</span><span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">UnixConnection</span> <span style="color: #97b098;">{</span> <span style="color: #00bfff;">ref</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">sock</span>, .. <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #b0b1a3;">{</span>
                <span style="color: #00bfff;">self</span>.parser.parse_value<span style="color: #97b098;">(</span>sock<span style="color: #97b098;">)</span>
            <span style="color: #b0b1a3;">}</span>
        <span style="color: #93a8c6;">}</span>;
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">shutdown connection on protocol error</span>
        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Err</span><span style="color: #93a8c6;">(</span>e<span style="color: #93a8c6;">)</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span>result <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">shutdown</span> = <span style="color: #00bfff;">match</span> e.as_io_error<span style="color: #b0b1a3;">()</span> <span style="color: #b0b1a3;">{</span>
                <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span> =&gt; e.kind<span style="color: #97b098;">()</span> == <span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">UnexpectedEof</span>,
                <span style="color: #98f5ff;">None</span> =&gt; <span style="color: #00bfff;">false</span>,
            <span style="color: #b0b1a3;">}</span>;
            <span style="color: #00bfff;">if</span> shutdown <span style="color: #b0b1a3;">{</span>
                <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.con <span style="color: #97b098;">{</span>
                    <span style="color: #98f5ff;">ActualConnection</span>::<span style="color: #98f5ff;">Tcp</span><span style="color: #aebed8;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">connection</span><span style="color: #aebed8;">)</span> =&gt; <span style="color: #aebed8;">{</span>
                        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_</span> = connection.reader.shutdown<span style="color: #b0b0b3;">(</span><span style="color: #a2cd5a;">net</span>::<span style="color: #98f5ff;">Shutdown</span>::<span style="color: #98f5ff;">Both</span><span style="color: #b0b0b3;">)</span>;
                        connection.open = <span style="color: #00bfff;">false</span>;
                    <span style="color: #aebed8;">}</span>
                    <span style="color: #ffd700;">#</span><span style="color: #aebed8;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b0b3;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"tls"</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">]</span>
                    <span style="color: #98f5ff;">ActualConnection</span>::<span style="color: #98f5ff;">TcpTls</span><span style="color: #aebed8;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">connection</span><span style="color: #aebed8;">)</span> =&gt; <span style="color: #aebed8;">{</span>
                        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_</span> = connection.reader.shutdown<span style="color: #b0b0b3;">()</span>;
                        connection.open = <span style="color: #00bfff;">false</span>;
                    <span style="color: #aebed8;">}</span>
                    <span style="color: #ffd700;">#</span><span style="color: #aebed8;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b0b3;">(</span><span style="color: #ffd700;">unix</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">]</span>
                    <span style="color: #98f5ff;">ActualConnection</span>::<span style="color: #98f5ff;">Unix</span><span style="color: #aebed8;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">connection</span><span style="color: #aebed8;">)</span> =&gt; <span style="color: #aebed8;">{</span>
                        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_</span> = connection.sock.shutdown<span style="color: #b0b0b3;">(</span><span style="color: #a2cd5a;">net</span>::<span style="color: #98f5ff;">Shutdown</span>::<span style="color: #98f5ff;">Both</span><span style="color: #b0b0b3;">)</span>;
                        connection.open = <span style="color: #00bfff;">false</span>;
                    <span style="color: #aebed8;">}</span>
                <span style="color: #97b098;">}</span>
            <span style="color: #b0b1a3;">}</span>
        <span style="color: #93a8c6;">}</span>
        result
    <span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Parser</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// Creates a new parser that parses the data behind the reader.  More</span>
    <span style="color: #ffe4b5;">/// than one value can be behind the reader in which case the parser can</span>
    <span style="color: #ffe4b5;">/// be invoked multiple times.  In other words: the stream does not have</span>
    <span style="color: #ffe4b5;">/// to be terminated.</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">Parser</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Parser</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #4eee94;">decoder</span>: <span style="color: #a2cd5a;">combine</span>::<span style="color: #a2cd5a;">stream</span>::<span style="color: #a2cd5a;">decoder</span>::<span style="color: #98f5ff;">Decoder</span>::new<span style="color: #97b098;">()</span>,
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">public api</span>

    <span style="color: #ffe4b5;">/// Parses synchronously into a single value from the reader.</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">parse_value</span><span style="color: #93a8c6;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #98f5ff;">Read</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">reader</span>: <span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">RedisResult</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Value</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">decoder</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>.decoder;
        <span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">&#36716;&#25442;&#20026;&#20102;  macro&#35843;&#29992;</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">result</span> = <span style="color: #a2cd5a;">combine</span>::<span style="color: #ffd700;">decode!</span><span style="color: #b0b1a3;">(</span>decoder, reader, value<span style="color: #97b098;">()</span>, |input, _| <span style="color: #97b098;">{</span>
            <span style="color: #a2cd5a;">combine</span>::<span style="color: #a2cd5a;">stream</span>::<span style="color: #a2cd5a;">easy</span>::<span style="color: #98f5ff;">Stream</span>::from<span style="color: #aebed8;">(</span>input<span style="color: #aebed8;">)</span>
        <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>;
        <span style="color: #00bfff;">match</span> result <span style="color: #b0b1a3;">{</span>
            <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span>err<span style="color: #97b098;">)</span> =&gt; <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">match</span> err <span style="color: #aebed8;">{</span>
                <span style="color: #a2cd5a;">combine</span>::<span style="color: #a2cd5a;">stream</span>::<span style="color: #a2cd5a;">decoder</span>::<span style="color: #98f5ff;">Error</span>::<span style="color: #98f5ff;">Io</span> <span style="color: #b0b0b3;">{</span> error, .. <span style="color: #b0b0b3;">}</span> =&gt; error.into<span style="color: #b0b0b3;">()</span>,
                <span style="color: #a2cd5a;">combine</span>::<span style="color: #a2cd5a;">stream</span>::<span style="color: #a2cd5a;">decoder</span>::<span style="color: #98f5ff;">Error</span>::<span style="color: #98f5ff;">Parse</span><span style="color: #b0b0b3;">(</span>err<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
                    <span style="color: #00bfff;">if</span> err.is_unexpected_end_of_input<span style="color: #90a890;">()</span> <span style="color: #90a890;">{</span>
                        <span style="color: #98f5ff;">RedisError</span>::from<span style="color: #a2b6da;">(</span><span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Error</span>::from<span style="color: #9cb6ad;">(</span><span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">UnexpectedEof</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                    <span style="color: #90a890;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #90a890;">{</span>
                        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">err</span> = err
                            .map_range<span style="color: #a2b6da;">(</span>|range| <span style="color: #f08080;">format!</span><span style="color: #9cb6ad;">(</span><span style="color: #deb887;">"</span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, range<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                            .map_position<span style="color: #a2b6da;">(</span>|pos| pos.translate_position<span style="color: #9cb6ad;">(</span>decoder.buffer<span style="color: #8c8c8c;">()</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                            .to_string<span style="color: #a2b6da;">()</span>;
                        <span style="color: #98f5ff;">RedisError</span>::from<span style="color: #a2b6da;">(</span><span style="color: #9cb6ad;">(</span><span style="color: #98f5ff;">ErrorKind</span>::<span style="color: #98f5ff;">ResponseError</span>, <span style="color: #deb887;">"parse error"</span>, err<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                    <span style="color: #90a890;">}</span>
                <span style="color: #b0b0b3;">}</span>
            <span style="color: #aebed8;">}</span><span style="color: #97b098;">)</span>,
            <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span>result<span style="color: #97b098;">)</span> =&gt; result,
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org9a93ce6" class="outline-3">
<h3 id="org9a93ce6"><span class="section-number-3">4.6.</span> cmd 到 redis命令格式的转换: 主要集中在 <a href="file:///Users/lishaohua/.cargo/registry/src/github.com-1ecc6299db9ec823/redis-0.22.1/src/cmd.rs:202">write_command</a> 中, 代码如下:</h3>
<div class="outline-text-3" id="text-4-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">fn</span> <span style="color: #daa520;">write_command</span><span style="color: #8c8c8c;">&lt;</span>'<span style="color: #4eee94;">a</span>, <span style="color: #98f5ff;">I</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #4eee94;">cmd</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">impl</span> <span style="color: #f08080; font-weight: bold;">?</span><span style="color: #98f5ff;">Sized</span> + <span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Write</span><span style="color: #93a8c6;">)</span>, <span style="color: #4eee94;">args</span>: <span style="color: #98f5ff;">I</span>, <span style="color: #4eee94;">cursor</span>: <span style="color: #98f5ff;">u64</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Result</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #93a8c6;">()</span><span style="color: #8c8c8c;">&gt;</span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">I</span>: <span style="color: #98f5ff;">IntoIterator</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">Item</span> = <span style="color: #98f5ff;">Arg</span><span style="color: #93a8c6;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #b0b1a3;">[</span><span style="color: #98f5ff;">u8</span><span style="color: #b0b1a3;">]</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> + <span style="color: #98f5ff;">Clone</span> + <span style="color: #98f5ff;">ExactSizeIterator</span>,
<span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">buf</span> = ::<span style="color: #a2cd5a;">itoa</span>::<span style="color: #98f5ff;">Buffer</span>::new<span style="color: #93a8c6;">()</span>;

    cmd.write_all<span style="color: #93a8c6;">(</span>b<span style="color: #deb887;">"*"</span><span style="color: #93a8c6;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">s</span> = buf.format<span style="color: #93a8c6;">(</span>args.len<span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">)</span>;
    cmd.write_all<span style="color: #93a8c6;">(</span>s.as_bytes<span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
    cmd.write_all<span style="color: #93a8c6;">(</span>b<span style="color: #deb887;">"\r\n"</span><span style="color: #93a8c6;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;

    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">cursor_bytes</span> = <span style="color: #a2cd5a;">itoa</span>::<span style="color: #98f5ff;">Buffer</span>::new<span style="color: #93a8c6;">()</span>;
    <span style="color: #00bfff;">for</span> <span style="color: #4eee94;">item</span> <span style="color: #00bfff;">in</span> args <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">bytes</span> = <span style="color: #00bfff;">match</span> item <span style="color: #b0b1a3;">{</span>
            <span style="color: #98f5ff;">Arg</span>::<span style="color: #98f5ff;">Cursor</span> =&gt; cursor_bytes.format<span style="color: #97b098;">(</span>cursor<span style="color: #97b098;">)</span>.as_bytes<span style="color: #97b098;">()</span>,
            <span style="color: #98f5ff;">Arg</span>::<span style="color: #98f5ff;">Simple</span><span style="color: #97b098;">(</span>val<span style="color: #97b098;">)</span> =&gt; val,
        <span style="color: #b0b1a3;">}</span>;

        cmd.write_all<span style="color: #b0b1a3;">(</span>b<span style="color: #deb887;">"$"</span><span style="color: #b0b1a3;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">s</span> = buf.format<span style="color: #b0b1a3;">(</span>bytes.len<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>;
        cmd.write_all<span style="color: #b0b1a3;">(</span>s.as_bytes<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
        cmd.write_all<span style="color: #b0b1a3;">(</span>b<span style="color: #deb887;">"\r\n"</span><span style="color: #b0b1a3;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;

        cmd.write_all<span style="color: #b0b1a3;">(</span>bytes<span style="color: #b0b1a3;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
        cmd.write_all<span style="color: #b0b1a3;">(</span>b<span style="color: #deb887;">"\r\n"</span><span style="color: #b0b1a3;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
    <span style="color: #93a8c6;">}</span>
    <span style="color: #98f5ff;">Ok</span><span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">)</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1fc78e2" class="outline-2">
<h2 id="org1fc78e2"><span class="section-number-2">5.</span> Pin &amp; UnPin, Future</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org9844fcd" class="outline-3">
<h3 id="org9844fcd"><span class="section-number-3">5.1.</span> 需要重新读一下： <a href="https://doc.rust-lang.org/std/pin/index.html">https://doc.rust-lang.org/std/pin/index.html</a> 因为 Box::pin(t) 可以将 T: Pin, 变为  unpin, 因为 Pointer 为 unpin.</h3>
</div>
<div id="outline-container-org048bcf3" class="outline-3">
<h3 id="org048bcf3"><span class="section-number-3">5.2.</span> Pin 的定义: Pin wrap pointers type， guarantee the value behind the pointer, won't be moved 即： Pin&lt;P&lt;T&gt;&gt; , 中的 T 不给交换(mem::swap) 移动</h3>
</div>
<div id="outline-container-orgafeedd9" class="outline-3">
<h3 id="orgafeedd9"><span class="section-number-3">5.3.</span> Pin 的意义: 即解决 self-ref的 结构体的 内存移动。</h3>
</div>
<div id="outline-container-org7622eb2" class="outline-3">
<h3 id="org7622eb2"><span class="section-number-3">5.4.</span> Pin &amp; UnPin 类型涉及到 Struct 中存在 自引用(self ref) 指针 的结构。</h3>
<div class="outline-text-3" id="text-5-4">
</div>
<div id="outline-container-org292bb4a" class="outline-4">
<h4 id="org292bb4a"><span class="section-number-4">5.4.1.</span> 因为 该种结构 可能需要move，即： 使用 mem::swap（one, two）， 该函数接受任何类型的 &amp;mut ref， 使用 memcpy 对内存进行交换。</h4>
</div>
<div id="outline-container-org6de389d" class="outline-4">
<h4 id="org6de389d"><span class="section-number-4">5.4.2.</span> memcpy 并不适合 对于 包含 self-ref 的结构进行 交换， 将导致 指针错乱，详见： <a href="https://rust-lang.github.io/async-book/04_pinning/01_chapter.html#pinning">https://rust-lang.github.io/async-book/04_pinning/01_chapter.html#pinning</a></h4>
</div>
<div id="outline-container-orga4038e2" class="outline-4">
<h4 id="orga4038e2"><span class="section-number-4">5.4.3.</span> Pin 的doc为<a href="https://doc.rust-lang.org/std/pin/index.html">https://doc.rust-lang.org/std/pin/index.html</a></h4>
</div>
</div>
<div id="outline-container-org3935172" class="outline-3">
<h3 id="org3935172"><span class="section-number-3">5.5.</span> 重读：<a href="https://rust-lang.github.io/async-book/04_pinning/01_chapter.html#pinning">https://rust-lang.github.io/async-book/04_pinning/01_chapter.html#pinning</a></h3>
<div class="outline-text-3" id="text-5-5">
</div>
<div id="outline-container-org74e2b41" class="outline-4">
<h4 id="org74e2b41"><span class="section-number-4">5.5.1.</span> 其中有对 为什么 会Future要求Pin 的要求，进行了基本的解释， 比如 async {} 转换为 类似对应的 Future（其中包含了 self-ref ） example：</h4>
<div class="outline-text-4" id="text-5-5-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">async</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">x</span> = <span style="color: #93a8c6;">[</span>0; 128<span style="color: #93a8c6;">]</span>;
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">read_into_buf_fut</span> = read_into_buf<span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> x<span style="color: #93a8c6;">)</span>;
    read_into_buf_fut.<span style="color: #00bfff;">await</span>;
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"</span><span style="color: #deb887; font-style: italic;">{:?}</span><span style="color: #deb887;">"</span>, x<span style="color: #93a8c6;">)</span>;

<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">compile to below like</span>
<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">ReadIntoBuf</span><span style="color: #8c8c8c;">&lt;</span>'<span style="color: #4eee94;">a</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">buf</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #00bfff;">mut</span> <span style="color: #93a8c6;">[</span><span style="color: #98f5ff;">u8</span><span style="color: #93a8c6;">]</span>, <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">points to `x` below</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">AsyncFuture</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">x</span>: <span style="color: #93a8c6;">[</span><span style="color: #98f5ff;">u8</span>; 128<span style="color: #93a8c6;">]</span>,
    <span style="color: #4eee94;">read_into_buf_fut</span>: <span style="color: #98f5ff;">ReadIntoBuf</span><span style="color: #93a8c6;">&lt;</span>'<span style="color: #4eee94;">what_lifetime</span><span style="color: #f08080; font-weight: bold;">?</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">AsyncFuture &#21253;&#21547; &#20869;&#37096; fut &#38656;&#35201;&#30340; &#21464;&#37327; x&#65292; ReadIntoBuf &#21017; &#21253;&#21547;&#25351;&#21521; AsyncFuture &#30340;&#25351;&#38024;&#65292;&#21363;&#65306; &#26500;&#25104;&#20102; Self-ref &#32467;&#26500;&#12290;</span>
<span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">&#21363;&#65306;&#22914;&#26524;&#23558; AsyncFuture swap&#20986;&#21435;&#65292; &#23558;&#23548;&#33268; &#25351;&#38024;&#30340;&#28151;&#20081;&#12290;</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org4d87b53" class="outline-4">
<h4 id="org4d87b53"><span class="section-number-4">5.5.2.</span> Pin wrap pointers type， guarantee the value behind the pointer, won't be moved, T: !Unpin  then  Pin&lt;&amp;mut T&gt;, Pin&lt;&amp;T&gt;, Pin&lt;Box&lt;T&gt;&gt; 保证T不被移动，</h4>
</div>
<div id="outline-container-org22e7057" class="outline-4">
<h4 id="org22e7057"><span class="section-number-4">5.5.3.</span> Future/Stream 从 Pin 到Unpin 的转换： Box::pin(Fut) =&gt; Pin&lt;Box&lt;Fut&gt;&gt;, pin_utils::pin_mut!(fut) =&gt; Pin&lt;&amp;mut Fut&gt; 即 =&gt; 后的实现 都是impl Unpin</h4>
</div>
<div id="outline-container-org269bce3" class="outline-4">
<h4 id="org269bce3"><span class="section-number-4">5.5.4.</span> summary:</h4>
<div class="outline-text-4" id="text-5-5-4">
</div>
<ol class="org-ol">
<li><a id="org726afc3"></a>if T: Unpin then Pin&lt;'a, T&gt; impl Unpin<br /></li>
<li><a id="orgd1404a8"></a>T: !Unpin, &amp;mut T =&gt; Pin&lt;T&gt;  的转换 需要unsafe 代码<br /></li>
<li><a id="orgcc70b10"></a>大部分的type  以及有这些type组成的struct impl Unpin, async/await 自动生成的 Future 是一个意外<br /></li>
<li><a id="orga60dcfc"></a>实现!Unpin 的方法： 1) impl !Unpin 在 nightly + feature flag 2) 添加 std::marker::PhantomPinned field到 struct<br /></li>
<li><a id="org29f45e4"></a>Pin 在stack 的var，需要使用unsafe code<br /></li>
<li><a id="orgbc983fa"></a>Pin 在heap上的var， 可以使用 Box::pin<br /></li>
<li><a id="org0c1bf8a"></a>For pinned data where T: !Unpin you have to maintain the invariant that its memory will not get invalidated or repurposed from the moment it gets pinned until when drop is called. This is an important part of the pin contract.<br /></li>
</ol>
</div>
</div>
<div id="outline-container-org476ac0d" class="outline-3">
<h3 id="org476ac0d"><span class="section-number-3">5.6.</span> Pin 并没有对 mem::swap 做特殊处理，因为swap 要求 &amp;mut T, 所以， Pin来prevent &amp;mut T 的导出即可。</h3>
<div class="outline-text-3" id="text-5-6">
</div>
<div id="outline-container-org5d829e7" class="outline-4">
<h4 id="org5d829e7"><span class="section-number-4">5.6.1.</span> 1. 测试一下，直接  mem::swap(&amp;mut Pin&lt;T&gt;, &amp;mut Pin&lt;T&gt;) ;</h4>
</div>
<div id="outline-container-org8b17dfb" class="outline-4">
<h4 id="org8b17dfb"><span class="section-number-4">5.6.2.</span> 2. 基本上所有的type 都会自动实现 Unpin, Future 是一个意外（需要查找 async function rust auto generator的示例 才能更深入的理解）</h4>
</div>
<div id="outline-container-org8fb8db5" class="outline-4">
<h4 id="org8fb8db5"><span class="section-number-4">5.6.3.</span> 3. T: is Unpin, then  Pin&lt;Box&lt;T&gt;&gt;, Box&lt;T&gt;, Pin&lt;&amp;mut T&gt;, &amp;mut T 都是 Unpin 的</h4>
</div>
<div id="outline-container-org3391750" class="outline-4">
<h4 id="org3391750"><span class="section-number-4">5.6.4.</span> 4. Pin&lt;Box&lt;T&gt;&gt;</h4>
</div>
<div id="outline-container-org5573895" class="outline-4">
<h4 id="org5573895"><span class="section-number-4">5.6.5.</span> </h4>
</div>
</div>
<div id="outline-container-org13f497a" class="outline-3">
<h3 id="org13f497a"><span class="section-number-3">5.7.</span> <a href="https://cfsamson.github.io/books-futures-explained/introduction.html">https://cfsamson.github.io/books-futures-explained/introduction.html</a></h3>
</div>
<div id="outline-container-org0a45fbf" class="outline-3">
<h3 id="org0a45fbf"><span class="section-number-3">5.8.</span> ? 所以Pin 的要求是什么？呢？,如果 要求 Pin&lt;Future&lt;Output = T&gt;&gt;  ?</h3>
</div>
<div id="outline-container-org8baf614" class="outline-3">
<h3 id="org8baf614"><span class="section-number-3">5.9.</span> Test:</h3>
<div class="outline-text-3" id="text-5-9">
</div>
<div id="outline-container-org0a787cd" class="outline-4">
<h4 id="org0a787cd"><span class="section-number-4">5.9.1.</span> mem::swap(&amp;mut Pin&lt;Box&lt;T&gt;&gt;, &amp;mut Pin<a id="orgde9baf1"></a>); T: !Unpin 可以的</h4>
</div>
</div>
</div>

<div id="outline-container-orga8f991c" class="outline-2">
<h2 id="orga8f991c"><span class="section-number-2">6.</span> ?? 如何构建一个 delegate_to macro库：</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org306974f" class="outline-3">
<h3 id="org306974f"><span class="section-number-3">6.1.</span> 1. 肯定是需要借助 macro构建</h3>
</div>
<div id="outline-container-org1a5c7e2" class="outline-3">
<h3 id="org1a5c7e2"><span class="section-number-3">6.2.</span> 2. 如何动态的进行一个  信息收集功能呢？ （这里面必然涉及到 一个动态分发的功能的实现） 举例说明：</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">PersonInner</span> <span style="color: #8c8c8c;">{</span>

<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">PersonInner</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">test</span><span style="color: #93a8c6;">()</span> <span style="color: #93a8c6;">{}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">TestMacro</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Person</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">PersonInner</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Person</span> <span style="color: #8c8c8c;">{</span>

  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">delegate_to</span><span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">test</span><span style="color: #93a8c6;">()</span> <span style="color: #93a8c6;">{}</span>

  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">delegate_to</span><span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">]</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">test_1</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">one</span>: <span style="color: #98f5ff;">i32</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{}</span>

  <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">delegate_to</span><span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">]</span> <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#22914;&#20309;&#23454;&#29616; &#20989;&#25968;&#31614;&#21517;&#30340; &#33258;&#21160;&#22635;&#20805;&#21602;&#65311;</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">test_1</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">one</span>: <span style="color: #98f5ff;">i32</span>, i<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8099739" class="outline-3">
<h3 id="org8099739"><span class="section-number-3">6.3.</span> 3. 为什么没有使用 Deref trait？ 因为Deref 中的target 只能有一个， 不能在一个 包含多个field的 struct中，同时 实现 Deref&lt;One&gt; , Deref&lt;Two&gt;, 即如下：</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">PersonInner</span> <span style="color: #8c8c8c;">{</span>

<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">PersonInner</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">test</span><span style="color: #93a8c6;">()</span> <span style="color: #93a8c6;">{}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">PersonOuter</span> <span style="color: #8c8c8c;">{</span>

<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">PersonOuter</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">fuck</span><span style="color: #93a8c6;">()</span> <span style="color: #93a8c6;">{}</span>
<span style="color: #8c8c8c;">}</span>


<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">TestMacro</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Person</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">PersonInner</span>,
  <span style="color: #4eee94;">outer</span>: <span style="color: #98f5ff;">PersonOuter</span>,
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Deref</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Person</span> <span style="color: #8c8c8c;">{</span>
   <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Target</span> = <span style="color: #98f5ff;">PersonInner</span>;
   <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">deref</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Target</span> <span style="color: #93a8c6;">{</span>
      <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.inner
   <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">//</span><span style="color: #7f7f7f;">error, conflict impl Deref</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Deref</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Person</span> <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Target</span> = <span style="color: #98f5ff;">PersonOuter</span>;
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Person</span> <span style="color: #8c8c8c;">{</span>

<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7396a84" class="outline-2">
<h2 id="org7396a84"><span class="section-number-2">7.</span> Async</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org38633ca" class="outline-3">
<h3 id="org38633ca"><span class="section-number-3">7.1.</span> 需要查看的相关 文章/github：</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>[done] <a href="https://cfsamson.github.io/books-futures-explained/introduction.html">https://cfsamson.github.io/books-futures-explained/introduction.html</a> 基本简单实现, 没有涉及到设么东西, 认识了 waker &amp; reactor, 并使用 thread 进行 timeout 触发</li>
<li>[done] <a href="https://cfsamson.github.io/book-exploring-async-basics/">https://cfsamson.github.io/book-exploring-async-basics/</a>  使用 Fn 来包装 为 Task (延迟计算, ) 然后使用 global runtime 进行注册, <a href="file:///Users/lishaohua/Documents/self_test/rust_test/async_explore/runtime/src/main.rs:485">代码在</a>  其中 Http 此类真正的 async io 操作 比较有意思: 需要手动的 注册 对 fd 的read感兴趣, 然后 注册 可read的callback</li>
<li>[done]  <a href="https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/">https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/</a> 讲解 如何Green Thread, 即 如何在stack/heap 中 实现 yield_thread, 通过 asm switch 汇编命令, 执行 函数 的跳转 (Task 是否有的时候跟 GreenThread 是一个东西? ) , 这里面 只是主动 yield, 编译器 负责主动生成yield 代码</li>
<li>[done] <a href="https://aturon.github.io/blog/2016/09/07/futures-design/">https://aturon.github.io/blog/2016/09/07/futures-design/</a>  非常好的文章, 基本贯穿了 Future的设计,  为什么采用 Poll base的 Future , 而非 callback base的形式, callback的形式要求进行 memory 分配, 导致 非zero cost, (在 对Future Join select 等 组合操作时), Task 就是 Green Thread,  Task 包含了 OS thread 执行它的 各种环境(寄存器 etc 设置等), Task 表示为状态机 由编译器 进行 转换, block_on 时候在 stack上分配, spawn 时在 heap分配 (因为需要 传递到 channel 由 thread pool 进行执行) , 一个Task由 多个 Task join组成时候, 状态机 如何保证 sub Task内的 fd可读时, 只会poll 对应的subTask, 而非 将所有的sub Task 都poll一遍? (这里面给出了解决的方法, 解决方法在这里 <a href="http://alexcrichton.com/futures-rs/futures/task/fn.with_unpark_event.html">http://alexcrichton.com/futures-rs/futures/task/fn.with_unpark_event.html</a> 但是 404了)</li>
<li><a href="https:https://github.com/aturon/rfcs/blob/remove-runtime/active/0000-remove-runtime.md">old green threading model</a> old Green Thread in Rust 是如何样子的 设计呢?</li>
<li><a href="https://cfsamsonbooks.gitbook.io/epoll-kqueue-iocp-explained/">https://cfsamsonbooks.gitbook.io/epoll-kqueue-iocp-explained/</a></li>
<li><a href="https://www.joyk.com/dig/detail/1580554844291848">https://www.joyk.com/dig/detail/1580554844291848</a></li>
<li><a href="https://docs.rs/smol/0.1.18/smol/index.html">https://docs.rs/smol/0.1.18/smol/index.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-org75f0704" class="outline-3">
<h3 id="org75f0704"><span class="section-number-3">7.2.</span> Runtime:</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li><a href="https://github.com/async-rs/async-std">https://github.com/async-rs/async-std</a></li>
<li><a href="https://github.com/tokio-rs/tokio">https://github.com/tokio-rs/tokio</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd055b48" class="outline-3">
<h3 id="orgd055b48"><span class="section-number-3">7.3.</span> Concurreny &amp; async</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li><a href="https://cfsamson.github.io/book-exploring-async-basics/1_concurrent_vs_parallel.html">https://cfsamson.github.io/book-exploring-async-basics/1_concurrent_vs_parallel.html</a></li>
<li><a href="https://cfsamson.github.io/book-exploring-async-basics/2_async_history.html">https://cfsamson.github.io/book-exploring-async-basics/2_async_history.html</a></li>
<li><a href="https://cfsamson.github.io/book-exploring-async-basics/5_strategies_for_handling_io.html">https://cfsamson.github.io/book-exploring-async-basics/5_strategies_for_handling_io.html</a></li>
<li><a href="https://cfsamson.github.io/book-exploring-async-basics/6_epoll_kqueue_iocp.html">https://cfsamson.github.io/book-exploring-async-basics/6_epoll_kqueue_iocp.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-org23fa89a" class="outline-3">
<h3 id="org23fa89a"><span class="section-number-3">7.4.</span> Waker:</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li><a href="https://boats.gitlab.io/blog/post/wakers-i/">https://boats.gitlab.io/blog/post/wakers-i/</a></li>
<li><a href="https://alschwalm.com/blog/static/2017/03/07/exploring-dynamic-dispatch-in-rust/">https://alschwalm.com/blog/static/2017/03/07/exploring-dynamic-dispatch-in-rust/</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge2f42b7" class="outline-3">
<h3 id="orge2f42b7"><span class="section-number-3">7.5.</span> Generators &amp; async/await</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li>generator: <a href="https://github.com/rust-lang/rfcs/blob/master/text/2033-experimental-coroutines.md">https://github.com/rust-lang/rfcs/blob/master/text/2033-experimental-coroutines.md</a></li>
<li><a href="https://cfsamson.github.io/books-futures-explained/0_background_information.html%23green-threads">https://cfsamson.github.io/books-futures-explained/0_background_information.html%23green-threads</a></li>
<li>yield:</li>
</ul>
</div>
</div>
<div id="outline-container-org03eba78" class="outline-3">
<h3 id="org03eba78"><span class="section-number-3">7.6.</span> Pin:</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li><a href="https://github.com/rust-lang/rfcs/blob/master/text/2349-pin.md">https://github.com/rust-lang/rfcs/blob/master/text/2349-pin.md</a></li>
</ul>
</div>
</div>
<div id="outline-container-org1f450b5" class="outline-3">
<h3 id="org1f450b5"><span class="section-number-3">7.7.</span> Park thread:</h3>
<div class="outline-text-3" id="text-7-7">
<ul class="org-ul">
<li><a href="https://cfsamson.github.io/books-futures-explained/6_future_example.html%23bonus-section---a-proper-way-to-park-our-thread">https://cfsamson.github.io/books-futures-explained/6_future_example.html%23bonus-section---a-proper-way-to-park-our-thread</a></li>
<li>Why using thread park/unpark is a bad idea for a library: <a href="https://github.com/rust-lang/futures-rs/pull/2010">https://github.com/rust-lang/futures-rs/pull/2010</a></li>
<li><a href="https://docs.rs/crossbeam/0.7.3/crossbeam/sync/struct.Parker.html">https://docs.rs/crossbeam/0.7.3/crossbeam/sync/struct.Parker.html</a></li>
<li></li>
</ul>
</div>
</div>
<div id="outline-container-orgaaf70ca" class="outline-3">
<h3 id="orgaaf70ca"><span class="section-number-3">7.8.</span> book:</h3>
<div class="outline-text-3" id="text-7-8">
<ul class="org-ul">
<li>The official Asyc book: <a href="https://rust-lang.github.io/async-book/01_getting_started/01_chapter.html">https://rust-lang.github.io/async-book/01_getting_started/01_chapter.html</a></li>
<li>Tokio tutorial: <a href="https://tokio.rs/tokio/tutorial">https://tokio.rs/tokio/tutorial</a></li>
<li>The async_std book: <a href="https://book.async.rs/">https://book.async.rs/</a></li>
<li>smol - a small and fast async runtime : <a href="https://github.com/smol-rs/async-executor/blob/master/src/lib.rs">https://github.com/smol-rs/async-executor/blob/master/src/lib.rs</a></li>
<li>Aron Turon: Designing futures for Rust: <a href="https://aturon.github.io/blog/2016/09/07/futures-design/">https://aturon.github.io/blog/2016/09/07/futures-design/</a></li>
<li>Steve Klabnik's presentation: Rust's journey to Async/Await: <a href="https://www.infoq.com/presentations/rust-2019/">https://www.infoq.com/presentations/rust-2019/</a></li>
<li>The Tokio Blog: <a href="https://tokio.rs/blog/2019-10-scheduler/">https://tokio.rs/blog/2019-10-scheduler/</a></li>
<li>Stjepan's blog with a series where he implements an Executor: <a href="https://web.archive.org/web/20200207092849/https://stjepang.github.io/2020/01/31/build-your-own-executor.html">https://web.archive.org/web/20200207092849/https://stjepang.github.io/2020/01/31/build-your-own-executor.html</a></li>
<li>Jon Gjengset's video on The Why, What and How of Pinning in Rust: <a href="https://youtu.be/DkMwYxfSYNQ">https://youtu.be/DkMwYxfSYNQ</a></li>
<li>Withoutboats blog series about async/await: <a href="https://boats.gitlab.io/blog/post/2018-01-25-async-i-self-referential-structs/">https://boats.gitlab.io/blog/post/2018-01-25-async-i-self-referential-structs/</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf3ff5ef" class="outline-2">
<h2 id="orgf3ff5ef"><span class="section-number-2">8.</span> Async impl:</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org461a5f5" class="outline-3">
<h3 id="org461a5f5"><span class="section-number-3">8.1.</span> 200 line  rust async: 讲解： 代码在： rust_test/async_test/src/main.rs:193</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>在 main 函数中， 创建 Reactor, 在 block_on 中创建 Waker, 然后调用 Future::poll(Future, waker)</li>
<li>Future Trait 定义了 fn poll() 方法，</li>
<li>Future::poll 内容为： Task 根据 reactor中自己的 state， 然后决定 .regist,  还是 等待，</li>
<li>Reactor::regist 之后，将 waker，以及 task.id， 放倒入 self.tasks 中, 并spawn进行计时， 计时之后执行的代码为， reactor.lock().wake(task.id)， reactor.wake 方法简单的 将 thread::unpark 即完成了工作.</li>
</ul>
</div>
</div>
<div id="outline-container-org7f69ee6" class="outline-3">
<h3 id="org7f69ee6"><span class="section-number-3">8.2.</span> Waker &amp; Context 结构: Waker 最为重要， Waker 在简单的设计中 的操作 即是： 唤醒  thread</h3>
<div class="outline-text-3" id="text-8-2">
<ul class="org-ul">
<li>struct Waker： 构建方式 只能是 unsafe fn from_raw(waker: RawWaker) -&gt; Waker, 其他的则是 wake, will_wake wake相关的函数 etc (impl  From&lt;Arc&lt;Wake(trait)&gt;&gt;)</li>
<li>std::task::RawWaker: 则是一个 data pointer &amp; vtable(一系列的函数指针) 的struct。（因为在 嵌入式中不能使用 Trait 所以提供此类方式 实现 Trait Waker）</li>
<li>Context 结构目前 仅是Waker结构的 简单包装而已，并没有任何特殊用途</li>
</ul>
</div>
</div>
<div id="outline-container-orgce740b9" class="outline-3">
<h3 id="orgce740b9"><span class="section-number-3">8.3.</span> Future trait:  <a href="https://aturon.github.io/blog/2016/08/11/futures/">https://aturon.github.io/blog/2016/08/11/futures/</a></h3>
<div class="outline-text-3" id="text-8-3">
<ul class="org-ul">
<li>fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;</li>
<li>Task 实现了 Future Trait：  Task 中的poll方法，应该在Task不能够继续进展时， 应该 reactor.regist(self) 关注 自己的 fd（将自身注册到  reactor上）</li>
<li>所以 结构如下：</li>
</ul>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Task</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">id</span>: <span style="color: #98f5ff;">usize</span>,
    <span style="color: #4eee94;">data</span>: <span style="color: #98f5ff;">u64</span>,
    <span style="color: #4eee94;">reactor</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Mutex</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Box</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">Reactor</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #7f7f7f;">//// </span><span style="color: #7f7f7f;">&#24212;&#35813;&#21253;&#21547;&#21807;&#19968;&#30340; reactor &#25351;&#38024;</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Future</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Task</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Output</span> = <span style="color: #98f5ff;">usize</span>;

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">poll</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">self</span>: <span style="color: #98f5ff;">Pin</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Self</span><span style="color: #b0b1a3;">&gt;</span>, <span style="color: #4eee94;">cx</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Context</span><span style="color: #b0b1a3;">&lt;</span>'<span style="color: #4eee94;">_</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Poll</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Output</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #f08080;">println!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"poll ing----------"</span><span style="color: #b0b1a3;">)</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">r</span> = <span style="color: #00bfff;">self</span>.reactor.lock<span style="color: #b0b1a3;">()</span>.unwrap<span style="color: #b0b1a3;">()</span>;

        <span style="color: #00bfff;">if</span> r.is_ready<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.id<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">{</span>
            *r.tasks.get_mut<span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.id<span style="color: #97b098;">)</span>.unwrap<span style="color: #97b098;">()</span> = <span style="color: #98f5ff;">TaskState</span>::<span style="color: #98f5ff;">Finished</span>;
            <span style="color: #98f5ff;">Poll</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">self</span>.id<span style="color: #97b098;">)</span>
        <span style="color: #b0b1a3;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #00bfff;">if</span> r.tasks.contains_key<span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.id<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">{</span>
            r.tasks
                .insert<span style="color: #97b098;">(</span><span style="color: #00bfff;">self</span>.id, <span style="color: #98f5ff;">TaskState</span>::<span style="color: #98f5ff;">NotReady</span><span style="color: #aebed8;">(</span>cx.waker<span style="color: #b0b0b3;">()</span>.clone<span style="color: #b0b0b3;">()</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>;
            <span style="color: #98f5ff;">Poll</span>::<span style="color: #98f5ff;">Pending</span>
        <span style="color: #b0b1a3;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#19982; reactor &#30340;&#20132;&#20114;,  reactor &#23558; &#20219;&#21153; &#29366;&#24577;&#25554;&#20837;&#21040; tasks &#20013;, &#28982;&#21518; send(msg) &#21040; &#21478;&#22806;&#19968;&#20010; &#32447;&#31243; (&#21478;&#19968;&#20010; &#32447;&#31243; &#25509;&#21463;&#21040;&#21734; msg &#20043;&#21518;&#36827;&#34892; &#35745;&#26102;,  &#20043;&#21518; &#20462;&#25913; TaskState, &#28982;&#21518; wake &#36816;&#34892;&#32447;&#31243;)</span>
            <span style="color: #7f7f7f;">//  </span><span style="color: #7f7f7f;">fn regist(&amp;mut self, task_id: u16, waker: Waker, duration: u64) {</span>
            <span style="color: #7f7f7f;">//      </span><span style="color: #7f7f7f;">if self.tasks.insert(task_id, TaskState::Wait(waker)).is_none() {</span>
            <span style="color: #7f7f7f;">//          </span><span style="color: #7f7f7f;">self.dispatcher</span>
            <span style="color: #7f7f7f;">//              </span><span style="color: #7f7f7f;">.send(Event::Timeout(task_id, duration))</span>
            <span style="color: #7f7f7f;">//              </span><span style="color: #7f7f7f;">.unwrap();</span>
            <span style="color: #7f7f7f;">//      </span><span style="color: #7f7f7f;">}</span>
            <span style="color: #7f7f7f;">//  </span><span style="color: #7f7f7f;">}</span>

             r.regist
                <span style="color: #97b098;">(</span><span style="color: #00bfff;">self</span>.data, cx.waker<span style="color: #aebed8;">()</span>.clone<span style="color: #aebed8;">()</span>, <span style="color: #00bfff;">self</span>.id<span style="color: #97b098;">)</span>;
            <span style="color: #98f5ff;">Poll</span>::<span style="color: #98f5ff;">Pending</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orge6ecd08" class="outline-3">
<h3 id="orge6ecd08"><span class="section-number-3">8.4.</span> Reactor: async 的核心， 类似于 epoll： 是链接 fd 与 Task的重要纽带，</h3>
<div class="outline-text-3" id="text-8-4">
<ul class="org-ul">
<li>在简单的实现中： Reactor  实现的比较 复杂，保存着 Task的TaskState, TaskState是包含Waker的一个 enum， 在 fd可用时，能够 waker.wake()</li>
</ul>
</div>
</div>
<div id="outline-container-org52d7d39" class="outline-3">
<h3 id="org52d7d39"><span class="section-number-3">8.5.</span> Executor: 主要包含 Task Struct &amp; TaskState， Queue ， 如何 Handle Panic， &amp; spawn Task</h3>
<div class="outline-text-3" id="text-8-5">
<ul class="org-ul">
<li>Handle Panic 可以通过 在 catch_unwind  block 中执行</li>
<li>Queue： 则包含着 多个 queue 的设计，以及 steal work 的一些设计</li>
<li>Spawn Task: 在实现 spawn_task 只alloc 一次，并不容易， 因为 需要 alloc Task ，then alloc Task State &amp; alloc oneshot channel，第一次实现 alloc once 是在 <a href="https://github.com/async-rs/async-task/releases/tag/v1.0.0">async-task 1.0 版本</a>  <a href="https://async.rs/blog/announcing-async-std/">相关blog 在</a>, tokio 在 之后实现了 类似的 操作 <a href="https://tokio.rs/blog/2019-10-scheduler/#reducing-allocations">https://tokio.rs/blog/2019-10-scheduler/#reducing-allocations</a>)</li>
</ul>
</div>
</div>
<div id="outline-container-org49629a3" class="outline-3">
<h3 id="org49629a3"><span class="section-number-3">8.6.</span> ？ Arc：</h3>
<div class="outline-text-3" id="text-8-6">
<ul class="org-ul">
<li>应该注意在 多线程 中， 对于 Arc的把持，可能会产生的“死锁” 问题， 即： 应该在 生命最短  的 thread中 把持 Arc::downgrade, 而非 Arc.clone()</li>
<li>在  main.rs 代码中， 即： Reactor 不会在main thread 中进行释放，可能会在其他的thread 中进行，从而导致错误的代码逻辑 (因为 Thread 之间为兄弟关系，并非从属关系，所以 哪一个 wait  另一个 并没有太大的问题？)</li>
</ul>
</div>
</div>

<div id="outline-container-org0fd3ef5" class="outline-3">
<h3 id="org0fd3ef5"><span class="section-number-3">8.7.</span> rust 是如何将 async block 转换为 Task: Future 的poll调用的</h3>
<div class="outline-text-3" id="text-8-7">
<ul class="org-ul">
<li>Generator &amp; Future 有非常多相似之处，但是 之前存在哪些关联， 则是比较隐晦、晦涩的。即： 简单的介绍了  Generator  代码生成后的 效果，即： Future 也是如此 (代码具有许多的关联之处)</li>
<li>关键： Task 的poll 方法，是如何 通过 async {} 调用到的</li>
</ul>
<pre class="example" id="org0664bcc">
// Generator 代码
fn main() {
  let a:i32 = 4;
  let mut gen = move || {
     yield a * 2; // 跟 (a*2).await 类似
  }

  if let GeneratorState::Yield(n) = gen.resume()  {
     // do something
  }
  if let GeneratorState::Compelete(()) = gen.resume() {
    // ....
  }
}
// 上述代码 被转换为 通用代码
enum GeneratorState&lt;Y, R&gt; {
  Yield(Y),
  Complete(R),
}

trait Generator {
  type Yield; type Return;

  fn resume(&amp;mut self) -&gt; GeneratorState&lt;Yield, Return&gt;;
}


enum GeneratorA {
  Enter(i32),
  Yield(i32),
  Exit,
}

impl GeneratorA {
  fn start(a: i32) {GeneratorA::Enter(a)}
}

impl Generator for GeneratorA {
  type Yield = i32;
  type Return = ();
  fn resume(&amp;mut self) -&gt; GeneratorState&lt;Yield, Return&gt; {
    match self {
      GeneratorA::Enter(a) =&gt; {
        // yield code, a = a * 2;
        a = a * 2;
        *self = GeneratorA::Yield(a);
        GeneratorState::Yield(a);
      }
      GeneratorA::Yield(_) =&gt; {
        *self = GeneratorA::Exist;
        GeneratorState::Complete(());
      }
      GeneratorA::Exist() =&gt; {
        panic("can't advance any more");
      }
   }
  }
}
</pre>
</div>
</div>
<div id="outline-container-org1109378" class="outline-3">
<h3 id="org1109378"><span class="section-number-3">8.8.</span> 几个重要的 crate: crossbeam, async-std, tokio, 之间的关系，  async-task</h3>
</div>
</div>
<div id="outline-container-org5852902" class="outline-2">
<h2 id="org5852902"><span class="section-number-2">9.</span> tokio: 全解析：</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgc6d2191" class="outline-3">
<h3 id="orgc6d2191"><span class="section-number-3">9.1.</span> Tokio useage:</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-org28cdf32" class="outline-4">
<h4 id="org28cdf32"><span class="section-number-4">9.1.1.</span> #[tokio:main]: 将 main函数 转换为  async 然后 自动 构建 let r = runtime::Builder::new(); r.block_on(整体的 func)</h4>
</div>
<div id="outline-container-org84970b0" class="outline-4">
<h4 id="org84970b0"><span class="section-number-4">9.1.2.</span> runtime.block_on(async future) 直接收 async  func， 并 调用  exec.block_on(future) 以执行 future</h4>
</div>
<div id="outline-container-orga9a1ffa" class="outline-4">
<h4 id="orga9a1ffa"><span class="section-number-4">9.1.3.</span> .await 只能在 async function中 调用, 即: 1) await 只为 async fun 准备, 2) await 将 future  转换为  Generator 的状态机 3) await 顺序执行, 执行一次, loop 为 server 循环处理 client的 关键逻辑</h4>
</div>
<div id="outline-container-org75a41d9" class="outline-4">
<h4 id="org75a41d9"><span class="section-number-4">9.1.4.</span> block_on(future) 为 阻塞调用, 一直 poll 直到 future完成</h4>
</div>
<div id="outline-container-org638ecd1" class="outline-4">
<h4 id="org638ecd1"><span class="section-number-4">9.1.5.</span> spawn 则直接spawn task,交由 runtime去执行</h4>
</div>
<div id="outline-container-org49604ea" class="outline-4">
<h4 id="org49604ea"><span class="section-number-4">9.1.6.</span> ? tokio 如何实现的 sleep ? 为什么 Sleep 并没有实现 Future?</h4>
</div>
</div>
<div id="outline-container-orgc203eef" class="outline-3">
<h3 id="orgc203eef"><span class="section-number-3">9.2.</span> 在异步中使用  Mutex 并非一个好的主意, 无论是 tokio::sync::Mutex, or std Mutex  都是: 所以最好的方式,依然是 spawn task for all task use, and pass msg for connection</h3>
</div>
<div id="outline-container-org9076e3c" class="outline-3">
<h3 id="org9076e3c"><span class="section-number-3">9.3.</span> 在使用 HashMap&lt;room, TcpStream&gt; 实现的过程中, 存在了如下问题:</h3>
<div class="outline-text-3" id="text-9-3">
</div>
<div id="outline-container-org33f5399" class="outline-4">
<h4 id="org33f5399"><span class="section-number-4">9.3.1.</span> 1. std::net::TcpStream, 因为需要保持 socket 的多处ref  &amp; 可写, 导致 需要使用 RefCell, 而 RefCell 是 !Sync 导致, Mutex&lt;RefCell&lt;TcpStream&gt;&gt; 不能够 Send + Sync, 因为 Mutex 的签名 为: impl&lt;T: ?Sized + Send&gt; Send for Mutex&lt;T&gt;, impl&lt;T: ?Sized + Send&gt; Sync for Mutex&lt;T&gt;</h4>
</div>
<div id="outline-container-org031b2ec" class="outline-4">
<h4 id="org031b2ec"><span class="section-number-4">9.3.2.</span> 2. tokio::net::TcpStream 因为 是 Sync &amp; Send, 所以实现了 如下的代码包装: 其中存在的问题为, 经常出现“死锁”情况. 并且 无法避免: 因为 一个read 完成之后,会进入另一个 循环,进行read, 并且 总是在read中, read 会把持 lock, 导致, public_msg 无法进行完全.</h4>
</div>
<div id="outline-container-org200ca45" class="outline-4">
<h4 id="org200ca45"><span class="section-number-4">9.3.3.</span> 3. 所以, 使用 Mutex 对 Fd 进行加锁的行为, 不可行.(因为无法避免 fd 在等待 read)</h4>
<div class="outline-text-4" id="text-9-3-3">
<pre class="example" id="orgbf3ee7a">
#[derive(Clone)]
struct SocketWrapper {
    inner: Arc&lt;Mutex&lt;TcpStream&gt;&gt;,
    eq: SocketAddr,
}
impl Deref for SocketWrapper {
    type Target = Arc&lt;Mutex&lt;TcpStream&gt;&gt;;
    fn deref(&amp;self) -&gt; &amp;Self::Target {
        &amp;self.inner
    }
}
impl DerefMut for SocketWrapper {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {
        &amp;mut self.inner
    }
}

impl SocketWrapper {
    fn new(socket: Arc&lt;Mutex&lt;TcpStream&gt;&gt;, eq: SocketAddr) -&gt; SocketWrapper {
        SocketWrapper { inner: socket, eq }
    }
}
impl PartialEq for SocketWrapper {
    fn eq(&amp;self, other: &amp;SocketWrapper) -&gt; bool {
        self.eq.eq(&amp;other.eq)
    }

    fn ne(&amp;self, other: &amp;SocketWrapper) -&gt; bool {
        self.eq.ne(&amp;other.eq)
    }
}
impl Hash for SocketWrapper {
    fn hash&lt;H: Hasher&gt;(&amp;self, state: &amp;mut H) {
        self.eq.hash(state);
    }
}

impl fmt::Debug for SocketWrapper {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, "addr: {}", self.eq)
    }
}
impl Eq for SocketWrapper {}

let chat_room: Mutex&lt;HashMap&lt;String, HashSet&lt;SocketWrapper&gt;&gt;&gt; = Mutex::new(HashMap::new());
// 主体结构如下:
fn main() {
    let addr = env::args()
        .nth(1)
        .unwrap_or_else(|| "127.0.0.1:8080".to_string());

    // Next up we create a TCP listener which will listen for incoming
    // connections. This TCP listener is bound to the address we determined
    // above and must be associated with an event loop.

    let runtime = tokio::runtime::Builder::new_current_thread()
        .enable_all()
        .build()
        .unwrap();
    let chat_room: Mutex&lt;HashMap&lt;String, HashSet&lt;SocketWrapper&gt;&gt;&gt; = Mutex::new(HashMap::new());
    let chat_room = Arc::new(chat_room);

    runtime.block_on(async {
        let listener = TcpListener::bind(&amp;addr).await.unwrap();
        // let mut db: Arc&lt;Mutex&lt;HashMap&lt;String, HashSet&lt;TcpStream&gt;&gt;&gt;&gt; =
        //     Arc::new(Mutex::new(HashMap::default()));
        loop {
            let (mut socket, addr) = listener.accept().await.unwrap();
            let peer_addr = socket.peer_addr().unwrap();
            let socket = Arc::new(Mutex::new(socket));
            let socket_fd = SocketWrapper::new(socket, peer_addr);
            // println!("filename: {:?}", socket.to_m.file_name_ref());
            // println!("socket: {:?}", socket.peer_addr());
            // let chat = chat_room.clone();
            // let socket = SocketWrapper::new(socket, socket.peer_addr());

            let i_chat = chat_room.clone();
            // let idb = db.clone();
            // let mut chat = db.clone();
            tokio::spawn(async move { socket_handler(socket_fd, i_chat).await });
        }
    })
}

async fn socket_handler(
    socket: SocketWrapper,
    db: Arc&lt;Mutex&lt;HashMap&lt;String, HashSet&lt;SocketWrapper&gt;&gt;&gt;&gt;,
) {
    let mut buf = vec![0; 1024];
    let mut n = 0;
    loop {
        {
            n = socket
                .lock()
                .await
                .read(&amp;mut buf)
                .await
                .expect("failed to read data from socket");
        }

        if n == 0 {
            return;
        }
        let istr: String = String::from_utf8_lossy(&amp;buf[0..n]).into_owned();
        // split by : , room, msg;
        let mut iter = istr.split(":");
        let room = iter.next().unwrap_or("global");
        let msg = iter.next();
        let i_db = db.clone();

        {
            let mut lock = i_db.lock().await;
            let mut val = lock.entry(room.to_owned()).or_insert(HashSet::new());
            val.insert(socket.clone());
        }
        println!(
            "istr: {:?}, room: {:?}, msg: {:?}, db: {:?}",
            istr, room, msg, db
        );

        {
            if let Some(i_msg) = msg {
                publish_msg(room, i_msg, db.clone()).await;
            }
        }

        {
            socket
                .lock()
                .await
                .write_all(&amp;buf[0..n])
                .await
                .expect("failed to write data to socket");
        }
        n = 0;
    }
}
async fn publish_msg(
    room: &amp;str,
    msg: &amp;str,
    db: Arc&lt;Mutex&lt;HashMap&lt;String, HashSet&lt;SocketWrapper&gt;&gt;&gt;&gt;,
) {
    println!("publish_msg begin");
    if let Some(pepoles) = db.lock().await.get(room) {
        println!("****************************************************************************************************");
        for s in pepoles.iter() {
            s.lock().await.write(&amp;msg.as_ref()).await;
        }
    }
    println!("publish_msg done");
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb1c644e" class="outline-3">
<h3 id="orgb1c644e"><span class="section-number-3">9.4.</span> mio:</h3>
<div class="outline-text-3" id="text-9-4">
</div>
<div id="outline-container-orgdc83150" class="outline-4">
<h4 id="orgdc83150"><span class="section-number-4">9.4.1.</span> <a href="file:///Users/lishaohua/.cargo/registry/src/github.com-1ecc6299db9ec823/mio-0.6.12/src/poll.rs:327">mio::Poll</a> : 屏蔽 各个平台实现的 EventLoop : (linux epoll)</h4>
</div>
<div id="outline-container-org994d888" class="outline-4">
<h4 id="org994d888"><span class="section-number-4">9.4.2.</span> 大概的使用方法为:</h4>
<div class="outline-text-4" id="text-9-4-2">
<pre class="example" id="org14cba9c">
let poll = Poll::new()?;
let socket = TcpStream::connect(&amp;"216.58.193.100:80".parse()?)?;
// the socket with `poll`, requesting readable
poll.register(&amp;socket, Token(0), Ready::readable(), PollOpt::edge())?;


// Poll 结构比较重要:

pub struct Poll {
    // Platform specific IO selector
    selector: sys::Selector,

    // Custom readiness queue
    readiness_queue: ReadinessQueue,

    // Use an atomic to first check if a full lock will be required. This is a
    // fast-path check for single threaded cases avoiding the extra syscall
    lock_state: AtomicUsize,

    // Sequences concurrent calls to `Poll::poll`
    lock: Mutex&lt;()&gt;,

    // Wakeup the next waiter
    condvar: Condvar,
}
</pre>
</div>
</div>
<div id="outline-container-org3fb2d64" class="outline-4">
<h4 id="org3fb2d64"><span class="section-number-4">9.4.3.</span> 经过层层调用, 最终 调用为 <a href="file:///Users/lishaohua/.cargo/registry/src/github.com-1ecc6299db9ec823/mio-0.6.12/src/sys/unix/kqueue.rs:95">Selector.register()</a></h4>
</div>
<div id="outline-container-org8c770ef" class="outline-4">
<h4 id="org8c770ef"><span class="section-number-4">9.4.4.</span> Poll.poll(&amp;mut events) 中的代码比较复杂:  <a href="file:///Users/lishaohua/.cargo/registry/src/github.com-1ecc6299db9ec823/mio-0.6.12/src/poll.rs:1007">需要重新看</a></h4>
</div>
<div id="outline-container-org9558c7a" class="outline-4">
<h4 id="org9558c7a"><span class="section-number-4">9.4.5.</span> Poll.register 方法比较 有意思:  这其中隐含着 rust的代码设计模式, 值得思考, 如何范化 参数限制</h4>
<div class="outline-text-4" id="text-9-4-5">
<pre class="example" id="org40b97f4">
// 这里 使用了 generic template, 但是对E 做了impl的限制
pub fn register&lt;E: ?Sized&gt;(&amp;self, handle: &amp;E, token: Token, interest: Ready, opts: PollOpt) -&gt; io::Result&lt;()&gt;
    where E: Evented
{
    validate_args(token)?;

    /*
     * Undefined behavior:
     * - Reusing a token with a different `Evented` without deregistering
     * (or closing) the original `Evented`.
     */
    trace!("registering with poller");

    // Register interests for this socket
    // 这里 将 方法调用 转身 传递给了 handle 参数
    handle.register(self, token, interest, opts)?;

    Ok(())
}
</pre>
</div>
</div>
<div id="outline-container-orge70b543" class="outline-4">
<h4 id="orge70b543"><span class="section-number-4">9.4.6.</span> </h4>
</div>
</div>
<div id="outline-container-orgddde8a0" class="outline-3">
<h3 id="orgddde8a0"><span class="section-number-3">9.5.</span> tokio: source code</h3>
<div class="outline-text-3" id="text-9-5">
</div>
<div id="outline-container-org37166a7" class="outline-4">
<h4 id="org37166a7"><span class="section-number-4">9.5.1.</span> Events: A collection of readiness events</h4>
<div class="outline-text-4" id="text-9-5-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #ffe4b5;">/// Representation of a spawned future/stream.</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// This object is returned by the `spawn` function in this module. This</span>
<span style="color: #ffe4b5;">/// represents a "fused task and future", storing all necessary pieces of a task</span>
<span style="color: #ffe4b5;">/// and owning the top-level future that's being driven as well.</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// A `Spawn` can be poll'd for completion or execution of the current thread</span>
<span style="color: #ffe4b5;">/// can be blocked indefinitely until a notification arrives. This can be used</span>
<span style="color: #ffe4b5;">/// with either futures or streams, with different methods being available on</span>
<span style="color: #ffe4b5;">/// `Spawn` depending which is used.</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Spawn</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #f08080; font-weight: bold;">?</span><span style="color: #98f5ff;">Sized</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">id</span>: <span style="color: #98f5ff;">usize</span>,
    <span style="color: #4eee94;">data</span>: <span style="color: #98f5ff;">LocalMap</span>,
    <span style="color: #4eee94;">obj</span>: <span style="color: #98f5ff;">T</span>,
<span style="color: #8c8c8c;">}</span>


<span style="color: #ffe4b5;">/// Pre-allocated storage for a uniform data type</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// See [module documentation] for more details.</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// [module documentation]: index.html</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Clone</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Slab</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Chunk of memory</span>
    <span style="color: #4eee94;">entries</span>: <span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Entry</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Number of Filled elements currently in the slab</span>
    <span style="color: #4eee94;">len</span>: <span style="color: #98f5ff;">usize</span>,

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Offset of the next available slot in the slab. Set to the slab's</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">capacity when the slab is full.</span>
    <span style="color: #4eee94;">next</span>: <span style="color: #98f5ff;">usize</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #ffe4b5;">/// An event loop.</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// The event loop is the main source of blocking in an application which drives</span>
<span style="color: #ffe4b5;">/// all other I/O events and notifications happening. Each event loop can have</span>
<span style="color: #ffe4b5;">/// multiple handles pointing to it, each of which can then be used to create</span>
<span style="color: #ffe4b5;">/// various I/O objects to interact with the event loop in interesting ways.</span>
<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO: expand this</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Core</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">events</span>: <span style="color: #a2cd5a;">mio</span>::<span style="color: #98f5ff;">Events</span>,
    <span style="color: #4eee94;">tx</span>: <span style="color: #a2cd5a;">mpsc</span>::<span style="color: #98f5ff;">UnboundedSender</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Message</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #4eee94;">rx</span>: <span style="color: #98f5ff;">RefCell</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Spawn</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #a2cd5a;">mpsc</span>::<span style="color: #98f5ff;">UnboundedReceiver</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">Message</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #4eee94;">_rx_registration</span>: <span style="color: #a2cd5a;">mio</span>::<span style="color: #98f5ff;">Registration</span>,
    <span style="color: #4eee94;">rx_readiness</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">MySetReadiness</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Rc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">RefCell</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Inner</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Used for determining when the future passed to `run` is ready. Once the</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">registration is passed to `io` above we never touch it again, just keep</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">it alive.</span>
    <span style="color: #4eee94;">_future_registration</span>: <span style="color: #a2cd5a;">mio</span>::<span style="color: #98f5ff;">Registration</span>,
    <span style="color: #4eee94;">future_readiness</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">MySetReadiness</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>


<span style="color: #ffe4b5;">/// A collection of readiness events.</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// `Events` is passed as an argument to [`Poll::poll`] and will be used to</span>
<span style="color: #ffe4b5;">/// receive any new readiness events received since the last poll. Usually, a</span>
<span style="color: #ffe4b5;">/// single `Events` instance is created at the same time as a [`Poll`] and</span>
<span style="color: #ffe4b5;">/// reused on each call to [`Poll::poll`].</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// See [`Poll`] for more documentation on polling.</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// # Examples</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// ```</span>
<span style="color: #ffe4b5;">/// # use std::error::Error;</span>
<span style="color: #ffe4b5;">/// # fn try_main() -&gt; Result&lt;(), Box&lt;Error&gt;&gt; {</span>
<span style="color: #ffe4b5;">/// use mio::{Events, Poll};</span>
<span style="color: #ffe4b5;">/// use std::time::Duration;</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// let mut events = Events::with_capacity(1024);</span>
<span style="color: #ffe4b5;">/// let poll = Poll::new()?;</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// assert_eq!(0, events.len());</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// // Register `Evented` handles with `poll`</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// poll.poll(&amp;mut events, Some(Duration::from_millis(100)))?;</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// for event in &amp;events {</span>
<span style="color: #ffe4b5;">///     println!("event={:?}", event);</span>
<span style="color: #ffe4b5;">/// }</span>
<span style="color: #ffe4b5;">/// #     Ok(())</span>
<span style="color: #ffe4b5;">/// # }</span>
<span style="color: #ffe4b5;">/// #</span>
<span style="color: #ffe4b5;">/// # fn main() {</span>
<span style="color: #ffe4b5;">/// #     try_main().unwrap();</span>
<span style="color: #ffe4b5;">/// # }</span>
<span style="color: #ffe4b5;">/// ```</span>
<span style="color: #ffe4b5;">///</span>
<span style="color: #ffe4b5;">/// [`Poll::poll`]: struct.Poll.html#method.poll</span>
<span style="color: #ffe4b5;">/// [`Poll`]: struct.Poll.html</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Events</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">inner</span>: <span style="color: #a2cd5a;">sys</span>::<span style="color: #98f5ff;">Events</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Events</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">sys_events</span>: <span style="color: #98f5ff;">KeventList</span>,
    <span style="color: #4eee94;">events</span>: <span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Event</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #4eee94;">event_map</span>: <span style="color: #98f5ff;">HashMap</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Token</span>, <span style="color: #98f5ff;">usize</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">KeventList</span><span style="color: #8c8c8c;">(</span><span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #a2cd5a;">libc</span>::kevent<span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span>;

<span style="color: #ffe4b5;">/// [`Token`]: ../struct.Token.html</span>
<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Copy, Clone, Eq, PartialEq, Debug</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Event</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">kind</span>: <span style="color: #98f5ff;">Ready</span>,
    <span style="color: #4eee94;">token</span>: <span style="color: #98f5ff;">Token</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org875a2fd" class="outline-4">
<h4 id="org875a2fd"><span class="section-number-4">9.5.2.</span> Runtime:</h4>
</div>
<div id="outline-container-org52f0a88" class="outline-4">
<h4 id="org52f0a88"><span class="section-number-4">9.5.3.</span> source code</h4>
<div class="outline-text-4" id="text-9-5-3">
<div class="org-src-container">
<pre class="src src-rust">    <span style="color: #ffe4b5;">/// cpu-pool  &#20195;&#30721; ----------------------------------</span>
    <span style="color: #ffe4b5;">/// A thread pool intended to run CPU intensive work.</span>
    <span style="color: #ffe4b5;">/// &#20351;&#29992; Thread Pool &#25191;&#34892; task</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">CpuPool</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Inner</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Builder</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">create</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">CpuPool</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>tx, rx<span style="color: #b0b1a3;">)</span> = <span style="color: #a2cd5a;">mpsc</span>::channel<span style="color: #b0b1a3;">()</span>;
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">pool</span> = <span style="color: #98f5ff;">CpuPool</span> <span style="color: #b0b1a3;">{</span>
                <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Arc</span>::new<span style="color: #97b098;">(</span><span style="color: #98f5ff;">Inner</span> <span style="color: #aebed8;">{</span>
                    <span style="color: #4eee94;">tx</span>: <span style="color: #98f5ff;">Mutex</span>::new<span style="color: #b0b0b3;">(</span>tx<span style="color: #b0b0b3;">)</span>,
                    <span style="color: #4eee94;">rx</span>: <span style="color: #98f5ff;">Mutex</span>::new<span style="color: #b0b0b3;">(</span>rx<span style="color: #b0b0b3;">)</span>,
                    <span style="color: #4eee94;">cnt</span>: <span style="color: #98f5ff;">AtomicUsize</span>::new<span style="color: #b0b0b3;">(</span>1<span style="color: #b0b0b3;">)</span>,
                    <span style="color: #4eee94;">size</span>: <span style="color: #00bfff;">self</span>.pool_size,
                <span style="color: #aebed8;">}</span><span style="color: #97b098;">)</span>,
            <span style="color: #b0b1a3;">}</span>;
            <span style="color: #ffd700;">assert!</span><span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.pool_size &gt; 0<span style="color: #b0b1a3;">)</span>;

            <span style="color: #00bfff;">for</span> <span style="color: #4eee94;">counter</span> <span style="color: #00bfff;">in</span> 0..<span style="color: #00bfff;">self</span>.pool_size <span style="color: #b0b1a3;">{</span>
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">inner</span> = pool.inner.clone<span style="color: #97b098;">()</span>;
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">after_start</span> = <span style="color: #00bfff;">self</span>.after_start.clone<span style="color: #97b098;">()</span>;
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">before_stop</span> = <span style="color: #00bfff;">self</span>.before_stop.clone<span style="color: #97b098;">()</span>;
                <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">thread_builder</span> = <span style="color: #a2cd5a;">thread</span>::<span style="color: #98f5ff;">Builder</span>::new<span style="color: #97b098;">()</span>;
                <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">name_prefix</span><span style="color: #97b098;">)</span> = <span style="color: #00bfff;">self</span>.name_prefix <span style="color: #97b098;">{</span>
                    thread_builder = thread_builder.name<span style="color: #aebed8;">(</span><span style="color: #f08080;">format!</span><span style="color: #b0b0b3;">(</span><span style="color: #deb887;">"</span><span style="color: #deb887; font-style: italic;">{}{}</span><span style="color: #deb887;">"</span>, name_prefix, counter<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>;
                <span style="color: #97b098;">}</span>
                <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">self</span>.stack_size &gt; 0 <span style="color: #97b098;">{</span>
                    thread_builder = thread_builder.stack_size<span style="color: #aebed8;">(</span><span style="color: #00bfff;">self</span>.stack_size<span style="color: #aebed8;">)</span>;
                <span style="color: #97b098;">}</span>
                thread_builder.spawn<span style="color: #97b098;">(</span><span style="color: #00bfff;">move</span> || inner.work<span style="color: #aebed8;">(</span>after_start, before_stop<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>.unwrap<span style="color: #97b098;">()</span>;
            <span style="color: #b0b1a3;">}</span>
            <span style="color: #00bfff;">return</span> pool
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Inner</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">send</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">msg</span>: <span style="color: #98f5ff;">Message</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">self</span>.tx.lock<span style="color: #b0b1a3;">()</span>.unwrap<span style="color: #b0b1a3;">()</span>.send<span style="color: #b0b1a3;">(</span>msg<span style="color: #b0b1a3;">)</span>.unwrap<span style="color: #b0b1a3;">()</span>;
        <span style="color: #93a8c6;">}</span>

        <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">work</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">after_start</span>: <span style="color: #98f5ff;">Option</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Arc</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">Fn</span><span style="color: #aebed8;">()</span> + <span style="color: #98f5ff;">Send</span> + <span style="color: #98f5ff;">Sync</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span>, <span style="color: #4eee94;">before_stop</span>: <span style="color: #98f5ff;">Option</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Arc</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">Fn</span><span style="color: #aebed8;">()</span> + <span style="color: #98f5ff;">Send</span> + <span style="color: #98f5ff;">Sync</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
            after_start.map<span style="color: #b0b1a3;">(</span>|fun| fun<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>;
            <span style="color: #00bfff;">loop</span> <span style="color: #b0b1a3;">{</span>
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">msg</span> = <span style="color: #00bfff;">self</span>.rx.lock<span style="color: #97b098;">()</span>.unwrap<span style="color: #97b098;">()</span>.recv<span style="color: #97b098;">()</span>.unwrap<span style="color: #97b098;">()</span>;
                <span style="color: #00bfff;">match</span> msg <span style="color: #97b098;">{</span>
                    <span style="color: #98f5ff;">Message</span>::<span style="color: #98f5ff;">Run</span><span style="color: #aebed8;">(</span>r<span style="color: #aebed8;">)</span> =&gt; r.run<span style="color: #aebed8;">()</span>,
                    <span style="color: #98f5ff;">Message</span>::<span style="color: #98f5ff;">Close</span> =&gt; <span style="color: #00bfff;">break</span>,
                <span style="color: #97b098;">}</span>
            <span style="color: #b0b1a3;">}</span>
            before_stop.map<span style="color: #b0b1a3;">(</span>|fun| fun<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>;
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Run</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #ffe4b5;">/// Actually run the task (invoking `poll` on its future) on the current</span>
        <span style="color: #ffe4b5;">/// thread.</span>
        <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">deprecated</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
        <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">run</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Run</span> <span style="color: #b0b1a3;">{</span> <span style="color: #00bfff;">mut</span> spawn, inner <span style="color: #b0b1a3;">}</span> = <span style="color: #00bfff;">self</span>;

            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">SAFETY: the ownership of this `Run` object is evidence that</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">we are in the `POLLING`/`REPOLL` state for the mutex.</span>
            <span style="color: #ff0000;">unsafe</span> <span style="color: #b0b1a3;">{</span>
                inner.mutex.start_poll<span style="color: #97b098;">()</span>;

                <span style="color: #00bfff;">loop</span> <span style="color: #97b098;">{</span>
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">unpark</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #aebed8;">&lt;</span><span style="color: #98f5ff;">Unpark</span><span style="color: #aebed8;">&gt;</span> = inner.clone<span style="color: #aebed8;">()</span>;
                    <span style="color: #00bfff;">match</span> spawn.poll_future<span style="color: #aebed8;">(</span>unpark<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">{</span> <span style="color: #ffe4b5;">/// &#36825;&#37324; &#20026; Future &#25191;&#34892;&#30340;&#22320;&#26041;&#65292; spawn: Spawn&lt;Box&lt;MySender&gt;&gt; </span>
                        <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">NotReady</span><span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{}</span>
                        <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #90a890;">(</span><span style="color: #a2b6da;">()</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span> |
                        <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span><span style="color: #90a890;">()</span><span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #00bfff;">return</span> inner.mutex.complete<span style="color: #b0b0b3;">()</span>,
                    <span style="color: #aebed8;">}</span>
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">run</span> = <span style="color: #98f5ff;">Run</span> <span style="color: #aebed8;">{</span> <span style="color: #4eee94;">spawn</span>: spawn, <span style="color: #4eee94;">inner</span>: inner.clone<span style="color: #b0b0b3;">()</span> <span style="color: #aebed8;">}</span>;
                    <span style="color: #00bfff;">match</span> inner.mutex.wait<span style="color: #aebed8;">(</span>run<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">{</span>
                        <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span><span style="color: #90a890;">()</span><span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #00bfff;">return</span>,            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">we've waited</span>
                        <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>r<span style="color: #b0b0b3;">)</span> =&gt; spawn = r.spawn,   <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">someone's notified us</span>
                    <span style="color: #aebed8;">}</span>
                <span style="color: #97b098;">}</span>
            <span style="color: #b0b1a3;">}</span>
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Executor</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">Inner</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">execute</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">run</span>: <span style="color: #98f5ff;">Run</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">self</span>.send<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Message</span>::<span style="color: #98f5ff;">Run</span><span style="color: #97b098;">(</span>run<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">CpuPool</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #ffe4b5;">/// Panics if `size == 0`.</span>
        <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">size</span>: <span style="color: #98f5ff;">usize</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">CpuPool</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #98f5ff;">Builder</span>::new<span style="color: #b0b1a3;">()</span>.pool_size<span style="color: #b0b1a3;">(</span>size<span style="color: #b0b1a3;">)</span>.create<span style="color: #b0b1a3;">()</span>
        <span style="color: #93a8c6;">}</span>


        <span style="color: #ffe4b5;">/// Spawns a closure on this thread pool.</span>
        <span style="color: #ffe4b5;">///</span>
        <span style="color: #ffe4b5;">/// This function is a convenience wrapper around the `spawn` function above</span>
        <span style="color: #ffe4b5;">/// for running a closure wrapped in `future::lazy`. It will spawn the</span>
        <span style="color: #ffe4b5;">/// function `f` provided onto the thread pool, and continue to run the</span>
        <span style="color: #ffe4b5;">/// future returned by `f` on the thread pool as well.</span>
        <span style="color: #ffe4b5;">///</span>
        <span style="color: #ffe4b5;">/// The returned future will be a handle to the result produced by the</span>
        <span style="color: #ffe4b5;">/// future that `f` returns.</span>
        <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_fn</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">f</span>: <span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">CpuFuture</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">R</span>::<span style="color: #98f5ff;">Item</span>, <span style="color: #98f5ff;">R</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span>
        <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">R</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
              <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">IntoFuture</span> + '<span style="color: #00bfff;">static</span>,
              <span style="color: #98f5ff;">R</span>::<span style="color: #4eee94;">Future</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
              <span style="color: #98f5ff;">R</span>::<span style="color: #4eee94;">Item</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
              <span style="color: #98f5ff;">R</span>::<span style="color: #4eee94;">Error</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
        <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">self</span>.spawn<span style="color: #b0b1a3;">(</span>lazy<span style="color: #97b098;">(</span>f<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #93a8c6;">}</span>

        <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">f</span>: <span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">CpuFuture</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Item</span>, <span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span>
        <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">Future</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
              <span style="color: #98f5ff;">F</span>::<span style="color: #4eee94;">Item</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
              <span style="color: #98f5ff;">F</span>::<span style="color: #4eee94;">Error</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
        <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>tx, rx<span style="color: #b0b1a3;">)</span> = channel<span style="color: #b0b1a3;">()</span>; <span style="color: #ffe4b5;">///&#21019;&#24314; f&#65306;F &#25191;&#34892;&#32467;&#26524; &#20256;&#36882;&#36890;&#36947;</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">keep_running_flag</span> = <span style="color: #98f5ff;">Arc</span>::new<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">AtomicBool</span>::new<span style="color: #97b098;">(</span><span style="color: #00bfff;">false</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>;
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">AssertUnwindSafe is used here because `Send + 'static` is basically</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">an alias for an implementation of the `UnwindSafe` trait but we can't</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">express that in the standard library right now.</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">sender</span> = <span style="color: #98f5ff;">MySender</span> <span style="color: #b0b1a3;">{</span> <span style="color: #ffe4b5;">/// &#20027;&#35201;&#30340;&#36816;&#31639; &#36733;&#20307;&#65292; &#20854;&#20013;&#21253;&#21547; tx, &#23558;&#32467;&#26524;&#21457;&#36865;&#30340; sender, &#21253;&#21547; fut</span>
                <span style="color: #4eee94;">fut</span>: <span style="color: #98f5ff;">AssertUnwindSafe</span><span style="color: #97b098;">(</span>f<span style="color: #97b098;">)</span>.catch_unwind<span style="color: #97b098;">()</span>,
                <span style="color: #4eee94;">tx</span>: <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>tx<span style="color: #97b098;">)</span>, <span style="color: #ffe4b5;">/// &#22312;runner &#23454;&#20307; &#20013; &#20445;&#25345; sender</span>
                <span style="color: #4eee94;">keep_running_flag</span>: keep_running_flag.clone<span style="color: #97b098;">()</span>,
            <span style="color: #b0b1a3;">}</span>;
            <span style="color: #a2cd5a;">executor</span>::spawn<span style="color: #b0b1a3;">(</span>sender<span style="color: #b0b1a3;">)</span>.execute<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.inner.clone<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>;
            <span style="color: #98f5ff;">CpuFuture</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">inner</span>: rx , <span style="color: #4eee94;">keep_running_flag</span>: keep_running_flag.clone<span style="color: #97b098;">()</span> <span style="color: #b0b1a3;">}</span> <span style="color: #ffe4b5;">/// &#25509;&#21463; f&#65306;F &#30340;&#32467;&#26524;</span>
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #ffe4b5;">/// Future &#25191;&#34892;&#30340;&#22320;&#26041; </span>
    <span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">Future</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Future</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">MySender</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Item</span>, <span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Item</span> = <span style="color: #93a8c6;">()</span>;
        <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Error</span> = <span style="color: #93a8c6;">()</span>;

        <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">poll</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Poll</span><span style="color: #93a8c6;">&lt;</span><span style="color: #b0b1a3;">()</span>, <span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Ok</span><span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #97b098;">(</span>_<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> = <span style="color: #00bfff;">self</span>.tx.as_mut<span style="color: #b0b1a3;">()</span>.unwrap<span style="color: #b0b1a3;">()</span>.poll_cancel<span style="color: #b0b1a3;">()</span> <span style="color: #b0b1a3;">{</span>
                <span style="color: #00bfff;">if</span> !<span style="color: #00bfff;">self</span>.keep_running_flag.load<span style="color: #97b098;">(</span><span style="color: #98f5ff;">Ordering</span>::<span style="color: #98f5ff;">SeqCst</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">{</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Cancelled, bail out</span>
                    <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">()</span>.into<span style="color: #b0b0b3;">()</span><span style="color: #aebed8;">)</span>
                <span style="color: #97b098;">}</span>
            <span style="color: #b0b1a3;">}</span>

            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">res</span> = <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.fut.poll<span style="color: #b0b1a3;">()</span> <span style="color: #b0b1a3;">{</span>
                <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #aebed8;">(</span>e<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span>,
                <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">NotReady</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">NotReady</span><span style="color: #97b098;">)</span>,
                <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span> =&gt; <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span>,
            <span style="color: #b0b1a3;">}</span>;

            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">if the receiving end has gone away then that's ok, we just ignore the</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">send error here.</span>
            drop<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.tx.take<span style="color: #97b098;">()</span>.unwrap<span style="color: #97b098;">()</span>.send<span style="color: #97b098;">(</span>res<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>;
            <span style="color: #98f5ff;">Ok</span><span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #97b098;">(</span><span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

     <span style="color: #ffe4b5;">/// spawn_fun  &#19982; cpupool  &#20043;&#38388;&#30340; &#28040;&#24687;&#32467;&#26500;&#65292;  </span>
     <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">Message</span> <span style="color: #8c8c8c;">{</span>
         <span style="color: #98f5ff;">Run</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Run</span><span style="color: #93a8c6;">)</span>,
         <span style="color: #98f5ff;">Close</span>,
     <span style="color: #8c8c8c;">}</span>

     <span style="color: #ffe4b5;">/// Units of work submitted to an `Executor`, currently only created</span>
     <span style="color: #ffe4b5;">/// internally.</span>
     <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Run</span> <span style="color: #8c8c8c;">{</span>
         <span style="color: #4eee94;">spawn</span>: <span style="color: #98f5ff;">Spawn</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Future</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">Item</span> = <span style="color: #aebed8;">()</span>, <span style="color: #98f5ff;">Error</span> = <span style="color: #aebed8;">()</span><span style="color: #97b098;">&gt;</span> + <span style="color: #98f5ff;">Send</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #ffe4b5;">/// &#36825;&#37324;&#38754; &#20026; Spawn&lt;Box&lt;MySender&gt;&gt; </span>
         <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">RunInner</span><span style="color: #93a8c6;">&gt;</span>,
     <span style="color: #8c8c8c;">}</span>

      <span style="color: #ffe4b5;">/// The type of future returned from the `CpuPool::spawn` function, which</span>
      <span style="color: #ffe4b5;">/// proxies the futures running on the thread pool.</span>
      <span style="color: #ffe4b5;">///</span>
      <span style="color: #ffe4b5;">/// This future will resolve in the same way as the underlying future, and it</span>
      <span style="color: #ffe4b5;">/// will propagate panics.</span>
      <span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">must_use</span><span style="color: #8c8c8c;">]</span>
      <span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Debug</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
      <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">CpuFuture</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">E</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
          <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Receiver</span><span style="color: #93a8c6;">&lt;</span><span style="color: #a2cd5a;">thread</span>::<span style="color: #98f5ff;">Result</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Result</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">E</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
          <span style="color: #4eee94;">keep_running_flag</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">AtomicBool</span><span style="color: #93a8c6;">&gt;</span>,
      <span style="color: #8c8c8c;">}</span>

     <span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">T</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>, <span style="color: #4eee94;">E</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Future</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">CpuFuture</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">E</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
       <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Item</span> = <span style="color: #98f5ff;">T</span>;
       <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Error</span> = <span style="color: #98f5ff;">E</span>;

       <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">poll</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Poll</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">E</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
           <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.inner.poll<span style="color: #b0b1a3;">()</span>.expect<span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"cannot poll CpuFuture twice"</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">{</span>
               <span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">Ok</span><span style="color: #aebed8;">(</span><span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>e<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span>e.into<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span>,
               <span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">Ok</span><span style="color: #aebed8;">(</span><span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>e<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span>,
               <span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">Err</span><span style="color: #aebed8;">(</span>e<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #a2cd5a;">panic</span>::resume_unwind<span style="color: #97b098;">(</span>e<span style="color: #97b098;">)</span>,
               <span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">NotReady</span> =&gt; <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">NotReady</span><span style="color: #97b098;">)</span>,
           <span style="color: #b0b1a3;">}</span>
       <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>


    <span style="color: #ffe4b5;">/// future lib &#24211;&#30340; &#20195;&#30721; -----------------------------------------------------</span>
    <span style="color: #ffe4b5;">/// Creates a new future which will eventually be the same as the one created</span>
    <span style="color: #ffe4b5;">/// by the closure provided.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// The provided closure is only run once the future has a callback scheduled</span>
    <span style="color: #ffe4b5;">/// on it, otherwise the callback never runs. Once run, however, this future is</span>
    <span style="color: #ffe4b5;">/// the same as the one the closure creates.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// # Examples</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// ```</span>
    <span style="color: #ffe4b5;">/// use futures::future::*;</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// let a = lazy(|| ok::&lt;u32, u32&gt;(1));</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// let b = lazy(|| -&gt; FutureResult&lt;u32, u32&gt; {</span>
    <span style="color: #ffe4b5;">///     panic!("oh no!")</span>
    <span style="color: #ffe4b5;">/// });</span>
    <span style="color: #ffe4b5;">/// drop(b); // closure is never run</span>
    <span style="color: #ffe4b5;">/// ```</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">lazy</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #4eee94;">f</span>: <span style="color: #98f5ff;">F</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">Lazy</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;</span>
    <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #8c8c8c;">()</span> -&gt; <span style="color: #98f5ff;">R</span>,
          <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">IntoFuture</span>
    <span style="color: #8c8c8c;">{</span>
        <span style="color: #98f5ff;">Lazy</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #4eee94;">inner</span>: _<span style="color: #98f5ff;">Lazy</span>::<span style="color: #98f5ff;">First</span><span style="color: #b0b1a3;">(</span>f<span style="color: #b0b1a3;">)</span>,
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #ffe4b5;">/// A future which defers creation of the actual future until a callback is</span>
    <span style="color: #ffe4b5;">/// scheduled.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// This is created by the `lazy` function.</span>
    <span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Debug</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
        <span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">must_use = </span><span style="color: #deb887;">"futures do nothing unless polled"</span><span style="color: #8c8c8c;">]</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Lazy</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">IntoFuture</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #4eee94;">inner</span>: _Lazy<span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span>::<span style="color: #98f5ff;">Future</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Debug</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
    <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">_Lazy</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #98f5ff;">First</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span>,
        <span style="color: #98f5ff;">Second</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">R</span><span style="color: #93a8c6;">)</span>,
        <span style="color: #98f5ff;">Moved</span>,
    <span style="color: #8c8c8c;">}</span>

  <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">futures-0.1.17/src/task_impl/mod.rs</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #4eee94;">obj</span>: <span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">Spawn</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #98f5ff;">Spawn</span> <span style="color: #93a8c6;">{</span>
          <span style="color: #4eee94;">id</span>: fresh_task_id<span style="color: #b0b1a3;">()</span>,
          <span style="color: #4eee94;">obj</span>: obj,
          <span style="color: #4eee94;">data</span>: local_map<span style="color: #b0b1a3;">()</span>,
      <span style="color: #93a8c6;">}</span>
  <span style="color: #8c8c8c;">}</span>


<span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">Future</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Spawn</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// Polls the internal future, scheduling notifications to be sent to the</span>
    <span style="color: #ffe4b5;">/// `unpark` argument.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// This method will poll the internal future, testing if it's completed</span>
    <span style="color: #ffe4b5;">/// yet. The `unpark` argument is used as a sink for notifications sent to</span>
    <span style="color: #ffe4b5;">/// this future. That is, while the future is being polled, any call to</span>
    <span style="color: #ffe4b5;">/// `task::park()` will return a handle that contains the `unpark`</span>
    <span style="color: #ffe4b5;">/// specified.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// If this function returns `NotReady`, then the `unpark` should have been</span>
    <span style="color: #ffe4b5;">/// scheduled to receive a notification when poll can be called again.</span>
    <span style="color: #ffe4b5;">/// Otherwise if `Ready` or `Err` is returned, the `Spawn` task can be</span>
    <span style="color: #ffe4b5;">/// safely destroyed.</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">deprecated</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">note = </span><span style="color: #deb887;">"recommended to use `poll_future_notify` instead"</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">deprecated</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">poll_future</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">unpark</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Unpark</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Poll</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Item</span>, <span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">self</span>.enter<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">BorrowedUnpark</span>::<span style="color: #98f5ff;">Old</span><span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>unpark<span style="color: #97b098;">)</span>, |f| f.poll<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #ffe4b5;">/// Waits for the internal future to complete, blocking this thread's</span>
    <span style="color: #ffe4b5;">/// execution until it does.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// This function will call `poll_future` in a loop, waiting for the future</span>
    <span style="color: #ffe4b5;">/// to complete. When a future cannot make progress it will use</span>
    <span style="color: #ffe4b5;">/// `thread::park` to block the current thread.</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">wait_future</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Item</span>, <span style="color: #98f5ff;">F</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">ThreadNotify</span>::with_current<span style="color: #b0b1a3;">(</span>|notify| <span style="color: #97b098;">{</span>

            <span style="color: #00bfff;">loop</span> <span style="color: #aebed8;">{</span>
                <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.poll_future_notify<span style="color: #b0b0b3;">(</span>notify, 0<span style="color: #b0b0b3;">)</span><span style="color: #f08080; font-weight: bold;">?</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">NotReady</span> =&gt; notify.park<span style="color: #90a890;">()</span>,
                    <span style="color: #98f5ff;">Async</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #90a890;">(</span>e<span style="color: #90a890;">)</span> =&gt; <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #90a890;">(</span>e<span style="color: #90a890;">)</span>,
                <span style="color: #b0b0b3;">}</span>
            <span style="color: #aebed8;">}</span>
        <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #ffe4b5;">/// A specialized function to request running a future to completion on the</span>
    <span style="color: #ffe4b5;">/// specified executor.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// This function only works for futures whose item and error types are `()`</span>
    <span style="color: #ffe4b5;">/// and also implement the `Send` and `'static` bounds. This will submit</span>
    <span style="color: #ffe4b5;">/// units of work (instances of `Run`) to the `exec` argument provided</span>
    <span style="color: #ffe4b5;">/// necessary to drive the future to completion.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// When the future would block, it's arranged that when the future is again</span>
    <span style="color: #ffe4b5;">/// ready it will submit another unit of work to the `exec` provided. This</span>
    <span style="color: #ffe4b5;">/// will happen in a loop until the future has completed.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// This method is not appropriate for all futures, and other kinds of</span>
    <span style="color: #ffe4b5;">/// executors typically provide a similar function with perhaps relaxed</span>
    <span style="color: #ffe4b5;">/// bounds as well.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// Note that this method is likely to be deprecated in favor of the</span>
    <span style="color: #ffe4b5;">/// `futures::Executor` trait and `execute` method, but if this'd cause</span>
    <span style="color: #ffe4b5;">/// difficulty for you please let us know!</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">execute</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">exec</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Executor</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span>
        <span style="color: #00bfff;">where</span> <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">Future</span><span style="color: #93a8c6;">&lt;</span>Item=<span style="color: #b0b1a3;">()</span>, Error=<span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">&gt;</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
    <span style="color: #93a8c6;">{</span>
        exec.clone<span style="color: #b0b1a3;">()</span>.execute<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Run</span> <span style="color: #97b098;">{</span> <span style="color: #ffe4b5;">/// &#36825;&#37324;&#26368;&#32456;&#23558; &#35843;&#29992;  Inner impl Executor &#27979; &#26041;&#27861;&#65292; &#21363;tx.send</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Ideally this method would be defined directly on</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">`Spawn&lt;BoxFuture&lt;(), ()&gt;&gt;` so we wouldn't have to box here and</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">it'd be more explicit, but unfortunately that currently has a</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">link error on nightly: rust-lang/rust#36155</span>
            <span style="color: #4eee94;">spawn</span>: spawn<span style="color: #aebed8;">(</span><span style="color: #98f5ff;">Box</span>::new<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">self</span>.into_inner<span style="color: #90a890;">()</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>,
            <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Arc</span>::new<span style="color: #aebed8;">(</span><span style="color: #98f5ff;">RunInner</span> <span style="color: #b0b0b3;">{</span>
                <span style="color: #4eee94;">exec</span>: exec,
                <span style="color: #4eee94;">mutex</span>: <span style="color: #98f5ff;">UnparkMutex</span>::new<span style="color: #90a890;">()</span>
            <span style="color: #b0b0b3;">}</span><span style="color: #aebed8;">)</span>,
        <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbcc2d09" class="outline-4">
<h4 id="orgbcc2d09"><span class="section-number-4">9.5.4.</span> CpuPool 的使用方法为：</h4>
<div class="outline-text-4" id="text-9-5-4">
</div>
<ol class="org-ol">
<li><a id="org47267cd"></a>1. CpuPool::new(cpu_cores), 在这里即 spawn了 thread， 来进行 receive:  Message::Run(r) =&gt; r.run(),<br /></li>
<li><a id="org00ec7cb"></a>2. let fut = ENV.cpu_pool.spawn_fn(move || { }); Box::new(fut)<br />
<ol class="org-ol">
<li><a id="org181edcd"></a>这里面 CpuPool.spawn_fn  将 block wrapper 成一个  Run, 然后使用  Exector trait的方法， execute() 方法， 将 Run 提交给 tx.send(runner)<br /></li>
<li><a id="org7233a37"></a>如何 将 Run的结果，返回给 主线程， 在 cpu_pool.spawn_fn(|| {}) 之后，  会返回 一个 CpuFuture { rx: rx, keep_running_flag: Arc&lt;AtomicBool&gt;} , rx 为 spawn 中 let (tx, rx) = channel();<br /></li>
</ol>
</li>
<li><a id="org1997fb0"></a>一些问题：<br />
<ol class="org-ol">
<li><a id="orge8352a5"></a>1. mpsc::channel  为 多生产者 一个 消费者 模式， 所以 在多个 Thread 进行 消费 Future的时候， 需要 self.rx.lock().unwrap().recv() 进行 lock的争用<br /></li>
<li><a id="orge0e67d6"></a>2. 重要的关键点， 即： regist 以及， run。 wait 在 <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/futures-cpupool-0.1.8/src/lib.rs">这里</a><br /></li>
</ol>
</li>
<li><a id="orge221838"></a>?  问题未了解：<br />
<ol class="org-ol">
<li><a id="orgbcb6556"></a>1. 在返回 NotReady 时候，会发生什么？ 如何 进行的注册?<br /></li>
</ol>
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org291be13" class="outline-2">
<h2 id="org291be13"><span class="section-number-2">10.</span> Mutex &amp; Condvar</h2>
<div class="outline-text-2" id="text-10">
<p>
**
</p>
<pre class="example" id="org67ae8e4">
struct InnerPool {
    queue: BinaryHeap&lt;Job&gt;,
    shutdown: bool,
}

struct SharedPool {
    inner: Mutex&lt;InnerPool&gt;,
    cvar: Condvar,
}

</pre>
</div>
</div>


<div id="outline-container-orgbf9be3c" class="outline-2">
<h2 id="orgbf9be3c"><span class="section-number-2">11.</span> r2d2: 链接池管理工具</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-orgbd1293c" class="outline-4">
<h4 id="orgbd1293c"><span class="section-number-4">11.0.1.</span> 1. Pool: pub struct Pool&lt;M: ManageConnection&gt;(Arc&lt;SharedPool&lt;M&gt;&gt;);</h4>
<div class="outline-text-4" id="text-11-0-1">
</div>
<ol class="org-ol">
<li><a id="orgd58e689"></a><br />
<div class="outline-text-5" id="text-11-0-1-1">
<div class="org-src-container">
<pre class="src src-rust">   <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Pool</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">SharedPool</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span>; <span style="color: #ffe4b5;">/// &#20351;&#29992;Arc &#20849;&#20139; Pool</span>

    <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Conn</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">C</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #4eee94;">conn</span>: <span style="color: #98f5ff;">C</span>,
        <span style="color: #4eee94;">birth</span>: <span style="color: #98f5ff;">Instant</span>,
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">IdleConn</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">C</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #4eee94;">conn</span>: <span style="color: #98f5ff;">Conn</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">C</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #4eee94;">idle_start</span>: <span style="color: #98f5ff;">Instant</span>,
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">PoolInternals</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">C</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #4eee94;">conns</span>: <span style="color: #98f5ff;">VecDeque</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">IdleConn</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">C</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #4eee94;">num_conns</span>: <span style="color: #98f5ff;">u32</span>,
        <span style="color: #4eee94;">pending_conns</span>: <span style="color: #98f5ff;">u32</span>,
        <span style="color: #4eee94;">last_error</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">String</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">SharedPool</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span>
    <span style="color: #00bfff;">where</span>
        <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>,
    <span style="color: #8c8c8c;">{</span>
        <span style="color: #4eee94;">config</span>: <span style="color: #98f5ff;">Config</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span>, <span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #ffe4b5;">/// &#37197;&#32622;&#20449;&#24687;   &#25351;&#21521;Config:</span>
        <span style="color: #4eee94;">manager</span>: <span style="color: #98f5ff;">M</span>,
        <span style="color: #4eee94;">internals</span>: <span style="color: #98f5ff;">Mutex</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">PoolInternals</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #ffe4b5;">/// &#20855;&#20307;&#30340; connection &#38142;&#25509;&#65292; &#36825;&#37324;&#38754;&#30340; Mutex &#20026; &#21487;&#37325;&#20837;&#30340; Mutex&#12290;&#65288;&#21363; &#24050;&#32463;&#33719;&#24471;lock&#30340;&#22312;acquire &#19968;&#27425; &#20381;&#28982;&#21487;&#20197;&#65289;</span>
        <span style="color: #4eee94;">cond</span>: <span style="color: #98f5ff;">Condvar</span>,
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Config</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">C</span>, <span style="color: #98f5ff;">E</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span> <span style="color: #ffe4b5;">/// max_size, min_idle &#31561; &#37197;&#32622;&#20449;&#24687;</span>
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">max_size</span>: <span style="color: #98f5ff;">u32</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">min_idle</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">u32</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">test_on_check_out</span>: <span style="color: #98f5ff;">bool</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">max_lifetime</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Duration</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">idle_timeout</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Duration</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">connection_timeout</span>: <span style="color: #98f5ff;">Duration</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">error_handler</span>: <span style="color: #98f5ff;">Box</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">HandleError</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">E</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">connection_customizer</span>: <span style="color: #98f5ff;">Box</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">CustomizeConnection</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">C</span>, <span style="color: #98f5ff;">E</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #00bfff;">pub</span> <span style="color: #4eee94;">thread_pool</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">ScheduledThreadPool</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #ffe4b5;">/// &#22312; add_connection &#26041;&#27861;&#20013;&#20351;&#29992;&#65292; &#20351;&#29992; thread_pool.execute_after(|| { create_connection();  internals.conns.push_back(conn);})</span>
    <span style="color: #8c8c8c;">}</span>

  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">trait</span> <span style="color: #4eee94;">ManageConnection</span>: <span style="color: #98f5ff;">Send</span> + <span style="color: #98f5ff;">Sync</span> + '<span style="color: #00bfff;">static</span> <span style="color: #8c8c8c;">{</span> <span style="color: #ffe4b5;">/// &#23454;&#29616; connect &#26041;&#27861;&#65292; &#21363;&#21487;&#65292;&#27604;&#22914;Mysql&#65292; Redis &#23454;&#29616;&#33258;&#24049;&#30340; &#36830;&#25509;</span>
      <span style="color: #ffe4b5;">/// The connection type this manager deals with.</span>
      <span style="color: #00bfff;">type</span> <span style="color: #4eee94;">Connection</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>;

      <span style="color: #ffe4b5;">/// The error type returned by `Connection`s.</span>
      <span style="color: #00bfff;">type</span> <span style="color: #4eee94;">Error</span>: <span style="color: #a2cd5a;">error</span>::<span style="color: #98f5ff;">Error</span> + '<span style="color: #00bfff;">static</span>;


    <span style="color: #ffe4b5;">/// Attempts to create a new connection.</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">connect</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Connection</span>, <span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span>;

    <span style="color: #ffe4b5;">/// Determines if the connection is still connected to the database.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// A standard implementation would check if a simple query like `SELECT 1`</span>
    <span style="color: #ffe4b5;">/// succeeds.</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">is_valid</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">conn</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Connection</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #b0b1a3;">()</span>, <span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span>;

    <span style="color: #ffe4b5;">/// *Quickly* determines if the connection is no longer usable.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// This will be called synchronously every time a connection is returned</span>
    <span style="color: #ffe4b5;">/// to the pool, so it should *not* block. If it returns `true`, the</span>
    <span style="color: #ffe4b5;">/// connection will be discarded.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// For example, an implementation might check if the underlying TCP socket</span>
    <span style="color: #ffe4b5;">/// has disconnected. Implementations that do not support this kind of</span>
    <span style="color: #ffe4b5;">/// fast health check may simply return `false`.</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">has_broken</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">conn</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Self</span>::<span style="color: #98f5ff;">Connection</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">bool</span>;
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org8cf0c5b" class="outline-4">
<h4 id="org8cf0c5b"><span class="section-number-4">11.0.2.</span> Pool 的适用方法 pool.get() -&gt; Result&lt;PooledConnection&lt;M&gt;, Error&gt;</h4>
<div class="outline-text-4" id="text-11-0-2">
<p>
<b>**</b>
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Pool</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">SharedPool</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>;


<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">PooledConnection</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span> 
<span style="color: #ffe4b5;">/// &#36825;&#37324;&#31616;&#21333;&#30340; impl Drop + Deref + DerefMut &#20854;&#20013; Drop &#23558; conn &#24402;&#36824;, </span>
<span style="color: #ffe4b5;">/// Deref &#23558; conn &#26292;&#38706;&#65292; &#21487;&#20197;&#20316;&#20026;wrapper &#30340;&#20869;&#23481;&#20351;&#29992; </span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>,
<span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">pool</span>: <span style="color: #98f5ff;">Pool</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #93a8c6;">&gt;</span>,
    <span style="color: #4eee94;">checkout</span>: <span style="color: #98f5ff;">Instant</span>,
    <span style="color: #4eee94;">conn</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Conn</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Drop</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">PooledConnection</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>,
<span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">drop</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">self</span>.pool.put_back<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.checkout, <span style="color: #00bfff;">self</span>.conn.take<span style="color: #97b098;">()</span>.unwrap<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>;
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Deref</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">PooledConnection</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>,
<span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Target</span> = <span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span>;

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">deref</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.conn.as_ref<span style="color: #b0b1a3;">()</span>.unwrap<span style="color: #b0b1a3;">()</span>.conn
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>


<span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Pool</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;</span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>,
<span style="color: #8c8c8c;">{</span>

    <span style="color: #ffe4b5;">/// Retrieves a connection from the pool.</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// Waits for at most the configured connection timeout before returning an</span>
    <span style="color: #ffe4b5;">/// error.</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">get</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">PooledConnection</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #b0b1a3;">&gt;</span>, <span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span> <span style="color: #ffe4b5;">/// &#36825;&#37324;&#20026;&#36820;&#22238;&#30340;class &#31867;&#22411;, &#22914;&#19978;</span>
        <span style="color: #00bfff;">self</span>.get_timeout<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.0.config.connection_timeout<span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #ffe4b5;">/// Retrieves a connection from the pool, waiting for at most `timeout`</span>
    <span style="color: #ffe4b5;">///</span>
    <span style="color: #ffe4b5;">/// The given timeout will be used instead of the configured connection</span>
    <span style="color: #ffe4b5;">/// timeout.</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">get_timeout</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">timeout</span>: <span style="color: #98f5ff;">Duration</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">PooledConnection</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #b0b1a3;">&gt;</span>, <span style="color: #98f5ff;">Error</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">start</span> = <span style="color: #98f5ff;">Instant</span>::now<span style="color: #b0b1a3;">()</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">end</span> = start + timeout;
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">internals</span> = <span style="color: #00bfff;">self</span>.0.internals.lock<span style="color: #b0b1a3;">()</span>; <span style="color: #ffe4b5;">/// SharedPool&#20013;&#30340; internals &#20026; &#21487;&#37325;&#20837;&#38145;</span>

        <span style="color: #00bfff;">loop</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.try_get_inner<span style="color: #97b098;">(</span>internals<span style="color: #97b098;">)</span> <span style="color: #97b098;">{</span> <span style="color: #ffe4b5;">/// &#26469;&#21040;&#19979;&#38754;&#20195;&#30721;</span>
                <span style="color: #98f5ff;">Ok</span><span style="color: #aebed8;">(</span>conn<span style="color: #aebed8;">)</span> =&gt; <span style="color: #aebed8;">{</span>
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">event</span> = <span style="color: #98f5ff;">CheckoutEvent</span> <span style="color: #b0b0b3;">{</span>
                        <span style="color: #4eee94;">id</span>: conn.conn.as_ref<span style="color: #90a890;">()</span>.unwrap<span style="color: #90a890;">()</span>.id,
                        <span style="color: #4eee94;">duration</span>: start.elapsed<span style="color: #90a890;">()</span>,
                    <span style="color: #b0b0b3;">}</span>;
                    <span style="color: #00bfff;">self</span>.0.config.event_handler.handle_checkout<span style="color: #b0b0b3;">(</span>event<span style="color: #b0b0b3;">)</span>;
                    <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>conn<span style="color: #b0b0b3;">)</span>;
                <span style="color: #aebed8;">}</span>
                <span style="color: #98f5ff;">Err</span><span style="color: #aebed8;">(</span>i<span style="color: #aebed8;">)</span> =&gt; internals = i,
            <span style="color: #97b098;">}</span>

            add_connection<span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.0, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> internals<span style="color: #97b098;">)</span>; 
           <span style="color: #ffe4b5;">///&#21482;&#26377;&#22312; try_get_inner(internals) &#22833;&#36133;&#30340;&#26102;&#20505;&#65292;&#25165;&#20250;&#21040;&#36825;&#37324;</span>
           <span style="color: #ffe4b5;">/// &#21363;&#65306; &#27809;&#26377;&#25343;&#21040;Conn, &#36825;&#37324;&#25165;&#26159; &#27604;&#36739;&#37325;&#35201;&#30340;&#22320;&#26041; !!!</span>


            <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">self</span>.0.cond.wait_until<span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> internals, end<span style="color: #97b098;">)</span>.timed_out<span style="color: #97b098;">()</span> <span style="color: #97b098;">{</span>
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">event</span> = <span style="color: #98f5ff;">TimeoutEvent</span> <span style="color: #aebed8;">{</span> timeout <span style="color: #aebed8;">}</span>;
                <span style="color: #00bfff;">self</span>.0.config.event_handler.handle_timeout<span style="color: #aebed8;">(</span>event<span style="color: #aebed8;">)</span>;

                <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #aebed8;">(</span><span style="color: #98f5ff;">Error</span><span style="color: #b0b0b3;">(</span>internals.last_error.take<span style="color: #90a890;">()</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>;
            <span style="color: #97b098;">}</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">try_get_inner</span><span style="color: #93a8c6;">&lt;</span>'<span style="color: #4eee94;">a</span><span style="color: #93a8c6;">&gt;(</span>
        <span style="color: #cccccc; background-color: #181a26;">&amp;</span>'<span style="color: #4eee94;">a</span> <span style="color: #00bfff;">self</span>,
        <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">internals</span>: <span style="color: #98f5ff;">MutexGuard</span><span style="color: #b0b1a3;">&lt;</span>'<span style="color: #4eee94;">a</span>, <span style="color: #98f5ff;">PoolInternals</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span>,
    <span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">PooledConnection</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #b0b1a3;">&gt;</span>, <span style="color: #98f5ff;">MutexGuard</span><span style="color: #b0b1a3;">&lt;</span>'<span style="color: #4eee94;">a</span>, <span style="color: #98f5ff;">PoolInternals</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">loop</span> <span style="color: #b0b1a3;">{</span> <span style="color: #ffe4b5;">/// &#27809;&#21861;&#22826;&#22823;&#29992;&#22788;</span>
            <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">mut</span> conn<span style="color: #97b098;">)</span> = internals.conns.pop<span style="color: #97b098;">()</span> <span style="color: #97b098;">{</span> <span style="color: #ffe4b5;">///&#30452;&#25509;&#20174;  sharedPool &#20013; pop&#20986; Conn&#26469;</span>
                establish_idle_connections<span style="color: #aebed8;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.0, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> internals<span style="color: #aebed8;">)</span>;
                drop<span style="color: #aebed8;">(</span>internals<span style="color: #aebed8;">)</span>;

                <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">self</span>.0.config.test_on_check_out <span style="color: #aebed8;">{</span>
                    <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>e<span style="color: #b0b0b3;">)</span> = <span style="color: #00bfff;">self</span>.0.manager.is_valid<span style="color: #b0b0b3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> conn.conn.conn<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">{</span>
                        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">msg</span> = e.to_string<span style="color: #90a890;">()</span>;
                        <span style="color: #00bfff;">self</span>.0.config.error_handler.handle_error<span style="color: #90a890;">(</span>e<span style="color: #90a890;">)</span>;
                        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">FIXME we shouldn't have to lock, unlock, and relock here</span>
                        internals = <span style="color: #00bfff;">self</span>.0.internals.lock<span style="color: #90a890;">()</span>;
                        internals.last_error = <span style="color: #98f5ff;">Some</span><span style="color: #90a890;">(</span>msg<span style="color: #90a890;">)</span>;
                        drop_conns<span style="color: #90a890;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.0, internals, <span style="color: #ffd700;">vec!</span><span style="color: #a2b6da;">[</span>conn.conn<span style="color: #a2b6da;">]</span><span style="color: #90a890;">)</span>;
                        internals = <span style="color: #00bfff;">self</span>.0.internals.lock<span style="color: #90a890;">()</span>;
                        <span style="color: #00bfff;">continue</span>;
                    <span style="color: #b0b0b3;">}</span>
                <span style="color: #aebed8;">}</span>

                <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #aebed8;">(</span><span style="color: #98f5ff;">PooledConnection</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #4eee94;">pool</span>: <span style="color: #00bfff;">self</span>.clone<span style="color: #90a890;">()</span>,
                    <span style="color: #4eee94;">checkout</span>: <span style="color: #98f5ff;">Instant</span>::now<span style="color: #90a890;">()</span>,
                    <span style="color: #4eee94;">conn</span>: <span style="color: #98f5ff;">Some</span><span style="color: #90a890;">(</span>conn.conn<span style="color: #90a890;">)</span>,
                <span style="color: #b0b0b3;">}</span><span style="color: #aebed8;">)</span>;
            <span style="color: #97b098;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #97b098;">{</span>
                <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #aebed8;">(</span>internals<span style="color: #aebed8;">)</span>;
            <span style="color: #97b098;">}</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>

<span style="color: #ffe4b5;">///&#20351;&#29992;&#21040; ThreadPool&#30340;&#22320;&#26041;!!!</span>
<span style="color: #00bfff;">fn</span> <span style="color: #daa520;">add_connection</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #4eee94;">shared</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">SharedPool</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #4eee94;">internals</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">PoolInternals</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">M</span>::<span style="color: #98f5ff;">Connection</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>,
<span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// &#36229;&#36807;  max_size  &#26102;&#65292; &#30452;&#25509;&#36820;&#22238;&#65292; &#19981;&#20877; &#24314;&#31435;&#36830;&#25509;</span>
    <span style="color: #00bfff;">if</span> internals.num_conns + internals.pending_conns &gt;= shared.config.max_size <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">return</span>;
    <span style="color: #93a8c6;">}</span>

    internals.pending_conns += 1;
    <span style="color: #ffe4b5;">/// </span>
    inner<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Duration</span>::from_secs<span style="color: #b0b1a3;">(</span>0<span style="color: #b0b1a3;">)</span>, shared<span style="color: #93a8c6;">)</span>;

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">inner</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #4eee94;">delay</span>: <span style="color: #98f5ff;">Duration</span>, <span style="color: #4eee94;">shared</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Arc</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">SharedPool</span><span style="color: #97b098;">&lt;</span><span style="color: #98f5ff;">M</span><span style="color: #97b098;">&gt;</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span>
    <span style="color: #00bfff;">where</span>
        <span style="color: #4eee94;">M</span>: <span style="color: #98f5ff;">ManageConnection</span>,
    <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">new_shared</span> = <span style="color: #98f5ff;">Arc</span>::downgrade<span style="color: #b0b1a3;">(</span>shared<span style="color: #b0b1a3;">)</span>;
        shared.config.thread_pool.execute_after<span style="color: #b0b1a3;">(</span>delay, <span style="color: #00bfff;">move</span> || <span style="color: #97b098;">{</span> <span style="color: #ffe4b5;">/// thread_pool &#25191;&#34892;  &#21019;&#24314;&#38142;&#25509;&#20219;&#21153;</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">shared</span> = <span style="color: #00bfff;">match</span> new_shared.upgrade<span style="color: #aebed8;">()</span> <span style="color: #aebed8;">{</span>
                <span style="color: #98f5ff;">Some</span><span style="color: #b0b0b3;">(</span>shared<span style="color: #b0b0b3;">)</span> =&gt; shared,
                <span style="color: #98f5ff;">None</span> =&gt; <span style="color: #00bfff;">return</span>,
            <span style="color: #aebed8;">}</span>;

            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">conn</span> = shared.manager.connect<span style="color: #aebed8;">()</span>.and_then<span style="color: #aebed8;">(</span>|<span style="color: #00bfff;">mut</span> conn| <span style="color: #b0b0b3;">{</span> <span style="color: #ffe4b5;">/// &#21019;&#24314;&#38142;&#25509; &#38656;&#35201;&#20351;&#29992; Manager</span>
                shared
                    .config
                    .connection_customizer
                    .on_acquire<span style="color: #90a890;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> conn<span style="color: #90a890;">)</span>
                    .map<span style="color: #90a890;">(</span>|_| conn<span style="color: #90a890;">)</span>
            <span style="color: #b0b0b3;">}</span><span style="color: #aebed8;">)</span>;
            <span style="color: #00bfff;">match</span> conn <span style="color: #aebed8;">{</span>
                <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>conn<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">id</span> = <span style="color: #98f5ff;">CONNECTION_ID</span>.fetch_add<span style="color: #90a890;">(</span>1, <span style="color: #98f5ff;">Ordering</span>::<span style="color: #98f5ff;">Relaxed</span><span style="color: #90a890;">)</span> <span style="color: #00bfff;">as</span> <span style="color: #98f5ff;">u64</span>;

                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">event</span> = <span style="color: #98f5ff;">AcquireEvent</span> <span style="color: #90a890;">{</span> id <span style="color: #90a890;">}</span>;
                    shared.config.event_handler.handle_acquire<span style="color: #90a890;">(</span>event<span style="color: #90a890;">)</span>;

                    <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">internals</span> = shared.internals.lock<span style="color: #90a890;">()</span>;
                    internals.last_error = <span style="color: #98f5ff;">None</span>;
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">now</span> = <span style="color: #98f5ff;">Instant</span>::now<span style="color: #90a890;">()</span>;
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">conn</span> = <span style="color: #98f5ff;">IdleConn</span> <span style="color: #90a890;">{</span>
                        <span style="color: #4eee94;">conn</span>: <span style="color: #98f5ff;">Conn</span> <span style="color: #a2b6da;">{</span>
                            conn,
                            <span style="color: #4eee94;">extensions</span>: <span style="color: #98f5ff;">Extensions</span>::new<span style="color: #9cb6ad;">()</span>,
                            <span style="color: #4eee94;">birth</span>: now,
                            id,
                        <span style="color: #a2b6da;">}</span>,
                        <span style="color: #4eee94;">idle_start</span>: now,
                    <span style="color: #90a890;">}</span>;
                    internals.conns.push<span style="color: #90a890;">(</span>conn<span style="color: #90a890;">)</span>; <span style="color: #ffe4b5;">/// &#23558;&#38142;&#25509; &#25918;&#21040; conns &#20013;&#65292; &#21363;&#65306; &#38142;&#25509;&#27744;: </span>
                    internals.pending_conns -= 1;
                    internals.num_conns += 1;
                    shared.cond.notify_one<span style="color: #90a890;">()</span>;
                <span style="color: #b0b0b3;">}</span>
                <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>err<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
                    shared.internals.lock<span style="color: #90a890;">()</span>.last_error = <span style="color: #98f5ff;">Some</span><span style="color: #90a890;">(</span>err.to_string<span style="color: #a2b6da;">()</span><span style="color: #90a890;">)</span>;
                    shared.config.error_handler.handle_error<span style="color: #90a890;">(</span>err<span style="color: #90a890;">)</span>;
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">delay</span> = <span style="color: #a2cd5a;">cmp</span>::max<span style="color: #90a890;">(</span><span style="color: #98f5ff;">Duration</span>::from_millis<span style="color: #a2b6da;">(</span>200<span style="color: #a2b6da;">)</span>, delay<span style="color: #90a890;">)</span>;
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">delay</span> = <span style="color: #a2cd5a;">cmp</span>::min<span style="color: #90a890;">(</span>shared.config.connection_timeout / 2, delay * 2<span style="color: #90a890;">)</span>;
                    inner<span style="color: #90a890;">(</span>delay, <span style="color: #cccccc; background-color: #181a26;">&amp;</span>shared<span style="color: #90a890;">)</span>; <span style="color: #ffe4b5;">/// &#21457;&#29983;&#22833;&#36133; &#30340;&#26102;&#20505;&#65292; &#37325;&#35797;</span>
                <span style="color: #b0b0b3;">}</span>
            <span style="color: #aebed8;">}</span>
        <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>;
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8c31f50" class="outline-2">
<h2 id="org8c31f50"><span class="section-number-2">12.</span> daom_rs 项目中 ENV.spawn_fn 如何与 gate core进行同步的， 应该说是： 没有，因为 futures-cpupool 只会讲 spawn_fun中的block进行封装，然后 执行， 根 core 完全没关系了</h2>
</div>
<div id="outline-container-org8a7df40" class="outline-2">
<h2 id="org8a7df40"><span class="section-number-2">13.</span> tokio:</h2>
<div class="outline-text-2" id="text-13">
</div>
<div id="outline-container-orgaf536a6" class="outline-3">
<h3 id="orgaf536a6"><span class="section-number-3">13.1.</span> SourceCode:</h3>
<div class="outline-text-3" id="text-13-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">runtime</span>: <span style="color: #a2cd5a;">tokio</span>::<span style="color: #a2cd5a;">runtime</span>::<span style="color: #98f5ff;">Runtime</span> = <span style="color: #a2cd5a;">tokio</span>::<span style="color: #a2cd5a;">runtime</span>::<span style="color: #98f5ff;">Runtime</span>::new<span style="color: #8c8c8c;">()</span>.unwrap<span style="color: #8c8c8c;">()</span>;
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Runtime</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Runtime</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Builder</span>::new_multi_thread<span style="color: #b0b1a3;">()</span>.enable_all<span style="color: #b0b1a3;">()</span>.build<span style="color: #b0b1a3;">()</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">tokio::runtime::Builder</span>
<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Builder</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new_multi_thread</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">Buil</span>|'
        der <span style="color: #93a8c6;">{</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">The number `61` is fairly arbitrary. I believe this value was copied from golang.</span>
        <span style="color: #98f5ff;">Builder</span>::new<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Kind</span>::<span style="color: #98f5ff;">MultiThread</span>, 61, 61<span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">build</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Runtime</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">match</span> <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.kind <span style="color: #b0b1a3;">{</span>
            <span style="color: #98f5ff;">Kind</span>::<span style="color: #98f5ff;">CurrentThread</span> =&gt; <span style="color: #00bfff;">self</span>.build_current_thread_runtime<span style="color: #97b098;">()</span>,
            <span style="color: #ffd700;">#</span><span style="color: #97b098;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #aebed8;">(</span><span style="color: #ffd700;">all</span><span style="color: #b0b0b3;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"rt-multi-thread"</span><span style="color: #ffd700;">, not</span><span style="color: #90a890;">(</span><span style="color: #ffd700;">tokio_wasi</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">]</span>
            <span style="color: #98f5ff;">Kind</span>::<span style="color: #98f5ff;">MultiThread</span> =&gt; <span style="color: #00bfff;">self</span>.build_threaded_runtime<span style="color: #97b098;">()</span>,
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #ffe4b5;">/// Build::new_mutli_threadpool().build()</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">build_threaded_runtime</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Runtime</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">use</span> <span style="color: #00bfff;">crate</span>::<span style="color: #a2cd5a;">loom</span>::<span style="color: #a2cd5a;">sys</span>::num_cpus;
        <span style="color: #00bfff;">use</span> <span style="color: #00bfff;">crate</span>::<span style="color: #a2cd5a;">runtime</span>::<span style="color: #b0b1a3;">{</span><span style="color: #98f5ff;">Config</span>, <span style="color: #a2cd5a;">runtime</span>::<span style="color: #98f5ff;">Scheduler</span><span style="color: #b0b1a3;">}</span>;
        <span style="color: #00bfff;">use</span> <span style="color: #00bfff;">crate</span>::<span style="color: #a2cd5a;">runtime</span>::<span style="color: #a2cd5a;">scheduler</span>::<span style="color: #b0b1a3;">{</span><span style="color: #00bfff;">self</span>, <span style="color: #98f5ff;">MultiThread</span><span style="color: #b0b1a3;">}</span>;

        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">core_threads</span> = <span style="color: #00bfff;">self</span>.worker_threads.unwrap_or_else<span style="color: #b0b1a3;">(</span>num_cpus<span style="color: #b0b1a3;">)</span>;

        <span style="color: #ffe4b5;">/// &#37325;&#35201;&#65292; IO/Timer &#65288;&#20107;&#20214;&#39537;&#21160;&#30340;&#28304;&#27849;&#65289; &#20854;&#20013; driver: Driver</span>
        <span style="color: #ffe4b5;">/// driver_handle: [[file+emacs:/Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/driver.rs::18][Handle]]</span>
        <span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>driver, driver_handle<span style="color: #b0b1a3;">)</span> = <span style="color: #a2cd5a;">driver</span>::<span style="color: #98f5ff;">Driver</span>::new<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.get_cfg<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;

        <span style="color: #ffe4b5;">/// Create the blocking pool</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">blocking_pool</span> =
            <span style="color: #a2cd5a;">blocking</span>::create_blocking_pool<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>, <span style="color: #00bfff;">self</span>.max_blocking_threads + core_threads<span style="color: #b0b1a3;">)</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">blocking_spawner</span> = blocking_pool.spawner<span style="color: #b0b1a3;">()</span>.clone<span style="color: #b0b1a3;">()</span>;

        <span style="color: #ffe4b5;">/// Generate a rng seed for this runtime.</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">seed_generator_1</span> = <span style="color: #00bfff;">self</span>.seed_generator.next_generator<span style="color: #b0b1a3;">()</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">seed_generator_2</span> = <span style="color: #00bfff;">self</span>.seed_generator.next_generator<span style="color: #b0b1a3;">()</span>;

        <span style="color: #ffe4b5;">/// &#36825;&#37324;&#27604;&#36739;&#37325;&#35201;&#65292; &#35843;&#29992;&#20102; worker.rs#create</span>
        <span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>scheduler, handle, launch<span style="color: #b0b1a3;">)</span> = <span style="color: #98f5ff;">MultiThread</span>::new<span style="color: #b0b1a3;">(</span>
            core_threads,
            driver,
            driver_handle,
            blocking_spawner,
            seed_generator_2,
            <span style="color: #98f5ff;">Config</span> <span style="color: #97b098;">{</span>
                <span style="color: #4eee94;">before_park</span>: <span style="color: #00bfff;">self</span>.before_park.clone<span style="color: #aebed8;">()</span>,
                <span style="color: #4eee94;">after_unpark</span>: <span style="color: #00bfff;">self</span>.after_unpark.clone<span style="color: #aebed8;">()</span>,
                <span style="color: #4eee94;">global_queue_interval</span>: <span style="color: #00bfff;">self</span>.global_queue_interval,
                <span style="color: #4eee94;">event_interval</span>: <span style="color: #00bfff;">self</span>.event_interval,
                <span style="color: #ffd700;">#</span><span style="color: #aebed8;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b0b3;">(</span><span style="color: #ffd700;">tokio_unstable</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">]</span>
                <span style="color: #4eee94;">unhandled_panic</span>: <span style="color: #00bfff;">self</span>.unhandled_panic.clone<span style="color: #aebed8;">()</span>,
                <span style="color: #4eee94;">disable_lifo_slot</span>: <span style="color: #00bfff;">self</span>.disable_lifo_slot,
                <span style="color: #4eee94;">seed_generator</span>: seed_generator_1,
            <span style="color: #97b098;">}</span>,
        <span style="color: #b0b1a3;">)</span>;

        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">handle</span> = <span style="color: #98f5ff;">Handle</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">inner</span>: <span style="color: #a2cd5a;">scheduler</span>::<span style="color: #98f5ff;">Handle</span>::<span style="color: #98f5ff;">MultiThread</span><span style="color: #97b098;">(</span>handle<span style="color: #97b098;">)</span> <span style="color: #b0b1a3;">}</span>;

        <span style="color: #ffe4b5;">/// Spawn the thread pool workers</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_enter</span> = handle.enter<span style="color: #b0b1a3;">()</span>;
        launch.launch<span style="color: #b0b1a3;">()</span>;

        <span style="color: #98f5ff;">Ok</span><span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">Runtime</span>::from_parts<span style="color: #97b098;">(</span><span style="color: #98f5ff;">Scheduler</span>::<span style="color: #98f5ff;">MultiThread</span><span style="color: #aebed8;">(</span>scheduler<span style="color: #aebed8;">)</span>, handle, blocking_pool<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>

<span style="color: #ffe4b5;">/// Blocking Pool struct</span>
<span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">spawner</span>: <span style="color: #98f5ff;">Spawner</span>,
    <span style="color: #4eee94;">shutdown_rx</span>: <span style="color: #a2cd5a;">shutdown</span>::<span style="color: #98f5ff;">Receiver</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">builder</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Builder</span>, <span style="color: #4eee94;">thread_cap</span>: <span style="color: #98f5ff;">usize</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>shutdown_tx, shutdown_rx<span style="color: #b0b1a3;">)</span> = <span style="color: #a2cd5a;">shutdown</span>::channel<span style="color: #b0b1a3;">()</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">keep_alive</span> = builder.keep_alive.unwrap_or<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">KEEP_ALIVE</span><span style="color: #b0b1a3;">)</span>;

        <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #4eee94;">spawner</span>: <span style="color: #98f5ff;">Spawner</span> <span style="color: #97b098;">{</span>
                <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Arc</span>::new<span style="color: #aebed8;">(</span><span style="color: #98f5ff;">Inner</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #4eee94;">shared</span>: <span style="color: #98f5ff;">Mutex</span>::new<span style="color: #90a890;">(</span><span style="color: #98f5ff;">Shared</span> <span style="color: #a2b6da;">{</span>
                        <span style="color: #4eee94;">queue</span>: <span style="color: #98f5ff;">VecDeque</span>::new<span style="color: #9cb6ad;">()</span>,
                        <span style="color: #4eee94;">num_notify</span>: 0,
                        <span style="color: #4eee94;">shutdown</span>: <span style="color: #00bfff;">false</span>,
                        <span style="color: #4eee94;">shutdown_tx</span>: <span style="color: #98f5ff;">Some</span><span style="color: #9cb6ad;">(</span>shutdown_tx<span style="color: #9cb6ad;">)</span>,
                        <span style="color: #4eee94;">last_exiting_thread</span>: <span style="color: #98f5ff;">None</span>,
                        <span style="color: #4eee94;">worker_threads</span>: <span style="color: #98f5ff;">HashMap</span>::new<span style="color: #9cb6ad;">()</span>,
                        <span style="color: #4eee94;">worker_thread_index</span>: 0,
                    <span style="color: #a2b6da;">}</span><span style="color: #90a890;">)</span>,
                    <span style="color: #4eee94;">condvar</span>: <span style="color: #98f5ff;">Condvar</span>::new<span style="color: #90a890;">()</span>,
                    <span style="color: #4eee94;">thread_name</span>: builder.thread_name.clone<span style="color: #90a890;">()</span>,
                    <span style="color: #4eee94;">stack_size</span>: builder.thread_stack_size,
                    <span style="color: #4eee94;">after_start</span>: builder.after_start.clone<span style="color: #90a890;">()</span>,
                    <span style="color: #4eee94;">before_stop</span>: builder.before_stop.clone<span style="color: #90a890;">()</span>,
                    thread_cap,
                    keep_alive,
                    <span style="color: #4eee94;">metrics</span>: <span style="color: #98f5ff;">Default</span>::default<span style="color: #90a890;">()</span>,
                <span style="color: #b0b0b3;">}</span><span style="color: #aebed8;">)</span>,
            <span style="color: #97b098;">}</span>,
            shutdown_rx,
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>


</pre>
</div>
</div>
</div>
<div id="outline-container-orga39814b" class="outline-3">
<h3 id="orga39814b"><span class="section-number-3">13.2.</span> worker::<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:188">create</a>, workers 的数量 与 Runtime::worker_threads 的数量 相同</h3>
<div class="outline-text-3" id="text-13-2">
</div>
<div id="outline-container-org33a802b" class="outline-4">
<h4 id="org33a802b"><span class="section-number-4">13.2.1.</span> 1. <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:202">queue::local</a> 分配 queue 空间： <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/queue.rs:85">local</a></h4>
</div>
<div id="outline-container-org10f2e4e" class="outline-4">
<h4 id="org10f2e4e"><span class="section-number-4">13.2.2.</span> 2. 组装 <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:207">cores</a>: Array&lt;<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:86">Core</a>&gt;, 其结构中：run_queue 为接受 Task的 队列， 比较重要</h4>
</div>
<div id="outline-container-org4abb89f" class="outline-4">
<h4 id="org4abb89f"><span class="section-number-4">13.2.3.</span> 3. <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:222">构建</a> 了 1 个 <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/handle.rs:13">Handle</a> {}  为 n 个 <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:241">workers</a> 共享</h4>
</div>
<div id="outline-container-org92d38bd" class="outline-4">
<h4 id="org92d38bd"><span class="section-number-4">13.2.4.</span> 4. 组装为： pub(crate) struct Launch(Vec&lt;Arc&lt;Worker&gt;&gt;);</h4>
</div>
<div id="outline-container-orgce09943" class="outline-4">
<h4 id="orgce09943"><span class="section-number-4">13.2.5.</span> ? MutlThread::<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/handle.rs:13">Handle</a>  类型的作用是？</h4>
<div class="outline-text-4" id="text-13-2-5">
<p>
<i><b>*</b> [[<a href="file:///Users/shaohua.li">file:///Users/shaohua.li</a></i>.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:222][let handle]] = Arc::new(<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/handle.rs:13">Handle</a> { shared:<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:121">Shared</a> {}} <i>/ //</i> Handle to the multi thread scheduler
</p>
</div>
</div>
<div id="outline-container-orga721abb" class="outline-4">
<h4 id="orga721abb"><span class="section-number-4">13.2.6.</span> runtime::<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:365">spawn_blocking</a>(move <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:370">run</a>(worker))</h4>
<div class="outline-text-4" id="text-13-2-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #98f5ff;">CURRENT</span>.set<span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>cx, || <span style="color: #93a8c6;">{</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This should always be an error. It only returns a `Result` to support</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">using `?` to short circuit.</span>
    <span style="color: #ffd700;">assert!</span><span style="color: #b0b1a3;">(</span>cx.run<span style="color: #97b098;">(</span>core<span style="color: #97b098;">)</span>.is_err<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Check if there are any deferred tasks to notify. This can happen when</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">the worker core is lost due to `block_in_place()` being called from</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">within the task.</span>
    wake_deferred_tasks<span style="color: #b0b1a3;">()</span>;
<span style="color: #93a8c6;">}</span><span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf3942d2" class="outline-4">
<h4 id="orgf3942d2"><span class="section-number-4">13.2.7.</span> <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:416">cx.run</a> 最终 在一个while 循环中 进行</h4>
</div>
</div>
<div id="outline-container-org87b8a81" class="outline-3">
<h3 id="org87b8a81"><span class="section-number-3">13.3.</span> lanch.<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/builder.rs:1060">launch</a> thread::spawn 的时候，创建 thread 与 worker关联的地方</h3>
<div class="outline-text-3" id="text-13-3">
</div>
<div id="outline-container-org29c875d" class="outline-4">
<h4 id="org29c875d"><span class="section-number-4">13.3.1.</span> Launch  结构为：</h4>
<div class="outline-text-4" id="text-13-3-1">
<div class="org-src-container">
<pre class="src src-rust">  <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Launch</span><span style="color: #8c8c8c;">(</span><span style="color: #98f5ff;">Vec</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Arc</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Worker</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span>;

  <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">launch</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #8c8c8c;">)</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #00bfff;">for</span> <span style="color: #4eee94;">worker</span> <span style="color: #00bfff;">in</span> <span style="color: #00bfff;">self</span>.0.drain<span style="color: #93a8c6;">(</span>..<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
          <span style="color: #a2cd5a;">runtime</span>::spawn_blocking<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">move</span> || run<span style="color: #97b098;">(</span>worker<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>;
      <span style="color: #93a8c6;">}</span>
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #ffe4b5;">/// runtime::Handle</span>
  <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Handle</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">inner</span>: <span style="color: #a2cd5a;">scheduler</span>::<span style="color: #98f5ff;">Handle</span>,
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #ffe4b5;">/// scheduler::Handle</span>
  <span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">derive</span><span style="color: #93a8c6;">(</span><span style="color: #ffd700;">Debug, Clone</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
  <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">Handle</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"rt"</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
      <span style="color: #98f5ff;">CurrentThread</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Arc</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #a2cd5a;">current_thread</span>::<span style="color: #98f5ff;">Handle</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span>,

      <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">all</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"rt-multi-thread"</span><span style="color: #ffd700;">, not</span><span style="color: #aebed8;">(</span><span style="color: #ffd700;">tokio_wasi</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
      <span style="color: #98f5ff;">MultiThread</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Arc</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #a2cd5a;">multi_thread</span>::<span style="color: #98f5ff;">Handle</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span>,

      <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">TODO: This is to avoid triggering "dead code" warnings many other places</span>
      <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">in the codebase. Remove this during a later cleanup</span>
      <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">not</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"rt"</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
      <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">allow</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">dead_code</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
      <span style="color: #98f5ff;">Disabled</span>,
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #ffe4b5;">/// multi_thread::Handle</span>
  <span style="color: #ffe4b5;">/// Handle to the multi thread scheduler</span>
  <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Handle</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #ffe4b5;">/// Task spawner</span>
      <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">super</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">shared</span>: <span style="color: #a2cd5a;">worker</span>::<span style="color: #98f5ff;">Shared</span>,

      <span style="color: #ffe4b5;">/// Resource driver handles</span>
      <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">driver</span>: <span style="color: #a2cd5a;">driver</span>::<span style="color: #98f5ff;">Handle</span>,

      <span style="color: #ffe4b5;">/// Blocking pool spawner</span>
      <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">blocking_spawner</span>: <span style="color: #a2cd5a;">blocking</span>::<span style="color: #98f5ff;">Spawner</span>,

      <span style="color: #ffe4b5;">/// Current random number generator seed</span>
      <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">seed_generator</span>: <span style="color: #98f5ff;">RngSeedGenerator</span>,
  <span style="color: #8c8c8c;">}</span>

    <span style="color: #ffe4b5;">/// runtime::spawn_blocking</span>
    <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_blocking</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">F</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">JoinHandle</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;</span>
    <span style="color: #00bfff;">where</span>
        <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #8c8c8c;">()</span> -&gt; <span style="color: #98f5ff;">R</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
        <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
    <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">rt</span> = <span style="color: #98f5ff;">Handle</span>::current<span style="color: #93a8c6;">()</span>; <span style="color: #ffe4b5;">/// &#19978;&#38754; runtime::Handle</span>
        rt.spawn_blocking<span style="color: #93a8c6;">(</span>func<span style="color: #93a8c6;">)</span> <span style="color: #ffe4b5;">/// runtime#Handle -&gt; rt.spawn_blocking(func)</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #ffe4b5;">/// runtime#Handle.spawn_blocking</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_blocking</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">F</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">JoinHandle</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;</span>
    <span style="color: #00bfff;">where</span>
        <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #8c8c8c;">()</span> -&gt; <span style="color: #98f5ff;">R</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
        <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
    <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">self</span>.inner.blocking_spawner<span style="color: #93a8c6;">()</span>.spawn_blocking<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">self</span>, func<span style="color: #93a8c6;">)</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #ffe4b5;">/// &#25152;&#20197;&#36825;&#37324;&#30340;&#36820;&#22238;&#30340;&#20026; Handle#blocking_spawner: blocking::Spawner</span>
    <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">blocking_spawner</span><span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #a2cd5a;">blocking</span>::<span style="color: #98f5ff;">Spawner</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #98f5ff;">Handle</span>::<span style="color: #98f5ff;">CurrentThread</span><span style="color: #b0b1a3;">(</span>h<span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span>h.blocking_spawner,

            <span style="color: #ffd700;">#</span><span style="color: #b0b1a3;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">all</span><span style="color: #aebed8;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"rt-multi-thread"</span><span style="color: #ffd700;">, not</span><span style="color: #b0b0b3;">(</span><span style="color: #ffd700;">tokio_wasi</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">]</span>
            <span style="color: #98f5ff;">Handle</span>::<span style="color: #98f5ff;">MultiThread</span><span style="color: #b0b1a3;">(</span>h<span style="color: #b0b1a3;">)</span> =&gt; <span style="color: #cccccc; background-color: #181a26;">&amp;</span>h.blocking_spawner,
        <span style="color: #93a8c6;">}</span>
    <span style="color: #8c8c8c;">}</span>

  <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Spawner</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">track_caller</span><span style="color: #93a8c6;">]</span>
      <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_blocking</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #93a8c6;">&gt;(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">rt</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Handle</span>, <span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">F</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">JoinHandle</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">R</span><span style="color: #93a8c6;">&gt;</span>
      <span style="color: #00bfff;">where</span>
          <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #93a8c6;">()</span> -&gt; <span style="color: #98f5ff;">R</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
          <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
      <span style="color: #93a8c6;">{</span>
          <span style="color: #ffe4b5;">/// &#37325;&#35201;&#30340;logic&#65292; &#21019;&#24314;&#36827;&#31243;&#30340; &#22320;&#26041;</span>
          <span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>join_handle, spawn_result<span style="color: #b0b1a3;">)</span> =
              <span style="color: #00bfff;">if</span> <span style="color: #ffd700;">cfg!</span><span style="color: #b0b1a3;">(</span>debug_assertions<span style="color: #b0b1a3;">)</span> &amp;&amp; <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">mem</span>::size_of::<span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">F</span><span style="color: #b0b1a3;">&gt;()</span> &gt; 2048 <span style="color: #b0b1a3;">{</span>
                  <span style="color: #00bfff;">self</span>.spawn_blocking_inner<span style="color: #97b098;">(</span><span style="color: #98f5ff;">Box</span>::new<span style="color: #aebed8;">(</span>func<span style="color: #aebed8;">)</span>, <span style="color: #98f5ff;">Mandatory</span>::<span style="color: #98f5ff;">NonMandatory</span>, <span style="color: #98f5ff;">None</span>, rt<span style="color: #97b098;">)</span>
              <span style="color: #b0b1a3;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #b0b1a3;">{</span>
                  <span style="color: #00bfff;">self</span>.spawn_blocking_inner<span style="color: #97b098;">(</span>func, <span style="color: #98f5ff;">Mandatory</span>::<span style="color: #98f5ff;">NonMandatory</span>, <span style="color: #98f5ff;">None</span>, rt<span style="color: #97b098;">)</span>
              <span style="color: #b0b1a3;">}</span>;

          <span style="color: #00bfff;">match</span> spawn_result <span style="color: #b0b1a3;">{</span>
              <span style="color: #98f5ff;">Ok</span><span style="color: #97b098;">(</span><span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span> =&gt; join_handle,
              <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Compat: do not panic here, return the join_handle even though it will never resolve</span>
              <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">SpawnError</span>::<span style="color: #98f5ff;">ShuttingDown</span><span style="color: #97b098;">)</span> =&gt; join_handle,
              <span style="color: #98f5ff;">Err</span><span style="color: #97b098;">(</span><span style="color: #98f5ff;">SpawnError</span>::<span style="color: #98f5ff;">NoThreads</span><span style="color: #aebed8;">(</span>e<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> =&gt; <span style="color: #97b098;">{</span>
                  <span style="color: #ffd700;">panic!</span><span style="color: #aebed8;">(</span><span style="color: #deb887;">"OS can't spawn worker thread: {}"</span>, e<span style="color: #aebed8;">)</span>
              <span style="color: #97b098;">}</span>
          <span style="color: #b0b1a3;">}</span>
      <span style="color: #93a8c6;">}</span>
  <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_blocking_inner</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;(</span>
        <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>,
        <span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">F</span>,
        <span style="color: #4eee94;">is_mandatory</span>: <span style="color: #98f5ff;">Mandatory</span>,
        <span style="color: #4eee94;">name</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">&gt;</span>,
        <span style="color: #4eee94;">rt</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Handle</span>,
    <span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #8c8c8c;">(</span><span style="color: #98f5ff;">JoinHandle</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">R</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #b0b1a3;">()</span>, <span style="color: #98f5ff;">SpawnError</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #00bfff;">where</span>
        <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #8c8c8c;">()</span> -&gt; <span style="color: #98f5ff;">R</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
        <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
    <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">fut</span> = <span style="color: #98f5ff;">BlockingTask</span>::new<span style="color: #93a8c6;">(</span>func<span style="color: #93a8c6;">)</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">id</span> = <span style="color: #a2cd5a;">task</span>::<span style="color: #98f5ff;">Id</span>::next<span style="color: #93a8c6;">()</span>;
        <span style="color: #ffe4b5;">/// ...</span>
        <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">not</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">all</span><span style="color: #aebed8;">(</span><span style="color: #ffd700;">tokio_unstable, feature = </span><span style="color: #deb887;">"tracing"</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_</span> = name;

        <span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span>task, handle<span style="color: #93a8c6;">)</span> = <span style="color: #a2cd5a;">task</span>::unowned<span style="color: #93a8c6;">(</span>fut, <span style="color: #98f5ff;">BlockingSchedule</span>::new<span style="color: #b0b1a3;">(</span>rt<span style="color: #b0b1a3;">)</span>, id<span style="color: #93a8c6;">)</span>; <span style="color: #ffe4b5;">/// &#36825;&#37324;&#23558; func &#23553;&#35013;&#20026; Task</span>

        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">spawned</span> = <span style="color: #00bfff;">self</span>.spawn_task<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Task</span>::new<span style="color: #b0b1a3;">(</span>task, is_mandatory<span style="color: #b0b1a3;">)</span>, rt<span style="color: #93a8c6;">)</span>;
        <span style="color: #93a8c6;">(</span>handle, spawned<span style="color: #93a8c6;">)</span>
    <span style="color: #8c8c8c;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_task</span><span style="color: #8c8c8c;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">task</span>: <span style="color: #98f5ff;">Task</span>, <span style="color: #4eee94;">rt</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Handle</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">Result</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #93a8c6;">()</span>, <span style="color: #98f5ff;">SpawnError</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">shared</span> = <span style="color: #00bfff;">self</span>.inner.shared.lock<span style="color: #93a8c6;">()</span>;

        shared.queue.push_back<span style="color: #93a8c6;">(</span>task<span style="color: #93a8c6;">)</span>; <span style="color: #ffe4b5;">/// &#36825;&#37324;&#23558; task &#25918;&#20837;&#21040; shared.queue</span>
        <span style="color: #00bfff;">self</span>.inner.metrics.inc_queue_depth<span style="color: #93a8c6;">()</span>;

        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">self</span>.inner.metrics.num_idle_threads<span style="color: #93a8c6;">()</span> == 0 <span style="color: #93a8c6;">{</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">No threads are able to process the task.</span>
            <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">self</span>.inner.metrics.num_threads<span style="color: #b0b1a3;">()</span> == <span style="color: #00bfff;">self</span>.inner.thread_cap <span style="color: #b0b1a3;">{</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">At max number of threads</span>
            <span style="color: #b0b1a3;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #b0b1a3;">{</span>
                <span style="color: #ffd700;">assert!</span><span style="color: #97b098;">(</span>shared.shutdown_tx.is_some<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span>;
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">shutdown_tx</span> = shared.shutdown_tx.clone<span style="color: #97b098;">()</span>;

                <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>shutdown_tx<span style="color: #97b098;">)</span> = shutdown_tx <span style="color: #97b098;">{</span>
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">id</span> = shared.worker_thread_index;

                    <span style="color: #ffe4b5;">/// spawn_thread</span>
                    <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.spawn_thread<span style="color: #aebed8;">(</span>shutdown_tx, rt, id<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">{</span>
                        <span style="color: #98f5ff;">Ok</span><span style="color: #b0b0b3;">(</span>handle<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
                            <span style="color: #00bfff;">self</span>.inner.metrics.inc_num_threads<span style="color: #90a890;">()</span>;
                            shared.worker_thread_index += 1;
                            shared.worker_threads.insert<span style="color: #90a890;">(</span>id, handle<span style="color: #90a890;">)</span>;
                        <span style="color: #b0b0b3;">}</span>
                        <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">ref</span> <span style="color: #4eee94;">e</span><span style="color: #b0b0b3;">)</span>
                            <span style="color: #00bfff;">if</span> is_temporary_os_thread_error<span style="color: #b0b0b3;">(</span>e<span style="color: #b0b0b3;">)</span>
                                &amp;&amp; <span style="color: #00bfff;">self</span>.inner.metrics.num_threads<span style="color: #b0b0b3;">()</span> &gt; 0 =&gt;
                        <span style="color: #b0b0b3;">{</span>
                            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">OS temporarily failed to spawn a new thread.</span>
                            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">The task will be picked up eventually by a currently</span>
                            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">busy thread.</span>
                        <span style="color: #b0b0b3;">}</span>
                        <span style="color: #98f5ff;">Err</span><span style="color: #b0b0b3;">(</span>e<span style="color: #b0b0b3;">)</span> =&gt; <span style="color: #b0b0b3;">{</span>
                            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">The OS refused to spawn the thread and there is no thread</span>
                            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">to pick up the task that has just been pushed to the queue.</span>
                            <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #90a890;">(</span><span style="color: #98f5ff;">SpawnError</span>::<span style="color: #98f5ff;">NoThreads</span><span style="color: #a2b6da;">(</span>e<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>;
                        <span style="color: #b0b0b3;">}</span>
                    <span style="color: #aebed8;">}</span>
                <span style="color: #97b098;">}</span>
            <span style="color: #b0b1a3;">}</span>
        <span style="color: #93a8c6;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #93a8c6;">{</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Notify an idle worker thread. The notification counter</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">is used to count the needed amount of notifications</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">exactly. Thread libraries may generate spurious</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">wakeups, this counter is used to keep us in a</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">consistent state.</span>
            <span style="color: #00bfff;">self</span>.inner.metrics.dec_num_idle_threads<span style="color: #b0b1a3;">()</span>;
            shared.num_notify += 1;
            <span style="color: #00bfff;">self</span>.inner.condvar.notify_one<span style="color: #b0b1a3;">()</span>;
        <span style="color: #93a8c6;">}</span>

        <span style="color: #98f5ff;">Ok</span><span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">)</span>
    <span style="color: #8c8c8c;">}</span>


    <span style="color: #ffe4b5;">/// &#20135;&#29983; thread &#30340;&#22320;&#26041;</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_thread</span><span style="color: #8c8c8c;">(</span>
        <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>,
        <span style="color: #4eee94;">shutdown_tx</span>: <span style="color: #a2cd5a;">shutdown</span>::<span style="color: #98f5ff;">Sender</span>,
        <span style="color: #4eee94;">rt</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Handle</span>,
        <span style="color: #4eee94;">id</span>: <span style="color: #98f5ff;">usize</span>,
    <span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Result</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #a2cd5a;">thread</span>::<span style="color: #98f5ff;">JoinHandle</span><span style="color: #93a8c6;">&lt;</span><span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">builder</span> = <span style="color: #a2cd5a;">thread</span>::<span style="color: #98f5ff;">Builder</span>::new<span style="color: #93a8c6;">()</span>.name<span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">self</span>.inner.thread_name<span style="color: #b0b1a3;">)()</span><span style="color: #93a8c6;">)</span>;

        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #93a8c6;">(</span>stack_size<span style="color: #93a8c6;">)</span> = <span style="color: #00bfff;">self</span>.inner.stack_size <span style="color: #93a8c6;">{</span>
            builder = builder.stack_size<span style="color: #b0b1a3;">(</span>stack_size<span style="color: #b0b1a3;">)</span>;
        <span style="color: #93a8c6;">}</span>

        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">rt</span> = rt.clone<span style="color: #93a8c6;">()</span>; <span style="color: #ffe4b5;">/// rt&#20026; runtime#Handle</span>

        builder.spawn<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">move</span> || <span style="color: #b0b1a3;">{</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Only the reference should be moved into the closure</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_enter</span> = rt.enter<span style="color: #97b098;">()</span>;
            rt.inner.blocking_spawner<span style="color: #97b098;">()</span>.inner.run<span style="color: #97b098;">(</span>id<span style="color: #97b098;">)</span>; <span style="color: #ffe4b5;">/// &#19979;&#38754;&#20026; &#20027;&#35201;&#30340;&#36923;&#36753;</span>
            drop<span style="color: #97b098;">(</span>shutdown_tx<span style="color: #97b098;">)</span>;
        <span style="color: #b0b1a3;">}</span><span style="color: #93a8c6;">)</span>
    <span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Inner</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">run</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">worker_thread_id</span>: <span style="color: #98f5ff;">usize</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #b0b1a3;">(</span>f<span style="color: #b0b1a3;">)</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.after_start <span style="color: #b0b1a3;">{</span>
            f<span style="color: #97b098;">()</span>
        <span style="color: #b0b1a3;">}</span>

        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">shared</span> = <span style="color: #00bfff;">self</span>.shared.lock<span style="color: #b0b1a3;">()</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">join_on_thread</span> = <span style="color: #98f5ff;">None</span>;

        '<span style="color: #4eee94;">main</span>: <span style="color: #00bfff;">loop</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #ffe4b5;">/// BUSY  &#36825;&#37324;&#20026; &#25191;&#34892; run(worker) &#36716;&#25442;&#20026; Task &#20043;&#21518; task.run()</span>
            <span style="color: #00bfff;">while</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>task<span style="color: #97b098;">)</span> = shared.queue.pop_front<span style="color: #97b098;">()</span> <span style="color: #97b098;">{</span>
                <span style="color: #00bfff;">self</span>.metrics.dec_queue_depth<span style="color: #aebed8;">()</span>;
                drop<span style="color: #aebed8;">(</span>shared<span style="color: #aebed8;">)</span>;
                task.run<span style="color: #aebed8;">()</span>; <span style="color: #ffe4b5;">/// run(worker)</span>

                shared = <span style="color: #00bfff;">self</span>.shared.lock<span style="color: #aebed8;">()</span>;
            <span style="color: #97b098;">}</span>

            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">IDLE</span>
            <span style="color: #00bfff;">self</span>.metrics.inc_num_idle_threads<span style="color: #97b098;">()</span>;

            <span style="color: #00bfff;">while</span> !shared.shutdown <span style="color: #97b098;">{</span>
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">lock_result</span> = <span style="color: #00bfff;">self</span>.condvar.wait_timeout<span style="color: #aebed8;">(</span>shared, <span style="color: #00bfff;">self</span>.keep_alive<span style="color: #aebed8;">)</span>.unwrap<span style="color: #aebed8;">()</span>;

                shared = lock_result.0;
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">timeout_result</span> = lock_result.1;

                <span style="color: #00bfff;">if</span> shared.num_notify != 0 <span style="color: #aebed8;">{</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">We have received a legitimate wakeup,</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">acknowledge it by decrementing the counter</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">and transition to the BUSY state.</span>
                    shared.num_notify -= 1;
                    <span style="color: #00bfff;">break</span>;
                <span style="color: #aebed8;">}</span>

                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Even if the condvar "timed out", if the pool is entering the</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">shutdown phase, we want to perform the cleanup logic.</span>
                <span style="color: #00bfff;">if</span> !shared.shutdown &amp;&amp; timeout_result.timed_out<span style="color: #aebed8;">()</span> <span style="color: #aebed8;">{</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">We'll join the prior timed-out thread's JoinHandle after dropping the lock.</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This isn't done when shutting down, because the thread calling shutdown will</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">handle joining everything.</span>
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">my_handle</span> = shared.worker_threads.remove<span style="color: #b0b0b3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>worker_thread_id<span style="color: #b0b0b3;">)</span>;
                    join_on_thread = <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">mem</span>::replace<span style="color: #b0b0b3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> shared.last_exiting_thread, my_handle<span style="color: #b0b0b3;">)</span>;

                    <span style="color: #00bfff;">break</span> '<span style="color: #4eee94;">main</span>;
                <span style="color: #aebed8;">}</span>

                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Spurious wakeup detected, go back to sleep.</span>
            <span style="color: #97b098;">}</span>

            <span style="color: #00bfff;">if</span> shared.shutdown <span style="color: #97b098;">{</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Drain the queue</span>
                <span style="color: #00bfff;">while</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #aebed8;">(</span>task<span style="color: #aebed8;">)</span> = shared.queue.pop_front<span style="color: #aebed8;">()</span> <span style="color: #aebed8;">{</span>
                    <span style="color: #00bfff;">self</span>.metrics.dec_queue_depth<span style="color: #b0b0b3;">()</span>;
                    drop<span style="color: #b0b0b3;">(</span>shared<span style="color: #b0b0b3;">)</span>;

                    task.shutdown_or_run_if_mandatory<span style="color: #b0b0b3;">()</span>;

                    shared = <span style="color: #00bfff;">self</span>.shared.lock<span style="color: #b0b0b3;">()</span>;
                <span style="color: #aebed8;">}</span>

                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Work was produced, and we "took" it (by decrementing num_notify).</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This means that num_idle was decremented once for our wakeup.</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">But, since we are exiting, we need to "undo" that, as we'll stay idle.</span>
                <span style="color: #00bfff;">self</span>.metrics.inc_num_idle_threads<span style="color: #aebed8;">()</span>;
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">NOTE: Technically we should also do num_notify++ and notify again,</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">but since we're shutting down anyway, that won't be necessary.</span>
                <span style="color: #00bfff;">break</span>;
            <span style="color: #97b098;">}</span>
        <span style="color: #b0b1a3;">}</span>

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Thread exit</span>
        <span style="color: #00bfff;">self</span>.metrics.dec_num_threads<span style="color: #b0b1a3;">()</span>;

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">num_idle should now be tracked exactly, panic</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">with a descriptive message if it is not the</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">case.</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">prev_idle</span> = <span style="color: #00bfff;">self</span>.metrics.dec_num_idle_threads<span style="color: #b0b1a3;">()</span>;
        <span style="color: #00bfff;">if</span> prev_idle &lt; <span style="color: #00bfff;">self</span>.metrics.num_idle_threads<span style="color: #b0b1a3;">()</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #ffd700;">panic!</span><span style="color: #97b098;">(</span><span style="color: #deb887;">"num_idle_threads underflowed on thread exit"</span><span style="color: #97b098;">)</span>
        <span style="color: #b0b1a3;">}</span>

        <span style="color: #00bfff;">if</span> shared.shutdown &amp;&amp; <span style="color: #00bfff;">self</span>.metrics.num_threads<span style="color: #b0b1a3;">()</span> == 0 <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">self</span>.condvar.notify_one<span style="color: #97b098;">()</span>;
        <span style="color: #b0b1a3;">}</span>

        drop<span style="color: #b0b1a3;">(</span>shared<span style="color: #b0b1a3;">)</span>;

        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #b0b1a3;">(</span>f<span style="color: #b0b1a3;">)</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.before_stop <span style="color: #b0b1a3;">{</span>
            f<span style="color: #97b098;">()</span>
        <span style="color: #b0b1a3;">}</span>

        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #b0b1a3;">(</span>handle<span style="color: #b0b1a3;">)</span> = join_on_thread <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_</span> = handle.join<span style="color: #97b098;">()</span>;
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgad36766" class="outline-3">
<h3 id="orgad36766"><span class="section-number-3">13.4.</span> 在 runtime::spawn_blocking(move || run(worker)); 中 的几个关键点：</h3>
<div class="outline-text-3" id="text-13-4">
</div>
<div id="outline-container-orgc5d444e" class="outline-4">
<h4 id="orgc5d444e"><span class="section-number-4">13.4.1.</span> block {run(worker)}  =&gt; fut 的转换</h4>
<div class="outline-text-4" id="text-13-4-1">
<div class="org-src-container">
<pre class="src src-rust">      <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">spawn_blocking_inner</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">F</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;(</span>
          <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>,
          <span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">F</span>,
          <span style="color: #4eee94;">is_mandatory</span>: <span style="color: #98f5ff;">Mandatory</span>,
          <span style="color: #4eee94;">name</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">&gt;</span>,
          <span style="color: #4eee94;">rt</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Handle</span>,
      <span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #8c8c8c;">(</span><span style="color: #98f5ff;">JoinHandle</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">R</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #98f5ff;">Result</span><span style="color: #93a8c6;">&lt;</span><span style="color: #b0b1a3;">()</span>, <span style="color: #98f5ff;">SpawnError</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span>
      <span style="color: #00bfff;">where</span>
          <span style="color: #4eee94;">F</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #8c8c8c;">()</span> -&gt; <span style="color: #98f5ff;">R</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
          <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
      <span style="color: #8c8c8c;">{</span>
          <span style="color: #ffe4b5;">/// &#23558; func &#23553;&#35013;&#20026; BlockingTask</span>
          <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">fut</span> = <span style="color: #98f5ff;">BlockingTask</span>::new<span style="color: #93a8c6;">(</span>func<span style="color: #93a8c6;">)</span>;
          <span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span>task, handle<span style="color: #93a8c6;">)</span> = <span style="color: #a2cd5a;">task</span>::unowned<span style="color: #93a8c6;">(</span>fut, <span style="color: #98f5ff;">BlockingSchedule</span>::new<span style="color: #b0b1a3;">(</span>rt<span style="color: #b0b1a3;">)</span>, id<span style="color: #93a8c6;">)</span>; <span style="color: #ffe4b5;">/// &#25152;&#20197; &#36825;&#37324;&#26368;&#32456;&#38598;&#37027;&#20010; func &#23553;&#35013;&#20026; task, </span>

          <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">spawned</span> = <span style="color: #00bfff;">self</span>.spawn_task<span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">Task</span>::new<span style="color: #b0b1a3;">(</span>task, is_mandatory<span style="color: #b0b1a3;">)</span>, rt<span style="color: #93a8c6;">)</span>;
      <span style="color: #8c8c8c;">}</span>

  <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">BlockingSchedule</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"test-util"</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
      <span style="color: #4eee94;">handle</span>: <span style="color: #98f5ff;">Handle</span>,
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #ffe4b5;">/// Converts a function to a future that completes on poll.</span>
  <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">BlockingTask</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">&gt;</span>,
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">BlockingTask</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
      <span style="color: #ffe4b5;">/// Initializes a new blocking task from the given function.</span>
      <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">BlockingTask</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
          <span style="color: #98f5ff;">BlockingTask</span> <span style="color: #b0b1a3;">{</span> <span style="color: #4eee94;">func</span>: <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>func<span style="color: #97b098;">)</span> <span style="color: #b0b1a3;">}</span>
      <span style="color: #93a8c6;">}</span>
  <span style="color: #8c8c8c;">}</span>


<span style="color: #00bfff;">impl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">R</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #98f5ff;">Future</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">BlockingTask</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span><span style="color: #8c8c8c;">&gt;</span>
<span style="color: #00bfff;">where</span>
    <span style="color: #4eee94;">T</span>: <span style="color: #98f5ff;">FnOnce</span><span style="color: #8c8c8c;">()</span> -&gt; <span style="color: #98f5ff;">R</span> + <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
    <span style="color: #4eee94;">R</span>: <span style="color: #98f5ff;">Send</span> + '<span style="color: #00bfff;">static</span>,
<span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">type</span> <span style="color: #98f5ff;">Output</span> = <span style="color: #98f5ff;">R</span>;

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">poll</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>: <span style="color: #98f5ff;">Pin</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Self</span><span style="color: #b0b1a3;">&gt;</span>, <span style="color: #4eee94;">_cx</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #98f5ff;">Context</span><span style="color: #b0b1a3;">&lt;</span>'<span style="color: #4eee94;">_</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Poll</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">R</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">me</span> = <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> *<span style="color: #00bfff;">self</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">func</span> = me
            .func
            .take<span style="color: #b0b1a3;">()</span>
            .expect<span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"[internal exception] blocking task ran twice."</span><span style="color: #b0b1a3;">)</span>; <span style="color: #ffe4b5;">/// &#23558;func take&#20986;&#26469;</span>

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This is a little subtle:</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">For convenience, we'd like _every_ call tokio ever makes to Task::poll() to be budgeted</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">using coop. However, the way things are currently modeled, even running a blocking task</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">currently goes through Task::poll(), and so is subject to budgeting. That isn't really</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">what we want; a blocking task may itself want to run tasks (it might be a Worker!), so</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">we want it to start without any budgeting.</span>
        <span style="color: #00bfff;">crate</span>::<span style="color: #a2cd5a;">runtime</span>::<span style="color: #a2cd5a;">coop</span>::stop<span style="color: #b0b1a3;">()</span>;

        <span style="color: #98f5ff;">Poll</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #b0b1a3;">(</span>func<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span> <span style="color: #ffe4b5;">/// func()  &#25191;&#34892; block, run(worker)</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd926cff" class="outline-3">
<h3 id="orgd926cff"><span class="section-number-3">13.5.</span> Blocking_pool:  blocking::create_blocking_pool(self, self.max_blocking_threads + core_threads);</h3>
<div class="outline-text-3" id="text-13-5">
</div>
<div id="outline-container-org82091b7" class="outline-4">
<h4 id="org82091b7"><span class="section-number-4">13.5.1.</span> 结构：</h4>
<div class="outline-text-4" id="text-13-5-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">spawner</span>: <span style="color: #98f5ff;">Spawner</span>,
    <span style="color: #4eee94;">shutdown_rx</span>: <span style="color: #a2cd5a;">shutdown</span>::<span style="color: #98f5ff;">Receiver</span>,
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Spawner</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Inner</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Inner</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// State shared between worker threads.</span>
    <span style="color: #4eee94;">shared</span>: <span style="color: #98f5ff;">Mutex</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Shared</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #ffe4b5;">/// Pool threads wait on this.</span>
    <span style="color: #4eee94;">condvar</span>: <span style="color: #98f5ff;">Condvar</span>,

    <span style="color: #ffe4b5;">/// Spawned threads use this name.</span>
    <span style="color: #4eee94;">thread_name</span>: <span style="color: #98f5ff;">ThreadNameFn</span>,

    <span style="color: #ffe4b5;">/// Spawned thread stack size.</span>
    <span style="color: #4eee94;">stack_size</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">usize</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #ffe4b5;">/// Call after a thread starts.</span>
    <span style="color: #4eee94;">after_start</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Callback</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #ffe4b5;">/// Call before a thread stops.</span>
    <span style="color: #4eee94;">before_stop</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Callback</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Maximum number of threads.</span>
    <span style="color: #4eee94;">thread_cap</span>: <span style="color: #98f5ff;">usize</span>,

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Customizable wait timeout.</span>
    <span style="color: #4eee94;">keep_alive</span>: <span style="color: #98f5ff;">Duration</span>,

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Metrics about the pool.</span>
    <span style="color: #4eee94;">metrics</span>: <span style="color: #98f5ff;">SpawnerMetrics</span>,
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgadd6944" class="outline-4">
<h4 id="orgadd6944"><span class="section-number-4">13.5.2.</span> 调用：</h4>
<div class="outline-text-4" id="text-13-5-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #ffe4b5;">/// runtime/builder.rs</span>
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">core_threads</span> = <span style="color: #00bfff;">self</span>.worker_threads.unwrap_or_else<span style="color: #8c8c8c;">(</span>num_cpus<span style="color: #8c8c8c;">)</span>;
<span style="color: #00bfff;">let</span> <span style="color: #4eee94;">blocking_pool</span> =
   <span style="color: #a2cd5a;">blocking</span>::create_blocking_pool<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">self</span>, <span style="color: #00bfff;">self</span>.max_blocking_threads + core_threads<span style="color: #8c8c8c;">)</span>; <span style="color: #ffe4b5;">/// &#25152;&#20197;&#36825;&#37324;&#30340;&#25968;&#20540;&#20026;&#65306;  max_blocking_threads (512) + core_threads (16)</span>


<span style="color: #ffe4b5;">///runtime/blocking/mod.rs</span>
  <span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">create_blocking_pool</span><span style="color: #8c8c8c;">(</span><span style="color: #4eee94;">builder</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Builder</span>, <span style="color: #4eee94;">thread_cap</span>: <span style="color: #98f5ff;">usize</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #98f5ff;">BlockingPool</span>::new<span style="color: #93a8c6;">(</span>builder, thread_cap<span style="color: #93a8c6;">)</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #ffe4b5;">/// runtime/blocking/pool.rs</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">new</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">builder</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Builder</span>, <span style="color: #4eee94;">thread_cap</span>: <span style="color: #98f5ff;">usize</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>shutdown_tx, shutdown_rx<span style="color: #b0b1a3;">)</span> = <span style="color: #a2cd5a;">shutdown</span>::channel<span style="color: #b0b1a3;">()</span>;
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">keep_alive</span> = builder.keep_alive.unwrap_or<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">KEEP_ALIVE</span><span style="color: #b0b1a3;">)</span>;

        <span style="color: #98f5ff;">BlockingPool</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #4eee94;">spawner</span>: <span style="color: #98f5ff;">Spawner</span> <span style="color: #97b098;">{</span>
                <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">Arc</span>::new<span style="color: #aebed8;">(</span><span style="color: #98f5ff;">Inner</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #4eee94;">shared</span>: <span style="color: #98f5ff;">Mutex</span>::new<span style="color: #90a890;">(</span><span style="color: #98f5ff;">Shared</span> <span style="color: #a2b6da;">{</span>
                        <span style="color: #4eee94;">queue</span>: <span style="color: #98f5ff;">VecDeque</span>::new<span style="color: #9cb6ad;">()</span>,
                        <span style="color: #4eee94;">num_notify</span>: 0,
                        <span style="color: #4eee94;">shutdown</span>: <span style="color: #00bfff;">false</span>,
                        <span style="color: #4eee94;">shutdown_tx</span>: <span style="color: #98f5ff;">Some</span><span style="color: #9cb6ad;">(</span>shutdown_tx<span style="color: #9cb6ad;">)</span>,
                        <span style="color: #4eee94;">last_exiting_thread</span>: <span style="color: #98f5ff;">None</span>,
                        <span style="color: #4eee94;">worker_threads</span>: <span style="color: #98f5ff;">HashMap</span>::new<span style="color: #9cb6ad;">()</span>,
                        <span style="color: #4eee94;">worker_thread_index</span>: 0,
                    <span style="color: #a2b6da;">}</span><span style="color: #90a890;">)</span>,
                    <span style="color: #4eee94;">condvar</span>: <span style="color: #98f5ff;">Condvar</span>::new<span style="color: #90a890;">()</span>,
                    <span style="color: #4eee94;">thread_name</span>: builder.thread_name.clone<span style="color: #90a890;">()</span>, <span style="color: #ffe4b5;">/// &#19979;&#38754;&#36825;&#20123;&#22522;&#26412;&#21516;&#27493; builder &#30340;&#37197;&#32622;</span>
                    <span style="color: #4eee94;">stack_size</span>: builder.thread_stack_size,
                    <span style="color: #4eee94;">after_start</span>: builder.after_start.clone<span style="color: #90a890;">()</span>,
                    <span style="color: #4eee94;">before_stop</span>: builder.before_stop.clone<span style="color: #90a890;">()</span>,
                    thread_cap, <span style="color: #ffe4b5;">/// </span>
                    keep_alive,
                    <span style="color: #4eee94;">metrics</span>: <span style="color: #98f5ff;">Default</span>::default<span style="color: #90a890;">()</span>,
                <span style="color: #b0b0b3;">}</span><span style="color: #aebed8;">)</span>,
            <span style="color: #97b098;">}</span>,
            shutdown_rx,
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org6a2559f" class="outline-3">
<h3 id="org6a2559f"><span class="section-number-3">13.6.</span> <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:370">Worker#run</a></h3>
<div class="outline-text-3" id="text-13-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">fn</span> <span style="color: #daa520;">run</span><span style="color: #8c8c8c;">(</span><span style="color: #4eee94;">worker</span>: <span style="color: #98f5ff;">Arc</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Worker</span><span style="color: #93a8c6;">&gt;</span><span style="color: #8c8c8c;">)</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">AbortOnPanic</span>;

    <span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Drop</span> <span style="color: #00bfff;">for</span> <span style="color: #98f5ff;">AbortOnPanic</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">drop</span><span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">if</span> <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">thread</span>::panicking<span style="color: #97b098;">()</span> <span style="color: #97b098;">{</span>
                <span style="color: #f08080;">eprintln!</span><span style="color: #aebed8;">(</span><span style="color: #deb887;">"worker thread panicking; aborting process"</span><span style="color: #aebed8;">)</span>;
                <span style="color: #a2cd5a;">std</span>::<span style="color: #a2cd5a;">process</span>::abort<span style="color: #aebed8;">()</span>;
            <span style="color: #97b098;">}</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Catching panics on worker threads in tests is quite tricky. Instead, when</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">debug assertions are enabled, we just abort the process.</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">debug_assertions</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_abort_on_panic</span> = <span style="color: #98f5ff;">AbortOnPanic</span>;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Acquire a core. If this fails, then another thread is running this</span>
    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">worker and there is nothing further to do.</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">core</span> = <span style="color: #00bfff;">match</span> worker.core.take<span style="color: #93a8c6;">()</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #98f5ff;">Some</span><span style="color: #b0b1a3;">(</span>core<span style="color: #b0b1a3;">)</span> =&gt; core,
        <span style="color: #98f5ff;">None</span> =&gt; <span style="color: #00bfff;">return</span>,
    <span style="color: #93a8c6;">}</span>;

    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">handle</span> = <span style="color: #a2cd5a;">scheduler</span>::<span style="color: #98f5ff;">Handle</span>::<span style="color: #98f5ff;">MultiThread</span><span style="color: #93a8c6;">(</span>worker.handle.clone<span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">)</span>;
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">_enter</span> = <span style="color: #00bfff;">crate</span>::<span style="color: #a2cd5a;">runtime</span>::<span style="color: #a2cd5a;">context</span>::enter_runtime<span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>handle, <span style="color: #00bfff;">true</span><span style="color: #93a8c6;">)</span>;

    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Set the worker context.</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">cx</span> = <span style="color: #98f5ff;">Context</span> <span style="color: #93a8c6;">{</span> <span style="color: #ffe4b5;">/// ? Context &#30340;&#20316;&#29992;&#26159;&#65311; &#19981;&#24212;&#35813;&#26159; &#27599;&#20010;Task&#20013;&#19968;&#20010; Context&#21527;&#65311;</span>
        worker,
        <span style="color: #4eee94;">core</span>: <span style="color: #98f5ff;">RefCell</span>::new<span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">None</span><span style="color: #b0b1a3;">)</span>,
    <span style="color: #93a8c6;">}</span>;

    <span style="color: #98f5ff;">CURRENT</span>.set<span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span>cx, || <span style="color: #b0b1a3;">{</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">This should always be an error. It only returns a `Result` to support</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">using `?` to short circuit.</span>
        <span style="color: #ffd700;">assert!</span><span style="color: #97b098;">(</span>cx.run<span style="color: #aebed8;">(</span>core<span style="color: #aebed8;">)</span>.is_err<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span>; <span style="color: #ffe4b5;">/// cx.run &#35843;&#29992; &#26368;&#32456;worker&#36923;&#36753;</span>

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Check if there are any deferred tasks to notify. This can happen when</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">the worker core is lost due to `block_in_place()` being called from</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">within the task.</span>
        wake_deferred_tasks<span style="color: #97b098;">()</span>;
    <span style="color: #b0b1a3;">}</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>


<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Context</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">run</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">core</span>: <span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Core</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">RunResult</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">while</span> !core.is_shutdown <span style="color: #b0b1a3;">{</span> <span style="color: #ffe4b5;">/// &#27515;&#24490;&#29615;</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Increment the tick</span>
            core.tick<span style="color: #97b098;">()</span>;

            <span style="color: #ffe4b5;">/// Run maintenance, if needed</span>
            core = <span style="color: #00bfff;">self</span>.maintenance<span style="color: #97b098;">(</span>core<span style="color: #97b098;">)</span>;

            <span style="color: #ffe4b5;">/// First, check work available to the current worker.</span>
            <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>task<span style="color: #97b098;">)</span> = core.next_task<span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.worker<span style="color: #97b098;">)</span> <span style="color: #97b098;">{</span> <span style="color: #ffe4b5;">/// worker &#33719;&#21462;&#20219;&#21153;  &#36825;&#37324;&#38754; &#38656;&#35201; &#27880;&#24847; next_task &#30340;&#36820;&#22238; &#24182;&#38750;Task&#65292; &#32780;&#26159;Notified, Notified &#31867;&#22411;&#26159;&#19968;&#20010; &#38750;&#24120; &#29305;&#27530;&#30340;&#31867;&#22411;&#65306; </span>
                core = <span style="color: #00bfff;">self</span>.run_task<span style="color: #aebed8;">(</span>task, core<span style="color: #aebed8;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
                <span style="color: #00bfff;">continue</span>;
            <span style="color: #97b098;">}</span>

            <span style="color: #ffe4b5;">/// There is no more **local** work to process, try to steal work</span>
            <span style="color: #ffe4b5;">/// from other workers.</span>
            <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">let</span> <span style="color: #98f5ff;">Some</span><span style="color: #97b098;">(</span>task<span style="color: #97b098;">)</span> = core.steal_work<span style="color: #97b098;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.worker<span style="color: #97b098;">)</span> <span style="color: #97b098;">{</span>
                core = <span style="color: #00bfff;">self</span>.run_task<span style="color: #aebed8;">(</span>task, core<span style="color: #aebed8;">)</span><span style="color: #f08080; font-weight: bold;">?</span>;
            <span style="color: #97b098;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #97b098;">{</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Wait for work</span>
                core = <span style="color: #00bfff;">if</span> did_defer_tasks<span style="color: #aebed8;">()</span> <span style="color: #aebed8;">{</span>
                    <span style="color: #00bfff;">self</span>.park_timeout<span style="color: #b0b0b3;">(</span>core, <span style="color: #98f5ff;">Some</span><span style="color: #90a890;">(</span><span style="color: #98f5ff;">Duration</span>::from_millis<span style="color: #a2b6da;">(</span>0<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                <span style="color: #aebed8;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #aebed8;">{</span>
                    <span style="color: #00bfff;">self</span>.park<span style="color: #b0b0b3;">(</span>core<span style="color: #b0b0b3;">)</span>
                <span style="color: #aebed8;">}</span>;
            <span style="color: #97b098;">}</span>
        <span style="color: #b0b1a3;">}</span>

        core.pre_shutdown<span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.worker<span style="color: #b0b1a3;">)</span>;

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Signal shutdown</span>
        <span style="color: #00bfff;">self</span>.worker.handle.shutdown_core<span style="color: #b0b1a3;">(</span>core<span style="color: #b0b1a3;">)</span>;
        <span style="color: #98f5ff;">Err</span><span style="color: #b0b1a3;">(</span><span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">run_task</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">task</span>: <span style="color: #98f5ff;">Notified</span>, <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">core</span>: <span style="color: #98f5ff;">Box</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Core</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">RunResult</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">task</span> = <span style="color: #00bfff;">self</span>.worker.handle.shared.owned.assert_owner<span style="color: #b0b1a3;">(</span>task<span style="color: #b0b1a3;">)</span>;

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Make sure the worker is not in the **searching** state. This enables</span>
        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">another idle worker to try to steal work.</span>
        core.transition_from_searching<span style="color: #b0b1a3;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">self</span>.worker<span style="color: #b0b1a3;">)</span>;

        <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Make the core available to the runtime context</span>
        core.metrics.incr_poll_count<span style="color: #b0b1a3;">()</span>;
        *<span style="color: #00bfff;">self</span>.core.borrow_mut<span style="color: #b0b1a3;">()</span> = <span style="color: #98f5ff;">Some</span><span style="color: #b0b1a3;">(</span>core<span style="color: #b0b1a3;">)</span>;

        <span style="color: #ffe4b5;">/// Run the task</span>
        <span style="color: #a2cd5a;">coop</span>::budget<span style="color: #b0b1a3;">(</span>|| <span style="color: #97b098;">{</span>
            task.run<span style="color: #aebed8;">()</span>; <span style="color: #ffe4b5;">/// task&#30340;&#19978;&#19979;&#25991; &#20999;&#25442;&#22312;&#21738;&#37324;&#65311;</span>

            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">As long as there is budget remaining and a task exists in the</span>
            <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">`lifo_slot`, then keep running.</span>
            <span style="color: #00bfff;">loop</span> <span style="color: #aebed8;">{</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Check if we still have the core. If not, the core was stolen</span>
                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">by another worker.</span>
                <span style="color: #00bfff;">let</span> <span style="color: #00bfff;">mut</span> <span style="color: #4eee94;">core</span> = <span style="color: #00bfff;">match</span> <span style="color: #00bfff;">self</span>.core.borrow_mut<span style="color: #b0b0b3;">()</span>.take<span style="color: #b0b0b3;">()</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #98f5ff;">Some</span><span style="color: #90a890;">(</span>core<span style="color: #90a890;">)</span> =&gt; core,
                    <span style="color: #98f5ff;">None</span> =&gt; <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Err</span><span style="color: #90a890;">(</span><span style="color: #a2b6da;">()</span><span style="color: #90a890;">)</span>,
                <span style="color: #b0b0b3;">}</span>;

                <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Check for a task in the LIFO slot</span>
                <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">task</span> = <span style="color: #00bfff;">match</span> core.lifo_slot.take<span style="color: #b0b0b3;">()</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #98f5ff;">Some</span><span style="color: #90a890;">(</span>task<span style="color: #90a890;">)</span> =&gt; task,
                    <span style="color: #98f5ff;">None</span> =&gt; <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #90a890;">(</span>core<span style="color: #90a890;">)</span>,
                <span style="color: #b0b0b3;">}</span>;

                <span style="color: #00bfff;">if</span> <span style="color: #a2cd5a;">coop</span>::has_budget_remaining<span style="color: #b0b0b3;">()</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Run the LIFO task, then loop</span>
                    core.metrics.incr_poll_count<span style="color: #90a890;">()</span>;
                    *<span style="color: #00bfff;">self</span>.core.borrow_mut<span style="color: #90a890;">()</span> = <span style="color: #98f5ff;">Some</span><span style="color: #90a890;">(</span>core<span style="color: #90a890;">)</span>;
                    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">task</span> = <span style="color: #00bfff;">self</span>.worker.handle.shared.owned.assert_owner<span style="color: #90a890;">(</span>task<span style="color: #90a890;">)</span>;
                    task.run<span style="color: #90a890;">()</span>;
                <span style="color: #b0b0b3;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #b0b0b3;">{</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">Not enough budget left to run the LIFO task, push it to</span>
                    <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">the back of the queue and return.</span>
                    core.run_queue
                        .push_back<span style="color: #90a890;">(</span>task, <span style="color: #00bfff;">self</span>.worker.inject<span style="color: #a2b6da;">()</span>, <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> core.metrics<span style="color: #90a890;">)</span>;
                    <span style="color: #00bfff;">return</span> <span style="color: #98f5ff;">Ok</span><span style="color: #90a890;">(</span>core<span style="color: #90a890;">)</span>;
                <span style="color: #b0b0b3;">}</span>
            <span style="color: #aebed8;">}</span>
        <span style="color: #97b098;">}</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>

<span style="color: #00bfff;">impl</span> <span style="color: #98f5ff;">Core</span> <span style="color: #8c8c8c;">{</span>

    <span style="color: #ffe4b5;">/// Return the next notified task available to this worker.</span>
    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">next_task</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span>, <span style="color: #4eee94;">worker</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">Worker</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Notified</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
        <span style="color: #00bfff;">if</span> <span style="color: #00bfff;">self</span>.tick % worker.handle.shared.config.global_queue_interval == 0 <span style="color: #b0b1a3;">{</span>
            worker.inject<span style="color: #97b098;">()</span>.pop<span style="color: #97b098;">()</span>.or_else<span style="color: #97b098;">(</span>|| <span style="color: #00bfff;">self</span>.next_local_task<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span> <span style="color: #ffe4b5;">/// &#22312;&#35268;&#23450;&#30340;&#21608;&#26399;&#20869; &#20808;&#20174; global queue&#20013; &#23581;&#35797;&#33719;&#21462;</span>
        <span style="color: #b0b1a3;">}</span> <span style="color: #00bfff;">else</span> <span style="color: #b0b1a3;">{</span>
            <span style="color: #00bfff;">self</span>.next_local_task<span style="color: #97b098;">()</span>.or_else<span style="color: #97b098;">(</span>|| worker.inject<span style="color: #aebed8;">()</span>.pop<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">}</span>

    <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">next_local_task</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Notified</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span> <span style="color: #ffe4b5;">/// &#20174; run_queue &#20013; pop Task</span>
        <span style="color: #00bfff;">self</span>.lifo_slot.take<span style="color: #b0b1a3;">()</span>.or_else<span style="color: #b0b1a3;">(</span>|| <span style="color: #00bfff;">self</span>.run_queue.pop<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgad5b525" class="outline-3">
<h3 id="orgad5b525"><span class="section-number-3">13.7.</span> Task: 的 结构类型： 其中woker.next_local_task(&amp;self) -&gt; Option&lt;Notified&gt; ， Notified 为: type Notified = task::Notified&lt;Arc&lt;Handle&gt;&gt;;</h3>
<div class="outline-text-3" id="text-13-7">
</div>
<div id="outline-container-orge2e9a8d" class="outline-4">
<h4 id="orge2e9a8d"><span class="section-number-4">13.7.1.</span> pub(crate) struct <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/task/mod.rs:229">task::Notified</a>&lt;S: 'static&gt;(Task&lt;S&gt;);</h4>
</div>
<div id="outline-container-orgad662df" class="outline-4">
<h4 id="orgad662df"><span class="section-number-4">13.7.2.</span> pub(crate) struct <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/task/mod.rs:219">Task</a>&lt;S: 'static&gt; {  raw: RawTask,   _p: PhantomData&lt;S&gt; }</h4>
</div>
<div id="outline-container-orgbf2bcff" class="outline-4">
<h4 id="orgbf2bcff"><span class="section-number-4">13.7.3.</span> 这里面的 Notified 非常奇怪: 其包含了一个 raw: RawTask 以及 _p: PhantomData， 不占用空间， 就是说 Notified基本等同于 RawTask, 至于, 为什么需要带上 &lt;S&gt;， 仅仅是 传递 Sync, 等属性 吗？</h4>
</div>
<div id="outline-container-orgbcb19cb" class="outline-4">
<h4 id="orgbcb19cb"><span class="section-number-4">13.7.4.</span> 另外 需要注意： Task 与  blocking/pool.rs 中的 pub(crate) struct Task {    task: task::UnownedTask&lt;BlockingSchedule&gt;,    mandatory: Mandatory,}  结构不同，</h4>
</div>
<div id="outline-container-orgf56cfee" class="outline-4">
<h4 id="orgf56cfee"><span class="section-number-4">13.7.5.</span> 说明 blocking_spawn 与 worker.spawn 产生的Task 不同</h4>
<div class="outline-text-4" id="text-13-7-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #ffe4b5;">/// A scheduler worker</span>
<span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">super</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Worker</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// Used to hand-off a worker's core to another thread.</span>
    <span style="color: #4eee94;">core</span>: <span style="color: #98f5ff;">AtomicCell</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Core</span><span style="color: #93a8c6;">&gt;</span>,
<span style="color: #8c8c8c;">}</span>
<span style="color: #ffe4b5;">/// Core data</span>
<span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Core</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// Used to schedule bookkeeping tasks every so often.</span>
    <span style="color: #4eee94;">tick</span>: <span style="color: #98f5ff;">u32</span>,

    <span style="color: #ffe4b5;">/// When a task is scheduled from a worker, it is stored in this slot. The</span>
    <span style="color: #ffe4b5;">/// worker will check this slot for a task **before** checking the run</span>
    <span style="color: #ffe4b5;">/// queue. This effectively results in the **last** scheduled task to be run</span>
    <span style="color: #ffe4b5;">/// next (LIFO). This is an optimization for message passing patterns and</span>
    <span style="color: #ffe4b5;">/// helps to reduce latency.</span>
    <span style="color: #4eee94;">lifo_slot</span>: <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Notified</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #ffe4b5;">/// The worker-local run queue.</span>
    <span style="color: #4eee94;">run_queue</span>: <span style="color: #a2cd5a;">queue</span>::<span style="color: #98f5ff;">Local</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Arc</span><span style="color: #b0b1a3;">&lt;</span><span style="color: #98f5ff;">Handle</span><span style="color: #b0b1a3;">&gt;</span><span style="color: #93a8c6;">&gt;</span>, <span style="color: #ffe4b5;">/// &#27599;&#20010;worker&#19968;&#20010; run_queue, &#22914;&#26524;&#27809;&#26377;&#20043;&#21518;&#25165;&#20250;&#20174; woker.shared &#20013;&#33719;&#21462;</span>
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">impl</span> core <span style="color: #8c8c8c;">{</span>
  <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">next_local_task</span><span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #00bfff;">mut</span> <span style="color: #00bfff;">self</span><span style="color: #93a8c6;">)</span> -&gt; <span style="color: #98f5ff;">Option</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">Notified</span><span style="color: #93a8c6;">&gt;</span> <span style="color: #93a8c6;">{</span>
      <span style="color: #00bfff;">self</span>.lifo_slot.take<span style="color: #b0b1a3;">()</span>.or_else<span style="color: #b0b1a3;">(</span>|| <span style="color: #00bfff;">self</span>.run_queue.pop<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
  <span style="color: #93a8c6;">}</span>

<span style="color: #8c8c8c;">}</span>


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org86c4f57" class="outline-3">
<h3 id="org86c4f57"><span class="section-number-3">13.8.</span> derive#Handle: 主要为 Epoll， 或者其他  IO事件 注册器</h3>
<div class="outline-text-3" id="text-13-8">
</div>
<div id="outline-container-orgae2c33e" class="outline-4">
<h4 id="orgae2c33e"><span class="section-number-4">13.8.1.</span> source code:</h4>
<div class="outline-text-4" id="text-13-8-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Handle</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// IO driver handle</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">io</span>: <span style="color: #98f5ff;">IoHandle</span>,

    <span style="color: #ffe4b5;">/// Signal driver handle</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg_attr</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">any</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">not</span><span style="color: #aebed8;">(</span><span style="color: #ffd700;">unix</span><span style="color: #aebed8;">)</span><span style="color: #ffd700;">, loom</span><span style="color: #97b098;">)</span><span style="color: #ffd700;">, allow</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">dead_code</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">signal</span>: <span style="color: #98f5ff;">SignalHandle</span>,

    <span style="color: #ffe4b5;">/// Time driver handle</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">time</span>: <span style="color: #98f5ff;">TimeHandle</span>,

    <span style="color: #ffe4b5;">/// Source of `Instant::now()`</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg_attr</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">not</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">all</span><span style="color: #aebed8;">(</span><span style="color: #ffd700;">feature = </span><span style="color: #deb887;">"time"</span><span style="color: #ffd700;">, feature = </span><span style="color: #deb887;">"test-util"</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #ffd700;">, allow</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">dead_code</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">clock</span>: <span style="color: #98f5ff;">Clock</span>,
<span style="color: #8c8c8c;">}</span>
<span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">IoHandle</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #98f5ff;">Enabled</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span>::<span style="color: #a2cd5a;">runtime</span>::<span style="color: #a2cd5a;">io</span>::<span style="color: #98f5ff;">Handle</span><span style="color: #93a8c6;">)</span>,
    <span style="color: #98f5ff;">Disabled</span><span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">UnparkThread</span><span style="color: #93a8c6;">)</span>,
<span style="color: #8c8c8c;">}</span>
<span style="color: #ffe4b5;">/// A reference to an I/O driver.</span>
<span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Handle</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffe4b5;">/// Registers I/O resources.</span>
    <span style="color: #4eee94;">registry</span>: <span style="color: #a2cd5a;">mio</span>::<span style="color: #98f5ff;">Registry</span>,

    <span style="color: #ffe4b5;">/// Allocates `ScheduledIo` handles when creating new resources.</span>
    <span style="color: #4eee94;">io_dispatch</span>: <span style="color: #98f5ff;">RwLock</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">IoDispatcher</span><span style="color: #93a8c6;">&gt;</span>,

    <span style="color: #ffe4b5;">/// Used to wake up the reactor from a call to `turn`.</span>
    <span style="color: #ffe4b5;">/// Not supported on Wasi due to lack of threading support.</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">cfg</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">not</span><span style="color: #97b098;">(</span><span style="color: #ffd700;">tokio_wasi</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #4eee94;">waker</span>: <span style="color: #a2cd5a;">mio</span>::<span style="color: #98f5ff;">Waker</span>,

    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">metrics</span>: <span style="color: #98f5ff;">IoDriverMetrics</span>,
<span style="color: #8c8c8c;">}</span>


</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf0738af" class="outline-3">
<h3 id="orgf0738af"><span class="section-number-3">13.9.</span> Lanch workers: pub(crate) struct Launch(Vec&lt;Arc&lt;<a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/scheduler/multi_thread/worker.rs:74">Worker</a>&gt;&gt;);</h3>
</div>
<div id="outline-container-orgc256470" class="outline-3">
<h3 id="orgc256470"><span class="section-number-3">13.10.</span> ?scheduler？  区分与 <a href="file:///Users/shaohua.li/.cargo/registry/src/mirrors.tuna.tsinghua.edu.cn-df7c3c540f42cdbd/tokio-1.28.0/src/runtime/handle.rs:12">runtime/handle.rs</a> 这里面就是 Runtime的一个包装，</h3>
</div>
<div id="outline-container-org7aa8d8c" class="outline-3">
<h3 id="org7aa8d8c"><span class="section-number-3">13.11.</span> Context Switch： rust async runtime like tokio 并不需要 Context Switch <a href="https://users.rust-lang.org/t/where-the-tokio-task-context-switch-code/94984/11">https://users.rust-lang.org/t/where-the-tokio-task-context-switch-code/94984/11</a></h3>
<div class="outline-text-3" id="text-13-11">
</div>
<div id="outline-container-org84c7e67" class="outline-4">
<h4 id="org84c7e67"><span class="section-number-4">13.11.1.</span> Rust 将 .await, async  转换为 状态机， 即便是 多层的嵌套 .await 调用， 依然 可以转换为 状态机 无非是 状态多一点</h4>
</div>
<div id="outline-container-orgbb8da70" class="outline-4">
<h4 id="orgbb8da70"><span class="section-number-4">13.11.2.</span> 状态机的转换中， 跨越 .await 的变量使用 保存在 状态机中, 对于 如下 foo 内调用 bar， 将转换为 FooState (其内嵌 BarState）</h4>
<div class="outline-text-4" id="text-13-11-2">
<div class="org-src-container">
<pre class="src src-rust">  <span style="color: #00bfff;">async</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">foo</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">local</span> = 123;
    bar<span style="color: #93a8c6;">()</span>.<span style="color: #00bfff;">await</span>;
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"</span><span style="color: #deb887; font-style: italic;">{local}</span><span style="color: #deb887;">"</span><span style="color: #93a8c6;">)</span>;
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #00bfff;">async</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">bar</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">other</span> = 456;
    <span style="color: #00bfff;">yield</span><span style="color: #93a8c6;">()</span>.<span style="color: #00bfff;">await</span>;
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"</span><span style="color: #deb887; font-style: italic;">{other}</span><span style="color: #deb887;">"</span><span style="color: #93a8c6;">)</span>;
  <span style="color: #8c8c8c;">}</span>


  <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">FooState</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #98f5ff;">Initial</span>,
    <span style="color: #98f5ff;">AwaitBar</span> <span style="color: #93a8c6;">{</span> <span style="color: #4eee94;">local</span>: <span style="color: #98f5ff;">i32</span>, <span style="color: #4eee94;">bar</span>: <span style="color: #98f5ff;">BarState</span> <span style="color: #93a8c6;">}</span>,
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #00bfff;">enum</span> <span style="color: #98f5ff;">BarState</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #98f5ff;">Initial</span>,
    <span style="color: #98f5ff;">AwaitYield</span> <span style="color: #93a8c6;">{</span> <span style="color: #4eee94;">other</span>: <span style="color: #98f5ff;">i32</span>, <span style="color: #00bfff;">yield</span>: <span style="color: #98f5ff;">YeildState</span> <span style="color: #93a8c6;">}</span>,
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #98f5ff;">FooState</span>::<span style="color: #98f5ff;">AwaitBar</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #4eee94;">local</span>: 123,
    <span style="color: #4eee94;">bar</span>: <span style="color: #98f5ff;">BarState</span>::<span style="color: #98f5ff;">AwaitYield</span> <span style="color: #93a8c6;">{</span>
      <span style="color: #4eee94;">other</span>: 345,
      <span style="color: #00bfff;">yield</span>: ...
    <span style="color: #93a8c6;">}</span>,
  <span style="color: #8c8c8c;">}</span>

  <span style="color: #00bfff;">yield</span>
  bar <span style="color: #8c8c8c;">{</span> <span style="color: #4eee94;">other</span>: 345 <span style="color: #8c8c8c;">}</span>
  foo <span style="color: #8c8c8c;">{</span> <span style="color: #4eee94;">local</span>: 123 <span style="color: #8c8c8c;">}</span>

<span style="color: #ffe4b5;">/// &#22914;&#26524;&#36716;&#25442;&#20026; &#20195;&#30721;&#65292; fn &#21017;&#36716;&#25442;&#20026; &#20309;&#31181;&#24418;&#24335;&#30340;&#21602;?</span>

  <span style="color: #00bfff;">async</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">foo</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">let</span> <span style="color: #4eee94;">local</span> = 123;
    bar<span style="color: #93a8c6;">()</span>.<span style="color: #00bfff;">await</span>;
    <span style="color: #f08080;">println!</span><span style="color: #93a8c6;">(</span><span style="color: #deb887;">"</span><span style="color: #deb887; font-style: italic;">{local}</span><span style="color: #deb887;">"</span><span style="color: #93a8c6;">)</span>;
  <span style="color: #8c8c8c;">}</span>

<span style="color: #ffe4b5;">/// rust &#23558; bar().await &#36716;&#25442;&#20026;&#22914;&#19979;</span>
<span style="color: #00bfff;">while</span> barstate.poll<span style="color: #8c8c8c;">()</span> != <span style="color: #98f5ff;">Poll</span>::<span style="color: #98f5ff;">Ready</span><span style="color: #8c8c8c;">()</span> <span style="color: #8c8c8c;">{</span>

<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6cee76c" class="outline-4">
<h4 id="org6cee76c"><span class="section-number-4">13.11.3.</span> 所以 一个 Future 的最终结果为 一个巨大的 Enum 包含各种状态, fn  的内嵌调用将会被 压平 为一个函数，（此处错误）  函数不用压平， 还是 各种源代码， pc保持 代码位置。</h4>
</div>
<div id="outline-container-orgf35af49" class="outline-4">
<h4 id="orgf35af49"><span class="section-number-4">13.11.4.</span> 一个 函数 是如何处理 heap以及 stack变量的。</h4>
<div class="outline-text-4" id="text-13-11-4">
</div>
<ol class="org-ol">
<li><a id="orgd776efa"></a>func(name) { local val = 10; if name == 5 ; name = val * 5 }<br /></li>
<li><a id="orgc576da4"></a>name 应该为 heap 分配的， 传入为 addr<br /></li>
<li><a id="org4c6f77e"></a>val 需要在stack中分配， 如果跨越 await， 则 保存为 一种状态机<br /></li>
<li><a id="org63d68db"></a>所以 name = val * 5 将直接更改 name 地址（内存地址）的数值， 也没有什么不妥之处，val 可能为寄存器， 比 name 内存要快不少而已。<br /></li>
<li><a id="org2a070bd"></a>如果 rust 不将 fn 压平的话， 则需要将 .await 转换为 一个 loop/while 来 不断的对Future进行 poll， pc 始终 在 该循环中， 下次 唤醒， 则再次进入<br /></li>
<li><a id="orgf6c93fc"></a>如果 内嵌的 state 不在 heap中的话， 则 是 在 while 中调用内层的 函数 Poll::NotReady return 之后（， 类似于 name = val * 5， 直接修改自身 存在heap中的值, ） 然后yield<br /></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org8e4e1c7" class="outline-2">
<h2 id="org8e4e1c7"><span class="section-number-2">14.</span> codec:</h2>
<div class="outline-text-2" id="text-14">
</div>
<div id="outline-container-org7bb3b59" class="outline-3">
<h3 id="org7bb3b59"><span class="section-number-3">14.1.</span> Frame <i>/</i> 主要作用为 实现 Stream &amp; Sink Trait</h3>
<div class="outline-text-3" id="text-14-1">
<p>
<b>*</b>
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">Framed</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">U</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">pin</span><span style="color: #93a8c6;">]</span>
    <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">FramedImpl</span><span style="color: #93a8c6;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">U</span>, <span style="color: #98f5ff;">RWFrames</span><span style="color: #93a8c6;">&gt;</span>
<span style="color: #8c8c8c;">}</span>

</pre>
</div>
</div>
<div id="outline-container-org6914d57" class="outline-4">
<h4 id="org6914d57"><span class="section-number-4">14.1.1.</span> <a href="file:///Users/shaohua.li/Documents/work/doam_rs/vendor/futures-core/src/stream.rs:27">Stream</a> / <a href="file:///Users/shaohua.li/Documents/work/doam_rs/vendor/futures-sink/src/lib.rs:52">Sink</a>: Stream 用于 read， Sink用于 write Sink 中异步发送， 其中包含data的 cache</h4>
</div>
<div id="outline-container-orgea5445c" class="outline-4">
<h4 id="orgea5445c"><span class="section-number-4">14.1.2.</span> FramedImpl 为 主要实现</h4>
<div class="outline-text-4" id="text-14-1-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #00bfff;">pub</span><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">crate</span><span style="color: #8c8c8c;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">FramedImpl</span><span style="color: #8c8c8c;">&lt;</span><span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">U</span>, <span style="color: #98f5ff;">State</span><span style="color: #8c8c8c;">&gt;</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">pin</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">T</span>,
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">state</span>: <span style="color: #98f5ff;">State</span>,
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #4eee94;">codec</span>: <span style="color: #98f5ff;">U</span>,
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org911356d" class="outline-3">
<h3 id="org911356d"><span class="section-number-3">14.2.</span> <a href="file:///Users/shaohua.li/Documents/work/doam_rs/vendor/tokio-util/src/codec/framed.rs:293">impl Stream for Frame&lt;T, U&gt;</a>  最终转移到 FramedImpl 中</h3>
<div class="outline-text-3" id="text-14-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #ffd700;">pin_project!</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #ffd700;">#</span><span style="color: #93a8c6;">[</span><span style="color: #ffd700;">derive</span><span style="color: #b0b1a3;">(</span><span style="color: #ffd700;">Debug</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">]</span>
    <span style="color: #00bfff;">pub</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">crate</span><span style="color: #93a8c6;">)</span> <span style="color: #00bfff;">struct</span> <span style="color: #98f5ff;">FramedImpl</span>&lt;<span style="color: #98f5ff;">T</span>, <span style="color: #98f5ff;">U</span>, <span style="color: #98f5ff;">State</span> = <span style="color: #98f5ff;">RWFrames</span>&gt; <span style="color: #93a8c6;">{</span>
        <span style="color: #ffd700;">#</span><span style="color: #b0b1a3;">[</span><span style="color: #ffd700;">pin</span><span style="color: #b0b1a3;">]</span>
        <span style="color: #00bfff;">pub</span><span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">crate</span><span style="color: #b0b1a3;">)</span> <span style="color: #4eee94;">inner</span>: <span style="color: #98f5ff;">T</span>,
        <span style="color: #00bfff;">pub</span><span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">crate</span><span style="color: #b0b1a3;">)</span> <span style="color: #4eee94;">state</span>: <span style="color: #98f5ff;">State</span>,
        <span style="color: #00bfff;">pub</span><span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">crate</span><span style="color: #b0b1a3;">)</span> <span style="color: #4eee94;">codec</span>: <span style="color: #98f5ff;">U</span>,
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org29121e6" class="outline-3">
<h3 id="org29121e6"><span class="section-number-3">14.3.</span> </h3>
</div>
</div>
<div id="outline-container-orgba57545" class="outline-2">
<h2 id="orgba57545"><span class="section-number-2">15.</span> await/async 的使用疑问：</h2>
<div class="outline-text-2" id="text-15">
</div>
<div id="outline-container-org2031434" class="outline-3">
<h3 id="org2031434"><span class="section-number-3">15.1.</span> async 将 fun 转换为 一个 Future</h3>
<div class="outline-text-3" id="text-15-1">
</div>
</div>
</div>
<div id="outline-container-orgd8d9147" class="outline-2">
<h2 id="orgd8d9147"><span class="section-number-2">16.</span> wasm: Wasm: 看起来使用比较复杂， 已经很难在手写了</h2>
<div class="outline-text-2" id="text-16">
</div>
<div id="outline-container-org6b49877" class="outline-3">
<h3 id="org6b49877"><span class="section-number-3">16.1.</span> wasm 为什么会快： 整体上看 wasm 特别像是OS，但是没有提供任何抽象</h3>
<div class="outline-text-3" id="text-16-1">
<ol class="org-ol">
<li>二进制格式wasm， 网络传输体积小，不需要转码 快</li>
<li>linear memory： 线性内存。 内存模型简单，没有GC， 不提供内存管理 使其简单</li>
<li>提议中： 多线程， 能够与os交互 实现 多进程，</li>
</ol>
</div>
</div>
<div id="outline-container-org267f3dd" class="outline-3">
<h3 id="org267f3dd"><span class="section-number-3">16.2.</span> wasm 在broswer  快速使用的原因：</h3>
<div class="outline-text-3" id="text-16-2">
<ol class="org-ol">
<li>vm(broswer ) 本身存在vm来run  js code</li>
<li>web api 作为host api 使用： DOM， WebGl, Audio Api</li>
</ol>
</div>
</div>
<div id="outline-container-orgfddc801" class="outline-3">
<h3 id="orgfddc801"><span class="section-number-3">16.3.</span> 周边工具:</h3>
<div class="outline-text-3" id="text-16-3">
<ol class="org-ol">
<li>wabbit, xxx.wat &#x2013;&#x2014;wat2wasm-&#x2014;&gt; xxx.wasm -&#x2014;wasm2wat&#x2014;&gt; xx.wat, xxx.wasm&#x2014;objdump&#x2014;&gt; wasm结构展示</li>
<li>wat 裸写 比较困难，除了需要写xx.wat之外，还需要 对xx.wasm使用js进行包装(wrapper)， 才能在web中进行使用。</li>
<li>WASI: 定义了 在 非 浏览器器之外运行 wasm 的 能力。 defines a modular system interface to run WebAssembly outside the web, providing access to things like files, network connections, clocks, and random numbers.</li>
<li>Emscripten 是将 C/C++ 代码编译为 WASM 模块的工具链。
Emscripten 的优势:
 支持多种语言，包括 C/C++、Rust、Go 等。
 可以生成高效、安全的 WASM 模块。
 提供 JavaScript 胶水代码，用于在 Web 浏览器中加载和执行 WASM 模块</li>
</ol>
</div>
</div>
<div id="outline-container-org20d8c07" class="outline-3">
<h3 id="org20d8c07"><span class="section-number-3">16.4.</span> 格式： 参考  <a href="https://webassembly.github.io/spec/core/text/index.html">text format</a> <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format">mdn</a></h3>
</div>
<div id="outline-container-orgad9b1dc" class="outline-3">
<h3 id="orgad9b1dc"><span class="section-number-3">16.5.</span> key Concepts:</h3>
<div class="outline-text-3" id="text-16-5">
<ol class="org-ol">
<li>Module: wasm &#x2013;broswer&#x2013;compilie to -&gt; executable machine code, 无状态，仅代表 executable code</li>
<li>Memory： ArrayBuffer 就是 wasm运行的 linear memory？</li>
<li>Table: reference, 不方便存储在 Memory中 (考虑安全以及 便携)</li>
<li>Instance: 1 + 2 + 3 即是： 代码 + 运行状态: <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface">js api</a></li>
</ol>
</div>
</div>
<div id="outline-container-orgade61d7" class="outline-3">
<h3 id="orgade61d7"><span class="section-number-3">16.6.</span> rust &lt;-&gt;  wasm: <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Rust_to_Wasm">mdn</a>, <a href="https://rustwasm.github.io/book/why-rust-and-webassembly.html">rustwasm</a>  wasm-pack: 是rust 与js 沟通的重要桥梁， 应该试试更高级的沟通，比如 Js中的类型， Rust中的类型 互相调用</h3>
<div class="outline-text-3" id="text-16-6">
<ol class="org-ol">
<li>abc:</li>
</ol>
<div class="org-src-container">
<pre class="src src-rust">  cargo install wasm-pack
  <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">cargo.toml</span>

<span style="color: #8c8c8c;">[</span>package<span style="color: #8c8c8c;">]</span>
name = <span style="color: #deb887;">"xxxx"</span>
version = <span style="color: #deb887;">"0.1.0"</span>
authors = <span style="color: #8c8c8c;">[</span><span style="color: #deb887;">"Your Name <a href="mailto:you%40example.com">&lt;you@example.com&gt;</a>"</span><span style="color: #8c8c8c;">]</span>
description = <span style="color: #deb887;">"A sample project with wasm-pack"</span>
license = <span style="color: #deb887;">"MIT/Apache-2.0"</span>
repository = <span style="color: #deb887;">"https://github.com/yourgithubusername/hello-wasm"</span>
edition = <span style="color: #deb887;">"2018"</span>

<span style="color: #8c8c8c;">[</span>lib<span style="color: #8c8c8c;">]</span>
<span style="color: #00bfff;">crate</span>-<span style="color: #00bfff;">type</span> = <span style="color: #8c8c8c;">[</span><span style="color: #deb887;">"cdylib"</span><span style="color: #8c8c8c;">]</span>
p
<span style="color: #8c8c8c;">[</span>dependencies<span style="color: #8c8c8c;">]</span>
wasm-bindgen = <span style="color: #deb887;">"0.2"</span>



<span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">lib.rs</span>

<span style="color: #00bfff;">use</span> <span style="color: #a2cd5a;">wasm_bindgen</span>::<span style="color: #a2cd5a;">prelude</span>::*;

<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">wasm_bindgen</span><span style="color: #8c8c8c;">]</span> <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">rust &#35843;&#29992; &#27983;&#35272;&#22120;&#30340; alert, &#20989;&#25968;&#32465;&#23450;</span>
<span style="color: #00bfff;">extern</span> <span style="color: #8c8c8c;">{</span>
    <span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">alert</span><span style="color: #93a8c6;">(</span><span style="color: #4eee94;">s</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

<span style="color: #ffd700;">#</span><span style="color: #8c8c8c;">[</span><span style="color: #ffd700;">wasm_bindgen</span><span style="color: #8c8c8c;">]</span> <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">rust &#36755;&#20986;&#21040;js &#20989;&#25968;&#32465;&#23450;</span>
<span style="color: #00bfff;">pub</span> <span style="color: #00bfff;">fn</span> <span style="color: #daa520;">greet</span><span style="color: #8c8c8c;">(</span><span style="color: #4eee94;">name</span>: <span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #98f5ff;">str</span><span style="color: #8c8c8c;">)</span> <span style="color: #8c8c8c;">{</span>
    alert<span style="color: #93a8c6;">(</span><span style="color: #cccccc; background-color: #181a26;">&amp;</span><span style="color: #f08080;">format!</span><span style="color: #b0b1a3;">(</span><span style="color: #deb887;">"Hello, </span><span style="color: #deb887; font-style: italic;">{}</span><span style="color: #deb887;">!"</span>, name<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>;
<span style="color: #8c8c8c;">}</span>

wasm-pack build --target web <span style="color: #7f7f7f;">// </span><span style="color: #7f7f7f;">&#27880;&#24847;target = web&#21442;&#25968; &#20250;&#23433;&#35013; wasm32-unknown-unknown &#21442;&#32771;&#65306; https://rust-lang.github.io/rustup/cross-compilation.html</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a18b7a" class="outline-3">
<h3 id="org3a18b7a"><span class="section-number-3">16.7.</span> <a href="https://wasmtime.dev/">wasmtime:</a>  使用rust编写的 wasm 运行时， 即： 符合wasm标准的 rust实现:</h3>
<div class="outline-text-3" id="text-16-7">
<ol class="org-ol">
<li>wasm book 看了看，没看懂，wasm 如何在 树莓派上运行的， 为什么没有 wasm runtime 呢？</li>
</ol>
</div>
</div>
<div id="outline-container-org308adcb" class="outline-3">
<h3 id="org308adcb"><span class="section-number-3">16.8.</span> lldb 使用：</h3>
<div class="outline-text-3" id="text-16-8">
<p>
rust使用 rust gdb 不支持 aarch, mac自带 lldb， 所以使用 rust-lldb (rust 提供的对 lldb 调用的封装shell):
</p>
</div>
</div>
<div id="outline-container-org31fd5c5" class="outline-3">
<h3 id="org31fd5c5"><span class="section-number-3">16.9.</span> lldb 使用方法：  注意 xxx.file 为  source code file</h3>
<div class="outline-text-3" id="text-16-9">
<ol class="org-ol">
<li>启动  lldb xxx.file / lldb; file xxx.file / lldb &#x2013; xx.file para1 para2</li>
<li>breakpoints:
<ul class="org-ul">
<li>breakpoint set -f xx.file -l num / br s -f xxx.file -l num / b xxx.file : num</li>
<li>br list, br del</li>
<li>b function_name</li>
</ul></li>
<li>next/n, step/s (step into function)  c(continue)</li>
<li>p varname</li>
<li>罗列当前 stack frame var: frame variable/ frame v/ fr v</li>
<li>当前代码 在哪里： frame select / fr s</li>
<li>堆栈 inspect： backstack: bt select 0 / bt 0   操作不会破坏堆栈 可以 用来了解 函数调用栈的 详细信息</li>
<li>设置观察点: watchpoints: watchpoint set variable varname/ watchpoint set variable -w read|write|read_write varname/ w s v varname -w read|write|read_write</li>
</ol>
</div>
</div>
<div id="outline-container-org46f5a2c" class="outline-3">
<h3 id="org46f5a2c"><span class="section-number-3">16.10.</span> rust-lldb:</h3>
<div class="outline-text-3" id="text-16-10">
<ol class="org-ol">
<li>rust compile with debug symbol: cargo build 默认为debug / rustc -g / rustc -C debuginfo=2</li>
<li>rust-lldb target/debug/xxxx arg1 arg2</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgfa77240" class="outline-2">
<h2 id="orgfa77240"><span class="section-number-2">17.</span> ----------&#x2013;&#x2014; ^^^^^ the trait `Speak` is not implemented for `&amp;dyn Speak`</h2>
</div>
<div id="outline-container-org61856f6" class="outline-2">
<h2 id="org61856f6"><span class="section-number-2">18.</span> rust 资源:</h2>
<div class="outline-text-2" id="text-18">
<ol class="org-ol">
<li><a href="https://reberhardt.com/cs110l/spring-2020/">https://reberhardt.com/cs110l/spring-2020/</a></li>
<li><a href="https://dtolnay.github.io/rust-quiz/1">https://dtolnay.github.io/rust-quiz/1</a></li>
<li><a href="https://github.com/TianyiShi2001/Algorithms">https://github.com/TianyiShi2001/Algorithms</a></li>
<li><a href="https://github.com/TianyiShi2001/Algorithms">https://github.com/TianyiShi2001/Algorithms</a></li>
<li><a href="https://github.com/LearningOS/rust-based-os-comp2023/blob/main/relatedinfo.md">https://github.com/LearningOS/rust-based-os-comp2023/blob/main/relatedinfo.md</a></li>
<li><a href="https://github.com/rcore-os/rCore/wiki/study-resource-of-system-programming-in-RUST">https://github.com/rcore-os/rCore/wiki/study-resource-of-system-programming-in-RUST</a></li>
</ol>
</div>
</div>
<div id="outline-container-org06b30ac" class="outline-2">
<h2 id="org06b30ac"><span class="section-number-2">19.</span> ? 待探索问题：</h2>
<div class="outline-text-2" id="text-19">
</div>
<div id="outline-container-org02ea20d" class="outline-3">
<h3 id="org02ea20d"><span class="section-number-3">19.1.</span> 标准库的 thread 使用</h3>
</div>
<div id="outline-container-org8e529d7" class="outline-3">
<h3 id="org8e529d7"><span class="section-number-3">19.2.</span> mspc 使用 +  内部实现原理 （channel）</h3>
</div>
<div id="outline-container-org913f5c1" class="outline-3">
<h3 id="org913f5c1"><span class="section-number-3">19.3.</span> <span class="todo HOLD">HOLD</span> tokio example</h3>
</div>
<div id="outline-container-org18f41ea" class="outline-3">
<h3 id="org18f41ea"><span class="section-number-3">19.4.</span> tokio inner</h3>
</div>
<div id="outline-container-org5319bf5" class="outline-3">
<h3 id="org5319bf5"><span class="section-number-3">19.5.</span> error handle 方式</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: wildimagine</p>
<p class="date">Created: 2024-03-12 Tue 14:15</p>
</div>
</body>
</html>
